<!DOCTYPE html>
<html lang="en" class="light min-h-screen">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Giorgi's GCSE Revision Hub</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    },
                    colors: {
                        primary: { light: '#4f46e5', DEFAULT: '#4f46e5', dark: '#6366f1' },
                        secondary: { light: '#059669', DEFAULT: '#059669', dark: '#10b981' },
                        background: { light: '#f8fafc', DEFAULT: '#f8fafc', dark: '#0f172a' },
                        card: { light: '#ffffff', DEFAULT: '#ffffff', dark: '#1e293b' },
                        text: { light: '#1e293b', DEFAULT: '#1e293b', dark: '#e2e8f0' },
                        muted: { light: '#64748b', DEFAULT: '#64748b', dark: '#94a3b8' },
                        status: {
                            review: 'bg-yellow-100 dark:bg-yellow-900/50 text-yellow-700 dark:text-yellow-300 border border-yellow-300 dark:border-yellow-700/50 font-medium',
                            progress: 'bg-blue-100 dark:bg-blue-900/50 text-blue-700 dark:text-blue-300 border border-blue-300 dark:border-blue-700/50 font-medium',
                            mastered: 'bg-green-100 dark:bg-green-900/50 text-green-700 dark:text-green-300 border border-green-300 dark:border-green-700/50 font-medium',
                        }
                    },
                    boxShadow: {
                        'widget': '0 4px 12px -1px rgb(0 0 0 / 0.07), 0 2px 8px -2px rgb(0 0 0 / 0.05)',
                        'widget-dark': '0 4px 12px -1px rgb(0 0 0 / 0.2), 0 2px 8px -2px rgb(0 0 0 / 0.15)',
                        'widget-hover': '0 10px 20px -3px rgb(0 0 0 / 0.1), 0 4px 8px -4px rgb(0 0 0 / 0.08)',
                        'widget-hover-dark': '0 10px 20px -3px rgb(0 0 0 / 0.3), 0 4px 8px -4px rgb(0 0 0 / 0.25)',
                    },
                    borderRadius: { 'xl': '0.75rem', 'lg': '0.5rem', 'spinner-modal': '16px' },
                    transitionTimingFunction: {
                        'smooth': 'cubic-bezier(0.4, 0, 0.2, 1)',
                        'snap': 'cubic-bezier(0.165, 0.84, 0.44, 1)',
                        'spin-ease': 'cubic-bezier(0.25, 0.1, 0.25, 1)',
                        'spin-end': 'cubic-bezier(0.33, 1, 0.68, 1)',
                        'momentum-spin': 'cubic-bezier(0.2, 1, 0.3, 1)',
                    }
                }
            }
        }
    </script>
    <style>
        :root {
             --ease-smooth: cubic-bezier(0.4, 0, 0.2, 1);
             --ease-snap: cubic-bezier(0.165, 0.84, 0.44, 1);
             --ease-spin-end: cubic-bezier(0.33, 1, 0.68, 1);
             --color-primary-DEFAULT: theme('colors.primary.DEFAULT');
             --color-primary-dark: theme('colors.primary.dark');
             --color-secondary-DEFAULT: theme('colors.secondary.DEFAULT');
             --color-secondary-dark: theme('colors.secondary.dark');
             --color-text-DEFAULT: theme('colors.text.DEFAULT');
             --color-text-dark: theme('colors.text.dark');
             --color-muted-DEFAULT: theme('colors.muted.DEFAULT');
             --color-muted-dark: theme('colors.muted.dark');
             --color-background-DEFAULT: theme('colors.background.DEFAULT');
             --color-background-dark: theme('colors.background.dark');
             --color-card-DEFAULT: theme('colors.card.DEFAULT');
             --color-card-dark: theme('colors.card.dark');
            --spinner-bg-color: theme('colors.background.light');
            --spinner-bg-color-dark: #2a303c;
            --spinner-container-bg: theme('colors.card.light');
            --spinner-container-bg-dark: theme('colors.card.dark');
            --spinner-shadow-light: rgba(0, 0, 0, 0.05);
            --spinner-shadow-medium: rgba(0, 0, 0, 0.1);
            --spinner-marker-color: var(--color-primary-DEFAULT);
            --spinner-button-bg: var(--spinner-marker-color);
            --spinner-button-bg-hover: theme('colors.primary.light');
            --spinner-text-primary: var(--color-text-DEFAULT);
            --spinner-text-primary-dark: var(--color-text-dark);
            --spinner-text-secondary: var(--color-muted-DEFAULT);
            --spinner-text-secondary-dark: var(--color-muted-dark);
            --spinner-text-light: theme('colors.white');
            --spinner-font-primary: 'Inter', sans-serif;
            --spinner-border-color: theme('colors.slate.200');
            --spinner-border-color-dark: theme('colors.slate.600');
            --spinner-focus-glow: rgba(79, 70, 229, 0.25);
            --spinner-color-1: #dc3545; --spinner-color-2: #fd7e14; --spinner-color-3: #ffc107;
            --spinner-color-4: #20c997; --spinner-color-5: #0d6efd; --spinner-color-6: #6f42c1;
            --spinner-color-7: #d63384; --spinner-color-8: #adb5bd; --spinner-color-9: #198754;
            --spinner-color-10: #0dcaf0;
        }
        html { scroll-behavior: smooth; }
        body { -webkit-font-smoothing: antialiased; -moz-osx-font-smoothing: grayscale; }
        button, a, input, textarea, select, div[role="button"], details summary {
            transition: background-color 0.2s ease-out, border-color 0.2s ease-out, color 0.2s ease-out, box-shadow 0.2s ease-out, opacity 0.2s ease-out, transform 0.15s ease-out;
            outline-offset: 2px;
        }
        *:focus-visible { outline: 2px solid var(--color-primary-DEFAULT); outline-offset: 3px; border-radius: 0.25rem; }
        .dark *:focus-visible { outline-color: var(--color-primary-dark); }
        input:focus-visible, select:focus-visible, textarea:focus-visible { border-color: var(--color-primary-DEFAULT) !important; outline: 1px solid var(--color-primary-DEFAULT); outline-offset: 0px; }
        .dark input:focus-visible, .dark select:focus-visible, .dark textarea:focus-visible { border-color: var(--color-primary-dark) !important; outline-color: var(--color-primary-dark); }
        a:focus-visible, button:focus-visible { outline-offset: 2px; }
        input[type="file"]:focus-visible + label, input[type="file"].focus-visible + label { outline: 2px solid var(--color-primary-DEFAULT); outline-offset: 1px; border-radius: theme('borderRadius.full'); }
        .dark input[type="file"]:focus-visible + label, .dark input[type="file"].focus-visible + label { outline-color: var(--color-primary-dark); }
        button:disabled, button[disabled] { opacity: 0.5; cursor: not-allowed; filter: grayscale(50%); transform: none !important; box-shadow: none !important; }
        .btn-animated { transform: scale(1); transition: transform 0.1s var(--ease-snap), background-color 0.15s var(--ease-smooth), box-shadow 0.1s var(--ease-smooth), filter 0.15s var(--ease-smooth); }
        .btn-animated:hover:not(:disabled) { filter: brightness(1.08); transform: scale(1.03); box-shadow: theme('boxShadow.md');}
        .btn-animated:active:not(:disabled) { transform: scale(0.96); filter: brightness(0.90); transition-duration: 0.05s; }
        a.nav-link:hover, a.mobile-nav-link:hover { transform: translateY(-1px); filter: brightness(1.1); }
        .dashboard-card { transition: transform 0.25s var(--ease-smooth), box-shadow 0.25s var(--ease-smooth); }
        .dashboard-card:hover { transform: translateY(-6px) scale(1.015); box-shadow: theme('boxShadow.widget-hover'); }
        .dark .dashboard-card:hover { box-shadow: theme('boxShadow.widget-hover-dark'); }
        .page { display: none; padding: 1rem; }
        @media (min-width: 768px) { .page { padding: 1.5rem; } }
        @media (min-width: 1024px) { .page { padding: 2rem; } }
        .page.active { display: block; animation: pageFadeIn 0.5s var(--ease-smooth); }
        @keyframes pageFadeIn { from { opacity: 0; transform: translateY(15px) scale(0.99); } to { opacity: 1; transform: translateY(0) scale(1); } }
        #mobile-menu { transform: translateX(-100%); opacity: 0; transition: transform 0.35s var(--ease-smooth), opacity 0.3s ease-out; pointer-events: none; }
        #mobile-menu.open { transform: translateX(0); opacity: 1; pointer-events: auto; }
        #mobile-overlay { transition: opacity 0.35s var(--ease-smooth); opacity: 0; pointer-events: none; }
        #mobile-overlay.visible { opacity: 1; pointer-events: auto; }
        @keyframes listItemFadeIn { from { opacity: 0; transform: translate(0, 10px) scale(0.98); } to { opacity: 1; transform: translate(0, 0) scale(1); } }
        .list-item-appear { animation: listItemFadeIn 0.4s var(--ease-smooth) backwards; }
        @keyframes contentFadeOut { to { opacity: 0; transform: scale(0.98); } }
        @keyframes contentFadeInShort { from { opacity: 0; transform: scale(0.98); } to { opacity: 1; transform: scale(1); } }
        .content-fade-out { animation: contentFadeOut 0.15s var(--ease-smooth) forwards; }
        .content-fade-in { animation: contentFadeInShort 0.3s var(--ease-smooth) 0.15s backwards; }
        .quiz-feedback-correct { animation: flashGreen 0.5s ease-out; }
        .quiz-feedback-incorrect { animation: shakeHorizontal 0.4s ease-in-out; }
        .pomodoro-mode-btn.shake-horizontal { animation: shakeHorizontal 0.4s ease-in-out; }
        @keyframes flashGreen { 0%, 100% { background-color: transparent; } 50% { background-color: rgba(74, 222, 128, 0.3); } }
        @keyframes shakeHorizontal { 0%, 100% { transform: translateX(0); } 25%, 75% { transform: translateX(-6px); } 50% { transform: translateX(6px); } }
        i[data-lucide] { width: 1em; height: 1em; display: inline-block; vertical-align: -0.125em; stroke-width: 2; }
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background-color: #e2e8f0; border-radius: 9999px; }
        ::-webkit-scrollbar-thumb { background-color: rgba(165, 180, 252, 0.7); border-radius: 9999px; }
        ::-webkit-scrollbar-thumb:hover { background-color: rgba(129, 140, 248, 0.9); }
        .dark ::-webkit-scrollbar-track { background-color: #334155; }
        .dark ::-webkit-scrollbar-thumb { background-color: rgba(99, 102, 241, 0.6); }
        .dark ::-webkit-scrollbar-thumb:hover { background-color: rgba(79, 70, 229, 0.8); }
        #timetable-body tr:nth-child(even) { background-color: theme('colors.slate.50 / 70%'); }
        #timetable-body tr:hover { background-color: theme('colors.slate.100'); }
        .dark #timetable-body tr:nth-child(even) { background-color: theme('colors.slate.800 / 50%'); }
        .dark #timetable-body tr:hover { background-color: theme('colors.slate.700 / 60%'); }
        .timetable-new-day td { border-top: 3px solid #cbd5e1 !important; padding-top: 1.25rem !important; }
        .dark .timetable-new-day td { border-top-color: #475569 !important; }
        .timetable-subject-cell { background-color: rgba(var(--subject-rgb), 0.08); position: relative; }
        .dark .timetable-subject-cell { background-color: rgba(var(--subject-rgb), 0.18); }
        #timetable-body td { padding-top: 1rem; padding-bottom: 1rem; vertical-align: middle; }
        .timetable-subject-text { font-weight: 600; }
        .upcoming-exam-item { transition: transform 0.2s var(--ease-smooth), box-shadow 0.2s var(--ease-smooth), background-color 0.2s ease-out; }
        .upcoming-exam-item:hover { transform: scale(1.02); box-shadow: theme('boxShadow.widget-hover'); cursor: pointer; background-color: theme('colors.slate.50');}
        .dark .upcoming-exam-item:hover { box-shadow: theme('boxShadow.widget-hover-dark'); background-color: theme('colors.slate.800'); }
        .list-item { transition: background-color 0.15s ease-out, transform 0.2s var(--ease-smooth), box-shadow 0.2s var(--ease-smooth); }
        .list-item:hover { background-color: #f1f5f9; transform: scale(1.01); box-shadow: 0 3px 6px rgba(0,0,0,0.06); }
        .dark .list-item:hover { background-color: #334155; box-shadow: 0 3px 6px rgba(0,0,0,0.2); }
        .list-action-btn { color: #94a3b8; transition: color 0.15s ease-out, background-color 0.15s ease-out, transform 0.15s var(--ease-smooth); }
        .list-action-btn:hover { background-color: #eef2ff; transform: scale(1.15); } /* General hover */
        .list-action-btn.delete:hover { color: #ef4444; background-color: #fee2e2; transform: scale(1.15) rotate(5deg); }
        .list-action-btn.edit:hover { color: #4f46e5; background-color: #e0e7ff; transform: scale(1.15) rotate(-5deg); }
        .dark .list-action-btn { color: #64748b; }
        .dark .list-action-btn.delete:hover { color: #f87171; background-color: #450a0a; }
        .dark .list-action-btn.edit:hover { color: #818cf8; background-color: #3730a3; }

        #resource-url-wrapper, #resource-note-wrapper, #edit-resource-url-wrapper, #edit-resource-note-wrapper { display: none; }
        #resource-url-wrapper.visible, #resource-note-wrapper.visible, #edit-resource-url-wrapper.visible, #edit-resource-note-wrapper.visible { display: block; animation: contentFadeInShort 0.35s var(--ease-smooth); }

        .subject-tab[aria-selected="true"] { color: var(--color-primary-DEFAULT); border-color: var(--color-primary-DEFAULT); font-weight: 600; background-color: transparent; }
        .dark .subject-tab[aria-selected="true"] { color: var(--color-primary-dark); border-color: var(--color-primary-dark); background-color: transparent; }
         details > summary { list-style: none; cursor: pointer; transition: background-color 0.2s ease-out; position: relative; padding-right: 2.5rem; }
        details > summary::-webkit-details-marker { display: none; }
        details > summary .summary-chevron { display: block; width: 0.5rem; height: 0.5rem; border-bottom: 2px solid currentColor; border-right: 2px solid currentColor; position: absolute; right: 1rem; top: 50%; transform: translateY(-70%) rotate(45deg); transition: transform 0.3s var(--ease-smooth); pointer-events: none; }
        details[open] > summary .summary-chevron { transform: translateY(-40%) rotate(225deg); }
        details[open] > summary { background-color: #f1f5f9; border-bottom: 1px solid #e2e8f0; border-bottom-left-radius: 0; border-bottom-right-radius: 0; }
        .dark details[open] > summary { background-color: #334155; border-bottom-color: #475569; }
        details > div { display: grid; grid-template-rows: 0fr; opacity: 0; transition: grid-template-rows 0.4s var(--ease-smooth), opacity 0.3s ease-out 0.1s; }
        details[open] > div { grid-template-rows: 1fr; opacity: 1; }
        details > div > div { overflow: hidden; padding: 1rem 1.25rem; border-top: 1px solid theme('colors.slate.200'); background-color: #fdfdff; border-left: 3px solid theme('colors.primary.light'); border-right: 1px solid theme('colors.slate.100'); border-bottom: 1px solid theme('colors.slate.100'); border-bottom-left-radius: theme('borderRadius.lg'); border-bottom-right-radius: theme('borderRadius.lg'); }
        .dark details > div > div { border-top-color: #475569; background-color: #1a2435; border-left-color: theme('colors.primary.dark'); border-right-color: theme('colors.slate.700'); border-bottom-color: theme('colors.slate.700'); }
        #quiz-correct-answer-display { display: none; }
        #quiz-correct-answer-display.visible { display: block; animation: contentFadeInShort 0.3s var(--ease-smooth); }
        .quiz-file-preview { max-width: 80px; max-height: 60px; margin-top: 4px; border-radius: 4px; border: 1px solid #e2e8f0; object-fit: cover; vertical-align: middle; }
        .dark .quiz-file-preview { border-color: #475569; }
        .quiz-mode-image-display { display: block; max-width: 90%; max-height: 400px; height: auto; margin: 1rem auto; border-radius: 0.5rem; border: 1px solid #e2e8f0; object-fit: contain; }
        .dark .quiz-mode-image-display { border-color: #475569; }
        .file-input-button-style { display: inline-block; text-align: left; font-size: theme('fontSize.sm'); color: theme('colors.slate.500'); cursor: pointer; }
        .file-input-button-style > span { margin-right: theme('spacing.2'); padding: theme('spacing')['1.5'] theme('spacing.3'); border-radius: theme('borderRadius.full'); border-width: 0px; font-size: theme('fontSize.xs'); font-weight: theme('fontWeight.semibold'); background-color: theme('colors.primary.100'); color: theme('colors.primary.700'); transition: background-color 0.15s ease-out; }
        .file-input-button-style:hover > span { background-color: theme('colors.primary.200'); }
        .dark .file-input-button-style > span { background-color: theme('colors.primary.900 / 40%'); color: theme('colors.primary.300'); }
        .dark .file-input-button-style:hover > span { background-color: theme('colors.primary.900 / 60%'); }
        #quiz-question-file-wrapper, #quiz-answer-file-wrapper,
        #edit-quiz-question-file-wrapper, #edit-quiz-answer-file-wrapper { margin-bottom: 0.5rem; }
        .current-file-display { font-size: theme('fontSize.xs'); color: theme('colors.muted.DEFAULT'); margin-left: theme('spacing.2'); font-style: italic; }
        .dark .current-file-display { color: theme('colors.muted.dark');}

        .timer-ring { stroke-dasharray: 283; stroke-dashoffset: 283; transition: stroke-dashoffset 1s linear, stroke 0.3s ease-out; }
        .pomodoro-mode-btn.active { background-color: theme('colors.primary.DEFAULT'); color: white; border-color: theme('colors.primary.DEFAULT'); }
        .dark .pomodoro-mode-btn.active { background-color: theme('colors.primary.dark'); border-color: theme('colors.primary.dark'); color: theme('colors.text.dark'); }
        .pomodoro-mode-btn:disabled { opacity: 0.6; cursor: not-allowed; background-color: theme('colors.slate.200'); border-color: theme('colors.slate.300'); color: theme('colors.slate.500'); transform: none !important; filter: none !important; box-shadow: none !important; }
        .dark .pomodoro-mode-btn:disabled { background-color: theme('colors.slate.600'); border-color: theme('colors.slate.500'); color: theme('colors.slate.400'); }
        #pomodoro-subject-times .subject-time-item { border-left: 3px solid; padding-left: 0.75rem; }
        #pomodoro-extra-time-section { border-top: 1px solid theme('colors.slate.200'); dark:border-top-color: theme('colors.slate.700'); margin-top: 2rem; padding-top: 1.5rem; width: 100%; max-width: theme('maxWidth.xs'); text-align: center; }
        #won-time-display { font-size: theme('fontSize.lg'); font-weight: theme('fontWeight.semibold'); color: theme('colors.secondary.DEFAULT'); dark:color: theme('colors.secondary.dark'); letter-spacing: theme('letterSpacing.tight'); margin-bottom: 0.75rem; }
        #bonus-timer-countdown { font-size: theme('fontSize.lg'); font-weight: theme('fontWeight.semibold'); color: theme('colors.secondary.DEFAULT'); dark:color: theme('colors.secondary.dark'); margin-bottom: 1rem; }
       #daily-goal-progress-bar-bg { background-color: theme('colors.slate.200'); border-radius: theme('borderRadius.full'); height: 0.75rem; overflow: hidden; position: relative; }
       .dark #daily-goal-progress-bar-bg { background-color: theme('colors.slate.700'); }
       #daily-goal-progress-bar-fill { background-color: theme('colors.secondary.DEFAULT'); height: 100%; width: 0%; border-radius: theme('borderRadius.full'); transition: width 0.5s var(--ease-smooth); }
       .dark #daily-goal-progress-bar-fill { background-color: theme('colors.secondary.dark'); }
       .daily-goal-input { width: 70px; padding: 0.25rem 0.5rem; text-align: right; }
        #spin-wheel-modal-overlay {
            position: fixed;
            inset: 0;
            z-index: 70;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 1rem;
            background-color: rgba(0, 0, 0, 0.3);
            backdrop-filter: blur(4px);
            transition: opacity 0.3s var(--ease-smooth), transform 0.3s var(--ease-smooth);
            opacity: 0;
            transform: scale(0.95);
            pointer-events: none;
        }
        .dark #spin-wheel-modal-overlay {
             background-color: rgba(0, 0, 0, 0.6);
        }
        #spin-wheel-modal-overlay.visible {
            opacity: 1;
            transform: scale(1);
            pointer-events: auto;
        }
        #spinner-modal-content {
            position: relative;
            background-color: white; /* Explicitly white */
            opacity: 1;
            border-radius: theme('borderRadius.spinner-modal');
            box-shadow: 0 8px 30px var(--spinner-shadow-light);
            padding: 30px 40px;
            width: 100%;
            max-width: 480px;
            text-align: center;
            border: 1px solid var(--spinner-border-color);
            font-family: var(--spinner-font-primary);
        }
        .dark #spinner-modal-content {
            background-color: var(--spinner-container-bg-dark);
            border-color: var(--spinner-border-color-dark);
            color: var(--spinner-text-primary-dark);
        }
        #spinner-modal-content h2 {
            font-weight: 800;
            font-size: 1.8em;
            letter-spacing: -0.5px;
            margin-bottom: 8px;
            color: var(--spinner-text-primary);
        }
        .dark #spinner-modal-content h2 {
             color: var(--spinner-text-primary-dark);
        }
        #spinner-modal-content .modal-subtitle {
             font-size: 1em;
             color: var(--spinner-text-secondary);
             margin-top: 0;
             margin-bottom: 30px;
             max-width: 350px;
             margin-left: auto;
             margin-right: auto;
        }
         .dark #spinner-modal-content .modal-subtitle {
              color: var(--spinner-text-secondary-dark);
         }
        .spinner-viewport {
            width: 100%;
            max-width: 360px;
            height: 75px;
            border: 1px solid var(--spinner-border-color);
            background-color: white;
            overflow: hidden;
            position: relative;
            border-radius: 10px;
            box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.04);
            margin: 20px auto 30px auto;
        }
        .dark .spinner-viewport {
            border-color: var(--spinner-border-color-dark);
            background-color: white;
        }
        .spinner-viewport::before,
        .spinner-viewport::after {
            content: '';
            position: absolute;
            top: 0;
            bottom: 0;
            width: 40px;
            z-index: 2;
            pointer-events: none;
        }
        .spinner-viewport::before {
             left: 0;
             background: linear-gradient(to right, white, transparent);
        }
        .dark .spinner-viewport::before {
             background: linear-gradient(to right, white, transparent);
        }
         .spinner-viewport::after {
             right: 0;
             background: linear-gradient(to left, white, transparent);
        }
        .dark .spinner-viewport::after {
             background: linear-gradient(to left, white, transparent);
        }
        #momentum-spinner {
            display: flex;
            height: 100%;
            position: relative;
            left: 0;
            will-change: transform;
        }
        .momentum-spinner-item {
            min-width: 75px;
            height: 100%;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            font-size: 1.9em;
            font-weight: 700;
            border-right: 1px solid rgba(0, 0, 0, 0.08);
            box-sizing: border-box;
            color: var(--spinner-text-light);
            user-select: none;
            cursor: default;
            opacity: 0.95;
        }
        .momentum-spinner-item span {
            font-size: 0.4em;
            font-weight: 600;
            margin-top: 1px;
            opacity: 0.9;
            text-transform: uppercase;
            letter-spacing: 0.8px;
        }
        .momentum-spinner-item:last-child { border-right: none; }
        .momentum-spinner-item:nth-child(10n + 1) { background-color: var(--spinner-color-1); }
        .momentum-spinner-item:nth-child(10n + 2) { background-color: var(--spinner-color-2); }
        .momentum-spinner-item:nth-child(10n + 3) { background-color: var(--spinner-color-3); }
        .momentum-spinner-item:nth-child(10n + 4) { background-color: var(--spinner-color-4); }
        .momentum-spinner-item:nth-child(10n + 5) { background-color: var(--spinner-color-5); }
        .momentum-spinner-item:nth-child(10n + 6) { background-color: var(--spinner-color-6); }
        .momentum-spinner-item:nth-child(10n + 7) { background-color: var(--spinner-color-7); }
        .momentum-spinner-item:nth-child(10n + 8) { background-color: var(--spinner-color-8); }
        .momentum-spinner-item:nth-child(10n + 9) { background-color: var(--spinner-color-9); }
        .momentum-spinner-item:nth-child(10n + 10) { background-color: var(--spinner-color-10); }
        .spinner-marker {
            position: absolute;
            top: 0;
            left: 50%;
            transform: translateX(-50%);
            width: 3px;
            height: 75px; /* Full height */
            background-color: white; /* Use theme primary */
            border-radius: 0;
            z-index: 10;
            box-shadow: 0 1px 3px rgba(0,0,0,0.2);
        }
        .spinner-marker::after {
             display: none; /* Remove gradient */
        }
         .dark .spinner-marker {
             background-color: var(--color-primary-dark); /* Dark theme primary */
         }
        #modalSpinButton {
            padding: 14px 35px;
            font-size: 1.1em;
            font-weight: 700;
            cursor: pointer;
            background-color: var(--spinner-button-bg);
            color: var(--spinner-text-light);
            border: none;
            border-radius: 10px;
            transition: background-color 0.2s ease, transform 0.15s ease, box-shadow 0.2s ease;
            margin-bottom: 25px;
            box-shadow: 0 4px 12px var(--spinner-shadow-medium);
            letter-spacing: 0.3px;
            will-change: transform, box-shadow;
        }
        #modalSpinButton.ready-to-spin {
            animation: pulseGlow 2s infinite ease-out;
        }
        @keyframes pulseGlow {
            0% { box-shadow: 0 0 0 0px var(--spinner-focus-glow), 0 4px 12px var(--spinner-shadow-medium); }
            70% { box-shadow: 0 0 0 8px rgba(79, 70, 229, 0), 0 6px 16px var(--spinner-shadow-medium); }
            100% { box-shadow: 0 0 0 0px rgba(79, 70, 229, 0), 0 4px 12px var(--spinner-shadow-medium); }
        }
        #modalSpinButton:hover:not(:disabled) {
            background-color: var(--spinner-button-bg-hover);
            box-shadow: 0 6px 16px var(--spinner-shadow-medium);
            transform: translateY(-2px);
        }
        #modalSpinButton:active:not(:disabled) {
             transform: translateY(1px) scale(0.98);
             box-shadow: 0 2px 8px var(--spinner-shadow-medium);
        }
        #modalSpinButton:disabled {
            background-color: #ced4da;
            cursor: not-allowed;
            opacity: 0.7;
            box-shadow: none;
            transform: translateY(0);
        }
        .dark #modalSpinButton:disabled {
             background-color: theme('colors.slate.600');
             opacity: 0.6;
        }
        #momentum-result-display {
            margin-top: 5px;
            font-size: 1.1em;
            font-weight: 600;
            color: var(--spinner-text-secondary);
            min-height: 1.6em;
            text-align: center;
            opacity: 0;
            transform: translateY(15px);
        }
        .dark #momentum-result-display {
            color: var(--spinner-text-secondary-dark);
        }
        #momentum-result-display.show {
            animation: resultReveal 0.5s cubic-bezier(0.25, 0.46, 0.45, 0.94) forwards;
            animation-delay: 0.1s;
        }
         @keyframes resultReveal {
             0% { transform: translateY(15px) scale(0.9); opacity: 0; }
             100% { transform: translateY(0) scale(1); opacity: 1; }
         }
        #momentum-result-value {
            font-weight: 800;
            font-size: 2.8em;
            color: var(--spinner-text-primary);
            line-height: 1;
            margin: 0 6px;
            vertical-align: -4px;
            display: inline-block;
            transform: scale(1);
            transition: transform 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
         .dark #momentum-result-value {
             color: var(--spinner-text-primary-dark);
         }
        #momentum-result-value.updated {
            transform: scale(1.1);
        }
        #close-spinner-modal-button {
             position: absolute;
             top: 12px;
             right: 12px;
             padding: 6px;
             border-radius: 9999px;
             color: var(--color-muted-DEFAULT);
             background-color: transparent;
             border: none;
             cursor: pointer;
             transition: background-color 0.15s ease-out, color 0.15s ease-out;
             display: none;
        }
        .dark #close-spinner-modal-button {
            color: var(--color-muted-dark);
        }
        #close-spinner-modal-button:hover {
            background-color: theme('colors.slate.100');
            color: var(--color-text-DEFAULT);
        }
        .dark #close-spinner-modal-button:hover {
            background-color: theme('colors.slate.700');
            color: var(--color-text-dark);
        }
        #close-spinner-modal-button:focus-visible {
            outline: 2px solid var(--color-primary-DEFAULT);
            outline-offset: 1px;
        }
        .dark #close-spinner-modal-button:focus-visible {
             outline-color: var(--color-primary-dark);
        }
        #close-spinner-modal-button i {
            width: 20px;
            height: 20px;
            display: block;
        }
        #study-time-chart-container { height: 250px; position: relative; margin-top: 1rem; margin-bottom: 1rem; }
        .simple-modal-overlay { transition: opacity 0.25s var(--ease-smooth); }
        .simple-modal-content { transition: transform 0.3s var(--ease-smooth), opacity 0.25s ease-out; }
        .simple-modal-overlay.hidden { opacity: 0; pointer-events: none; }
        .simple-modal-overlay.hidden .simple-modal-content { transform: scale(0.9); opacity: 0; }
    </style>
</head>
<body class="flex flex-col min-h-screen bg-background text-text font-sans transition-colors duration-300 dark:bg-background-dark">
    <div id="login-overlay" class="fixed inset-0 bg-background dark:bg-background-dark flex items-center justify-center p-4 transition-opacity duration-300 z-[100]">
        <div class="bg-card text-text rounded-xl shadow-widget p-6 md:p-8 dark:bg-card-dark dark:text-text-dark dark:shadow-widget-dark transition-all duration-300 max-w-sm w-full">
            <h2 class="text-2xl font-semibold mb-4 text-center text-primary dark:text-primary-dark">Revision Hub Login</h2>
            <p class="text-muted dark:text-muted-dark text-sm mb-1 text-center">Welcome back, Giorgi!</p>
            <p class="text-xs text-muted dark:text-muted-dark mb-6 text-center">(Use your Firebase credentials)</p>
            <div class="mb-4">
                <label for="email-input" class="block text-sm font-medium text-muted dark:text-muted-dark mb-1">Email</label>
                <input type="email" id="email-input" placeholder="your.email@example.com" class="w-full p-2 border rounded-lg bg-background dark:bg-slate-700 border-slate-300 dark:border-slate-600 focus:ring-primary focus:border-primary transition duration-150 ease-in-out">
            </div>
            <div class="mb-6">
                <label for="password-input" class="block text-sm font-medium text-muted dark:text-muted-dark mb-1">Password</label>
                <input type="password" id="password-input" placeholder="••••••••" class="w-full p-2 border rounded-lg bg-background dark:bg-slate-700 border-slate-300 dark:border-slate-600 focus:ring-primary focus:border-primary transition duration-150 ease-in-out">
            </div>
            <button id="login-button" class="w-full bg-primary hover:bg-primary/90 dark:bg-primary-dark dark:hover:bg-primary-dark/90 text-white font-semibold py-2.5 px-4 rounded-lg btn-animated shadow-sm focus-visible:ring-2 focus-visible:ring-offset-2 focus-visible:ring-primary">Login</button>
            <p id="login-error" class="text-red-500 text-sm mt-3 text-center min-h-[1rem]"></p>
        </div>
    </div>

    <div id="app-wrapper" class="hidden flex flex-col min-h-screen">
        <header class="sticky top-0 z-50 bg-card dark:bg-card-dark shadow-md dark:shadow-slate-700/50 transition-colors duration-300">
             <nav class="container mx-auto px-4 py-3 flex justify-between items-center">
                 <a href="#" data-page="dashboard" class="nav-link text-xl md:text-2xl font-bold text-primary dark:text-primary-dark flex items-center space-x-2 btn-animated rounded-md p-1 -m-1 focus-visible:outline focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-primary"> <i data-lucide="graduation-cap" class="h-6 w-6"></i> <span>Giorgi's Hub</span> </a>
                <div class="hidden md:flex items-center space-x-1 lg:space-x-2">
                    <a href="#" data-page="dashboard" class="nav-link px-3 py-1.5 rounded-md text-muted dark:text-muted-dark hover:text-primary dark:hover:text-primary-dark hover:bg-slate-100 dark:hover:bg-slate-700 font-medium text-sm focus-visible:ring-2 focus-visible:ring-primary">Dashboard</a>
                     <a href="#" data-page="timetable" class="nav-link px-3 py-1.5 rounded-md text-muted dark:text-muted-dark hover:text-primary dark:hover:text-primary-dark hover:bg-slate-100 dark:hover:bg-slate-700 font-medium text-sm focus-visible:ring-2 focus-visible:ring-primary">Timetable</a>
                     <a href="#" data-page="resources" class="nav-link px-3 py-1.5 rounded-md text-muted dark:text-muted-dark hover:text-primary dark:hover:text-primary-dark hover:bg-slate-100 dark:hover:bg-slate-700 font-medium text-sm focus-visible:ring-2 focus-visible:ring-primary">Resources</a>
                     <a href="#" data-page="pomodoro" class="nav-link px-3 py-1.5 rounded-md text-muted dark:text-muted-dark hover:text-primary dark:hover:text-primary-dark hover:bg-slate-100 dark:hover:bg-slate-700 font-medium text-sm focus-visible:ring-2 focus-visible:ring-primary">Pomodoro</a>
                     <a href="#" data-page="tracker" class="nav-link px-3 py-1.5 rounded-md text-muted dark:text-muted-dark hover:text-primary dark:hover:text-primary-dark hover:bg-slate-100 dark:hover:bg-slate-700 font-medium text-sm focus-visible:ring-2 focus-visible:ring-primary">Tracker</a>
                     <a href="#" data-page="planner" class="nav-link px-3 py-1.5 rounded-md text-muted dark:text-muted-dark hover:text-primary dark:hover:text-primary-dark hover:bg-slate-100 dark:hover:bg-slate-700 font-medium text-sm focus-visible:ring-2 focus-visible:ring-primary">Planner</a>
                     <a href="#" data-page="quiz" class="nav-link px-3 py-1.5 rounded-md text-muted dark:text-muted-dark hover:text-primary dark:hover:text-primary-dark hover:bg-slate-100 dark:hover:bg-slate-700 font-medium text-sm focus-visible:ring-2 focus-visible:ring-primary">Quiz</a>
                    <button id="theme-toggle" title="Toggle Theme" class="p-2 rounded-full text-muted dark:text-muted-dark hover:bg-slate-100 dark:hover:bg-slate-700 focus:outline-none focus-visible:ring-2 focus-visible:ring-offset-2 focus-visible:ring-primary dark:focus-visible:ring-offset-slate-800 btn-animated"> <i data-lucide="sun" id="theme-icon-light" class="h-5 w-5"></i> <i data-lucide="moon" id="theme-icon-dark" class="h-5 w-5 hidden"></i> </button>
                    <button id="logout-button" title="Logout" class="p-2 rounded-full text-muted dark:text-muted-dark hover:bg-red-100 dark:hover:bg-red-900/50 hover:text-red-600 dark:hover:text-red-400 focus:outline-none focus-visible:ring-2 focus-visible:ring-offset-2 focus-visible:ring-red-500 dark:focus-visible:ring-offset-slate-800 btn-animated"> <i data-lucide="log-out" class="h-5 w-5"></i> </button>
                </div>
                <div class="md:hidden flex items-center">
                     <button id="theme-toggle-mobile" title="Toggle Theme" class="p-2 mr-2 rounded-full text-muted dark:text-muted-dark hover:bg-slate-100 dark:hover:bg-slate-700 focus:outline-none focus-visible:ring-2 focus-visible:ring-offset-2 focus-visible:ring-primary dark:focus-visible:ring-offset-slate-800 btn-animated"> <i data-lucide="sun" id="theme-icon-light-mobile" class="h-5 w-5"></i> <i data-lucide="moon" id="theme-icon-dark-mobile" class="h-5 w-5 hidden"></i> </button>
                    <button id="mobile-menu-button" title="Open Menu" class="p-2 rounded-md text-muted dark:text-muted-dark hover:text-primary dark:hover:text-primary-dark hover:bg-slate-100 dark:hover:bg-slate-700 focus:outline-none focus-visible:ring-2 focus-visible:ring-inset focus-visible:ring-primary btn-animated"> <span class="sr-only">Open main menu</span> <i data-lucide="menu" class="h-6 w-6"></i> </button>
                </div>
            </nav>
            <div id="mobile-overlay" class="fixed inset-0 bg-black/60 dark:bg-black/80 z-[55] hidden md:hidden"></div>
             <div id="mobile-menu" class="md:hidden fixed inset-y-0 left-0 w-64 bg-card dark:bg-card-dark shadow-xl z-[60] p-4 border-r border-slate-200 dark:border-slate-700"> <div class="flex justify-between items-center mb-6"> <a href="#" data-page="dashboard" class="nav-link text-lg font-bold text-primary dark:text-primary-dark flex items-center space-x-2 focus-visible:outline focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-primary rounded"> <i data-lucide="graduation-cap" class="h-5 w-5"></i> <span>Giorgi's Hub</span> </a> <button id="mobile-close-button" title="Close Menu" class="p-1 rounded-md text-muted dark:text-muted-dark hover:text-primary dark:hover:text-primary-dark hover:bg-slate-100 dark:hover:bg-slate-700 btn-animated focus-visible:ring-2 focus-visible:ring-primary"> <i data-lucide="x" class="h-5 w-5"></i> </button> </div> <nav class="flex flex-col space-y-1"> <a href="#" data-page="dashboard" class="mobile-nav-link block px-3 py-2 rounded-md text-base font-medium text-muted dark:text-muted-dark hover:bg-slate-100 dark:hover:bg-slate-700 hover:text-primary dark:hover:text-primary-dark focus-visible:ring-2 focus-visible:ring-primary">Dashboard</a> <a href="#" data-page="timetable" class="mobile-nav-link block px-3 py-2 rounded-md text-base font-medium text-muted dark:text-muted-dark hover:bg-slate-100 dark:hover:bg-slate-700 hover:text-primary dark:hover:text-primary-dark focus-visible:ring-2 focus-visible:ring-primary">Timetable</a> <a href="#" data-page="resources" class="mobile-nav-link block px-3 py-2 rounded-md text-base font-medium text-muted dark:text-muted-dark hover:bg-slate-100 dark:hover:bg-slate-700 hover:text-primary dark:hover:text-primary-dark focus-visible:ring-2 focus-visible:ring-primary">Resources</a> <a href="#" data-page="pomodoro" class="mobile-nav-link block px-3 py-2 rounded-md text-base font-medium text-muted dark:text-muted-dark hover:bg-slate-100 dark:hover:bg-slate-700 hover:text-primary dark:hover:text-primary-dark focus-visible:ring-2 focus-visible:ring-primary">Pomodoro</a> <a href="#" data-page="tracker" class="mobile-nav-link block px-3 py-2 rounded-md text-base font-medium text-muted dark:text-muted-dark hover:bg-slate-100 dark:hover:bg-slate-700 hover:text-primary dark:hover:text-primary-dark focus-visible:ring-2 focus-visible:ring-primary">Tracker</a> <a href="#" data-page="planner" class="mobile-nav-link block px-3 py-2 rounded-md text-base font-medium text-muted dark:text-muted-dark hover:bg-slate-100 dark:hover:bg-slate-700 hover:text-primary dark:hover:text-primary-dark focus-visible:ring-2 focus-visible:ring-primary">Planner</a> <a href="#" data-page="quiz" class="mobile-nav-link block px-3 py-2 rounded-md text-base font-medium text-muted dark:text-muted-dark hover:bg-slate-100 dark:hover:bg-slate-700 hover:text-primary dark:hover:text-primary-dark focus-visible:ring-2 focus-visible:ring-primary">Quiz</a> <hr class="my-3 border-slate-200 dark:border-slate-700"> <button id="logout-button-mobile" class="w-full text-left block px-3 py-2 rounded-md text-base font-medium text-red-600 dark:text-red-400 hover:bg-red-100 dark:hover:bg-red-900/50 btn-animated flex items-center space-x-2 focus-visible:ring-2 focus-visible:ring-red-500"> <i data-lucide="log-out" class="h-4 w-4"></i> <span>Logout</span> </button> </nav> </div>
        </header>

        <main class="flex-grow container mx-auto py-6 bg-background dark:bg-background-dark transition-colors duration-300">
            <section id="dashboard" class="page active">
                 <h1 class="text-2xl md:text-3xl font-bold mb-1 text-text dark:text-text-dark">Welcome, Giorgi!</h1>
                 <p class="text-muted dark:text-muted-dark mb-6 text-sm">Candidate Number: 7590</p>
                 <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                    <div class="dashboard-card bg-card text-text rounded-xl shadow-widget p-4 md:p-6 dark:bg-card-dark dark:text-text-dark dark:shadow-widget-dark md:col-span-2 lg:col-span-2">
                        <h2 class="text-xl font-semibold mb-4 flex items-center space-x-2"><i data-lucide="bar-chart-3" class="h-5 w-5 text-cyan-500"></i> <span>Study Insights</span></h2>
                        <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 mb-6">
                            <div class="text-center p-3 bg-slate-50 dark:bg-slate-800/50 rounded-lg"><div class="text-xs text-muted dark:text-muted-dark uppercase tracking-wider mb-1">Total Study Time</div><div id="analytics-total-time" class="text-2xl font-bold text-primary dark:text-primary-dark">--:--</div></div>
                            <div class="text-center p-3 bg-slate-50 dark:bg-slate-800/50 rounded-lg"><div class="text-xs text-muted dark:text-muted-dark uppercase tracking-wider mb-1">Total Sessions</div><div id="analytics-total-sessions" class="text-2xl font-bold text-secondary dark:text-secondary-dark">0</div></div>
                        </div>
                        <h3 class="text-base font-medium mb-2 text-muted dark:text-muted-dark">Time per Subject (Top 7)</h3><div id="study-time-chart-container" class="min-h-[200px] mb-6"><canvas id="study-time-chart"></canvas><div id="chart-loading-message" class="absolute inset-0 flex items-center justify-center text-muted dark:text-muted-dark italic">Loading chart...</div></div><hr class="border-slate-200 dark:border-slate-700 my-4"><h3 class="text-base font-medium mb-2 text-muted dark:text-muted-dark">Recent Sessions (Last 5)</h3><div id="pomodoro-summary" class="space-y-2 text-sm min-h-[60px] max-h-32 overflow-y-auto pr-2"></div><button id="start-pomodoro-dashboard-btn" class="mt-5 w-full bg-secondary hover:bg-secondary/90 dark:bg-secondary-dark dark:hover:bg-secondary-dark/90 text-white font-semibold py-2 px-4 rounded-lg flex items-center justify-center space-x-2 btn-animated shadow-sm focus-visible:ring-2 focus-visible:ring-offset-2 focus-visible:ring-secondary"> <i data-lucide="play-circle" class="h-5 w-5"></i> <span>Start Pomodoro</span> </button>
                    </div>
                    <div class="dashboard-card bg-card text-text rounded-xl shadow-widget p-4 md:p-6 dark:bg-card-dark dark:text-text-dark dark:shadow-widget-dark lg:col-span-1"><h2 class="text-xl font-semibold mb-4 flex items-center space-x-2"> <i data-lucide="calendar-clock" class="h-5 w-5 text-primary dark:text-primary-dark"></i> <span>Upcoming Exams</span> </h2><div id="upcoming-exams-list" class="space-y-3 text-sm min-h-[150px]"></div></div>
                    <div class="dashboard-card bg-card text-text rounded-xl shadow-widget p-4 md:p-6 dark:bg-card-dark dark:text-text-dark dark:shadow-widget-dark"><h2 class="text-xl font-semibold mb-4 flex items-center space-x-2"> <i data-lucide="target" class="h-5 w-5 text-secondary dark:text-secondary-dark"></i> <span>Today's Revision Goal</span> </h2><div id="daily-goal-display" class="min-h-[60px]"><div class="flex justify-between items-baseline mb-2 text-sm"><span class="text-muted dark:text-muted-dark">Goal:</span><span id="daily-goal-target" class="font-semibold text-text dark:text-text-dark">Loading...</span></div><div class="flex justify-between items-baseline mb-2 text-sm"><span class="text-muted dark:text-muted-dark">Completed:</span><span id="daily-goal-completed" class="font-semibold text-text dark:text-text-dark">Loading...</span></div><div id="daily-goal-progress-bar-bg" class="w-full mb-1"><div id="daily-goal-progress-bar-fill"></div></div><p id="daily-goal-percentage" class="text-xs text-right text-muted dark:text-muted-dark font-medium">0%</p></div><details id="set-goals-details" class="mt-4 text-sm border border-slate-200 dark:border-slate-700 rounded-lg overflow-hidden"><summary class="p-2 font-medium text-primary dark:text-primary-dark hover:bg-slate-100 dark:hover:bg-slate-700/50 flex items-center justify-between focus-visible:ring-1 focus-visible:ring-primary cursor-pointer"><span>Set Weekly Goals (mins)</span><span class="summary-chevron"></span></summary><div> <div class="p-3 space-y-3"><p class="text-xs text-muted dark:text-muted-dark mb-2">Enter goal time per day (e.g., 90 for 1h 30m).</p><div class="grid grid-cols-2 gap-x-4 gap-y-2 items-center"><label for="goal-monday" class="text-muted dark:text-muted-dark">Monday:</label><input type="number" id="goal-monday" min="0" step="15" placeholder="mins" class="daily-goal-input border border-slate-300 dark:border-slate-600 rounded bg-background dark:bg-slate-700 focus:ring-primary focus:border-primary"><label for="goal-tuesday" class="text-muted dark:text-muted-dark">Tuesday:</label><input type="number" id="goal-tuesday" min="0" step="15" placeholder="mins" class="daily-goal-input border border-slate-300 dark:border-slate-600 rounded bg-background dark:bg-slate-700 focus:ring-primary focus:border-primary"><label for="goal-wednesday" class="text-muted dark:text-muted-dark">Wednesday:</label><input type="number" id="goal-wednesday" min="0" step="15" placeholder="mins" class="daily-goal-input border border-slate-300 dark:border-slate-600 rounded bg-background dark:bg-slate-700 focus:ring-primary focus:border-primary"><label for="goal-thursday" class="text-muted dark:text-muted-dark">Thursday:</label><input type="number" id="goal-thursday" min="0" step="15" placeholder="mins" class="daily-goal-input border border-slate-300 dark:border-slate-600 rounded bg-background dark:bg-slate-700 focus:ring-primary focus:border-primary"><label for="goal-friday" class="text-muted dark:text-muted-dark">Friday:</label><input type="number" id="goal-friday" min="0" step="15" placeholder="mins" class="daily-goal-input border border-slate-300 dark:border-slate-600 rounded bg-background dark:bg-slate-700 focus:ring-primary focus:border-primary"><label for="goal-saturday" class="text-muted dark:text-muted-dark">Saturday:</label><input type="number" id="goal-saturday" min="0" step="15" placeholder="mins" class="daily-goal-input border border-slate-300 dark:border-slate-600 rounded bg-background dark:bg-slate-700 focus:ring-primary focus:border-primary"><label for="goal-sunday" class="text-muted dark:text-muted-dark">Sunday:</label><input type="number" id="goal-sunday" min="0" step="15" placeholder="mins" class="daily-goal-input border border-slate-300 dark:border-slate-600 rounded bg-background dark:bg-slate-700 focus:ring-primary focus:border-primary"></div><button id="save-daily-goals-btn" class="w-full mt-2 bg-primary hover:bg-primary/90 dark:bg-primary-dark dark:hover:bg-primary-dark/90 text-white font-semibold text-xs py-1.5 px-3 rounded-md btn-animated shadow-sm focus-visible:ring-2 focus-visible:ring-offset-2 focus-visible:ring-primary">Save Goals</button><p id="save-goals-message" class="text-xs text-center h-4 mt-1"></p></div></div></details></div>
                    <div class="dashboard-card bg-card text-text rounded-xl shadow-widget p-4 md:p-6 dark:bg-card-dark dark:text-text-dark dark:shadow-widget-dark"><h2 class="text-xl font-semibold mb-4 flex items-center space-x-2"><i data-lucide="plus-circle" class="h-5 w-5 text-green-500"></i><span>Quick Add</span></h2><p class="text-sm text-muted dark:text-muted-dark mb-4">Quickly add items to your sections.</p><div class="space-y-3"><button id="quick-add-resource" class="w-full text-sm bg-blue-100 dark:bg-blue-900/50 hover:bg-blue-200 dark:hover:bg-blue-800/70 text-blue-700 dark:text-blue-300 font-medium py-2 px-4 rounded-lg btn-animated flex items-center justify-center space-x-1.5"><i data-lucide="link"></i> <span>Add Resource</span></button><button id="quick-add-tracker" class="w-full text-sm bg-yellow-100 dark:bg-yellow-900/50 hover:bg-yellow-200 dark:hover:bg-yellow-800/70 text-yellow-700 dark:text-yellow-300 font-medium py-2 px-4 rounded-lg btn-animated flex items-center justify-center space-x-1.5"><i data-lucide="list-checks"></i> <span>Add Tracker Item</span></button><button id="quick-add-planner" class="w-full text-sm bg-purple-100 dark:bg-purple-900/50 hover:bg-purple-200 dark:hover:bg-purple-800/70 text-purple-700 dark:text-purple-300 font-medium py-2 px-4 rounded-lg btn-animated flex items-center justify-center space-x-1.5"><i data-lucide="calendar-plus"></i> <span>Schedule Session</span></button></div></div>
                    <div class="dashboard-card bg-card text-text rounded-xl shadow-widget p-4 md:p-6 dark:bg-card-dark dark:text-text-dark dark:shadow-widget-dark"><h2 class="text-xl font-semibold mb-4 flex items-center space-x-2"> <i data-lucide="quote" class="h-5 w-5 text-purple-500"></i> <span>Daily Motivation</span> </h2><blockquote id="motivational-quote" class="text-muted dark:text-muted-dark italic border-l-4 border-purple-300 dark:border-purple-600 pl-4 py-1 min-h-[40px]"> Loading quote... </blockquote></div>
                    <div class="bg-card text-text rounded-xl shadow-widget p-4 md:p-6 dark:bg-card-dark dark:text-text-dark dark:shadow-widget-dark md:col-span-2 lg:col-span-3"><h2 class="text-xl font-semibold mb-4 flex items-center space-x-2"> <i data-lucide="key-round" class="h-5 w-5 text-gray-500"></i> <span>Account Settings</span> </h2><div id="change-password-form"><p class="text-sm text-muted dark:text-muted-dark mb-3">Change your login password.</p><div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4 items-end"><div> <label for="current-password" class="block text-xs font-medium text-muted dark:text-muted-dark mb-1">Current Password:</label> <input type="password" id="current-password" class="w-full p-2 border border-slate-300 dark:border-slate-600 rounded-lg text-sm bg-background dark:bg-slate-700 focus:ring-primary focus:border-primary"> </div><div> <label for="new-password" class="block text-xs font-medium text-muted dark:text-muted-dark mb-1">New Password:</label> <input type="password" id="new-password" class="w-full p-2 border border-slate-300 dark:border-slate-600 rounded-lg text-sm bg-background dark:bg-slate-700 focus:ring-primary focus:border-primary"> </div><button id="change-password-button" class="bg-slate-500 hover:bg-slate-600 dark:bg-slate-600 dark:hover:bg-slate-500 text-white font-semibold py-2 px-4 rounded-lg h-10 btn-animated shadow-sm self-end w-full sm:w-auto focus-visible:ring-2 focus-visible:ring-offset-2 focus-visible:ring-slate-500">Change Password</button></div><p id="change-password-message" class="text-sm mt-2 min-h-[1rem]"></p></div></div>
                </div>
            </section>

            <section id="timetable" class="page">
                <h1 class="text-2xl md:text-3xl font-bold mb-6 text-text dark:text-text-dark">Exam Timetable</h1>
                <div class="bg-card text-text rounded-xl shadow-widget dark:bg-card-dark dark:text-text-dark dark:shadow-widget-dark transition-all duration-300 overflow-x-auto"><table class="min-w-full divide-y divide-slate-200 dark:divide-slate-700"><thead class="bg-slate-50 dark:bg-slate-700/50"><tr><th scope="col" class="pl-4 pr-3 py-3.5 text-left text-xs font-semibold text-muted dark:text-muted-dark uppercase tracking-wider">Subject & Paper</th><th scope="col" class="px-3 py-3.5 text-left text-xs font-semibold text-muted dark:text-muted-dark uppercase tracking-wider">Date & Time</th><th scope="col" class="px-3 py-3.5 text-left text-xs font-semibold text-muted dark:text-muted-dark uppercase tracking-wider">Duration</th><th scope="col" class="px-3 py-3.5 text-left text-xs font-semibold text-muted dark:text-muted-dark uppercase tracking-wider">Board/Tier</th><th scope="col" class="px-3 py-3.5 text-left text-xs font-semibold text-muted dark:text-muted-dark uppercase tracking-wider">Location & Seat</th><th scope="col" class="pl-3 pr-4 py-3.5 text-left text-xs font-semibold text-muted dark:text-muted-dark uppercase tracking-wider">Countdown</th></tr></thead><tbody id="timetable-body" class="divide-y divide-slate-200 dark:divide-slate-700"></tbody></table></div>
            </section>

            <section id="resources" class="page">
                 <h1 class="text-2xl md:text-3xl font-bold mb-6 text-text dark:text-text-dark">Revision Resources</h1><div class="bg-card text-text rounded-xl shadow-widget p-4 md:p-6 dark:bg-card-dark dark:text-text-dark dark:shadow-widget-dark transition-all duration-300"><h2 class="text-xl font-semibold mb-4">Manage Your Resources</h2><p class="text-muted dark:text-muted-dark mb-5">Select a subject to view, add, or manage links and notes.</p><div class="mb-5 border-b border-slate-200 dark:border-slate-700"><nav id="subject-tabs" class="flex space-x-4 overflow-x-auto pb-px" aria-label="Tabs"></nav></div><details id="add-resource-details" class="mb-6 border border-slate-200 dark:border-slate-700 rounded-lg overflow-hidden bg-slate-50 dark:bg-slate-800/50" style="display: none;"><summary class="p-3 font-medium text-primary dark:text-primary-dark hover:bg-slate-100 dark:hover:bg-slate-700/50 flex items-center justify-between focus-visible:ring-1 focus-visible:ring-primary cursor-pointer"> <span>Add New Resource</span> <span class="summary-chevron"></span> </summary><div> <div id="add-resource-form" class="grid grid-cols-1 md:grid-cols-3 gap-4 p-4"><div> <label for="resource-type" class="block text-sm font-medium text-muted dark:text-muted-dark mb-1">Type:</label> <select id="resource-type" class="w-full p-2 border border-slate-300 dark:border-slate-600 rounded-lg bg-background dark:bg-slate-700 focus:ring-primary focus:border-primary"> <option value="link">Link</option> <option value="note">Note</option> </select> </div><div class="md:col-span-2"> <label for="resource-title" class="block text-sm font-medium text-muted dark:text-muted-dark mb-1">Title:</label> <input type="text" id="resource-title" placeholder="e.g., Algebra Video" class="w-full p-2 border border-slate-300 dark:border-slate-600 rounded-lg bg-background dark:bg-slate-700 focus:ring-primary focus:border-primary"> </div><div id="resource-url-wrapper" class="md:col-span-3"> <label for="resource-url" class="block text-sm font-medium text-muted dark:text-muted-dark mb-1">URL:</label> <input type="url" id="resource-url" placeholder="https://example.com" class="w-full p-2 border border-slate-300 dark:border-slate-600 rounded-lg bg-background dark:bg-slate-700 focus:ring-primary focus:border-primary"> </div><div id="resource-note-wrapper" class="md:col-span-3"> <label for="resource-note" class="block text-sm font-medium text-muted dark:text-muted-dark mb-1">Note:</label> <textarea id="resource-note" placeholder="Enter notes..." rows="5" class="w-full p-2 border border-slate-300 dark:border-slate-600 rounded-lg bg-background dark:bg-slate-700 focus:ring-primary focus:border-primary"></textarea> </div><div class="md:col-span-3"> <button id="save-resource-btn" class="mt-2 bg-primary hover:bg-primary/90 dark:bg-primary-dark dark:hover:bg-primary-dark/90 text-white font-semibold py-2 px-5 rounded-lg btn-animated shadow-sm disabled:opacity-50 focus-visible:ring-2 focus-visible:ring-offset-2 focus-visible:ring-primary">Add Resource</button> </div></div></div></details><div id="resource-content" class="mt-4 min-h-[150px]"></div></div>
            </section>

            <section id="pomodoro" class="page">
                 <h1 class="text-2xl md:text-3xl font-bold mb-6 text-text dark:text-text-dark">Pomodoro Timer</h1><div class="bg-card text-text rounded-xl shadow-widget p-5 md:p-8 dark:bg-card-dark dark:text-text-dark dark:shadow-widget-dark transition-all duration-300 max-w-lg mx-auto flex flex-col items-center"><h2 id="pomodoro-mode-title" class="text-2xl font-semibold mb-5 text-center">Focus Session</h2><div id="pomodoro-subject-wrapper" class="mb-6 w-full max-w-xs mx-auto" style="display: block;"> <label for="pomodoro-subject" class="block text-sm font-medium text-muted dark:text-muted-dark mb-1 text-center">Subject (for Focus Session)</label> <select id="pomodoro-subject" class="w-full p-2 border border-slate-300 dark:border-slate-600 rounded-lg bg-background dark:bg-slate-700 focus:ring-primary focus:border-primary text-sm"> <option value="">-- Select Subject --</option> </select> </div><div class="flex justify-center space-x-3 mb-8"> <button id="work-mode-button" class="pomodoro-mode-btn text-sm font-medium py-1.5 px-4 rounded-full border border-slate-300 dark:border-slate-600 text-muted dark:text-muted-dark hover:bg-slate-100 dark:hover:bg-slate-700 btn-animated flex items-center space-x-1.5 active focus-visible:ring-2 focus-visible:ring-primary" data-mode="work"> <i data-lucide="briefcase" class="h-4 w-4"></i> <span>Work</span> </button> <button id="short-break-mode-button" class="pomodoro-mode-btn text-sm font-medium py-1.5 px-4 rounded-full border border-slate-300 dark:border-slate-600 text-muted dark:text-muted-dark hover:bg-slate-100 dark:hover:bg-slate-700 btn-animated flex items-center space-x-1.5 focus-visible:ring-2 focus-visible:ring-primary" data-mode="shortBreak"> <i data-lucide="coffee" class="h-4 w-4"></i> <span>Short Break</span> </button> <button id="long-break-mode-button" class="pomodoro-mode-btn text-sm font-medium py-1.5 px-4 rounded-full border border-slate-300 dark:border-slate-600 text-muted dark:text-muted-dark hover:bg-slate-100 dark:hover:bg-slate-700 btn-animated flex items-center space-x-1.5 focus-visible:ring-2 focus-visible:ring-primary" data-mode="longBreak"> <i data-lucide="bed" class="h-4 w-4"></i> <span>Long Break</span> </button> </div><div id="main-pomodoro-timer-area" class="relative w-52 h-52 mx-auto mb-8 transition-opacity duration-300"> <svg class="w-full h-full" viewBox="0 0 100 100"> <circle class="text-slate-200 dark:text-slate-700" stroke-width="8" stroke="currentColor" fill="transparent" r="45" cx="50" cy="50"/> <circle id="timer-progress-ring" class="text-primary dark:text-primary-dark timer-ring" stroke-width="8" stroke-linecap="round" stroke="currentColor" fill="transparent" r="45" cx="50" cy="50" transform="rotate(-90 50 50)" /> </svg> <div id="timer-display" class="absolute inset-0 flex flex-col items-center justify-center text-4xl font-bold text-text dark:text-text-dark tracking-tight">00:00</div> <div id="timer-status" class="absolute bottom-0 left-0 right-0 text-center text-xs font-medium uppercase tracking-wider text-muted dark:text-muted-dark -mb-5">Work</div> </div><div id="main-pomodoro-controls" class="flex justify-center space-x-3 transition-opacity duration-300"> <button id="start-pause-button" class="bg-primary hover:bg-primary/90 dark:bg-primary-dark dark:hover:bg-primary-dark/90 text-white font-semibold py-2.5 px-6 rounded-lg btn-animated shadow-sm flex items-center space-x-2 focus-visible:ring-2 focus-visible:ring-offset-2 focus-visible:ring-primary"> <i data-lucide="play" class="h-5 w-5"></i> <span>Start</span> </button> <button id="reset-button" class="bg-slate-500 hover:bg-slate-600 dark:bg-slate-600 dark:hover:bg-slate-500 text-white font-semibold py-2.5 px-6 rounded-lg btn-animated shadow-sm flex items-center space-x-2 focus-visible:ring-2 focus-visible:ring-offset-2 focus-visible:ring-slate-500"> <i data-lucide="rotate-ccw" class="h-5 w-5"></i> <span>Reset</span> </button> </div><details class="mt-8 text-center w-full max-w-xs"> <summary class="cursor-pointer text-sm text-muted dark:text-muted-dark hover:text-primary dark:hover:text-primary-dark font-medium list-none flex items-center justify-center space-x-1 focus-visible:ring-1 focus-visible:ring-primary rounded p-1"> <i data-lucide="settings" class="h-4 w-4"></i> <span>Timer Settings</span> <span class="summary-chevron ml-auto"></span> </summary> <div><div class="space-y-3 text-left pt-4 p-2"> <div> <label for="work-duration" class="block text-xs font-medium text-muted dark:text-muted-dark mb-1">Work Duration (min):</label> <input type="number" id="work-duration" value="25" min="1" max="90" class="w-full p-1.5 border border-slate-300 dark:border-slate-500 rounded-md text-sm bg-white dark:bg-slate-600 focus:ring-primary focus:border-primary"> </div> <div> <label for="short-break-duration" class="block text-xs font-medium text-muted dark:text-muted-dark mb-1">Short Break (min):</label> <input type="number" id="short-break-duration" value="5" min="1" max="30" class="w-full p-1.5 border border-slate-300 dark:border-slate-500 rounded-md text-sm bg-white dark:bg-slate-600 focus:ring-primary focus:border-primary"> </div> <div> <label for="long-break-duration" class="block text-xs font-medium text-muted dark:text-muted-dark mb-1">Long Break (min):</label> <input type="number" id="long-break-duration" value="15" min="5" max="60" class="w-full p-1.5 border border-slate-300 dark:border-slate-500 rounded-md text-sm bg-white dark:bg-slate-600 focus:ring-primary focus:border-primary"> </div> </div></div> </details><div id="pomodoro-subject-times" class="mt-8 w-full max-w-xs border-t border-slate-200 dark:border-slate-700 pt-6 text-sm"><h3 class="text-base font-semibold mb-3 text-center text-muted dark:text-muted-dark">Total Time per Subject</h3><div class="min-h-[50px] space-y-2"></div></div><div id="pomodoro-extra-time-section"><h3 class="text-base font-semibold mb-3 flex items-center justify-center space-x-1.5 text-muted dark:text-muted-dark"><i data-lucide="trophy" class="h-4 w-4 text-yellow-500"></i><span>Extra Break Time Won</span></h3><div id="won-time-container"><div id="won-time-display" class="text-lg font-semibold text-secondary dark:text-secondary-dark mb-3">00:00:00</div><button id="use-won-time-button" class="text-sm bg-secondary hover:bg-secondary/90 dark:bg-secondary-dark dark:hover:bg-secondary-dark/90 text-white font-semibold py-1.5 px-4 rounded-lg btn-animated shadow-sm flex items-center justify-center space-x-1.5 mx-auto focus-visible:ring-2 focus-visible:ring-offset-2 focus-visible:ring-secondary disabled:opacity-50 disabled:cursor-not-allowed"><i data-lucide="hourglass" class="h-4 w-4"></i><span>Use Won Time</span></button></div><div id="bonus-timer-container" class="hidden"><div id="bonus-timer-countdown" class="text-lg font-semibold text-secondary dark:text-secondary-dark mb-4">Bonus Break: 00:00:00</div><p id="bonus-timer-completion-message" class="text-xs text-green-600 dark:text-green-400 min-h-[1rem]"></p></div></div></div>
            </section>

            <section id="tracker" class="page">
                 <h1 class="text-2xl md:text-3xl font-bold mb-6 text-text dark:text-text-dark">Feedback & Improvement Tracker</h1><div class="bg-card text-text rounded-xl shadow-widget p-4 md:p-6 dark:bg-card-dark dark:text-text-dark dark:shadow-widget-dark transition-all duration-300"><h2 class="text-xl font-semibold mb-4">Track Your Progress</h2><p class="text-muted dark:text-muted-dark mb-5">Log feedback, weak areas, and action points.</p><div class="mb-6"><label for="tracker-subject-select" class="block text-sm font-medium text-muted dark:text-muted-dark mb-1">Select Subject:</label><select id="tracker-subject-select" class="w-full md:w-1/2 lg:w-1/3 p-2 border border-slate-300 dark:border-slate-600 rounded-lg bg-background dark:bg-slate-700 focus:ring-primary focus:border-primary"> <option value="">-- Select Subject --</option> </select></div><details id="add-tracker-details" class="mb-6 border border-slate-200 dark:border-slate-700 rounded-lg overflow-hidden bg-slate-50 dark:bg-slate-800/50" style="display: none;"><summary class="p-3 font-medium text-primary dark:text-primary-dark hover:bg-slate-100 dark:hover:bg-slate-700/50 flex items-center justify-between focus-visible:ring-1 focus-visible:ring-primary cursor-pointer"><span>Add New Tracker Item</span> <span class="summary-chevron"></span></summary><div><div id="add-tracker-item-form" class="grid grid-cols-1 md:grid-cols-3 gap-4 p-4"><div class="md:col-span-2"> <label for="tracker-description" class="block text-sm font-medium text-muted dark:text-muted-dark mb-1">Description:</label> <textarea id="tracker-description" placeholder="Describe the feedback or area for improvement..." rows="3" class="w-full p-2 border border-slate-300 dark:border-slate-600 rounded-lg bg-background dark:bg-slate-700 focus:ring-primary focus:border-primary"></textarea> </div><div> <label for="tracker-status-select" class="block text-sm font-medium text-muted dark:text-muted-dark mb-1">Status:</label> <select id="tracker-status-select" class="w-full p-2 border border-slate-300 dark:border-slate-600 rounded-lg bg-background dark:bg-slate-700 focus:ring-primary focus:border-primary"> <option value="To Review">To Review</option> <option value="In Progress">In Progress</option> <option value="Mastered">Mastered</option> </select> </div><div class="md:col-span-3"> <button id="save-tracker-item-btn" class="mt-2 bg-primary hover:bg-primary/90 dark:bg-primary-dark dark:hover:bg-primary-dark/90 text-white font-semibold py-2 px-5 rounded-lg btn-animated shadow-sm disabled:opacity-50 focus-visible:ring-2 focus-visible:ring-offset-2 focus-visible:ring-primary">Add Item</button> </div></div></div></details><h3 class="text-lg font-medium mb-3 text-text dark:text-text-dark">Logged Items</h3><div id="tracker-items-list" class="mt-4 min-h-[150px] space-y-3"></div></div>
            </section>

            <section id="planner" class="page">
                <h1 class="text-2xl md:text-3xl font-bold mb-6 text-text dark:text-text-dark">Revision Planner</h1><div class="bg-card text-text rounded-xl shadow-widget p-4 md:p-6 dark:bg-card-dark dark:text-text-dark dark:shadow-widget-dark transition-all duration-300"><h2 class="text-xl font-semibold mb-4">Schedule Your Study Time</h2><p class="text-muted dark:text-muted-dark mb-5">Plan your revision sessions by date, time, subject, and topic.</p><div id="add-planner-item-form" class="mb-6 pb-6 border-b border-slate-200 dark:border-slate-700"><h3 class="text-lg font-medium mb-4 text-primary dark:text-primary-dark">Add New Session</h3><div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-5 gap-4 items-end"><div class="lg:col-span-1"> <label for="planner-date" class="block text-sm font-medium text-muted dark:text-muted-dark mb-1">Date:</label> <input type="date" id="planner-date" class="w-full p-2 border border-slate-300 dark:border-slate-600 rounded-lg bg-background dark:bg-slate-700 focus:ring-primary focus:border-primary"> </div><div class="lg:col-span-1"> <label for="planner-time" class="block text-sm font-medium text-muted dark:text-muted-dark mb-1">Time:</label> <input type="time" id="planner-time" class="w-full p-2 border border-slate-300 dark:border-slate-600 rounded-lg bg-background dark:bg-slate-700 focus:ring-primary focus:border-primary"> </div><div class="lg:col-span-1"> <label for="planner-subject-select" class="block text-sm font-medium text-muted dark:text-muted-dark mb-1">Subject:</label> <select id="planner-subject-select" class="w-full p-2 border border-slate-300 dark:border-slate-600 rounded-lg bg-background dark:bg-slate-700 focus:ring-primary focus:border-primary"> <option value="">-- Select --</option> </select> </div><div class="sm:col-span-2 lg:col-span-2"> <label for="planner-topic" class="block text-sm font-medium text-muted dark:text-muted-dark mb-1">Topic / Notes:</label> <input type="text" id="planner-topic" placeholder="e.g., Algebra Practice" class="w-full p-2 border border-slate-300 dark:border-slate-600 rounded-lg bg-background dark:bg-slate-700 focus:ring-primary focus:border-primary"> </div><div class="sm:col-span-full lg:col-span-5 flex justify-start"> <button id="save-planner-item-btn" class="mt-2 bg-primary hover:bg-primary/90 dark:bg-primary-dark dark:hover:bg-primary-dark/90 text-white font-semibold py-2 px-5 rounded-lg btn-animated shadow-sm disabled:opacity-50 focus-visible:ring-2 focus-visible:ring-offset-2 focus-visible:ring-primary">Schedule Session</button> </div></div></div><h2 class="text-xl font-semibold mt-6 mb-4 text-text dark:text-text-dark">Scheduled Sessions</h2><div id="planner-items-list" class="mt-4 space-y-5 min-h-[100px]"></div></div>
            </section>

             <section id="quiz" class="page">
                 <h1 class="text-2xl md:text-3xl font-bold mb-6 text-text dark:text-text-dark">Quiz Yourself</h1><div class="bg-card text-text rounded-xl shadow-widget p-4 md:p-6 dark:bg-card-dark dark:text-text-dark dark:shadow-widget-dark transition-all duration-300"><h2 class="text-xl font-semibold mb-4">Practice Questions</h2><p class="text-muted dark:text-muted-dark mb-5">Save challenging questions and test yourself. Get 5 right in a row for a bonus break!</p><div class="mb-6"><label for="quiz-subject-select" class="block text-sm font-medium text-muted dark:text-muted-dark mb-1">Select Subject:</label><select id="quiz-subject-select" class="w-full md:w-1/2 lg:w-1/3 p-2 border border-slate-300 dark:border-slate-600 rounded-lg bg-background dark:bg-slate-700 focus:ring-primary focus:border-primary"> <option value="">-- Select Subject --</option> </select></div><div id="quiz-content-wrapper" class="hidden"><details id="add-quiz-details" class="mb-6 border border-slate-200 dark:border-slate-700 rounded-lg overflow-hidden bg-slate-50 dark:bg-slate-800/50" style="display: none;"><summary class="p-3 font-medium text-primary dark:text-primary-dark hover:bg-slate-100 dark:hover:bg-slate-700/50 flex items-center justify-between focus-visible:ring-1 focus-visible:ring-primary cursor-pointer"><span>Add New Question</span> <span class="summary-chevron"></span></summary><div><div id="add-quiz-question-form" class="space-y-4 p-4"><div> <label for="quiz-question-input" class="block text-sm font-medium text-muted dark:text-muted-dark mb-1">Question:</label> <textarea id="quiz-question-input" placeholder="Enter the question text..." rows="3" class="w-full p-2 border border-slate-300 dark:border-slate-600 rounded-lg bg-background dark:bg-slate-700 focus:ring-primary focus:border-primary"></textarea> </div><div id="quiz-question-file-wrapper"> <label for="quiz-question-file" class="file-input-button-style"><span>Choose Q File</span> (Optional)</label> <input type="file" id="quiz-question-file" accept="image/*,application/pdf,.doc,.docx,.txt" class="sr-only"> <span id="quiz-question-filename" class="text-xs text-muted dark:text-muted-dark ml-2 align-middle"></span> <button type="button" id="clear-quiz-question-file" class="text-xs text-red-500 hover:underline ml-1 align-middle hidden" aria-label="Clear selected question file">&times;</button> </div><div> <label for="quiz-answer-input" class="block text-sm font-medium text-muted dark:text-muted-dark mb-1">Answer / Mark Scheme:</label> <textarea id="quiz-answer-input" placeholder="Enter the correct answer..." rows="4" class="w-full p-2 border border-slate-300 dark:border-slate-600 rounded-lg bg-background dark:bg-slate-700 focus:ring-primary focus:border-primary"></textarea> </div><div id="quiz-answer-file-wrapper"> <label for="quiz-answer-file" class="file-input-button-style"><span>Choose A File</span> (Optional)</label> <input type="file" id="quiz-answer-file" accept="image/*,application/pdf,.doc,.docx,.txt" class="sr-only"> <span id="quiz-answer-filename" class="text-xs text-muted dark:text-muted-dark ml-2 align-middle"></span> <button type="button" id="clear-quiz-answer-file" class="text-xs text-red-500 hover:underline ml-1 align-middle hidden" aria-label="Clear selected answer file">&times;</button></div><div><label for="quiz-paper-select" class="block text-sm font-medium text-muted dark:text-muted-dark mb-1">Paper (Optional):</label><select id="quiz-paper-select" class="w-full md:w-1/2 lg:w-1/3 p-2 border border-slate-300 dark:border-slate-600 rounded-lg bg-background dark:bg-slate-700 focus:ring-primary focus:border-primary text-sm"><option value="General">General</option></select></div><button id="save-quiz-question-btn" class="mt-2 bg-primary hover:bg-primary/90 dark:bg-primary-dark dark:hover:bg-primary-dark/90 text-white font-semibold py-2 px-5 rounded-lg btn-animated shadow-sm disabled:opacity-50 focus-visible:ring-2 focus-visible:ring-offset-2 focus-visible:ring-primary">Add Question</button></div></div></details><div id="quiz-list-container"><h3 class="text-lg font-medium mb-3 text-text dark:text-text-dark">Saved Questions</h3><div id="quiz-items-list" class="mt-4 mb-6 max-h-72 overflow-y-auto space-y-3 pr-2 border border-slate-200 dark:border-slate-700 rounded-lg p-3 bg-slate-50 dark:bg-slate-900/30 min-h-[100px]"></div><button id="start-quiz-button" class="bg-secondary hover:bg-secondary/90 dark:bg-secondary-dark dark:hover:bg-secondary-dark/90 text-white font-semibold py-2.5 px-5 rounded-lg btn-animated shadow-sm disabled:opacity-50 flex items-center space-x-2 focus-visible:ring-2 focus-visible:ring-offset-2 focus-visible:ring-secondary"> <i data-lucide="swords" class="h-5 w-5"></i> <span>Challenge Me!</span> </button></div></div><div id="quiz-mode-interface" class="hidden mt-6 pt-6 border-t border-slate-200 dark:border-slate-700"><div class="flex justify-between items-center mb-3"><h3 class="text-xl font-semibold text-primary dark:text-primary-dark">Quiz Challenge</h3><span id="quiz-progress" class="text-sm font-medium text-muted dark:text-muted-dark">Round 1 | Remaining: 0</span></div><div id="quiz-question-display" class="p-4 border-2 border-dashed border-slate-300 dark:border-slate-600 rounded-lg mb-4 min-h-[120px] bg-background dark:bg-slate-800/50 text-text dark:text-text-dark flex flex-col items-center justify-center text-center text-lg space-y-2"><p class="italic text-muted dark:text-muted-dark">Loading question...</p></div><div id="quiz-question-file-display" class="text-center"></div><div id="quiz-reveal-button-container" class="mb-3 text-center"><button id="quiz-reveal-answer-btn" class="bg-slate-200 hover:bg-slate-300 dark:bg-slate-600 dark:hover:bg-slate-500 text-text dark:text-text-dark font-medium py-2 px-4 rounded-lg text-sm btn-animated flex items-center space-x-1.5 mx-auto focus-visible:ring-2 focus-visible:ring-offset-1 focus-visible:ring-slate-500"><i data-lucide="eye" class="h-4 w-4"></i> <span>Show Answer</span></button></div><div id="quiz-correct-answer-display" class="p-3 bg-slate-100 dark:bg-slate-700 rounded-md text-sm mb-4 space-y-2" style="display: none;"><div id="quiz-answer-text-display"></div><div id="quiz-answer-file-display" class="text-center"></div></div><div id="quiz-judgment-buttons" class="mt-4 flex justify-center gap-4" style="display: none;"><button id="quiz-incorrect-btn" class="w-full sm:w-auto bg-red-500 hover:bg-red-600 text-white font-semibold py-2.5 px-6 rounded-lg btn-animated shadow-sm flex items-center justify-center space-x-2 focus-visible:ring-2 focus-visible:ring-offset-2 focus-visible:ring-red-500"><i data-lucide="x" class="h-5 w-5"></i> <span>Got it Wrong</span></button><button id="quiz-correct-btn" class="w-full sm:w-auto bg-green-500 hover:bg-green-600 text-white font-semibold py-2.5 px-6 rounded-lg btn-animated shadow-sm flex items-center justify-center space-x-2 focus-visible:ring-2 focus-visible:ring-offset-2 focus-visible:ring-green-500"><i data-lucide="check" class="h-5 w-5"></i> <span>Got it Right!</span></button></div><div class="mt-6 text-center"><button id="stop-quiz-button" class="text-xs text-muted dark:text-muted-dark hover:text-red-600 dark:hover:text-red-400 underline focus-visible:ring-1 focus-visible:ring-red-500 rounded px-1 btn-animated">Stop Quiz</button></div><div id="quiz-completion-message" class="hidden mt-6 p-4 text-center bg-green-100 dark:bg-green-900/50 text-green-700 dark:text-green-200 rounded-lg font-medium"></div></div></div>
            </section>
        </main>

        <footer class="bg-card dark:bg-card-dark mt-auto py-4 shadow-inner dark:shadow-[0_-1px_5px_-1px_rgba(0,0,0,0.1)] transition-colors duration-300 border-t border-slate-200 dark:border-slate-700"><div class="container mx-auto px-4 text-center text-xs text-muted dark:text-muted-dark">&copy; <span id="current-year"></span> Giorgi Suramlishvili Revision Hub. Candidate: 7590. Keep pushing!<br> <span class="text-gray-400 dark:text-gray-600 text-[10px] mt-1 block"><strong>Security Warning:</strong> Ensure Firebase Security Rules are configured for production use to protect data.</span></div></footer>
    </div>

    <div id="spin-wheel-modal-overlay" class="fixed inset-0 z-[70] flex items-center justify-center p-4 bg-black/30 dark:bg-black/60 backdrop-blur-sm hidden">
        <div id="spinner-modal-content" class="relative bg-card dark:bg-card-dark rounded-spinner-modal shadow-lg p-6 md:p-8 w-full max-w-lg text-center">
             <button id="close-spinner-modal-button" class="absolute top-3 right-3 p-1.5 rounded-full text-muted dark:text-muted-dark hover:bg-slate-100 dark:hover:bg-slate-700 focus-visible:ring-1 focus-visible:ring-primary btn-animated" title="Close" style="display: none;">
                 <i data-lucide="x" class="h-5 w-5"></i>
             </button>
            <h2 class="text-xl font-semibold mb-2 text-text dark:text-text-dark flex items-center justify-center space-x-2">
                <i data-lucide="gift" class="h-5 w-5 text-primary dark:text-primary-dark"></i>
                <span>Bonus Time Spinner!</span>
            </h2>
            <p class="modal-subtitle text-muted dark:text-muted-dark text-sm mb-6">You earned it! Spin for extra break time.</p>

            <div class="spinner-viewport" id="momentum-spinner-viewport">
                 <div class="spinner-marker"></div>
                <div id="momentum-spinner">
                </div>
            </div>

            <button id="modalSpinButton">Spin Now</button>

            <div id="momentum-result-display">
                You got <span id="momentum-result-value">?</span> minutes!
            </div>
        </div>
    </div>

    <div id="quiz-paper-select-modal" class="simple-modal-overlay fixed inset-0 z-[80] flex items-center justify-center p-4 bg-black/50 dark:bg-black/70 backdrop-blur-sm hidden"><div class="simple-modal-content bg-card dark:bg-card-dark rounded-xl shadow-lg p-6 w-full max-w-sm text-center transform scale-100 opacity-100"><h3 class="text-lg font-semibold mb-4 text-text dark:text-text-dark">Select Quiz Content</h3><p class="text-sm text-muted dark:text-muted-dark mb-5">Which questions do you want to include?</p><div id="quiz-paper-modal-options" class="space-y-3"><button data-paper-choice="All" class="quiz-paper-choice-btn w-full bg-primary hover:bg-primary/90 dark:bg-primary-dark dark:hover:bg-primary-dark/90 text-white font-medium py-2 px-4 rounded-lg btn-animated focus-visible:ring-2 focus-visible:ring-offset-2 focus-visible:ring-primary">All Questions</button><button data-paper-choice="General" class="quiz-paper-choice-btn w-full bg-slate-200 hover:bg-slate-300 dark:bg-slate-600 dark:hover:bg-slate-500 text-text dark:text-text-dark font-medium py-2 px-4 rounded-lg btn-animated focus-visible:ring-2 focus-visible:ring-offset-1 focus-visible:ring-slate-500">General Only</button></div><button id="cancel-paper-select-btn" class="mt-4 text-xs text-muted dark:text-muted-dark hover:text-red-600 dark:hover:text-red-400 underline focus-visible:ring-1 focus-visible:ring-red-500 rounded px-1 btn-animated">Cancel</button></div></div>

    <!-- Edit Resource Modal -->
    <div id="edit-resource-modal" class="simple-modal-overlay fixed inset-0 z-[80] flex items-center justify-center p-4 bg-black/50 dark:bg-black/70 backdrop-blur-sm hidden">
        <div class="simple-modal-content bg-card dark:bg-card-dark rounded-xl shadow-lg p-6 w-full max-w-lg transform scale-100 opacity-100">
            <h3 class="text-lg font-semibold mb-4 text-text dark:text-text-dark">Edit Resource</h3>
            <input type="hidden" id="edit-resource-id-input">
            <input type="hidden" id="edit-resource-subject-input">
            <div class="space-y-4">
                <div>
                    <label for="edit-resource-title-input" class="block text-sm font-medium text-muted dark:text-muted-dark mb-1">Title:</label>
                    <input type="text" id="edit-resource-title-input" class="w-full p-2 border border-slate-300 dark:border-slate-600 rounded-lg bg-background dark:bg-slate-700 focus:ring-primary focus:border-primary">
                </div>
                <div>
                    <label for="edit-resource-type-select" class="block text-sm font-medium text-muted dark:text-muted-dark mb-1">Type:</label>
                    <select id="edit-resource-type-select" class="w-full p-2 border border-slate-300 dark:border-slate-600 rounded-lg bg-background dark:bg-slate-700 focus:ring-primary focus:border-primary">
                        <option value="link">Link</option>
                        <option value="note">Note</option>
                    </select>
                </div>
                <div id="edit-resource-url-wrapper">
                    <label for="edit-resource-url-input" class="block text-sm font-medium text-muted dark:text-muted-dark mb-1">URL:</label>
                    <input type="url" id="edit-resource-url-input" class="w-full p-2 border border-slate-300 dark:border-slate-600 rounded-lg bg-background dark:bg-slate-700 focus:ring-primary focus:border-primary">
                </div>
                <div id="edit-resource-note-wrapper">
                    <label for="edit-resource-note-input" class="block text-sm font-medium text-muted dark:text-muted-dark mb-1">Note:</label>
                    <textarea id="edit-resource-note-input" rows="4" class="w-full p-2 border border-slate-300 dark:border-slate-600 rounded-lg bg-background dark:bg-slate-700 focus:ring-primary focus:border-primary"></textarea>
                </div>
            </div>
            <p id="edit-resource-error-message" class="text-red-500 text-xs mt-3 min-h-[1rem]"></p>
            <div class="mt-6 flex justify-end space-x-3">
                <button id="cancel-edit-resource-btn" class="px-4 py-2 text-sm font-medium text-muted dark:text-muted-dark bg-slate-100 hover:bg-slate-200 dark:bg-slate-700 dark:hover:bg-slate-600 rounded-lg btn-animated">Cancel</button>
                <button id="save-resource-changes-btn" class="px-4 py-2 text-sm font-medium text-white bg-primary hover:bg-primary/90 dark:bg-primary-dark dark:hover:bg-primary-dark/90 rounded-lg btn-animated">Save Changes</button>
            </div>
        </div>
    </div>

    <!-- Edit Tracker Item Modal -->
    <div id="edit-tracker-item-modal" class="simple-modal-overlay fixed inset-0 z-[80] flex items-center justify-center p-4 bg-black/50 dark:bg-black/70 backdrop-blur-sm hidden">
        <div class="simple-modal-content bg-card dark:bg-card-dark rounded-xl shadow-lg p-6 w-full max-w-lg transform scale-100 opacity-100">
            <h3 class="text-lg font-semibold mb-4 text-text dark:text-text-dark">Edit Tracker Item</h3>
            <input type="hidden" id="edit-tracker-id">
            <input type="hidden" id="edit-tracker-subject">
            <div class="space-y-4">
                <div>
                    <label for="edit-tracker-description" class="block text-sm font-medium text-muted dark:text-muted-dark mb-1">Description:</label>
                    <textarea id="edit-tracker-description" rows="3" class="w-full p-2 border border-slate-300 dark:border-slate-600 rounded-lg bg-background dark:bg-slate-700 focus:ring-primary focus:border-primary"></textarea>
                </div>
                <div>
                    <label for="edit-tracker-status-select" class="block text-sm font-medium text-muted dark:text-muted-dark mb-1">Status:</label>
                    <select id="edit-tracker-status-select" class="w-full p-2 border border-slate-300 dark:border-slate-600 rounded-lg bg-background dark:bg-slate-700 focus:ring-primary focus:border-primary">
                        <option value="To Review">To Review</option>
                        <option value="In Progress">In Progress</option>
                        <option value="Mastered">Mastered</option>
                    </select>
                </div>
            </div>
            <p id="edit-tracker-error-message" class="text-red-500 text-xs mt-3 min-h-[1rem]"></p>
            <div class="mt-6 flex justify-end space-x-3">
                <button id="cancel-edit-tracker-btn" class="px-4 py-2 text-sm font-medium text-muted dark:text-muted-dark bg-slate-100 hover:bg-slate-200 dark:bg-slate-700 dark:hover:bg-slate-600 rounded-lg btn-animated">Cancel</button>
                <button id="save-tracker-changes-btn" class="px-4 py-2 text-sm font-medium text-white bg-primary hover:bg-primary/90 dark:bg-primary-dark dark:hover:bg-primary-dark/90 rounded-lg btn-animated">Save Changes</button>
            </div>
        </div>
    </div>

    <!-- Edit Quiz Question Modal -->
    <div id="edit-quiz-question-modal" class="simple-modal-overlay fixed inset-0 z-[80] flex items-center justify-center p-4 bg-black/50 dark:bg-black/70 backdrop-blur-sm hidden">
        <div class="simple-modal-content bg-card dark:bg-card-dark rounded-xl shadow-lg p-6 w-full max-w-xl transform scale-100 opacity-100">
            <h3 class="text-lg font-semibold mb-4 text-text dark:text-text-dark">Edit Quiz Question</h3>
            <input type="hidden" id="edit-quiz-id">
            <input type="hidden" id="edit-quiz-subject">
            <div class="space-y-4">
                <div>
                    <label for="edit-quiz-question-input" class="block text-sm font-medium text-muted dark:text-muted-dark mb-1">Question:</label>
                    <textarea id="edit-quiz-question-input" rows="3" class="w-full p-2 border border-slate-300 dark:border-slate-600 rounded-lg bg-background dark:bg-slate-700 focus:ring-primary focus:border-primary"></textarea>
                </div>
                <div id="edit-quiz-question-file-wrapper">
                    <label for="edit-quiz-question-file" class="file-input-button-style"><span>Choose New Q File</span> (Optional)</label>
                    <input type="file" id="edit-quiz-question-file" accept="image/*,application/pdf,.doc,.docx,.txt" class="sr-only">
                    <span id="edit-quiz-question-filename" class="text-xs text-muted dark:text-muted-dark ml-2 align-middle"></span>
                    <button type="button" id="edit-clear-quiz-question-file" class="text-xs text-red-500 hover:underline ml-1 align-middle hidden" aria-label="Clear selected question file">&times;</button>
                    <div id="current-edit-q-file-display" class="mt-1 current-file-display">Current: None</div>
                </div>
                <div>
                    <label for="edit-quiz-answer-input" class="block text-sm font-medium text-muted dark:text-muted-dark mb-1">Answer / Mark Scheme:</label>
                    <textarea id="edit-quiz-answer-input" rows="4" class="w-full p-2 border border-slate-300 dark:border-slate-600 rounded-lg bg-background dark:bg-slate-700 focus:ring-primary focus:border-primary"></textarea>
                </div>
                <div id="edit-quiz-answer-file-wrapper">
                    <label for="edit-quiz-answer-file" class="file-input-button-style"><span>Choose New A File</span> (Optional)</label>
                    <input type="file" id="edit-quiz-answer-file" accept="image/*,application/pdf,.doc,.docx,.txt" class="sr-only">
                    <span id="edit-quiz-answer-filename" class="text-xs text-muted dark:text-muted-dark ml-2 align-middle"></span>
                    <button type="button" id="edit-clear-quiz-answer-file" class="text-xs text-red-500 hover:underline ml-1 align-middle hidden" aria-label="Clear selected answer file">&times;</button>
                    <div id="current-edit-a-file-display" class="mt-1 current-file-display">Current: None</div>
                </div>
                <div>
                    <label for="edit-quiz-paper-select" class="block text-sm font-medium text-muted dark:text-muted-dark mb-1">Paper (Optional):</label>
                    <select id="edit-quiz-paper-select" class="w-full md:w-1/2 lg:w-1/3 p-2 border border-slate-300 dark:border-slate-600 rounded-lg bg-background dark:bg-slate-700 focus:ring-primary focus:border-primary text-sm">
                        <option value="General">General</option>
                    </select>
                </div>
            </div>
            <p id="edit-quiz-error-message" class="text-red-500 text-xs mt-3 min-h-[1rem]"></p>
            <div class="mt-6 flex justify-end space-x-3">
                <button id="cancel-edit-quiz-btn" class="px-4 py-2 text-sm font-medium text-muted dark:text-muted-dark bg-slate-100 hover:bg-slate-200 dark:bg-slate-700 dark:hover:bg-slate-600 rounded-lg btn-animated">Cancel</button>
                <button id="save-quiz-changes-btn" class="px-4 py-2 text-sm font-medium text-white bg-primary hover:bg-primary/90 dark:bg-primary-dark dark:hover:bg-primary-dark/90 rounded-lg btn-animated">Save Changes</button>
            </div>
        </div>
    </div>

    <script type="module">
      // Firebase and other imports remain the same...
      import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.0/firebase-app.js";
      import { getAuth, onAuthStateChanged, signInWithEmailAndPassword, signOut, updatePassword, EmailAuthProvider, reauthenticateWithCredential } from "https://www.gstatic.com/firebasejs/11.6.0/firebase-auth.js";
      import { getFirestore, collection, doc, addDoc, getDocs, getDoc, setDoc, updateDoc, deleteDoc, query, orderBy, limit, serverTimestamp, increment, writeBatch, Timestamp, where, deleteField } from "https://www.gstatic.com/firebasejs/11.6.0/firebase-firestore.js"; // Added deleteField
      import { getStorage, ref, uploadBytes, getDownloadURL, deleteObject } from "https://www.gstatic.com/firebasejs/11.6.0/firebase-storage.js";

      const firebaseConfig = {
        apiKey: "AIzaSyAt3uFOLLQXjt2p0LERjvizePMfg9S74Mk",
        authDomain: "studentpage-97bb5.firebaseapp.com",
        projectId: "studentpage-97bb5",
        storageBucket: "studentpage-97bb5.firebasestorage.app",
        messagingSenderId: "613071061381",
        appId: "1:613071061381:web:124051538e7e0dfec344ec",
        measurementId: "G-WC262FYLJH"
      };

      let app, auth, db, storage;
      let currentUserId = null;
      let isInitialized = false;
      let eventListenersAttached = false;
      let countdownInterval = null;
      let pomodoroInterval = null;
      let bonusTimerInterval = null;
      let currentActiveSubject = null;
      let quizState = { active: false, currentSubject: null, currentPaperSelection: 'All', initialQuestions: [], currentQuizPool: [], incorrectlyAnswered: [], currentQuestionIndex: -1, round: 1, totalMastered: 0, isAnswerVisible: false, buttonTimeout: null, correctAnswersInSession: 0, isSpinnerModalOpen: false, spinJustFinished: false };
      let targetSubjectParam = null;
      const DEFAULT_TITLE = "Giorgi's GCSE Revision Hub";
      const dayNames = ['sunday', 'monday', 'tuesday', 'wednesday', 'thursday', 'friday', 'saturday'];
      let studyTimeChart = null;
      let openAddSectionFlag = null;
      const MAX_FILE_UPLOAD_SIZE = 5 * 1024 * 1024; // 5MB

      // Store initial data for quiz edit modal to track file changes
      let initialQuizDataForEdit = { questionFileUrl: null, answerFileUrl: null, questionFileCleared: false, answerFileCleared: false };


      const examData = [ { subject: "English Literature", paper: "Paper 1", date: "2025-05-12T08:45:00", duration: "1h 45m", board: "AQA", tier: null, location: "Sports Hall 1", seat: "M3" }, { subject: "Computer Science", paper: "Computer Systems Written", date: "2025-05-12T13:45:00", duration: "1h 30m", board: "OCR", tier: null, location: "Sports Hall 1", seat: "C10" }, { subject: "Biology", paper: "Paper 1", date: "2025-05-13T13:45:00", duration: "1h 45m", board: "AQA", tier: "H", location: "Sports Hall 1", seat: "N1" }, { subject: "Geography", paper: "Paper 1", date: "2025-05-14T08:45:00", duration: "1h 30m", board: "AQA", tier: null, location: "Sports Hall 1", seat: "F8" }, { subject: "Mathematics", paper: "Option H: Non-Calculator", date: "2025-05-15T08:45:00", duration: "1h 30m", board: "Edexcel", tier: "H", location: "Sports Hall 1", seat: "M3" }, { subject: "Chemistry", paper: "Paper 1", date: "2025-05-19T08:45:00", duration: "1h 45m", board: "AQA", tier: "H", location: "Sports Hall 1", seat: "N1" }, { subject: "English Literature", paper: "Paper 2", date: "2025-05-20T08:45:00", duration: "2h 15m", board: "AQA", tier: null, location: "Sports Hall 1", seat: "M3" }, { subject: "Computer Science", paper: "Computational Thinking, Algorithms & Programming", date: "2025-05-20T13:45:00", duration: "1h 30m", board: "OCR", tier: null, location: "Sports Hall 1", seat: "C10" }, { subject: "Physics", paper: "Paper 1", date: "2025-05-22T08:45:00", duration: "1h 45m", board: "AQA", tier: "H", location: "Sports Hall 1", seat: "N1" }, { subject: "English Language", paper: "Paper 1", date: "2025-05-23T08:45:00", duration: "1h 45m", board: "AQA", tier: null, location: "Sports Hall 1", seat: "M3" }, { subject: "Mathematics", paper: "Option H: Calculator", date: "2025-06-04T08:45:00", duration: "1h 30m", board: "Edexcel", tier: "H", location: "Sports Hall 1", seat: "M2" }, { subject: "English Language", paper: "Paper 2", date: "2025-06-06T08:45:00", duration: "1h 45m", board: "AQA", tier: null, location: "Sports Hall 1", seat: "M3" }, { subject: "Geography", paper: "Paper 2", date: "2025-06-06T13:45:00", duration: "1h 30m", board: "AQA", tier: null, location: "Sports Hall 1", seat: "F8" }, { subject: "Biology", paper: "Paper 2", date: "2025-06-09T08:45:00", duration: "1h 45m", board: "AQA", tier: "H", location: "Sports Hall 1", seat: "N1" }, { subject: "Spanish", paper: "Listening", date: "2025-06-10T08:45:00", duration: "0h 45m", board: "AQA", tier: "H", location: "4G3 - History E3", seat: null }, { subject: "Spanish", paper: "Reading", date: "2025-06-10T09:50:00", duration: "1h 00m", board: "AQA", tier: "H", location: "4G3 - History E3", seat: null }, { subject: "Mathematics", paper: "Option H: Calculator P3", date: "2025-06-11T08:45:00", duration: "1h 30m", board: "Edexcel", tier: "H", location: "Sports Hall 1", seat: "M3" }, { subject: "Geography", paper: "Paper 3", date: "2025-06-12T08:45:00", duration: "1h 30m", board: "AQA", tier: null, location: "Sports Hall 1", seat: "F8" }, { subject: "Chemistry", paper: "Paper 2", date: "2025-06-13T08:45:00", duration: "1h 45m", board: "AQA", tier: "H", location: "Sports Hall 1", seat: "N1" }, { subject: "Physics", paper: "Paper 2", date: "2025-06-16T08:45:00", duration: "1h 45m", board: "AQA", tier: "H", location: "Sports Hall 1", seat: "N1" }, { subject: "Spanish", paper: "Writing", date: "2025-06-17T08:45:00", duration: "1h 15m", board: "AQA", tier: "H", location: "Sports Hall 1", seat: "J3" } ].sort((a, b) => new Date(a.date) - new Date(b.date));
      const motivationalQuotes = [ "Believe you can and you're halfway there.", "The secret to getting ahead is getting started.", "Don't watch the clock; do what it does. Keep going.", "Success is not final, failure is not fatal: It is the courage to continue that counts.", "The expert in anything was once a beginner.", "Strive for progress, not perfection.", "Your limitation—it's only your imagination.", "Push yourself, because no one else is going to do it for you.", "Great things never come from comfort zones.", "The harder you work for something, the greater you'll feel when you achieve it.", "Focus on the step in front of you, not the whole staircase.", "Small steps every day lead to big results." ];
      const subjects = [...new Set(examData.map(exam => exam.subject))].sort();

      const MOMENTUM_ITEMS = [1, 2, 3, 4, 5, 6, 7, 8, 9, 10];
      const MOMENTUM_ITEM_WIDTH = 75;
      const MOMENTUM_REPETITIONS = 50;
      const MOMENTUM_SPIN_DURATION_SECONDS = 10;
      const MOMENTUM_SPIN_DURATION_MS = MOMENTUM_SPIN_DURATION_SECONDS * 1000;
      const MOMENTUM_WEIGHTS = [
          { value: 1, weight: 51 }, { value: 2, weight: 20 }, { value: 3, weight: 14 },
          { value: 4, weight: 10 }, { value: 5, weight: 8 }, { value: 6, weight: 7 },
          { value: 7, weight: 6 },  { value: 8, weight: 4 },  { value: 9, weight: 3 },
          { value: 10, weight: 2 },
      ];
      const CORRECT_ANSWERS_FOR_SPINNER = 5;

      const getElement = (id) => document.getElementById(id);
      const loginOverlay = getElement('login-overlay');
      const appWrapper = getElement('app-wrapper');
      const emailInput = getElement('email-input');
      const passwordInput = getElement('password-input');
      const loginButton = getElement('login-button');
      const loginError = getElement('login-error');
      const logoutButton = getElement('logout-button');
      const logoutButtonMobile = getElement('logout-button-mobile');
      const currentPasswordInput = getElement('current-password');
      const newPasswordInput = getElement('new-password');
      const changePasswordButton = getElement('change-password-button');
      const changePasswordMessage = getElement('change-password-message');
      const themeToggle = getElement('theme-toggle');
      const themeToggleMobile = getElement('theme-toggle-mobile');
      const themeIconLight = getElement('theme-icon-light');
      const themeIconDark = getElement('theme-icon-dark');
      const themeIconLightMobile = getElement('theme-icon-light-mobile');
      const themeIconDarkMobile = getElement('theme-icon-dark-mobile');
      const htmlElement = document.documentElement;
      const navLinks = document.querySelectorAll('.nav-link:not(.mobile-nav-link)');
      const pages = document.querySelectorAll('.page');
      const mobileMenuButton = getElement('mobile-menu-button');
      const mobileCloseButton = getElement('mobile-close-button');
      const mobileMenu = getElement('mobile-menu');
      const mobileOverlay = getElement('mobile-overlay');
      const mobileNavLinks = document.querySelectorAll('.mobile-nav-link');
      const currentYearEl = getElement('current-year');
      const upcomingExamsList = getElement('upcoming-exams-list');
      const dailyGoalDisplay = getElement('daily-goal-display');
      const dailyGoalTargetEl = getElement('daily-goal-target');
      const dailyGoalCompletedEl = getElement('daily-goal-completed');
      const dailyGoalProgressBarFill = getElement('daily-goal-progress-bar-fill');
      const dailyGoalPercentageEl = getElement('daily-goal-percentage');
      const setGoalsDetails = getElement('set-goals-details');
      const saveDailyGoalsBtn = getElement('save-daily-goals-btn');
      const saveGoalsMessage = getElement('save-goals-message');
      const goalInputs = { monday: getElement('goal-monday'), tuesday: getElement('goal-tuesday'), wednesday: getElement('goal-wednesday'), thursday: getElement('goal-thursday'), friday: getElement('goal-friday'), saturday: getElement('goal-saturday'), sunday: getElement('goal-sunday'), };
      const analyticsTotalTimeEl = getElement('analytics-total-time');
      const analyticsTotalSessionsEl = getElement('analytics-total-sessions');
      const studyTimeChartCanvas = getElement('study-time-chart');
      const chartLoadingMessage = getElement('chart-loading-message');
      const pomodoroSummary = getElement('pomodoro-summary');
      const quickAddResourceBtn = getElement('quick-add-resource');
      const quickAddTrackerBtn = getElement('quick-add-tracker');
      const quickAddPlannerBtn = getElement('quick-add-planner');
      const motivationalQuoteEl = getElement('motivational-quote');
      const timetableBody = getElement('timetable-body');
      const subjectTabsContainer = getElement('subject-tabs');
      const resourceContent = getElement('resource-content');
      const addResourceDetails = getElement('add-resource-details');
      const resourceTypeSelect = getElement('resource-type');
      const resourceTitleInput = getElement('resource-title');
      const resourceUrlWrapper = getElement('resource-url-wrapper');
      const resourceUrlInput = getElement('resource-url');
      const resourceNoteWrapper = getElement('resource-note-wrapper');
      const resourceNoteInput = getElement('resource-note');
      const saveResourceBtn = getElement('save-resource-btn');
      const timerDisplay = getElement('timer-display');
      const timerStatus = getElement('timer-status');
      const startPauseButton = getElement('start-pause-button');
      const resetButton = getElement('reset-button');
      const pomodoroSubjectSelect = getElement('pomodoro-subject');
      const pomodoroSubjectWrapper = getElement('pomodoro-subject-wrapper');
      const workDurationInput = getElement('work-duration');
      const shortBreakDurationInput = getElement('short-break-duration');
      const longBreakDurationInput = getElement('long-break-duration');
      const progressRing = getElement('timer-progress-ring');
      const workModeButton = getElement('work-mode-button');
      const shortBreakModeButton = getElement('short-break-mode-button');
      const longBreakModeButton = getElement('long-break-mode-button');
      const pomodoroModeTitle = getElement('pomodoro-mode-title');
      const pomodoroSubjectTimesContainer = getElement('pomodoro-subject-times');
      const modeButtons = [workModeButton, shortBreakModeButton, longBreakModeButton];
      const mainPomodoroTimerArea = getElement('main-pomodoro-timer-area');
      const mainPomodoroControls = getElement('main-pomodoro-controls');
      const wonTimeContainer = getElement('won-time-container');
      const wonTimeDisplay = getElement('won-time-display');
      const useWonTimeButton = getElement('use-won-time-button');
      const bonusTimerContainer = getElement('bonus-timer-container');
      const bonusTimerCountdown = getElement('bonus-timer-countdown');
      const bonusTimerCompletionMessage = getElement('bonus-timer-completion-message');
      const trackerSubjectSelect = getElement('tracker-subject-select');
      const trackerItemsList = getElement('tracker-items-list');
      const addTrackerDetails = getElement('add-tracker-details');
      const trackerDescriptionInput = getElement('tracker-description');
      const trackerStatusSelect = getElement('tracker-status-select');
      const saveTrackerItemBtn = getElement('save-tracker-item-btn');
      const plannerDateInput = getElement('planner-date');
      const plannerTimeInput = getElement('planner-time');
      const plannerSubjectSelect = getElement('planner-subject-select');
      const plannerTopicInput = getElement('planner-topic');
      const savePlannerItemBtn = getElement('save-planner-item-btn');
      const plannerItemsList = getElement('planner-items-list');
      const quizSubjectSelect = getElement('quiz-subject-select');
      const quizContentWrapper = getElement('quiz-content-wrapper');
      const addQuizDetails = getElement('add-quiz-details');
      const quizQuestionInput = getElement('quiz-question-input');
      const quizAnswerInput = getElement('quiz-answer-input');
      const quizQuestionFileInput = getElement('quiz-question-file');
      const quizQuestionFilenameEl = getElement('quiz-question-filename');
      const clearQuizQuestionFileBtn = getElement('clear-quiz-question-file');
      const quizAnswerFileInput = getElement('quiz-answer-file');
      const quizAnswerFilenameEl = getElement('quiz-answer-filename');
      const clearQuizAnswerFileBtn = getElement('clear-quiz-answer-file');
      const quizPaperSelect = getElement('quiz-paper-select');
      const saveQuizQuestionBtn = getElement('save-quiz-question-btn');
      const quizItemsList = getElement('quiz-items-list');
      const quizListContainer = getElement('quiz-list-container');
      const startQuizButton = getElement('start-quiz-button');
      const quizModeInterface = getElement('quiz-mode-interface');
      const quizQuestionDisplay = getElement('quiz-question-display');
      const quizQuestionFileDisplay = getElement('quiz-question-file-display');
      const quizRevealBtnContainer = getElement('quiz-reveal-button-container');
      const quizRevealAnswerBtn = getElement('quiz-reveal-answer-btn');
      const quizCorrectAnswerDisplay = getElement('quiz-correct-answer-display');
      const quizAnswerTextDisplay = getElement('quiz-answer-text-display');
      const quizAnswerFileDisplay = getElement('quiz-answer-file-display');
      const quizJudgmentButtons = getElement('quiz-judgment-buttons');
      const quizIncorrectBtn = getElement('quiz-incorrect-btn');
      const quizCorrectBtn = getElement('quiz-correct-btn');
      const stopQuizButton = getElement('stop-quiz-button');
      const quizProgress = getElement('quiz-progress');
      const quizCompletionMessage = getElement('quiz-completion-message');
      const quizPaperSelectModal = getElement('quiz-paper-select-modal');
      const quizPaperModalOptions = getElement('quiz-paper-modal-options');
      const cancelPaperSelectBtn = getElement('cancel-paper-select-btn');
      const spinnerModalOverlay = getElement('spin-wheel-modal-overlay');
      const momentumSpinnerViewport = getElement('momentum-spinner-viewport');
      const momentumSpinner = getElement('momentum-spinner');
      const modalSpinButton = getElement('modalSpinButton');
      const momentumResultDisplay = getElement('momentum-result-display');
      const momentumResultValueDisplay = getElement('momentum-result-value');
      const closeSpinnerModalButton = getElement('close-spinner-modal-button');

      // Edit Resource Modal Elements
      const editResourceModal = getElement('edit-resource-modal');
      const editResourceIdInput = getElement('edit-resource-id-input');
      const editResourceSubjectInput = getElement('edit-resource-subject-input');
      const editResourceTitleInput = getElement('edit-resource-title-input');
      const editResourceTypeSelect = getElement('edit-resource-type-select');
      const editResourceUrlWrapper = getElement('edit-resource-url-wrapper');
      const editResourceUrlInput = getElement('edit-resource-url-input');
      const editResourceNoteWrapper = getElement('edit-resource-note-wrapper');
      const editResourceNoteInput = getElement('edit-resource-note-input');
      const editResourceErrorMessage = getElement('edit-resource-error-message');
      const saveResourceChangesBtn = getElement('save-resource-changes-btn');
      const cancelEditResourceBtn = getElement('cancel-edit-resource-btn');

      // Edit Tracker Item Modal Elements
      const editTrackerItemModal = getElement('edit-tracker-item-modal');
      const editTrackerIdInput = getElement('edit-tracker-id');
      const editTrackerSubjectInput = getElement('edit-tracker-subject');
      const editTrackerDescriptionInput = getElement('edit-tracker-description');
      const editTrackerStatusSelect = getElement('edit-tracker-status-select');
      const editTrackerErrorMessage = getElement('edit-tracker-error-message');
      const saveTrackerChangesBtn = getElement('save-tracker-changes-btn');
      const cancelEditTrackerBtn = getElement('cancel-edit-tracker-btn');

      // Edit Quiz Question Modal Elements
      const editQuizQuestionModal = getElement('edit-quiz-question-modal');
      const editQuizIdInput = getElement('edit-quiz-id');
      const editQuizSubjectInput = getElement('edit-quiz-subject');
      const editQuizQuestionInput = getElement('edit-quiz-question-input');
      const editQuizQuestionFileInput = getElement('edit-quiz-question-file');
      const editQuizQuestionFilenameEl = getElement('edit-quiz-question-filename');
      const editClearQuizQuestionFileBtn = getElement('edit-clear-quiz-question-file');
      const currentEditQFileDisplay = getElement('current-edit-q-file-display');
      const editQuizAnswerInput = getElement('edit-quiz-answer-input');
      const editQuizAnswerFileInput = getElement('edit-quiz-answer-file');
      const editQuizAnswerFilenameEl = getElement('edit-quiz-answer-filename');
      const editClearQuizAnswerFileBtn = getElement('edit-clear-quiz-answer-file');
      const currentEditAFileDisplay = getElement('current-edit-a-file-display');
      const editQuizPaperSelect = getElement('edit-quiz-paper-select');
      const editQuizErrorMessage = getElement('edit-quiz-error-message');
      const saveQuizChangesBtn = getElement('save-quiz-changes-btn');
      const cancelEditQuizBtn = getElement('cancel-edit-quiz-btn');


      let pomodoroState = { totalSeconds: 0, currentSeconds: 0, timerState: 'stopped', timerMode: 'work', pomodoroCycle: 0, workSessionSubject: '', timerEndTime: null };
      const POMODORO_STORAGE_KEY = 'pomodoroState';

      let wonTimeSeconds = 0;
      let isBonusTimerRunning = false;

      let momentumSpinnerState = {
        isSpinning: false,
        spinTimeout: null,
        fullSequence: []
      };

      const safelyCreateIcons = () => { if (typeof lucide !== 'undefined' && lucide.createIcons) { try { lucide.createIcons(); } catch (e) { console.error("Lucide icon creation failed:", e); } } };
      const formatGeneralDate = (d) => { try { const date = (d instanceof Date) ? d : (d?.toDate ? d.toDate() : new Date(d)); if (isNaN(date.getTime())) return "Invalid Date"; return date.toLocaleDateString('en-GB', { weekday: 'short', year: 'numeric', month: 'short', day: 'numeric' }); } catch (e) { console.warn("Error formatting general date:", d, e); return "Invalid Date"; } };
      const formatPlannerDateTime = (iso) => { try { const date = new Date(iso); if (isNaN(date.getTime())) return "Invalid Date"; const dp = date.toLocaleDateString('en-GB', { weekday: 'short', month: 'short', day: 'numeric' }); const tp = date.toLocaleTimeString('en-GB', { hour: '2-digit', minute: '2-digit', hour12: true }); return `${dp}, ${tp}`; } catch (e) { console.warn("Error formatting planner date/time:", iso, e); try { return formatGeneralDate(iso.split('T')[0]); } catch { return "Invalid Date"; } } };
      const formatExamDate = (d) => { try { const date = new Date(d); if (isNaN(date.getTime())) return "Invalid Date"; return date.toLocaleDateString('en-GB', { weekday: 'short', month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit', hour12: true }); } catch (e) { console.warn("Error formatting exam date:", d, e); return "Invalid Date"; } };
      const formatMinutesToHHMM = (totalMinutes) => { if (typeof totalMinutes !== 'number' || isNaN(totalMinutes) || totalMinutes <= 0) return '00h 00m'; const hours = Math.floor(totalMinutes / 60); const minutes = totalMinutes % 60; return `${String(hours).padStart(2, '0')}h ${String(minutes).padStart(2, '0')}m`; };
      const formatSecondsToHHMMSS = (totalSeconds) => { if (isNaN(totalSeconds) || totalSeconds <= 0) return "00:00:00"; const hours = Math.floor(totalSeconds / 3600); const minutes = Math.floor((totalSeconds % 3600) / 60); const seconds = Math.floor(totalSeconds % 60); return `${String(hours).padStart(2, '0')}:${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`; };
      const formatSecondsToMMSS = (totalSeconds) => { if (isNaN(totalSeconds) || totalSeconds < 0) return "00:00"; const minutes = Math.floor(totalSeconds / 60); const seconds = Math.floor(totalSeconds % 60); return `${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`; };
      const formatDurationString = (durationString) => { let totalMinutes = 0; try { if (typeof durationString === 'string') { const hoursMatch = durationString.match(/(\d+)\s*h/); const minutesMatch = durationString.match(/(\d+)\s*m/); if (hoursMatch) totalMinutes += parseInt(hoursMatch[1]) * 60; if (minutesMatch) totalMinutes += parseInt(minutesMatch[1]); } } catch (e) { console.warn("Could not parse duration string:", durationString); } return formatMinutesToHHMM(totalMinutes); };
      const formatCountdown = (d) => { try { const now = new Date(); const examDate = new Date(d); if (isNaN(examDate.getTime())) return "<span class='text-red-500 dark:text-red-400'>Error</span>"; const diff = examDate - now; if (diff <= 0) return "<span class='text-green-600 dark:text-green-400 font-medium'>Completed</span>"; const days = Math.floor(diff / 864e5); const hours = Math.floor((diff % 864e5) / 36e5); const minutes = Math.floor((diff % 36e5) / 6e4); let p = []; if (days > 1) p.push(`${days} days`); else if (days === 1) p.push(`${days} day`); if (hours > 0) p.push(`${hours}h`); if (days < 1 && minutes > 0) p.push(`${minutes}m`); if (p.length === 0 && diff > 0) return "<span class='text-orange-500 font-medium'>&lt; 1m</span>"; return p.join(' '); } catch (e) { console.warn("Error formatting countdown:", d, e); return "<span class='text-red-500 dark:text-red-400'>Error</span>"; } };
      const subjectColorMap = {};
      const generateSubjectColors = () => { const baseColors = [ { tw: 'indigo', hex: '#4f46e5', rgb: '79, 70, 229' }, { tw: 'sky', hex: '#0ea5e9', rgb: '14, 165, 233' }, { tw: 'emerald', hex: '#10b981', rgb: '16, 185, 129' }, { tw: 'amber', hex: '#f59e0b', rgb: '245, 158, 11' }, { tw: 'violet', hex: '#8b5cf6', rgb: '139, 92, 246' }, { tw: 'rose', hex: '#f43f5e', rgb: '244, 63, 94' }, { tw: 'cyan', hex: '#06b6d4', rgb: '6, 182, 212' }, { tw: 'lime', hex: '#84cc16', rgb: '132, 204, 22' }, { tw: 'fuchsia', hex: '#d946ef', rgb: '217, 70, 239' }, { tw: 'orange', hex: '#f97316', rgb: '249, 115, 22' }, { tw: 'teal', hex: '#14b8a6', rgb: '20, 184, 166' }, { tw: 'blue', hex: '#3b82f6', rgb: '59, 130, 246' }, ]; subjects.forEach((subject, index) => { const color = baseColors[index % baseColors.length]; subjectColorMap[subject] = { borderClass: `border-${color.tw}-500 dark:border-${color.tw}-400`, bgClass: `bg-${color.tw}-500 dark:bg-${color.tw}-400`, textClass: `text-${color.tw}-600 dark:text-${color.tw}-400`, rgb: color.rgb, hex: color.hex }; }); subjectColorMap['default'] = { borderClass: 'border-slate-400 dark:border-slate-500', bgClass: 'bg-slate-400 dark:bg-slate-500', textClass: 'text-slate-600 dark:text-slate-400', rgb: '148, 163, 184', hex: '#94a3b8' }; };
      const getSubjectColorInfo = (subject) => { if (Object.keys(subjectColorMap).length <= 1) { generateSubjectColors(); } return subjectColorMap[subject] || subjectColorMap['default']; };
      const shuffleArray = (a) => { if (!Array.isArray(a)) return []; for (let i = a.length - 1; i > 0; i--) { const j = Math.floor(Math.random() * (i + 1)); [a[i], a[j]] = [a[j], a[i]]; } return a; };
      const escapeHtml = (unsafe) => { return unsafe ? unsafe.toString().replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;").replace(/"/g, "&quot;").replace(/'/g, "&#039;") : ''; };
      const getFilenameFromUrl = (url) => {
          if (!url) return 'N/A';
          try {
              const decodedUrl = decodeURIComponent(url);
              const pathPart = decodedUrl.substring(decodedUrl.lastIndexOf('/') + 1).split('?')[0];
              return pathPart.replace(/(_\d{13,})(?=\.[^.]+$)/, ''); // Remove timestamp suffix
          } catch (e) {
              console.warn("Could not parse filename from URL:", url, e);
              return 'File';
          }
      };
      const applyStaggerAnimation = (elements) => { if (!elements) return; Array.from(elements).forEach((el, index) => { if (el instanceof HTMLElement) { el.style.animationDelay = `${index * 0.06}s`; el.classList.add('list-item-appear'); } }); };
      const getTodayDateString = () => { const now = new Date(); const year = now.getFullYear(); const month = (now.getMonth() + 1).toString().padStart(2, '0'); const day = now.getDate().toString().padStart(2, '0'); return `${year}-${month}-${day}`; };
      const getDayName = (dayIndex) => dayNames[dayIndex] || 'sunday';
      const showTemporaryMessage = (element, message, duration = 3000, isSuccess = true) => { if (!element) return; element.textContent = message; element.classList.remove('text-red-500', 'text-green-600', 'dark:text-green-400'); if (isSuccess) { element.classList.add('text-green-600', 'dark:text-green-400'); } else { element.classList.add('text-red-500'); } setTimeout(() => { if (element) element.textContent = ''; }, duration); };
      const getCssVariable = (varName) => getComputedStyle(document.documentElement).getPropertyValue(varName).trim();

      try {
        app = initializeApp(firebaseConfig);
        auth = getAuth(app);
        db = getFirestore(app);
        storage = getStorage(app);
      } catch (error) {
        console.error("Firebase Initialization Error:", error);
        if (loginError) {
            loginError.textContent = "Firebase connection failed. Check config or network.";
            loginError.classList.remove('hidden');
        }
        if (loginButton) {
            loginButton.disabled = true;
            loginButton.textContent = 'Login Unavailable';
        }
        throw new Error("Firebase Initialization Failed. Cannot proceed.");
      }

      const getUserDataRef = (userId, path) => { if (!userId || !db) { return null; } const cleanPath = path.split('/').filter(p => p).join('/'); return doc(db, `users/${userId}/${cleanPath}`); }
      const getUserCollectionRef = (userId, collectionName) => { if (!userId || !db) { return null; } return collection(db, `users/${userId}/${collectionName}`); }
      const getSubjectSpecificCollectionRef = (userId, mainCollection, subject) => { if (!userId || !db || !subject) { return null; } return collection(db, `users/${userId}/${mainCollection}/${subject}/items`); }
      const getSubjectSpecificDocRef = (userId, mainCollection, subject, docId) => { if (!userId || !db || !subject || !docId) { return null; } return doc(db, `users/${userId}/${mainCollection}/${subject}/items/${docId}`); }

      const initializePostLogin = async (user) => {
          if (!db || !storage) {
              throw new Error("Database or Storage not ready during post-login initialization!");
          }
          if (currentYearEl) currentYearEl.textContent = new Date().getFullYear();
          if (countdownInterval) clearInterval(countdownInterval);

          try {
              generateSubjectColors();
              loadTimetable();
              populateSubjectDropdown(pomodoroSubjectSelect);
              populateSubjectDropdown(trackerSubjectSelect);
              populateSubjectDropdown(plannerSubjectSelect);
              populateSubjectDropdown(quizSubjectSelect);
              if (!loadPomodoroState()) {
                  setTimerMode('work', false);
              } else {
                  updateTimerDisplay();
              }
              await loadWonTime();
              loadResources();
              loadTracker();
              loadPlanner();
              loadQuizPage();
              showPage('dashboard');
              countdownInterval = setInterval(updateTimetableCountdowns, 30000);
              updateTimetableCountdowns();
              safelyCreateIcons();
          } catch (error) {
              console.error("Error during post-login initialization sequence:", error);
              const dashboardPage = getElement('dashboard');
              if (dashboardPage?.classList.contains('active')) {
                  dashboardPage.innerHTML = `<div class="p-4 bg-red-100 dark:bg-red-900/50 border border-red-300 dark:border-red-700 rounded-lg text-red-700 dark:text-red-200 text-center"><h2 class="font-semibold text-lg mb-2">Error Loading Application Data</h2><p class="text-sm mb-3">An error occurred while loading essential application data. Please try refreshing the page.</p><p class="text-xs">Error: ${escapeHtml(error.message)}</p></div>`;
              } else {
                  alert("A critical error occurred while loading the application. Please refresh the page.");
              }
              if (countdownInterval) clearInterval(countdownInterval);
              stopPomodoroTimer(true);
              await stopBonusTimer();
          }
      };

      onAuthStateChanged(auth, async (user) => {
          if (user && db && storage) {
              currentUserId = user.uid;
              loginOverlay?.classList.add('opacity-0', 'pointer-events-none');
              setTimeout(() => loginOverlay?.classList.add('hidden'), 400);
              if (appWrapper) {
                  appWrapper.classList.remove('hidden');
                  appWrapper.classList.add('flex');
              }
              if (!isInitialized) {
                  await initializePostLogin(user).catch(async err => {
                      console.error("FATAL: Post-login initialization failed:", err);
                      alert("Critical error loading application after login. Please refresh the page.");
                      await handleLogout();
                  });
                  isInitialized = true;
              }
          } else {
              currentUserId = null;
              isInitialized = false;
              loginOverlay?.classList.remove('hidden', 'opacity-0', 'pointer-events-none');
              appWrapper?.classList.add('hidden');
              appWrapper?.classList.remove('flex');
              clearDynamicContentAndIntervals();
              if (emailInput) emailInput.value = '';
              if (passwordInput) passwordInput.value = '';
              if (loginError) {
                  loginError.textContent = '';
                  loginError.classList.add('hidden');
              }
              document.title = DEFAULT_TITLE;
          }
          safelyCreateIcons();
      });

      const handleLogin = async () => {
          if (!emailInput || !passwordInput || !loginButton || !loginError || !auth) { if (loginError) { loginError.textContent = "Internal error. Please refresh."; loginError.classList.remove('hidden'); } if (loginButton) loginButton.disabled = true; return; }
          const email = emailInput.value.trim(); const password = passwordInput.value; loginError.textContent = ''; loginError.classList.add('hidden'); if (!email || !password) { loginError.textContent = "Please enter both email and password."; loginError.classList.remove('hidden'); return; }
          loginButton.disabled = true; loginButton.textContent = 'Logging in...';
          try { await signInWithEmailAndPassword(auth, email, password); } catch (error) { console.error("Login Error:", error.code, error.message); let errorMessage = "Login failed. Please check details and try again."; if (error.code === 'auth/invalid-credential' || error.code === 'auth/user-not-found' || error.code === 'auth/wrong-password') { errorMessage = "Invalid email or password."; } else if (error.code === 'auth/network-request-failed') { errorMessage = "Network error. Please check your connection."; } else if (error.code === 'auth/too-many-requests') { errorMessage = "Too many login attempts. Please try again later."; } else if (error.message) { errorMessage = `Login error: ${error.message}`; } loginError.textContent = errorMessage; loginError.classList.remove('hidden'); loginButton.disabled = false; loginButton.textContent = 'Login'; }
      };

      const handleLogout = async () => {
          if (!auth) return;
          stopPomodoroTimer(true);
          await stopBonusTimer();
          if (quizState.active) stopQuizMode();
          try { await signOut(auth); closeMobileMenu(); } catch (error) { console.error("Logout Error:", error); alert("Logout failed. Please try again."); }
       };

      const handleChangePassword = async () => {
            if (!currentPasswordInput || !newPasswordInput || !changePasswordButton || !changePasswordMessage || !auth?.currentUser) { if(changePasswordMessage) { showTemporaryMessage(changePasswordMessage, 'Cannot change password now.', 3000, false); } return; }
            const currentPassword = currentPasswordInput.value; const newPassword = newPasswordInput.value; changePasswordMessage.textContent = ''; changePasswordMessage.className = 'text-sm mt-2 min-h-[1rem]'; if (!currentPassword || !newPassword) { showTemporaryMessage(changePasswordMessage, 'Please enter both current and new passwords.', 3000, false); return; } if (newPassword.length < 6) { showTemporaryMessage(changePasswordMessage, 'New password must be at least 6 characters long.', 3000, false); return; }
            changePasswordButton.disabled = true; changePasswordButton.textContent = 'Changing...';
            try { const user = auth.currentUser; if (!user?.email) throw new Error("User or email not found for reauthentication."); const credential = EmailAuthProvider.credential(user.email, currentPassword); await reauthenticateWithCredential(user, credential); await updatePassword(user, newPassword); showTemporaryMessage(changePasswordMessage, 'Password updated successfully!', 4000, true); currentPasswordInput.value = ''; newPasswordInput.value = ''; } catch (error) { console.error("Change Password Error:", error.code, error.message); let msg = 'Failed to change password. Please try again.'; if (error.code === 'auth/wrong-password' || error.code === 'auth/invalid-credential') { msg = 'Incorrect current password.'; } else if (error.code === 'auth/weak-password') { msg = 'New password is too weak.'; } else if (error.code === 'auth/requires-recent-login') { msg = 'Security check: Please log out and log back in to change password.'; } showTemporaryMessage(changePasswordMessage, msg, 5000, false); } finally { changePasswordButton.disabled = false; changePasswordButton.textContent = 'Change Password'; }
      };

      const applyTheme = (theme) => { if (!htmlElement) return; const newTheme = (theme === 'dark' || theme === 'light') ? theme : 'light'; htmlElement.classList.remove('light', 'dark'); htmlElement.classList.add(newTheme); const isDark = newTheme === 'dark'; themeIconLight?.classList.toggle('hidden', isDark); themeIconDark?.classList.toggle('hidden', !isDark); themeIconLightMobile?.classList.toggle('hidden', isDark); themeIconDarkMobile?.classList.toggle('hidden', !isDark); try { localStorage.setItem('theme', newTheme); } catch (e) { console.warn("Could not save theme preference to localStorage:", e); } updateChartTheme(); safelyCreateIcons(); };
      const toggleTheme = () => { applyTheme(htmlElement?.classList.contains('dark') ? 'light' : 'dark'); };
      const setActiveLink = (pageId) => { navLinks.forEach(link => { if (link instanceof HTMLElement && link.dataset.page) { const isActive = link.dataset.page === pageId; link.classList.toggle('text-primary', isActive); link.classList.toggle('dark:text-primary-dark', isActive); link.classList.toggle('font-semibold', isActive); link.classList.toggle('bg-slate-100', isActive); link.classList.toggle('dark:bg-slate-700', isActive); link.classList.toggle('text-muted', !isActive); link.classList.toggle('dark:text-muted-dark', !isActive); link.classList.toggle('font-medium', !isActive); } }); mobileNavLinks.forEach(link => { if (link instanceof HTMLElement && link.dataset.page) { const isActive = link.dataset.page === pageId; link.classList.toggle('text-primary', isActive); link.classList.toggle('dark:text-primary-dark', isActive); link.classList.toggle('bg-slate-100', isActive); link.classList.toggle('dark:bg-slate-700', isActive); link.classList.toggle('font-semibold', isActive); link.classList.toggle('text-muted', !isActive); link.classList.toggle('dark:text-muted-dark', !isActive); link.classList.toggle('font-medium', !isActive); } }); };
      const showPage = (pageId) => { if (!getElement(pageId)) pageId = 'dashboard'; pages.forEach(page => page?.classList.remove('active')); const targetPage = getElement(pageId); if (targetPage) { targetPage.classList.add('active'); } else { getElement('dashboard')?.classList.add('active'); pageId = 'dashboard'; } setActiveLink(pageId); window.scrollTo(0, 0); if (targetSubjectParam && targetSubjectParam.page === pageId) { handleSubjectSelection(targetSubjectParam.subject, pageId); targetSubjectParam = null; } if (pageId === 'dashboard' && currentUserId) { loadDashboard(); } else if (pageId === 'pomodoro' && currentUserId) { displayPomodoroSubjectTimes(); updateWonTimeDisplayOnPomodoro(); updatePomodoroUIState(pomodoroState.timerState); } else if (pageId === 'timetable') { updateTimetableCountdowns(); } if (openAddSectionFlag && openAddSectionFlag.page === pageId) { const detailsElement = getElement(openAddSectionFlag.detailsId); if (detailsElement instanceof HTMLDetailsElement) { detailsElement.open = true; detailsElement.scrollIntoView({ behavior: 'smooth', block: 'nearest' }); } openAddSectionFlag = null; } if (pageId !== 'quiz' && quizState.active && !quizState.isSpinnerModalOpen) { stopQuizMode(); } safelyCreateIcons(); };
      const _navigateToPage = (pageId, param = null, openDetailsId = null) => { targetSubjectParam = (param && ['resources', 'tracker', 'quiz'].includes(pageId)) ? { page: pageId, subject: param } : null; if (!['resources', 'tracker', 'quiz'].includes(pageId)) { currentActiveSubject = null; } openAddSectionFlag = openDetailsId ? { page: pageId, detailsId: openDetailsId } : null; showPage(pageId); closeMobileMenu(); };
      window.navigateToPage = _navigateToPage;
      const openMobileMenu = () => { mobileMenu?.classList.add('open'); mobileOverlay?.classList.remove('hidden'); requestAnimationFrame(() => { mobileOverlay?.classList.add('visible'); }); };
      const closeMobileMenu = () => { mobileOverlay?.classList.remove('visible'); mobileMenu?.classList.remove('open'); setTimeout(() => mobileOverlay?.classList.add('hidden'), 350); };
      const createLoadingMessage = (text = "Loading...", isTableRow = false, colspan = 1) => { const p = document.createElement('p'); p.className = 'text-muted dark:text-muted-dark italic p-4 text-center text-sm'; p.textContent = text; if (isTableRow) { const td = document.createElement('td'); td.colSpan = colspan; td.className = 'p-4 text-center'; td.appendChild(p); const tr = document.createElement('tr'); tr.appendChild(td); return tr.outerHTML; } return p.outerHTML; };
      const clearDynamicContentAndIntervals = () => { if (countdownInterval) clearInterval(countdownInterval); if (pomodoroInterval) clearInterval(pomodoroInterval); if (bonusTimerInterval) clearInterval(bonusTimerInterval); countdownInterval = null; pomodoroInterval = null; bonusTimerInterval = null; document.title = DEFAULT_TITLE; if (studyTimeChart) { studyTimeChart.destroy(); studyTimeChart = null; } if (chartLoadingMessage) chartLoadingMessage.style.display = 'flex'; if (upcomingExamsList) upcomingExamsList.innerHTML = createLoadingMessage(); if (pomodoroSummary) pomodoroSummary.innerHTML = createLoadingMessage('No sessions logged.'); if (analyticsTotalTimeEl) analyticsTotalTimeEl.textContent = '--:--'; if (analyticsTotalSessionsEl) analyticsTotalSessionsEl.textContent = '0'; if (motivationalQuoteEl) motivationalQuoteEl.textContent = 'Loading quote...'; if (dailyGoalTargetEl) dailyGoalTargetEl.textContent = 'Loading...'; if (dailyGoalCompletedEl) dailyGoalCompletedEl.textContent = 'Loading...'; if (dailyGoalProgressBarFill) dailyGoalProgressBarFill.style.width = '0%'; if (dailyGoalPercentageEl) dailyGoalPercentageEl.textContent = '0%'; if (saveGoalsMessage) saveGoalsMessage.textContent = ''; Object.values(goalInputs).forEach(input => { if (input) input.value = ''; }); if (setGoalsDetails) setGoalsDetails.removeAttribute('open'); if (timetableBody) timetableBody.innerHTML = createLoadingMessage('Loading timetable...', true, 6); if (subjectTabsContainer) subjectTabsContainer.innerHTML = ''; if (resourceContent) resourceContent.innerHTML = createLoadingMessage('Select a subject.'); if (addResourceDetails) { addResourceDetails.style.display = 'none'; addResourceDetails.removeAttribute('open'); } if (resourceTitleInput) resourceTitleInput.value = ''; if (resourceUrlInput) resourceUrlInput.value = ''; if (resourceNoteInput) resourceNoteInput.value = ''; if (resourceTypeSelect) resourceTypeSelect.value = 'link'; if (trackerSubjectSelect) trackerSubjectSelect.value = ''; if (trackerItemsList) trackerItemsList.innerHTML = createLoadingMessage('Select a subject.'); if (addTrackerDetails) { addTrackerDetails.style.display = 'none'; addTrackerDetails.removeAttribute('open'); } if (trackerDescriptionInput) trackerDescriptionInput.value = ''; if (trackerStatusSelect) trackerStatusSelect.value = 'To Review'; if (plannerSubjectSelect) plannerSubjectSelect.value = ''; if (plannerItemsList) plannerItemsList.innerHTML = createLoadingMessage('No sessions scheduled.'); if (plannerDateInput) plannerDateInput.value = ''; if (plannerTimeInput) plannerTimeInput.value = ''; if (plannerTopicInput) plannerTopicInput.value = ''; if (quizSubjectSelect) quizSubjectSelect.value = ''; if (quizContentWrapper) quizContentWrapper.classList.add('hidden'); if (quizItemsList) quizItemsList.innerHTML = createLoadingMessage('Select a subject.'); if (addQuizDetails) { addQuizDetails.style.display = 'none'; addQuizDetails.removeAttribute('open'); } if (quizModeInterface) quizModeInterface.classList.add('hidden'); if (quizQuestionInput) quizQuestionInput.value = ''; if (quizAnswerInput) quizAnswerInput.value = ''; if (quizQuestionFileInput) quizQuestionFileInput.value = ''; if (quizAnswerFileInput) quizAnswerFileInput.value = ''; if (quizQuestionFilenameEl) quizQuestionFilenameEl.textContent = ''; if (clearQuizQuestionFileBtn) clearQuizQuestionFileBtn.classList.add('hidden'); if (quizAnswerFilenameEl) quizAnswerFilenameEl.textContent = ''; if (clearQuizAnswerFileBtn) clearQuizAnswerFileBtn.classList.add('hidden'); if (quizPaperSelect) quizPaperSelect.innerHTML = '<option value="General">General</option>'; if (currentPasswordInput) currentPasswordInput.value = ''; if (newPasswordInput) newPasswordInput.value = ''; if (changePasswordMessage) changePasswordMessage.textContent = ''; resetPomodoroTimer(true); stopBonusTimer(); wonTimeSeconds = 0; isBonusTimerRunning = false; quizState = { active: false, currentSubject: null, currentPaperSelection: 'All', initialQuestions: [], currentQuizPool: [], incorrectlyAnswered: [], currentQuestionIndex: -1, round: 1, totalMastered: 0, isAnswerVisible: false, buttonTimeout: null, correctAnswersInSession: 0, isSpinnerModalOpen: false, spinJustFinished: false }; currentActiveSubject = null; targetSubjectParam = null; openAddSectionFlag = null; };

      const loadDashboard = async () => { if (!currentUserId || !db || !getElement('dashboard')?.classList.contains('active')) { return; } if (upcomingExamsList) { upcomingExamsList.innerHTML = createLoadingMessage('Loading exams...'); try { const now = new Date(); const futureExams = examData.filter(exam => new Date(exam.date) > now).slice(0, 5); upcomingExamsList.innerHTML = ''; if (futureExams.length > 0) { futureExams.forEach((exam, index) => { const div = document.createElement('div'); const colorInfo = getSubjectColorInfo(exam.subject); div.className = `upcoming-exam-item p-3 rounded-lg border-l-4 ${colorInfo.borderClass} bg-background dark:bg-slate-800/50 shadow-sm list-item list-item-appear cursor-pointer hover:shadow-md dark:hover:shadow-widget-hover-dark`; div.style.animationDelay = `${index * 0.07}s`; div.dataset.page = "resources"; div.dataset.subject = exam.subject; div.setAttribute('role', 'button'); div.setAttribute('tabindex', '0'); div.onclick = () => window.navigateToPage('resources', exam.subject); div.onkeydown = (e) => { if (e.key === 'Enter' || e.key === ' ') window.navigateToPage('resources', exam.subject); }; div.innerHTML = `<div class="flex justify-between items-center mb-1 pointer-events-none"><span class="font-semibold text-text dark:text-text-dark">${escapeHtml(exam.subject)}</span><span class="text-xs font-medium ${colorInfo.textClass}" data-date="${exam.date}">${formatCountdown(exam.date)}</span></div><p class="text-xs text-muted dark:text-muted-dark pointer-events-none">${escapeHtml(exam.paper)} (${formatDurationString(exam.duration)})</p><p class="text-xs text-muted dark:text-muted-dark pointer-events-none">${formatExamDate(exam.date)}</p>`; upcomingExamsList.appendChild(div); }); applyStaggerAnimation(upcomingExamsList.children); } else { upcomingExamsList.innerHTML = createLoadingMessage('No upcoming exams found.'); } } catch (e) { console.error("Error rendering upcoming exams:", e); if (upcomingExamsList) upcomingExamsList.innerHTML = createLoadingMessage('Error loading exams.'); } } await updateAnalyticsDisplay(pomodoroSummary); if (motivationalQuoteEl) { motivationalQuoteEl.textContent = motivationalQuotes[Math.floor(Math.random() * motivationalQuotes.length)]; } if (dailyGoalTargetEl && dailyGoalCompletedEl && dailyGoalProgressBarFill && dailyGoalPercentageEl) { dailyGoalTargetEl.textContent = 'Loading...'; dailyGoalCompletedEl.textContent = 'Loading...'; dailyGoalProgressBarFill.style.width = '0%'; dailyGoalPercentageEl.textContent = '0%'; try { const goalsRef = getUserDataRef(currentUserId, 'settings/dailyGoals'); const goalsSnap = await getDoc(goalsRef); const dailyGoals = goalsSnap.exists() ? goalsSnap.data() : {}; const todayStr = getTodayDateString(); const progressRef = getUserDataRef(currentUserId, `dailyProgress/${todayStr}`); const progressSnap = await getDoc(progressRef); const todayProgress = progressSnap.exists() ? progressSnap.data() : { totalMinutes: 0 }; const completedMinutes = todayProgress.totalMinutes || 0; const todayDayName = getDayName(new Date().getDay()); const goalMinutes = dailyGoals[todayDayName] || 0; dailyGoalTargetEl.textContent = formatMinutesToHHMM(goalMinutes); dailyGoalCompletedEl.textContent = formatMinutesToHHMM(completedMinutes); let percentage = 0; if (goalMinutes > 0) { percentage = Math.min(100, Math.round((completedMinutes / goalMinutes) * 100)); } else if (completedMinutes > 0) { percentage = 100; } dailyGoalProgressBarFill.style.width = `${percentage}%`; dailyGoalPercentageEl.textContent = `${percentage}%`; loadDailyGoalInputs(dailyGoals); } catch (error) { console.error("Error loading daily goal data:", error); dailyGoalTargetEl.textContent = 'Error'; dailyGoalCompletedEl.textContent = 'Error'; dailyGoalPercentageEl.textContent = 'Error'; } } else { console.warn("Daily goal UI elements not found."); } safelyCreateIcons(); };
      const updateAnalyticsDisplay = async (pomodoroSummaryEl) => { if (!currentUserId || !db) return; if (analyticsTotalTimeEl) analyticsTotalTimeEl.textContent = '--:--'; if (analyticsTotalSessionsEl) analyticsTotalSessionsEl.textContent = '0'; if (pomodoroSummaryEl) pomodoroSummaryEl.innerHTML = createLoadingMessage('Loading sessions...'); if (chartLoadingMessage) chartLoadingMessage.style.display = 'flex'; try { const analyticsRef = getUserDataRef(currentUserId, 'stats/pomodoroAnalytics'); if (!analyticsRef) throw new Error("Could not get analytics ref."); const analyticsDoc = await getDoc(analyticsRef); let analyticsData = { totalMinutes: 0, totalSessions: 0, subjectMinutes: {} }; if (analyticsDoc.exists()) { analyticsData = analyticsDoc.data(); } const totalMins = analyticsData.totalMinutes || 0; const totalSessions = analyticsData.totalSessions || 0; const subjectMins = (analyticsData.subjectMinutes && typeof analyticsData.subjectMinutes === 'object') ? analyticsData.subjectMinutes : {}; if (analyticsTotalTimeEl) analyticsTotalTimeEl.textContent = formatMinutesToHHMM(totalMins); if (analyticsTotalSessionsEl) analyticsTotalSessionsEl.textContent = totalSessions; updateStudyTimeChart(subjectMins); const logColl = getUserCollectionRef(currentUserId, 'pomodoroLogs'); if (!logColl) throw new Error("Could not get pomodoro logs ref."); const logQuery = query(logColl, orderBy("timestamp", "desc"), limit(5)); const logSnapshot = await getDocs(logQuery); if (pomodoroSummaryEl) { pomodoroSummaryEl.innerHTML = ''; if (logSnapshot.empty) { pomodoroSummaryEl.innerHTML = createLoadingMessage('No recent study sessions.'); } else { logSnapshot.docs.forEach((logDoc, index) => { const data = logDoc.data(); const p = document.createElement('p'); p.className = 'text-xs text-muted dark:text-muted-dark list-item-appear border-b border-slate-100 dark:border-slate-700/50 pb-1.5 mb-1.5 last:border-b-0'; p.style.animationDelay = `${index * 0.06}s`; const dateStr = data.timestamp ? formatGeneralDate(data.timestamp) : 'Recent'; const colorInfo = getSubjectColorInfo(data.subject || 'Unknown Subject'); p.innerHTML = `<i data-lucide="check-circle" class="h-3 w-3 ${colorInfo.textClass} mr-1.5 inline-block align-middle"></i> <span class="font-medium text-text dark:text-text-dark">${escapeHtml(data.subject || 'Unknown Subject')}</span> - ${formatMinutesToHHMM(data.durationMinutes || 0)} <span class="text-gray-400 dark:text-gray-500">(${dateStr})</span>`; pomodoroSummaryEl.appendChild(p); }); safelyCreateIcons(); applyStaggerAnimation(pomodoroSummaryEl.children); } } } catch (error) { console.error("Error loading study insights:", error); if (pomodoroSummaryEl) pomodoroSummaryEl.innerHTML = createLoadingMessage('Error loading sessions.'); if (chartLoadingMessage) chartLoadingMessage.textContent = 'Error loading chart.'; if (analyticsTotalTimeEl) analyticsTotalTimeEl.textContent = 'Error'; if (analyticsTotalSessionsEl) analyticsTotalSessionsEl.textContent = 'Error'; } };
      const updateStudyTimeChart = (subjectMinutes) => { if (!studyTimeChartCanvas || typeof Chart === 'undefined') { if(chartLoadingMessage) chartLoadingMessage.textContent = 'Chart unavailable.'; return; } const sortedSubjects = Object.entries(subjectMinutes).sort(([,a], [,b]) => b - a).slice(0, 7); if (sortedSubjects.length === 0) { if(chartLoadingMessage) { chartLoadingMessage.textContent = 'No study time tracked yet.'; chartLoadingMessage.style.display = 'flex'; } if (studyTimeChart) { studyTimeChart.destroy(); studyTimeChart = null; } return; } if(chartLoadingMessage) chartLoadingMessage.style.display = 'none'; const labels = sortedSubjects.map(([key]) => { const originalSubject = subjects.find(s => s.replace(/[.*$#[\]/]/g, '_') === key) || key; return originalSubject; }); const data = sortedSubjects.map(([, mins]) => mins); const backgroundColors = sortedSubjects.map(([key]) => { const originalSubject = subjects.find(s => s.replace(/[.*$#[\]/]/g, '_') === key) || key; return getSubjectColorInfo(originalSubject).hex; }); const chartData = { labels: labels, datasets: [{ label: 'Minutes Studied', data: data, backgroundColor: backgroundColors, borderColor: backgroundColors.map(hex => hex + 'B3'), borderWidth: 1, borderRadius: 4, barThickness: 'flex', maxBarThickness: 30 }] }; const isDarkMode = htmlElement?.classList.contains('dark'); const gridColor = isDarkMode ? 'rgba(255, 255, 255, 0.1)' : 'rgba(0, 0, 0, 0.1)'; const labelColor = isDarkMode ? getCssVariable('--color-text-dark') : getCssVariable('--color-text-DEFAULT'); const tooltipBgColor = isDarkMode ? getCssVariable('--color-card-dark') : getCssVariable('--color-card-DEFAULT'); const tooltipTitleColor = labelColor; const tooltipBodyColor = isDarkMode ? getCssVariable('--color-muted-dark') : getCssVariable('--color-muted-DEFAULT'); const options = { responsive: true, maintainAspectRatio: false, indexAxis: 'y', scales: { x: { beginAtZero: true, title: { display: true, text: 'Minutes', color: labelColor }, grid: { color: gridColor }, ticks: { color: labelColor } }, y: { grid: { display: false }, ticks: { color: labelColor } } }, plugins: { legend: { display: false }, tooltip: { backgroundColor: tooltipBgColor, titleColor: tooltipTitleColor, bodyColor: tooltipBodyColor, borderColor: gridColor, borderWidth: 1, callbacks: { label: function(context) { let label = context.dataset.label || ''; if (label) { label += ': '; } if (context.parsed.x !== null) { label += formatMinutesToHHMM(context.parsed.x); } return label; } } } } }; if (studyTimeChart) { studyTimeChart.destroy(); } try { studyTimeChart = new Chart(studyTimeChartCanvas, { type: 'bar', data: chartData, options: options }); } catch (e) { console.error("Failed to create chart:", e); if (chartLoadingMessage) { chartLoadingMessage.textContent = 'Error displaying chart.'; chartLoadingMessage.style.display = 'flex'; } } };
      const updateChartTheme = () => { if (!studyTimeChart || typeof Chart === 'undefined') return; const isDarkMode = htmlElement?.classList.contains('dark'); const gridColor = isDarkMode ? 'rgba(255, 255, 255, 0.1)' : 'rgba(0, 0, 0, 0.1)'; const labelColor = isDarkMode ? getCssVariable('--color-text-dark') : getCssVariable('--color-text-DEFAULT'); const tooltipBgColor = isDarkMode ? getCssVariable('--color-card-dark') : getCssVariable('--color-card-DEFAULT'); const tooltipTitleColor = labelColor; const tooltipBodyColor = isDarkMode ? getCssVariable('--color-muted-dark') : getCssVariable('--color-muted-DEFAULT'); studyTimeChart.options.scales.x.title.color = labelColor; studyTimeChart.options.scales.x.grid.color = gridColor; studyTimeChart.options.scales.x.ticks.color = labelColor; studyTimeChart.options.scales.y.ticks.color = labelColor; studyTimeChart.options.plugins.tooltip.backgroundColor = tooltipBgColor; studyTimeChart.options.plugins.tooltip.titleColor = tooltipTitleColor; studyTimeChart.options.plugins.tooltip.bodyColor = tooltipBodyColor; studyTimeChart.options.plugins.tooltip.borderColor = gridColor; studyTimeChart.update(); };

      const loadDailyGoalInputs = (goalsData = {}) => { if (!goalInputs.monday) return; dayNames.forEach(day => { const input = goalInputs[day]; if (input instanceof HTMLInputElement) { input.value = goalsData[day] || 0; } }); };
      const saveDailyGoals = async () => { if (!currentUserId || !db || !saveDailyGoalsBtn || !saveGoalsMessage) { alert("Cannot save goals: Missing user, DB connection or UI elements."); return; } saveDailyGoalsBtn.disabled = true; saveDailyGoalsBtn.textContent = 'Saving...'; saveGoalsMessage.textContent = ''; saveGoalsMessage.className = 'text-xs text-center h-4 mt-1'; const newGoals = {}; let hasError = false; try { dayNames.forEach(day => { const input = goalInputs[day]; if (input instanceof HTMLInputElement) { const value = parseInt(input.value, 10); if (!isNaN(value) && value >= 0) { newGoals[day] = value; } else { newGoals[day] = 0; input.value = 0; } } }); if (Object.keys(newGoals).length !== 7) { throw new Error("Could not read all day inputs."); } const goalsRef = getUserDataRef(currentUserId, 'settings/dailyGoals'); if (!goalsRef) throw new Error("Could not get reference to save goals."); await setDoc(goalsRef, newGoals); showTemporaryMessage(saveGoalsMessage, 'Goals saved successfully!', 4000, true); await loadDashboard(); } catch (error) { hasError = true; console.error("Error saving daily goals:", error); showTemporaryMessage(saveGoalsMessage, 'Error saving goals.', 5000, false); alert(`Failed to save goals: ${error.message}`); } finally { saveDailyGoalsBtn.disabled = false; saveDailyGoalsBtn.textContent = 'Save Goals'; } };

      const loadTimetable = () => { if (!timetableBody) { return; } timetableBody.innerHTML = ''; let lastDateStr = null; if (!examData || examData.length === 0) { timetableBody.innerHTML = createLoadingMessage('Timetable data unavailable.', true, 6); return; } examData.forEach((exam, index) => { try { const tr = document.createElement('tr'); const currentDate = new Date(exam.date); if (isNaN(currentDate.getTime())) { return; } const currentDateStr = currentDate.toDateString(); if (lastDateStr && currentDateStr !== lastDateStr) { tr.classList.add('timetable-new-day'); } lastDateStr = currentDateStr; const colorInfo = getSubjectColorInfo(exam.subject); tr.classList.add('text-sm', 'align-middle'); tr.innerHTML = `<td class="timetable-subject-cell pl-4 pr-3 py-4 font-medium text-text dark:text-text-dark whitespace-nowrap border-l-4 ${colorInfo.borderClass}" style="--subject-rgb: ${colorInfo.rgb};"><span class="timetable-subject-text ${colorInfo.textClass}">${escapeHtml(exam.subject)}</span><br><span class="text-xs text-muted dark:text-muted-dark">${escapeHtml(exam.paper)}</span></td><td class="px-3 py-4 text-muted dark:text-muted-dark whitespace-nowrap">${formatExamDate(exam.date)}</td><td class="px-3 py-4 text-muted dark:text-muted-dark whitespace-nowrap">${formatDurationString(exam.duration)}</td><td class="px-3 py-4 text-muted dark:text-muted-dark whitespace-nowrap">${escapeHtml(exam.board)}${exam.tier ? ` (${escapeHtml(exam.tier)})` : ''}</td><td class="px-3 py-4 text-muted dark:text-muted-dark whitespace-nowrap">${escapeHtml(exam.location || 'N/A')}${exam.seat ? ` (Seat: ${escapeHtml(exam.seat)})` : ''}</td><td class="pl-3 pr-4 py-4 text-muted dark:text-muted-dark whitespace-nowrap countdown-cell" data-date="${exam.date}">${formatCountdown(exam.date)}</td>`; timetableBody.appendChild(tr); } catch (rowError) { console.error(`Error creating timetable row ${index}:`, rowError, exam); } }); safelyCreateIcons(); };
      const updateTimetableCountdowns = () => { if (!appWrapper || appWrapper.classList.contains('hidden') || !currentUserId) return; document.querySelectorAll('.countdown-cell[data-date]').forEach(cell => { if (cell instanceof HTMLElement && cell.dataset.date) { cell.innerHTML = formatCountdown(cell.dataset.date); } }); getElement('upcoming-exams-list')?.querySelectorAll('[data-date]').forEach(span => { if (span instanceof HTMLElement && span.dataset.date) { span.innerHTML = formatCountdown(span.dataset.date); } }); };

      const animateContentSwitch = async (containerElement, displayFunction, subject) => { if (!containerElement) return; containerElement.classList.add('content-fade-out'); await new Promise(resolve => setTimeout(resolve, 150)); containerElement.innerHTML = ''; containerElement.classList.remove('content-fade-out'); containerElement.innerHTML = createLoadingMessage(`Loading ${subject || ''}...`); try { await displayFunction(subject); } catch (e) { console.error(`Error during display function for ${subject} in animateContentSwitch:`, e); containerElement.innerHTML = createLoadingMessage(`Error loading content for ${subject}.`, false); } if (!containerElement.innerHTML.includes('Error loading')) { containerElement.classList.add('content-fade-in'); setTimeout(() => containerElement.classList.remove('content-fade-in'), 300); } };

      const handleSubjectSelection = (subject, context) => { const isValidSubject = subject && subjects.includes(subject); currentActiveSubject = isValidSubject ? subject : null; const toggleDetailsVisibility = (detailsId) => { const detailsElement = getElement(detailsId); if (detailsElement instanceof HTMLDetailsElement) { detailsElement.style.display = isValidSubject ? 'block' : 'none'; if (!isValidSubject && detailsElement.open) { detailsElement.open = false; } } }; if (context === 'resources') { setActiveSubjectTab(currentActiveSubject); toggleDetailsVisibility('add-resource-details'); if (isValidSubject) { if(resourceTitleInput) resourceTitleInput.value = ''; if(resourceUrlInput) resourceUrlInput.value = ''; if(resourceNoteInput) resourceNoteInput.value = ''; if(resourceTypeSelect) resourceTypeSelect.value = 'link'; toggleResourceTypeFields(); validateResourceForm(); animateContentSwitch(resourceContent, displayResources, currentActiveSubject); } else { if(resourceContent) resourceContent.innerHTML = createLoadingMessage('Select a subject tab above.'); } } else if (context === 'tracker') { toggleDetailsVisibility('add-tracker-details'); if (isValidSubject) { if(trackerDescriptionInput) trackerDescriptionInput.value = ''; if(trackerStatusSelect) trackerStatusSelect.value = 'To Review'; validateTrackerForm(); animateContentSwitch(trackerItemsList, displayTrackerItems, currentActiveSubject); } else { if(trackerItemsList) trackerItemsList.innerHTML = createLoadingMessage('Select a subject.'); } } else if (context === 'quiz') { stopQuizMode(); toggleDetailsVisibility('add-quiz-details'); if (quizContentWrapper) quizContentWrapper.classList.toggle('hidden', !isValidSubject); if (isValidSubject) { if(quizQuestionInput) quizQuestionInput.value = ''; if(quizAnswerInput) quizAnswerInput.value = ''; if(quizQuestionFileInput) quizQuestionFileInput.value = ''; if(quizAnswerFileInput) quizAnswerFileInput.value = ''; if(quizQuestionFilenameEl) quizQuestionFilenameEl.textContent = ''; if(clearQuizQuestionFileBtn) clearQuizQuestionFileBtn.classList.add('hidden'); if(quizAnswerFilenameEl) quizAnswerFilenameEl.textContent = ''; if(clearQuizAnswerFileBtn) clearQuizAnswerFileBtn.classList.add('hidden'); populateQuizPaperOptions(currentActiveSubject); validateQuizForm(); animateContentSwitch(quizItemsList, displaySavedQuizQuestions, currentActiveSubject); } else { if(quizItemsList) quizItemsList.innerHTML = createLoadingMessage('Select a subject.'); toggleQuizButtons(); populateQuizPaperOptions(null); } } };

      const loadResources = () => { if (!subjectTabsContainer) { return; } subjectTabsContainer.innerHTML = ''; if (!subjects || subjects.length === 0) { subjectTabsContainer.innerHTML = '<p class="text-sm text-muted p-2">No subjects defined.</p>'; return; } subjects.forEach(subject => { const button = document.createElement('button'); button.setAttribute('role', 'tab'); button.setAttribute('aria-selected', 'false'); button.dataset.subject = subject; button.className = `subject-tab whitespace-nowrap py-2 px-3 text-sm font-medium rounded-t-lg border-b-2 border-transparent text-muted dark:text-muted-dark hover:text-primary dark:hover:text-primary-dark hover:border-slate-300 dark:hover:border-slate-600 focus:outline-none focus-visible:ring-1 focus-visible:ring-primary focus-visible:ring-offset-1 transition-colors duration-150`; button.textContent = subject; subjectTabsContainer.appendChild(button); }); if (addResourceDetails) addResourceDetails.style.display = 'none'; if(resourceContent) resourceContent.innerHTML = createLoadingMessage('Select a subject tab above.'); validateResourceForm(); };
      const toggleResourceTypeFields = (isEditModal = false) => {
            const typeSelect = isEditModal ? editResourceTypeSelect : resourceTypeSelect;
            const urlWrapper = isEditModal ? editResourceUrlWrapper : resourceUrlWrapper;
            const noteWrapper = isEditModal ? editResourceNoteWrapper : resourceNoteWrapper;
            const urlInput = isEditModal ? editResourceUrlInput : resourceUrlInput;
            const noteInput = isEditModal ? editResourceNoteInput : resourceNoteInput;

            if (!typeSelect || !urlWrapper || !noteWrapper) return;
            const isLink = typeSelect.value === 'link';
            urlWrapper.classList.toggle('visible', isLink);
            noteWrapper.classList.toggle('visible', !isLink);
            if (isLink && noteInput && noteInput.value && !isEditModal) noteInput.value = ''; // Only clear if not edit modal or value is already there during edit
            else if (!isLink && urlInput && urlInput.value && !isEditModal) urlInput.value = '';

            if (isEditModal) validateEditResourceForm(); else validateResourceForm();
      };
      const validateResourceForm = () => { if (!saveResourceBtn || !resourceTitleInput || !resourceTypeSelect) { if(saveResourceBtn) saveResourceBtn.disabled = true; return; } let isValid = !!currentActiveSubject && resourceTitleInput.value.trim() !== ''; if (isValid) { if (resourceTypeSelect.value === 'link') { isValid = resourceUrlInput && resourceUrlInput.value.trim() !== '' && resourceUrlInput.checkValidity(); } else if (resourceTypeSelect.value === 'note') { isValid = resourceNoteInput && resourceNoteInput.value.trim() !== ''; } else { isValid = false; } } saveResourceBtn.disabled = !isValid; };
      const setActiveSubjectTab = (subject) => { document.querySelectorAll('#subject-tabs .subject-tab').forEach(tab => { if (tab instanceof HTMLElement && tab.dataset.subject) { const isSelected = tab.dataset.subject === subject; tab.setAttribute('aria-selected', isSelected.toString()); tab.classList.toggle('border-primary', isSelected); tab.classList.toggle('dark:border-primary-dark', isSelected); tab.classList.toggle('text-primary', isSelected); tab.classList.toggle('dark:text-primary-dark', isSelected); tab.classList.toggle('font-semibold', isSelected); tab.classList.toggle('border-transparent', !isSelected); tab.classList.toggle('text-muted', !isSelected); tab.classList.toggle('dark:text-muted-dark', !isSelected); tab.classList.toggle('font-medium', !isSelected); } }); };
      const displayResources = async (subject) => {
          if (!currentUserId || !resourceContent || !db) {
              if (resourceContent) resourceContent.innerHTML = createLoadingMessage('Cannot load resources: Not logged in or DB unavailable.');
              return;
          }
          resourceContent.innerHTML = createLoadingMessage(`Loading ${subject} resources...`);
          try {
              const collRef = getSubjectSpecificCollectionRef(currentUserId, 'resources', subject);
              if (!collRef) throw new Error("Could not get resources collection ref.");
              const q = query(collRef, orderBy("createdAt", "desc"));
              const snapshot = await getDocs(q);
              const items = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
              resourceContent.innerHTML = '';

              if (items.length === 0) {
                  resourceContent.innerHTML = createLoadingMessage(`No resources saved for ${subject} yet.`);
              } else {
                  const ul = document.createElement('ul');
                  ul.className = 'space-y-3';
                  items.forEach((item, index) => {
                      const li = document.createElement('li');
                      const itemSubject = item.subject || subject;
                      const colorInfo = getSubjectColorInfo(itemSubject);
                      li.className = `resource-item list-item flex justify-between items-start p-3 rounded-lg border ${colorInfo.borderClass.replace('border-l-4', 'border')} bg-background dark:bg-slate-800/50 hover:bg-slate-50 dark:hover:bg-slate-700/50 transition-all duration-150 space-x-3 list-item-appear`;
                      li.style.animationDelay = `${index * 0.06}s`;

                      let contentHtml = '';
                      if (item.type === 'link' && item.url) {
                          contentHtml = `<a href="${escapeHtml(item.url)}" target="_blank" rel="noopener noreferrer" class="flex items-center space-x-2 group focus-visible:outline focus-visible:outline-1 focus-visible:outline-primary rounded -m-1 p-1"><i data-lucide="link" class="h-4 w-4 text-primary dark:text-primary-dark flex-shrink-0"></i><span class="font-medium text-sm text-text dark:text-text-dark group-hover:underline">${escapeHtml(item.title)}</span><i data-lucide="external-link" class="h-3 w-3 text-muted dark:text-muted-dark opacity-0 group-hover:opacity-100 transition-opacity"></i></a>`;
                      } else if (item.type === 'note') {
                          contentHtml = `<div class="flex items-start space-x-2"><i data-lucide="notebook-pen" class="h-4 w-4 text-secondary dark:text-secondary-dark flex-shrink-0 mt-0.5"></i><div><p class="font-medium text-sm text-text dark:text-text-dark">${escapeHtml(item.title)}</p><p class="text-xs text-muted dark:text-muted-dark mt-1 whitespace-pre-wrap">${escapeHtml(item.noteContent || '')}</p></div></div>`;
                      } else {
                          contentHtml = `<p class="font-medium text-sm text-text dark:text-text-dark">${escapeHtml(item.title)}</p>`;
                      }

                      const actionsHtml = `
                          <div class="flex-shrink-0 flex items-center space-x-1">
                              <button title="Edit Resource" class="list-action-btn edit p-1 -m-1 rounded-full btn-animated focus-visible:ring-1 focus-visible:ring-primary" data-resource-id="${item.id}"><i data-lucide="edit-3" class="h-4 w-4"></i></button>
                              <button title="Delete Resource" class="list-action-btn delete p-1 -m-1 rounded-full btn-animated focus-visible:ring-1 focus-visible:ring-red-500" onclick="window.handleGenericDeleteItem('resources', '${escapeHtml(subject)}', '${item.id}', 'resource', window.displayResources)"><i data-lucide="trash-2" class="h-4 w-4"></i></button>
                          </div>`;

                      li.innerHTML = `<div class="flex-grow mr-2 overflow-hidden">${contentHtml}</div>${actionsHtml}`;
                      ul.appendChild(li);

                      const editBtn = li.querySelector('.list-action-btn.edit');
                      editBtn?.addEventListener('click', () => {
                          openEditResourceModal(item.id, subject, item);
                      });
                  });
                  resourceContent.appendChild(ul);
                  safelyCreateIcons();
              }
          } catch (error) {
              console.error(`Error loading resources for ${subject}:`, error);
              resourceContent.innerHTML = createLoadingMessage(`Error loading resources for ${subject}. Check console.`);
          }
      };
      window.displayResources = displayResources;
      const handleSaveResource = async () => { if (!currentUserId || !currentActiveSubject || !saveResourceBtn || !db) { alert("Cannot save resource: Missing user, subject, or database connection."); return; } validateResourceForm(); if (saveResourceBtn.disabled) return; const type = resourceTypeSelect?.value; const title = resourceTitleInput?.value.trim(); const url = resourceUrlInput?.value.trim(); const noteContent = resourceNoteInput?.value.trim(); if (!type || !title || (type === 'link' && !url) || (type === 'note' && !noteContent)) { validateResourceForm(); return; } const newResource = { title, type, createdAt: serverTimestamp(), subject: currentActiveSubject }; if (type === 'link') newResource.url = url; else if (type === 'note') newResource.noteContent = noteContent; saveResourceBtn.disabled = true; saveResourceBtn.textContent = 'Saving...'; try { const collRef = getSubjectSpecificCollectionRef(currentUserId, 'resources', currentActiveSubject); if (!collRef) throw new Error("Could not get resources collection ref."); await addDoc(collRef, newResource); if (resourceTitleInput) resourceTitleInput.value = ''; if (resourceUrlInput) resourceUrlInput.value = ''; if (resourceNoteInput) resourceNoteInput.value = ''; if (resourceTypeSelect) resourceTypeSelect.value = 'link'; toggleResourceTypeFields(); if (addResourceDetails) addResourceDetails.open = false; displayResources(currentActiveSubject); } catch (error) { console.error("Error saving resource:", error); alert("Failed to save resource. Please try again."); } finally { saveResourceBtn.disabled = false; saveResourceBtn.textContent = 'Add Resource'; validateResourceForm(); } };

      // Edit Resource Modal Functions
      const openEditResourceModal = (resourceId, subject, resourceData) => {
          if (!editResourceModal || !editResourceIdInput || !editResourceSubjectInput ||
              !editResourceTitleInput || !editResourceTypeSelect || !editResourceUrlInput ||
              !editResourceNoteInput || !editResourceErrorMessage) return;

          editResourceIdInput.value = resourceId;
          editResourceSubjectInput.value = subject;
          editResourceTitleInput.value = resourceData.title || '';
          editResourceTypeSelect.value = resourceData.type || 'link';
          editResourceUrlInput.value = resourceData.url || '';
          editResourceNoteInput.value = resourceData.noteContent || '';
          editResourceErrorMessage.textContent = '';

          toggleResourceTypeFields(true);
          validateEditResourceForm();

          editResourceModal.classList.remove('hidden');
          safelyCreateIcons();
      };

      const closeEditResourceModal = () => {
          if (editResourceModal) editResourceModal.classList.add('hidden');
          if (editResourceErrorMessage) editResourceErrorMessage.textContent = '';
      };

      const validateEditResourceForm = () => {
          if (!saveResourceChangesBtn || !editResourceTitleInput || !editResourceTypeSelect) {
              if (saveResourceChangesBtn) saveResourceChangesBtn.disabled = true;
              return;
          }
          let isValid = editResourceTitleInput.value.trim() !== '';
          if (isValid) {
              if (editResourceTypeSelect.value === 'link') {
                  isValid = editResourceUrlInput && editResourceUrlInput.value.trim() !== '' && editResourceUrlInput.checkValidity();
              } else if (editResourceTypeSelect.value === 'note') {
                  isValid = editResourceNoteInput && editResourceNoteInput.value.trim() !== '';
              } else {
                  isValid = false;
              }
          }
          saveResourceChangesBtn.disabled = !isValid;
      };

      const handleSaveResourceChanges = async () => {
          if (!currentUserId || !db || !editResourceIdInput || !editResourceSubjectInput ||
              !editResourceTitleInput || !editResourceTypeSelect || !editResourceUrlInput ||
              !editResourceNoteInput || !saveResourceChangesBtn || !editResourceErrorMessage) {
              if(editResourceErrorMessage) editResourceErrorMessage.textContent = 'Error: Modal elements missing.';
              return;
          }

          validateEditResourceForm();
          if (saveResourceChangesBtn.disabled) {
             if(editResourceErrorMessage) editResourceErrorMessage.textContent = 'Please fill required fields correctly.';
             return;
          }
          editResourceErrorMessage.textContent = '';

          const resourceId = editResourceIdInput.value;
          const subject = editResourceSubjectInput.value;
          const type = editResourceTypeSelect.value;
          const title = editResourceTitleInput.value.trim();
          const url = editResourceUrlInput.value.trim();
          const noteContent = editResourceNoteInput.value.trim();

          const updatedResourceData = { title, type, updatedAt: serverTimestamp() };
          if (type === 'link') {
              updatedResourceData.url = url;
              updatedResourceData.noteContent = deleteField();
          } else if (type === 'note') {
              updatedResourceData.noteContent = noteContent;
              updatedResourceData.url = deleteField();
          }

          saveResourceChangesBtn.disabled = true;
          saveResourceChangesBtn.textContent = 'Saving...';

          try {
              const docRef = getSubjectSpecificDocRef(currentUserId, 'resources', subject, resourceId);
              if (!docRef) throw new Error("Could not get document reference for update.");
              await updateDoc(docRef, updatedResourceData);
              closeEditResourceModal();
              if (currentActiveSubject === subject) {
                  displayResources(subject);
              }
          } catch (error) {
              console.error("Error updating resource:", error);
              if(editResourceErrorMessage) editResourceErrorMessage.textContent = 'Failed to save changes. Please try again.';
              alert("Failed to update resource. Please try again.");
          } finally {
              saveResourceChangesBtn.disabled = false;
              saveResourceChangesBtn.textContent = 'Save Changes';
          }
      };


      const loadWonTime = async () => {
          if (!currentUserId || !db) { wonTimeSeconds = 0; updateWonTimeDisplayOnPomodoro(); return; }
          try { const wonTimeRef = getUserDataRef(currentUserId, 'userData/wonTime'); if (!wonTimeRef) throw new Error("Could not get wonTimeRef"); const docSnap = await getDoc(wonTimeRef); if (docSnap.exists()) { const data = docSnap.data(); wonTimeSeconds = data?.seconds || 0; if (isNaN(wonTimeSeconds) || wonTimeSeconds < 0) { wonTimeSeconds = 0; } } else { wonTimeSeconds = 0; }
          } catch (e) { console.error("Error loading won time from Firebase:", e); wonTimeSeconds = 0; }
          updateWonTimeDisplayOnPomodoro();
      };
      const saveWonTime = async () => {
         if (!currentUserId || !db) { return; }
          try { const wonTimeRef = getUserDataRef(currentUserId, 'userData/wonTime'); if (!wonTimeRef) throw new Error("Could not get wonTimeRef for saving"); await setDoc(wonTimeRef, { seconds: wonTimeSeconds }, { merge: true });
          } catch (e) { console.error("Error saving won time to Firebase:", e); }
      };
      const addWonTime = async (secondsToAdd) => {
          if (typeof secondsToAdd !== 'number' || isNaN(secondsToAdd) || secondsToAdd <= 0) { return; }
          wonTimeSeconds += secondsToAdd;
          await saveWonTime();
          updateWonTimeDisplayOnPomodoro();
      };

      const loadPomodoroState = () => { try { const savedState = localStorage.getItem(POMODORO_STORAGE_KEY); if (savedState) { const parsedState = JSON.parse(savedState); if (parsedState && typeof parsedState.currentSeconds === 'number' && typeof parsedState.totalSeconds === 'number') { pomodoroState = { ...pomodoroState, ...parsedState }; if (workDurationInput) workDurationInput.value = parsedState.workDuration || 25; if (shortBreakDurationInput) shortBreakDurationInput.value = parsedState.shortBreakDuration || 5; if (longBreakDurationInput) longBreakDurationInput.value = parsedState.longBreakDuration || 15; if (pomodoroSubjectSelect && pomodoroState.timerMode === 'work') { pomodoroSubjectSelect.value = pomodoroState.workSessionSubject || ""; } if(pomodoroState.pomodoroCycle) { try { localStorage.setItem('pomodoroCycle', pomodoroState.pomodoroCycle.toString()); } catch(e){ console.warn("Failed to save cycle to localStorage on load", e); } } if (pomodoroState.timerState === 'running' && pomodoroState.timerEndTime) { const now = Date.now(); const remainingSeconds = Math.max(0, Math.round((pomodoroState.timerEndTime - now) / 1000)); pomodoroState.currentSeconds = remainingSeconds; if (remainingSeconds > 0) { startPomodoroTimerInterval(); updatePomodoroUIState('running'); } else { handlePomodoroCompletion(true); savePomodoroState(); } } else if (pomodoroState.timerState === 'paused') { setTimerMode(pomodoroState.timerMode, false); updatePomodoroUIState('paused'); updateTimerDisplay(); } else { setTimerMode(pomodoroState.timerMode || 'work', false); updatePomodoroUIState('stopped'); } return true; } else { localStorage.removeItem(POMODORO_STORAGE_KEY); } } } catch (e) { console.error("Error loading Pomodoro state from localStorage:", e); localStorage.removeItem(POMODORO_STORAGE_KEY); } return false; };
      const savePomodoroState = () => { try { const stateToSave = { ...pomodoroState, workDuration: parseInt(workDurationInput?.value || '25'), shortBreakDuration: parseInt(shortBreakDurationInput?.value || '5'), longBreakDuration: parseInt(longBreakDurationInput?.value || '15') }; localStorage.setItem(POMODORO_STORAGE_KEY, JSON.stringify(stateToSave)); } catch (e) { console.error("Error saving Pomodoro state to localStorage:", e); } };
      const stopPomodoroTimer = (clearStorage = false) => { if (pomodoroInterval) { clearInterval(pomodoroInterval); pomodoroInterval = null; } pomodoroState.timerState = 'stopped'; pomodoroState.timerEndTime = null; updatePomodoroUIState('stopped'); if (document.title.includes(':') && !document.title.includes('Bonus') && document.title !== DEFAULT_TITLE) { document.title = DEFAULT_TITLE; } if (clearStorage) { try { localStorage.removeItem(POMODORO_STORAGE_KEY); } catch (e) { console.error("Error clearing Pomodoro state from localStorage:", e);} } else { savePomodoroState(); } };
      const updatePomodoroUIState = (newState) => { if (!startPauseButton || !pomodoroSubjectSelect || !resetButton || !mainPomodoroTimerArea || !mainPomodoroControls) return; const isRunning = newState === 'running'; const isPaused = newState === 'paused'; const isStopped = !isRunning && !isPaused; const isMainTimerDisabled = isBonusTimerRunning; if (isRunning && !isMainTimerDisabled) { startPauseButton.innerHTML = `<i data-lucide="pause" class="h-5 w-5"></i> <span>Pause</span>`; } else if (isPaused && !isMainTimerDisabled) { startPauseButton.innerHTML = `<i data-lucide="play" class="h-5 w-5"></i> <span>Resume</span>`; } else { startPauseButton.innerHTML = `<i data-lucide="play" class="h-5 w-5"></i> <span>Start</span>`; } const disableControls = isRunning || isPaused || isMainTimerDisabled; modeButtons.forEach(btn => { if (btn) btn.disabled = disableControls; }); if(workDurationInput) workDurationInput.disabled = disableControls; if(shortBreakDurationInput) shortBreakDurationInput.disabled = disableControls; if(longBreakDurationInput) longBreakDurationInput.disabled = disableControls; pomodoroSubjectSelect.disabled = disableControls || pomodoroState.timerMode !== 'work'; startPauseButton.disabled = isMainTimerDisabled; resetButton.disabled = isMainTimerDisabled || isStopped; mainPomodoroTimerArea.classList.toggle('opacity-50', isMainTimerDisabled); mainPomodoroControls.classList.toggle('opacity-50', isMainTimerDisabled); mainPomodoroControls.classList.toggle('pointer-events-none', isMainTimerDisabled); safelyCreateIcons(); };
      const updateTimerDisplay = () => { if (!timerDisplay || !progressRing || isBonusTimerRunning) return; const ringCircumference = 2 * Math.PI * parseFloat(progressRing.getAttribute('r') || '45'); const timeString = formatSecondsToMMSS(pomodoroState.currentSeconds); timerDisplay.textContent = timeString; const progress = pomodoroState.totalSeconds > 0 ? Math.min(1, Math.max(0, (pomodoroState.totalSeconds - pomodoroState.currentSeconds) / pomodoroState.totalSeconds)) : 0; const offset = ringCircumference * (1 - progress); progressRing.style.strokeDashoffset = Math.max(0, Math.min(ringCircumference, offset)); if (pomodoroState.timerState === 'running') { let modeLabel = "Focus"; if (pomodoroState.timerMode === 'shortBreak') modeLabel = "Short Break"; else if (pomodoroState.timerMode === 'longBreak') modeLabel = "Long Break"; document.title = `${timeString} - ${modeLabel} | ${DEFAULT_TITLE}`; } else if (document.title.includes(':') && !document.title.includes('Bonus') && document.title !== DEFAULT_TITLE) { document.title = DEFAULT_TITLE; } };
      const setActiveModeButton = (activeMode) => { modeButtons.forEach(btn => { if (btn instanceof HTMLButtonElement && btn.dataset.mode) { btn.classList.toggle('active', btn.dataset.mode === activeMode); } }); if (pomodoroSubjectWrapper) { pomodoroSubjectWrapper.style.display = activeMode === 'work' ? 'block' : 'none'; } if(pomodoroSubjectSelect) { pomodoroSubjectSelect.disabled = activeMode !== 'work' || pomodoroState.timerState !== 'stopped' || isBonusTimerRunning; } };
      const handleDurationChange = (mode) => { if (isBonusTimerRunning) return; if (pomodoroState.timerState !== 'running' && pomodoroState.timerMode === mode) { setTimerMode(mode, false); } else { savePomodoroState(); } };
      const setTimerMode = (mode, fromInteraction = false) => { if (!timerStatus || !progressRing || !workDurationInput || !shortBreakDurationInput || !longBreakDurationInput || !pomodoroModeTitle) { return; } if ((pomodoroState.timerState === 'running' && fromInteraction) || isBonusTimerRunning) { const buttonToShake = modeButtons.find(btn => btn?.dataset.mode === mode); buttonToShake?.classList.add('shake-horizontal'); setTimeout(() => buttonToShake?.classList.remove('shake-horizontal'), 400); return; } stopPomodoroTimer(false); pomodoroState.timerMode = mode; try { pomodoroState.pomodoroCycle = parseInt(localStorage.getItem('pomodoroCycle') || '0'); } catch { pomodoroState.pomodoroCycle = 0; } let title = '', durationInput, ringColorClass = 'text-primary dark:text-primary-dark'; switch (mode) { case 'work': durationInput = workDurationInput; title = 'Focus Session'; if(timerStatus) timerStatus.textContent = 'Work'; if (pomodoroSubjectSelect && pomodoroState.workSessionSubject) { pomodoroSubjectSelect.value = pomodoroState.workSessionSubject; } break; case 'shortBreak': durationInput = shortBreakDurationInput; title = 'Short Break'; if(timerStatus) timerStatus.textContent = 'Short Break'; ringColorClass = 'text-emerald-500 dark:text-emerald-400'; break; case 'longBreak': durationInput = longBreakDurationInput; title = 'Long Break'; if(timerStatus) timerStatus.textContent = 'Long Break'; ringColorClass = 'text-sky-500 dark:text-sky-400'; break; default: mode = 'work'; durationInput = workDurationInput; pomodoroState.timerMode = 'work'; title = 'Focus Session'; if(timerStatus) timerStatus.textContent = 'Work'; } let newDuration = parseInt(durationInput?.value || (mode === 'work' ? '25' : (mode === 'shortBreak' ? '5' : '15'))); pomodoroState.totalSeconds = (!isNaN(newDuration) && newDuration > 0) ? newDuration * 60 : (25 * 60); pomodoroState.currentSeconds = pomodoroState.totalSeconds; pomodoroState.timerState = 'stopped'; pomodoroState.timerEndTime = null; if(pomodoroModeTitle) pomodoroModeTitle.textContent = title; setActiveModeButton(mode); updateTimerDisplay(); if (progressRing) { progressRing.classList.remove('text-primary', 'dark:text-primary-dark', 'text-emerald-500', 'dark:text-emerald-400', 'text-sky-500', 'dark:text-sky-400'); progressRing.classList.add(...ringColorClass.split(' ')); } updatePomodoroUIState('stopped'); savePomodoroState(); };
      const addPomodoroLogAndAnalytics = async (subject, durationMinutes) => { if (!currentUserId || !subject || !db) { return; } if (durationMinutes < 1) { return; } const sanitizedSubjectKey = subject.replace(/[.*$#[\]/]/g, '_'); if (!sanitizedSubjectKey) { return; } const logCollRef = getUserCollectionRef(currentUserId, 'pomodoroLogs'); const analyticsRef = getUserDataRef(currentUserId, 'stats/pomodoroAnalytics'); const todayStr = getTodayDateString(); const dailyProgressRef = getUserDataRef(currentUserId, `dailyProgress/${todayStr}`); if (!logCollRef || !analyticsRef || !dailyProgressRef) { return; } try { const batch = writeBatch(db); batch.set(doc(logCollRef), { subject: subject, durationMinutes, timestamp: serverTimestamp() }); const analyticsUpdateData = { totalSessions: increment(1), totalMinutes: increment(durationMinutes), [`subjectMinutes.${sanitizedSubjectKey}`]: increment(durationMinutes) }; batch.set(analyticsRef, analyticsUpdateData, { merge: true }); const dailyUpdateData = { totalMinutes: increment(durationMinutes), lastUpdated: serverTimestamp() }; batch.set(dailyProgressRef, dailyUpdateData, { merge: true }); await batch.commit(); if (getElement('dashboard')?.classList.contains('active')) { loadDashboard(); } if (getElement('pomodoro')?.classList.contains('active')) { displayPomodoroSubjectTimes(); } } catch (error) { console.error("Error logging Pomodoro using batch write:", error); } };
      const displayPomodoroSubjectTimes = async () => { const container = pomodoroSubjectTimesContainer?.querySelector('div'); if (!currentUserId || !db || !container) { if (container) container.innerHTML = createLoadingMessage('Cannot load times: Missing user/DB.'); return; } container.innerHTML = createLoadingMessage('Loading subject times...'); try { const analyticsRef = getUserDataRef(currentUserId, 'stats/pomodoroAnalytics'); if (!analyticsRef) throw new Error("Could not get pomodoroAnalytics doc ref."); const analyticsDoc = await getDoc(analyticsRef); container.innerHTML = ''; if (analyticsDoc.exists()) { const data = analyticsDoc.data(); const subjectMins = (data.subjectMinutes && typeof data.subjectMinutes === 'object') ? data.subjectMinutes : {}; const sortedSubjects = Object.entries(subjectMins).sort(([,a],[,b]) => b-a); if (sortedSubjects.length > 0) { sortedSubjects.forEach(([subjectKey, mins]) => { const originalSubject = subjects.find(s => s.replace(/[.*$#[\]/]/g, '_') === subjectKey) || subjectKey; const colorInfo = getSubjectColorInfo(originalSubject); const div = document.createElement('div'); div.className = `subject-time-item flex justify-between items-center text-sm ${colorInfo.borderClass}`; div.innerHTML = `<span class="text-text dark:text-text-dark">${escapeHtml(originalSubject)}</span><span class="font-medium text-muted dark:text-muted-dark">${formatMinutesToHHMM(mins)}</span>`; container.appendChild(div); }); } else { container.innerHTML = createLoadingMessage('No time tracked yet.'); } } else { container.innerHTML = createLoadingMessage('No time tracked yet.'); } safelyCreateIcons(); } catch(error) { console.error("Error loading Pomodoro subject times:", error); container.innerHTML = createLoadingMessage('Error loading times.'); } };
      const startPomodoroTimerInterval = () => { if (isBonusTimerRunning) { return; } if (pomodoroInterval) clearInterval(pomodoroInterval); pomodoroState.timerState = 'running'; if (!pomodoroState.timerEndTime || pomodoroState.timerState === 'stopped') { pomodoroState.timerEndTime = Date.now() + pomodoroState.currentSeconds * 1000; } savePomodoroState(); updatePomodoroUIState('running'); updateTimerDisplay(); pomodoroInterval = setInterval(() => { const now = Date.now(); const remainingMillis = pomodoroState.timerEndTime - now; pomodoroState.currentSeconds = Math.max(0, Math.round(remainingMillis / 1000)); updateTimerDisplay(); if (pomodoroState.currentSeconds <= 0) { handlePomodoroCompletion(false); } }, 1000); };
      const handlePomodoroCompletion = (fromLoad = false) => { if (pomodoroInterval) clearInterval(pomodoroInterval); pomodoroInterval = null; const finishedMode = pomodoroState.timerMode; const workDuration = parseInt(workDurationInput?.value || '25'); let nextMode = 'work'; let alertMessage = ''; if (finishedMode === 'work') { pomodoroState.pomodoroCycle++; try { localStorage.setItem('pomodoroCycle', pomodoroState.pomodoroCycle.toString()); } catch (e) { console.warn("Could not save pomodoro cycle to localStorage", e);} if (pomodoroState.workSessionSubject && workDuration > 0) { addPomodoroLogAndAnalytics(pomodoroState.workSessionSubject, workDuration); } nextMode = (pomodoroState.pomodoroCycle % 4 === 0) ? 'longBreak' : 'shortBreak'; alertMessage = `Focus session complete! Time for a ${nextMode === 'longBreak' ? 'long' : 'short'} break.`; } else { alertMessage = "Break's over! Time to get back to focus."; nextMode = 'work'; } if (alertMessage && !fromLoad) { alert(alertMessage); } pomodoroState.workSessionSubject = ''; setTimerMode(nextMode, false); if (!fromLoad && getElement('pomodoro')?.classList.contains('active')) { displayPomodoroSubjectTimes(); } };
      const startTimer = () => { if (isBonusTimerRunning) { alert("Cannot start main timer while bonus timer is active."); return; } if (pomodoroState.timerState === 'running') return; if (pomodoroState.timerState === 'paused') { startPomodoroTimerInterval(); return; } if (pomodoroState.timerMode === 'work') { const selectedSubject = pomodoroSubjectSelect?.value; if (!selectedSubject) { alert('Please select a subject for this Focus Session.'); pomodoroSubjectSelect?.focus(); pomodoroSubjectSelect?.parentElement?.classList.add('shake-horizontal'); setTimeout(() => pomodoroSubjectSelect?.parentElement?.classList.remove('shake-horizontal'), 400); return; } pomodoroState.workSessionSubject = selectedSubject; } else { pomodoroState.workSessionSubject = ''; } if (pomodoroState.currentSeconds <= 0) { setTimerMode(pomodoroState.timerMode, false); if (pomodoroState.currentSeconds <= 0) { alert("Timer duration is invalid (0 or less). Please adjust settings."); return; } } startPomodoroTimerInterval(); };
      const pauseTimer = () => { if (isBonusTimerRunning) { return; } if (pomodoroState.timerState !== 'running') return; if (pomodoroInterval) clearInterval(pomodoroInterval); pomodoroInterval = null; pomodoroState.timerState = 'paused'; pomodoroState.timerEndTime = null; updatePomodoroUIState('paused'); savePomodoroState(); if (document.title.includes(':') && !document.title.includes('Bonus') && document.title !== DEFAULT_TITLE) { document.title = DEFAULT_TITLE; } };
      const resetTimer = (silent = false) => { if (isBonusTimerRunning) { return; } stopPomodoroTimer(false); setTimerMode(pomodoroState.timerMode, false); };
      window.resetPomodoroTimer = resetTimer;

      const updateWonTimeDisplayOnPomodoro = () => { if (!wonTimeDisplay || !useWonTimeButton) return; wonTimeDisplay.textContent = formatSecondsToHHMMSS(wonTimeSeconds); const isDisabled = wonTimeSeconds <= 0 || isBonusTimerRunning; useWonTimeButton.disabled = isDisabled; useWonTimeButton.classList.toggle('opacity-50', isDisabled); useWonTimeButton.classList.toggle('cursor-not-allowed', isDisabled); useWonTimeButton.classList.toggle('hover:bg-secondary/90', !isDisabled); updatePomodoroUIState(pomodoroState.timerState); };
      const startBonusTimer = () => { if (wonTimeSeconds <= 0 || isBonusTimerRunning) return; let mainTimerWasRunning = false; if (pomodoroState.timerState === 'running') { pauseTimer(); mainTimerWasRunning = true; } isBonusTimerRunning = true; if (wonTimeContainer) wonTimeContainer.classList.add('hidden'); if (bonusTimerContainer) bonusTimerContainer.classList.remove('hidden'); if (bonusTimerCompletionMessage) bonusTimerCompletionMessage.textContent = ''; if(bonusTimerCountdown) bonusTimerCountdown.textContent = `Bonus Break: ${formatSecondsToHHMMSS(wonTimeSeconds)}`; document.title = `${formatSecondsToHHMMSS(wonTimeSeconds)} - Bonus Break | ${DEFAULT_TITLE}`; updatePomodoroUIState(pomodoroState.timerState); if (bonusTimerInterval) clearInterval(bonusTimerInterval); bonusTimerInterval = setInterval(async () => { wonTimeSeconds--; if (wonTimeSeconds <= 0) { await stopBonusTimer(true); if (mainTimerWasRunning) { startTimer(); } } else { if(bonusTimerCountdown) bonusTimerCountdown.textContent = `Bonus Break: ${formatSecondsToHHMMSS(wonTimeSeconds)}`; document.title = `${formatSecondsToHHMMSS(wonTimeSeconds)} - Bonus Break | ${DEFAULT_TITLE}`; } }, 1000); };
      const stopBonusTimer = async (completed = false) => { if (!isBonusTimerRunning && !bonusTimerInterval) return; if (bonusTimerInterval) clearInterval(bonusTimerInterval); bonusTimerInterval = null; isBonusTimerRunning = false; if (completed) { wonTimeSeconds = 0; if (bonusTimerCompletionMessage) { showTemporaryMessage(bonusTimerCompletionMessage, "Bonus time finished!", 4000, true); } } await saveWonTime(); if (wonTimeContainer) wonTimeContainer.classList.remove('hidden'); if (bonusTimerContainer) bonusTimerContainer.classList.add('hidden'); updateWonTimeDisplayOnPomodoro(); if (document.title.includes('Bonus Break')) { document.title = DEFAULT_TITLE; } };

      const loadTracker = () => { populateSubjectDropdown(trackerSubjectSelect); if(addTrackerDetails) addTrackerDetails.style.display = 'none'; if(trackerItemsList) trackerItemsList.innerHTML = createLoadingMessage('Select a subject to view items.'); validateTrackerForm(); };
      const validateTrackerForm = () => { if (saveTrackerItemBtn && trackerDescriptionInput) { saveTrackerItemBtn.disabled = !currentActiveSubject || trackerDescriptionInput.value.trim() === ''; } else if (saveTrackerItemBtn) { saveTrackerItemBtn.disabled = true; } };
      const displayTrackerItems = async (subject) => {
          if (!currentUserId || !trackerItemsList || !db) {
              if(trackerItemsList) trackerItemsList.innerHTML = createLoadingMessage('Cannot load items: Not logged in or DB unavailable.');
              return;
          }
          trackerItemsList.innerHTML = createLoadingMessage(`Loading ${subject} tracker items...`);
          try {
              const collRef = getSubjectSpecificCollectionRef(currentUserId, 'trackerItems', subject);
              if (!collRef) throw new Error("Could not get trackerItems collection ref.");
              const q = query(collRef, orderBy("createdAt", "desc"));
              const snapshot = await getDocs(q);
              const items = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
              trackerItemsList.innerHTML = '';

              if (items.length === 0) {
                  trackerItemsList.innerHTML = createLoadingMessage(`No items tracked for ${subject} yet.`);
              } else {
                  const getStatusClass = (status) => {
                      const statusKey = status?.toLowerCase().replace(/\s+/g,'') || 'review';
                      const statusClasses = tailwind?.config?.theme?.extend?.colors?.status;
                      return statusClasses?.[statusKey] || 'bg-gray-100 dark:bg-slate-700 text-gray-800 dark:text-gray-200 border border-gray-300 dark:border-gray-600 font-medium';
                  };
                  items.forEach((item, index) => {
                      const div = document.createElement('div');
                      const itemSubject = item.subject || subject;
                      const colorInfo = getSubjectColorInfo(itemSubject);
                      div.className = `tracker-item list-item flex justify-between items-start p-3 rounded-lg border ${colorInfo.borderClass.replace('border-l-4', 'border')} bg-background dark:bg-slate-800/50 hover:bg-slate-50 dark:hover:bg-slate-700/50 transition-all duration-150 space-x-3 list-item-appear`;
                      div.style.animationDelay = `${index * 0.05}s`;

                      const actionsHtml = `
                          <div class="flex-shrink-0 flex items-center space-x-1">
                              <button title="Edit Item" class="list-action-btn edit p-1 -m-1 rounded-full btn-animated focus-visible:ring-1 focus-visible:ring-primary" data-tracker-id="${item.id}"><i data-lucide="edit-3" class="h-4 w-4"></i></button>
                              <button title="Delete Item" class="list-action-btn delete p-1 -m-1 rounded-full btn-animated focus-visible:ring-1 focus-visible:ring-red-500" onclick="window.handleGenericDeleteItem('trackerItems', '${escapeHtml(subject)}', '${item.id}', 'tracker item', window.displayTrackerItems)"><i data-lucide="trash-2" class="h-4 w-4"></i></button>
                          </div>`;

                      div.innerHTML = `<div class="flex-grow"><p class="text-sm text-text dark:text-text-dark whitespace-pre-wrap">${escapeHtml(item.description)}</p><span class="text-xs px-2 py-0.5 rounded-full mt-2 inline-block ${getStatusClass(item.status)}">${escapeHtml(item.status || 'To Review')}</span>${item.createdAt ? `<span class="text-xs text-muted dark:text-muted-dark ml-2">${formatGeneralDate(item.createdAt)}</span>` : ''}</div>${actionsHtml}`;
                      trackerItemsList.appendChild(div);

                      const editBtn = div.querySelector('.list-action-btn.edit');
                      editBtn?.addEventListener('click', () => openEditTrackerItemModal(item.id, subject, item));
                  });
                  safelyCreateIcons();
              }
          } catch (error) {
              console.error(`Error loading tracker items for ${subject}:`, error);
              trackerItemsList.innerHTML = createLoadingMessage(`Error loading items for ${subject}. Check console.`);
          }
      };
      window.displayTrackerItems = displayTrackerItems;
      const handleSaveTrackerItem = async () => { if (!currentUserId || !currentActiveSubject || !saveTrackerItemBtn || !db || !trackerDescriptionInput || !trackerStatusSelect) { alert("Cannot save item: Missing user, subject, or form elements."); return; } validateTrackerForm(); if (saveTrackerItemBtn.disabled) return; const description = trackerDescriptionInput.value.trim(); const status = trackerStatusSelect.value; const newItem = { description, status, createdAt: serverTimestamp(), subject: currentActiveSubject }; saveTrackerItemBtn.disabled = true; saveTrackerItemBtn.textContent = 'Adding...'; try { const collRef = getSubjectSpecificCollectionRef(currentUserId, 'trackerItems', currentActiveSubject); if (!collRef) throw new Error("Could not get trackerItems collection ref."); await addDoc(collRef, newItem); trackerDescriptionInput.value = ''; trackerStatusSelect.value = 'To Review'; if (addTrackerDetails) addTrackerDetails.open = false; displayTrackerItems(currentActiveSubject); } catch (error) { console.error("Error saving tracker item:", error); alert("Failed to save tracker item."); } finally { saveTrackerItemBtn.disabled = false; saveTrackerItemBtn.textContent = 'Add Item'; validateTrackerForm(); } };

      // Edit Tracker Item Modal Functions
      const openEditTrackerItemModal = (trackerId, subject, trackerData) => {
          if (!editTrackerItemModal || !editTrackerIdInput || !editTrackerSubjectInput || !editTrackerDescriptionInput || !editTrackerStatusSelect || !editTrackerErrorMessage) return;

          editTrackerIdInput.value = trackerId;
          editTrackerSubjectInput.value = subject;
          editTrackerDescriptionInput.value = trackerData.description || '';
          editTrackerStatusSelect.value = trackerData.status || 'To Review';
          editTrackerErrorMessage.textContent = '';
          validateEditTrackerForm();
          editTrackerItemModal.classList.remove('hidden');
          safelyCreateIcons();
      };

      const closeEditTrackerItemModal = () => {
          if (editTrackerItemModal) editTrackerItemModal.classList.add('hidden');
          if (editTrackerErrorMessage) editTrackerErrorMessage.textContent = '';
      };

      const validateEditTrackerForm = () => {
          if (saveTrackerChangesBtn && editTrackerDescriptionInput) {
              saveTrackerChangesBtn.disabled = !editTrackerDescriptionInput.value.trim();
          } else if (saveTrackerChangesBtn) {
              saveTrackerChangesBtn.disabled = true;
          }
      };

      const handleSaveTrackerItemChanges = async () => {
          if (!currentUserId || !db || !editTrackerIdInput || !editTrackerSubjectInput || !editTrackerDescriptionInput || !editTrackerStatusSelect || !saveTrackerChangesBtn || !editTrackerErrorMessage) {
              if(editTrackerErrorMessage) editTrackerErrorMessage.textContent = 'Error: Modal elements missing.';
              return;
          }
          validateEditTrackerForm();
          if (saveTrackerChangesBtn.disabled) {
              if(editTrackerErrorMessage) editTrackerErrorMessage.textContent = 'Description cannot be empty.';
              return;
          }
          editTrackerErrorMessage.textContent = '';

          const trackerId = editTrackerIdInput.value;
          const subject = editTrackerSubjectInput.value;
          const description = editTrackerDescriptionInput.value.trim();
          const status = editTrackerStatusSelect.value;

          const updatedTrackerData = { description, status, updatedAt: serverTimestamp() };
          saveTrackerChangesBtn.disabled = true;
          saveTrackerChangesBtn.textContent = 'Saving...';

          try {
              const docRef = getSubjectSpecificDocRef(currentUserId, 'trackerItems', subject, trackerId);
              if (!docRef) throw new Error("Could not get document reference for update.");
              await updateDoc(docRef, updatedTrackerData);
              closeEditTrackerItemModal();
              if (currentActiveSubject === subject) {
                  displayTrackerItems(subject);
              }
          } catch (error) {
              console.error("Error updating tracker item:", error);
              if(editTrackerErrorMessage) editTrackerErrorMessage.textContent = 'Failed to save changes. Please try again.';
              alert("Failed to update tracker item. Please try again.");
          } finally {
              saveTrackerChangesBtn.disabled = false;
              saveTrackerChangesBtn.textContent = 'Save Changes';
          }
      };


      const loadPlanner = () => { if (!plannerDateInput || !plannerTimeInput || !plannerSubjectSelect || !plannerTopicInput || !savePlannerItemBtn || !plannerItemsList) { return; } populateSubjectDropdown(plannerSubjectSelect); displayPlannerItems(); try { const now = new Date(); const localISODate = new Date(now.getTime() - (now.getTimezoneOffset() * 60000)).toISOString().split('T')[0]; const localISOTime = now.toTimeString().substring(0, 5); plannerDateInput.value = localISODate; plannerTimeInput.value = localISOTime; } catch (e) { console.warn("Could not set default date/time for planner:", e); } validatePlannerForm(); };
      const validatePlannerForm = () => { if (savePlannerItemBtn && plannerDateInput && plannerTimeInput && plannerSubjectSelect && plannerTopicInput) { const isValid = plannerDateInput.value && plannerTimeInput.value && plannerSubjectSelect.value && plannerTopicInput.value.trim(); savePlannerItemBtn.disabled = !isValid; } else if (savePlannerItemBtn) { savePlannerItemBtn.disabled = true; } };
      const handleSavePlannerItem = async () => { if (!currentUserId || !db || !savePlannerItemBtn || !plannerDateInput || !plannerTimeInput || !plannerSubjectSelect || !plannerTopicInput ) { alert("Cannot schedule: Missing user, DB connection, or form elements."); return; } validatePlannerForm(); if (savePlannerItemBtn.disabled) return; const date = plannerDateInput.value; const time = plannerTimeInput.value; const subject = plannerSubjectSelect.value; const topic = plannerTopicInput.value.trim(); let dateTimeString; try { if (!/^\d{4}-\d{2}-\d{2}$/.test(date) || !/^\d{2}:\d{2}$/.test(time)) { throw new Error("Invalid date or time format entered."); } const combined = new Date(`${date}T${time}:00`); if (isNaN(combined.getTime())) throw new Error("Invalid date/time combination"); dateTimeString = combined.toISOString(); } catch (e) { console.error("Invalid date/time format:", e); alert("Please enter a valid date and time."); return; } const newItem = { dateTime: dateTimeString, subject, topic, createdAt: serverTimestamp() }; savePlannerItemBtn.disabled = true; savePlannerItemBtn.textContent = 'Scheduling...'; try { const collRef = getUserCollectionRef(currentUserId, 'plannerItems'); if (!collRef) throw new Error("Could not get plannerItems collection ref."); await addDoc(collRef, newItem); await displayPlannerItems(); if(plannerSubjectSelect) plannerSubjectSelect.value = ''; if(plannerTopicInput) plannerTopicInput.value = ''; validatePlannerForm(); } catch (e) { console.error("Error saving planner item:", e); alert("Failed to schedule session."); } finally { savePlannerItemBtn.disabled = false; savePlannerItemBtn.textContent = 'Schedule Session'; } };
      const displayPlannerItems = async () => { if (!currentUserId || !plannerItemsList || !db) { if (plannerItemsList) plannerItemsList.innerHTML = createLoadingMessage('Cannot load sessions: Not logged in or DB unavailable.'); return; } plannerItemsList.innerHTML = createLoadingMessage('Loading scheduled sessions...'); try { const collRef = getUserCollectionRef(currentUserId, 'plannerItems'); if (!collRef) throw new Error("Could not get plannerItems collection ref."); const q = query(collRef, orderBy("dateTime", "asc")); const snapshot = await getDocs(q); const items = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })); plannerItemsList.innerHTML = ''; if (items.length === 0) { plannerItemsList.innerHTML = createLoadingMessage('No sessions scheduled yet.'); } else { const groupedByDate = items.reduce((acc, item) => { try { if (!item.dateTime) throw new Error("Missing dateTime field"); const d = new Date(item.dateTime); if (isNaN(d.getTime())) throw new Error("Invalid stored date string"); const dateStr = d.toLocaleDateString('en-GB', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' }); if (!acc[dateStr]) acc[dateStr] = []; acc[dateStr].push(item); } catch (e) { console.warn("Skipping planner item with invalid date:", item.id, item.dateTime, e); } return acc; }, {}); const sortedDates = Object.keys(groupedByDate).sort((a, b) => { try { const parseDisplayDate = (str) => { const parts = str.split(', ')[1]?.split(' '); if (!parts || parts.length !== 3) return new Date(NaN); const day = parseInt(parts[0]); const year = parseInt(parts[2]); const monthNames = ["January", "February", "March", "April", "May", "June", "July", "August", "September", "October", "November", "December"]; const monthIndex = monthNames.findIndex(m => m.toLowerCase() === parts[1].toLowerCase()); if (isNaN(day) || isNaN(year) || monthIndex === -1) return new Date(NaN); return new Date(Date.UTC(year, monthIndex, day)); }; const dateA = parseDisplayDate(a); const dateB = parseDisplayDate(b); if (isNaN(dateA.getTime()) || isNaN(dateB.getTime())) return 0; return dateA - dateB; } catch { return 0; } }); sortedDates.forEach(dateStr => { const dateHeader = document.createElement('h4'); dateHeader.className = 'text-lg font-semibold mt-5 mb-2 text-text dark:text-text-dark border-b pb-1 dark:border-slate-600'; dateHeader.textContent = dateStr; plannerItemsList.appendChild(dateHeader); const list = document.createElement('ul'); list.className = 'space-y-3'; const sortedItems = groupedByDate[dateStr].sort((a,b) => new Date(a.dateTime) - new Date(b.dateTime)); sortedItems.forEach((item, index) => { const li = document.createElement('li'); const itemSubject = item.subject || 'Unspecified'; const colorInfo = getSubjectColorInfo(itemSubject); li.className = `planner-item list-item flex justify-between items-center p-3 rounded-lg border-l-4 ${colorInfo.borderClass} bg-card dark:bg-card-dark shadow-sm hover:bg-slate-50 dark:hover:bg-slate-700/60 transition-all duration-150 list-item-appear`; li.style.animationDelay = `${index * 0.05}s`; const formattedDateTime = item.dateTime ? formatPlannerDateTime(item.dateTime) : 'Invalid time'; const isPast = item.dateTime ? new Date(item.dateTime) < new Date() : false; li.innerHTML = `<div class="flex-grow mr-3 ${isPast ? 'opacity-60' : ''}"><p class="font-semibold text-sm text-text dark:text-text-dark">${escapeHtml(item.subject)}</p><p class="text-xs text-muted dark:text-muted-dark mt-0.5">${escapeHtml(item.topic)}</p><p class="text-xs text-primary dark:text-primary-dark font-medium mt-1.5">${formattedDateTime}</p>${isPast ? '<span class="text-xs text-red-500 dark:text-red-400 ml-2">(Past)</span>' : ''}</div><button title="Delete Session" class="list-action-btn delete p-1 -m-1 rounded-full btn-animated focus-visible:ring-1 focus-visible:ring-red-500" onclick="window.handleGenericDeleteItem('plannerItems', null, '${item.id}', 'scheduled session', window.displayPlannerItems)"><i data-lucide="trash-2" class="h-4 w-4"></i></button>`; list.appendChild(li); }); plannerItemsList.appendChild(list); }); safelyCreateIcons(); } } catch (error) { console.error("Error loading planner items:", error); plannerItemsList.innerHTML = createLoadingMessage('Error loading scheduled sessions. Check console.'); } };
      window.displayPlannerItems = displayPlannerItems;

      window.handleGenericDeleteItem = async (collectionName, subject, itemId, itemTypeName, displayFunction) => { if (!currentUserId || !itemId || !db) { alert(`Cannot delete ${itemTypeName}: Missing user ID or DB connection.`); return; } if (!confirm(`Are you sure you want to delete this ${itemTypeName}? This cannot be undone.`)) { return; } try { let itemRef; if (subject && ['resources', 'trackerItems', 'quizItems'].includes(collectionName)) { itemRef = getSubjectSpecificDocRef(currentUserId, collectionName, subject, itemId); } else if (!subject && ['plannerItems'].includes(collectionName)) { itemRef = doc(db, `users/${currentUserId}/${collectionName}/${itemId}`); } else { throw new Error(`Invalid collection/subject combination for deletion: ${collectionName}, ${subject}`); } if (!itemRef) throw new Error("Could not construct document reference for deletion."); if (collectionName === 'quizItems' && subject) { await handleDeleteQuizItemFiles(subject, itemId); } await deleteDoc(itemRef); if (typeof displayFunction === 'function') { if (subject && currentActiveSubject === subject) { displayFunction(subject); } else if (!subject) { displayFunction(); } } if (collectionName === 'quizItems' && currentActiveSubject === subject) { await toggleQuizButtons(); } } catch (error) { console.error(`Error deleting ${itemTypeName} (ID: ${itemId}):`, error); alert(`Failed to delete ${itemTypeName}. Check console for details.`); } };
      const handleDeleteQuizItemFiles = async (subject, itemId, specificFiles = { qFile: null, aFile: null }) => {
          if (!currentUserId || !subject || !db || !storage) return;

          const deleteFile = async (fileUrl, fileType) => {
              if (!fileUrl) return;
              try {
                  if (fileUrl.includes('firebasestorage.googleapis.com')) {
                      const fileRef = ref(storage, fileUrl);
                      await deleteObject(fileRef);
                      console.log(`Successfully deleted ${fileType} file: ${fileUrl}`);
                  }
              } catch (e) {
                  if (e.code === 'storage/object-not-found') {
                      // console.log(`${fileType} file not found, already deleted or never existed: ${fileUrl}`);
                  } else {
                      console.warn(`Failed to delete quiz ${fileType} file ${fileUrl}:`, e);
                  }
              }
          };

          if (specificFiles.qFile) await deleteFile(specificFiles.qFile, 'question');
          if (specificFiles.aFile) await deleteFile(specificFiles.aFile, 'answer');

          // If not deleting specific files, assume deleting all files for the item
          if (!specificFiles.qFile && !specificFiles.aFile && itemId) {
              const itemRef = getSubjectSpecificDocRef(currentUserId, 'quizItems', subject, itemId);
              if (!itemRef) return;
              try {
                  const docSnap = await getDoc(itemRef);
                  if (docSnap.exists()) {
                      const data = docSnap.data();
                      if (data.questionFileUrl) await deleteFile(data.questionFileUrl, 'question');
                      if (data.answerFileUrl) await deleteFile(data.answerFileUrl, 'answer');
                  }
              } catch(error) {
                  console.error(`Error retrieving quiz item ${itemId} to delete files:`, error);
              }
          }
      };


      const getPapersForSubject = (subject) => { if (!subject) return ['General']; const papers = examData.filter(exam => exam.subject === subject && exam.paper).map(exam => exam.paper); const uniquePapers = [...new Set(papers)]; if (uniquePapers.length === 0) { return ['General']; } if (!uniquePapers.includes('General')) { uniquePapers.push('General'); } return uniquePapers.sort(); };
      const populateQuizPaperOptions = (subject, selectElement = quizPaperSelect) => { // Added selectElement param
            const papers = getPapersForSubject(subject);
            if (selectElement instanceof HTMLSelectElement) {
                selectElement.innerHTML = '';
                papers.forEach(paper => {
                    const option = document.createElement('option');
                    option.value = paper;
                    option.textContent = paper;
                    selectElement.appendChild(option);
                });
                if (papers.includes('General')) {
                    selectElement.value = 'General';
                }
            }
            if (quizPaperModalOptions && selectElement === quizPaperSelect) { // Only update modal options if it's the main select
                quizPaperModalOptions.querySelectorAll('.specific-paper-btn').forEach(btn => btn.remove());
                const generalBtn = quizPaperModalOptions.querySelector('button[data-paper-choice="General"]');
                papers.filter(p => p !== 'General' && p !== 'All').forEach(paper => {
                    const button = document.createElement('button');
                    button.dataset.paperChoice = paper;
                    button.className = 'quiz-paper-choice-btn specific-paper-btn w-full bg-slate-200 hover:bg-slate-300 dark:bg-slate-600 dark:hover:bg-slate-500 text-text dark:text-text-dark font-medium py-2 px-4 rounded-lg btn-animated focus-visible:ring-2 focus-visible:ring-offset-1 focus-visible:ring-slate-500';
                    button.textContent = `${paper} Only`;
                    if (generalBtn) {
                        quizPaperModalOptions.insertBefore(button, generalBtn);
                    } else {
                        quizPaperModalOptions.appendChild(button);
                    }
                    button.addEventListener('click', (e) => {
                        const choice = e.target.dataset.paperChoice;
                        if (choice && e.target instanceof HTMLButtonElement) {
                            hidePaperSelectionModal();
                            startQuizMode(choice);
                        }
                    });
                });
            }
      };
      const loadQuizPage = () => { populateSubjectDropdown(quizSubjectSelect); if(quizContentWrapper) quizContentWrapper.classList.add('hidden'); if(quizModeInterface) quizModeInterface.classList.add('hidden'); if (addQuizDetails) addQuizDetails.style.display = 'none'; validateQuizForm(); toggleQuizButtons(); };
      const validateQuizForm = (isEdit = false) => {
            const qInput = isEdit ? editQuizQuestionInput : quizQuestionInput;
            const aInput = isEdit ? editQuizAnswerInput : quizAnswerInput;
            const qFileInput = isEdit ? editQuizQuestionFileInput : quizQuestionFileInput;
            const aFileInput = isEdit ? editQuizAnswerFileInput : quizAnswerFileInput;
            const saveBtn = isEdit ? saveQuizChangesBtn : saveQuizQuestionBtn;

            if (!saveBtn || !qInput || !aInput || !qFileInput || !aFileInput) {
                if (saveBtn) saveBtn.disabled = true;
                return;
            }

            let hasQuestion = qInput.value.trim() !== '' || qFileInput.files.length > 0;
            let hasAnswer = aInput.value.trim() !== '' || aFileInput.files.length > 0;

            // For edit mode, existing files also count towards validity if not cleared
            if (isEdit) {
                if (!hasQuestion && initialQuizDataForEdit.questionFileUrl && !initialQuizDataForEdit.questionFileCleared) {
                    hasQuestion = true;
                }
                if (!hasAnswer && initialQuizDataForEdit.answerFileUrl && !initialQuizDataForEdit.answerFileCleared) {
                    hasAnswer = true;
                }
            }
            saveBtn.disabled = !(currentActiveSubject && hasQuestion && hasAnswer);
      };
      const toggleQuizButtons = async () => { if (startQuizButton) startQuizButton.disabled = true; if (!currentActiveSubject || !currentUserId || !db || !startQuizButton) return; try { const collRef = getSubjectSpecificCollectionRef(currentUserId, 'quizItems', currentActiveSubject); if (!collRef) throw new Error("Could not get quizItems collection ref."); const q = query(collRef, limit(1)); const snapshot = await getDocs(q); startQuizButton.disabled = snapshot.empty; } catch (error) { console.error("Error checking for quiz questions:", error); if (startQuizButton) startQuizButton.disabled = true; } };
      const renderFilePreview = (url, altText = "Uploaded file", context = 'list') => { if (!url) return ''; const imageExtensions = /\.(jpg|jpeg|png|gif|webp|svg)(\?|$)/i; let displayHtml = ''; if (imageExtensions.test(url)) { const imgClass = context === 'quiz' ? 'quiz-mode-image-display' : 'quiz-file-preview'; displayHtml = `<img src="${escapeHtml(url)}" alt="${escapeHtml(altText)}" class="${imgClass} inline-block border border-slate-300 dark:border-slate-600 rounded" loading="lazy">`; } else { let filename = 'Attached File'; try { const decodedUrl = decodeURIComponent(url); const pathPart = decodedUrl.substring(decodedUrl.lastIndexOf('/') + 1).split('?')[0]; filename = pathPart.replace(/(_\d{13,})(?=\.[^.]+$)/, ''); } catch (e) { console.warn("Could not parse filename from URL:", url, e); } displayHtml = `<a href="${escapeHtml(url)}" target="_blank" rel="noopener noreferrer" class="inline-flex items-center space-x-1 text-xs text-primary dark:text-primary-dark hover:underline bg-slate-100 dark:bg-slate-700 px-2 py-1 rounded"><i data-lucide="paperclip" class="h-3 w-3"></i><span>${escapeHtml(filename)}</span></a>`; } const container = document.createElement('div'); container.innerHTML = displayHtml; safelyCreateIcons(); return container.innerHTML; };
      const displaySavedQuizQuestions = async (subject) => {
          if (!currentUserId || !quizItemsList || !db) {
              if(quizItemsList) quizItemsList.innerHTML = createLoadingMessage('Cannot load questions: Not logged in or DB unavailable.');
              return;
          }
          quizItemsList.innerHTML = createLoadingMessage(`Loading ${subject} questions...`);
          try {
              const collRef = getSubjectSpecificCollectionRef(currentUserId, 'quizItems', subject);
              if (!collRef) throw new Error("Could not get quizItems collection ref.");
              const q = query(collRef, orderBy("createdAt", "desc"));
              const snapshot = await getDocs(q);
              const items = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
              quizItemsList.innerHTML = '';

              if (items.length === 0) {
                  quizItemsList.innerHTML = createLoadingMessage(`No questions saved for ${subject} yet.`);
              } else {
                  items.forEach((item, index) => {
                      const div = document.createElement('div');
                      const itemSubject = item.subject || subject;
                      const colorInfo = getSubjectColorInfo(itemSubject);
                      const paper = item.paper || 'General';
                      div.className = `quiz-item list-item flex justify-between items-start p-3 rounded-lg border ${colorInfo.borderClass.replace('border-l-4', 'border')} bg-white dark:bg-slate-800 shadow-sm space-x-3 hover:bg-slate-50 dark:hover:bg-slate-700/60 transition-all duration-150 list-item-appear`;
                      div.style.animationDelay = `${index * 0.05}s`;

                      let questionHtml = item.question ? `<p class="font-medium text-text dark:text-text-dark mb-1 truncate" title="${escapeHtml(item.question)}">Q: ${escapeHtml(item.question)}</p>` : '';
                      if (item.questionFileUrl) {
                          questionHtml += `<div class="mt-1">${renderFilePreview(item.questionFileUrl, 'Question file', 'list')}</div>`;
                      }
                      if (!questionHtml) {
                          questionHtml = `<p class="font-medium text-text dark:text-text-dark mb-1 italic text-muted dark:text-muted-dark">(No question text/file)</p>`;
                      }

                      let answerHtml = item.answer ? `<p class="text-xs text-muted dark:text-muted-dark whitespace-pre-wrap break-words mt-1" title="${escapeHtml(item.answer)}">A: ${escapeHtml(item.answer.substring(0, 100))}${item.answer.length > 100 ? '...' : ''}</p>` : '';
                      if (item.answerFileUrl) {
                          answerHtml += `<div class="mt-1">${renderFilePreview(item.answerFileUrl, 'Answer file', 'list')}</div>`;
                      }
                      if (!answerHtml) {
                          answerHtml = `<p class="text-xs text-muted dark:text-muted-dark mt-1 italic">(No answer text/file)</p>`;
                      }
                      const paperTag = `<span class="text-xs px-1.5 py-0.5 rounded bg-slate-200 dark:bg-slate-600 text-slate-600 dark:text-slate-300 font-medium ml-2">${escapeHtml(paper)}</span>`;

                      const actionsHtml = `
                          <div class="flex-shrink-0 flex items-center space-x-1">
                              <button title="Edit Question" class="list-action-btn edit p-1 -m-1 rounded-full btn-animated focus-visible:ring-1 focus-visible:ring-primary" data-quiz-id="${item.id}"><i data-lucide="edit-3" class="h-4 w-4"></i></button>
                              <button title="Delete Question" class="list-action-btn delete p-1 -m-1 rounded-full btn-animated focus-visible:ring-1 focus-visible:ring-red-500" onclick="window.handleGenericDeleteItem('quizItems', '${escapeHtml(subject)}', '${item.id}', 'quiz question', window.displaySavedQuizQuestions)"><i data-lucide="trash-2" class="h-4 w-4"></i></button>
                          </div>`;

                      div.innerHTML = `<div class="flex-grow text-sm overflow-hidden"><div class="flex justify-between items-start mb-1">${questionHtml}${paperTag}</div>${answerHtml}</div>${actionsHtml}`;
                                            quizItemsList.appendChild(div);

                      // Attach event listener for the new edit button
                      const editBtn = div.querySelector('.list-action-btn.edit');
                      editBtn?.addEventListener('click', () => openEditQuizQuestionModal(item.id, subject, item));
                  });
                  safelyCreateIcons();
              }
              await toggleQuizButtons();
          } catch (error) {
              console.error(`Error loading quiz items for ${subject}:`, error);
              if(quizItemsList) quizItemsList.innerHTML = createLoadingMessage(`Error loading questions for ${subject}. Check console.`);
              await toggleQuizButtons();
          }
      };
      window.displaySavedQuizQuestions = displaySavedQuizQuestions; // Make globally accessible

      const uploadFile = async (file, subject) => { if (!file || !currentUserId || !subject || !storage) { throw new Error("Cannot upload file: Missing required information or storage service."); } if (file.size > MAX_FILE_UPLOAD_SIZE) { throw new Error(`File size exceeds limit (${(MAX_FILE_UPLOAD_SIZE / 1024 / 1024).toFixed(1)} MB).`); } const timestamp = Date.now(); const nameParts = file.name.split('.'); const extension = nameParts.length > 1 ? `.${nameParts.pop()}` : ''; const baseName = nameParts.join('.'); const cleanBaseName = baseName.replace(/[^a-zA-Z0-9_.\-]/g, '_'); const safeFileName = `${cleanBaseName}_${timestamp}${extension}`; const storagePath = `quizFiles/${currentUserId}/${subject}/${safeFileName}`; const storageRef = ref(storage, storagePath); try { const snapshot = await uploadBytes(storageRef, file); const downloadURL = await getDownloadURL(snapshot.ref); return downloadURL; } catch (error) { console.error("Firebase Storage Upload Error:", error); let userMessage = `Upload Failed: ${error.message}`; if (error.code === 'storage/unauthorized') { userMessage = 'Upload Failed: You do not have permission to upload files. Check Storage Rules.'; } else if (error.code === 'storage/canceled') { userMessage = 'Upload Failed: The upload was cancelled.'; } else if (error.code === 'storage/unknown') { userMessage = 'Upload Failed: An unknown error occurred. Check network connection.'; } else if (error.code === 'storage/quota-exceeded') { userMessage = 'Upload Failed: Storage quota exceeded.';} throw new Error(`${userMessage} (Code: ${error.code})`); } };
      const handleSaveQuizQuestion = async () => { if (!currentUserId || !currentActiveSubject || !saveQuizQuestionBtn || !db || !storage || !quizQuestionInput || !quizAnswerInput || !quizQuestionFileInput || !quizAnswerFileInput || !quizPaperSelect) { alert("Cannot save question: Missing required context or elements."); return; } validateQuizForm(); if (saveQuizQuestionBtn.disabled) { return; } const questionText = quizQuestionInput.value.trim(); const answerText = quizAnswerInput.value.trim(); const questionFile = quizQuestionFileInput.files[0]; const answerFile = quizAnswerFileInput.files[0]; const paper = quizPaperSelect.value || 'General'; saveQuizQuestionBtn.disabled = true; saveQuizQuestionBtn.textContent = 'Saving...'; let questionFileUrl = null; let answerFileUrl = null; let errorOccurred = false; try { if (questionFile) { saveQuizQuestionBtn.textContent = 'Uploading Q file...'; questionFileUrl = await uploadFile(questionFile, currentActiveSubject); } if (answerFile) { saveQuizQuestionBtn.textContent = 'Uploading A file...'; answerFileUrl = await uploadFile(answerFile, currentActiveSubject); } saveQuizQuestionBtn.textContent = 'Saving Data...'; const newItem = { question: questionText, answer: answerText, paper: paper, createdAt: serverTimestamp(), subject: currentActiveSubject }; if (questionFileUrl) newItem.questionFileUrl = questionFileUrl; if (answerFileUrl) newItem.answerFileUrl = answerFileUrl; const collRef = getSubjectSpecificCollectionRef(currentUserId, 'quizItems', currentActiveSubject); if (!collRef) throw new Error("Could not get quizItems collection ref for saving."); const docRef = await addDoc(collRef, newItem); if (quizQuestionInput) quizQuestionInput.value = ''; if (quizAnswerInput) quizAnswerInput.value = ''; if (quizQuestionFileInput) quizQuestionFileInput.value = '';
            if (quizAnswerFileInput) quizAnswerFileInput.value = '';
            if (quizQuestionFilenameEl) quizQuestionFilenameEl.textContent = '';
            if (clearQuizQuestionFileBtn) clearQuizQuestionFileBtn.classList.add('hidden');
            if (quizAnswerFilenameEl) quizAnswerFilenameEl.textContent = '';
            if (clearQuizAnswerFileBtn) clearQuizAnswerFileBtn.classList.add('hidden');
            if(quizPaperSelect) quizPaperSelect.value = 'General';
            if (addQuizDetails) addQuizDetails.open = false;
            displaySavedQuizQuestions(currentActiveSubject);
      } catch (error) { errorOccurred = true; console.error("Error during handleSaveQuizQuestion:", error); alert(`Failed to save question. ${error.message}. Check console.`); const cleanupPromises = []; if (questionFileUrl) { cleanupPromises.push( deleteObject(ref(storage, questionFileUrl)).then(() => {}).catch(e => console.warn("Could not clean up orphaned question file:", e)) ); } if (answerFileUrl) { cleanupPromises.push( deleteObject(ref(storage, answerFileUrl)).then(() => {}).catch(e => console.warn("Could not clean up orphaned answer file:", e)) ); } await Promise.allSettled(cleanupPromises); } finally { saveQuizQuestionBtn.textContent = 'Add Question'; validateQuizForm(); } };

      // --- Quiz Mode Logic ---
      const showPaperSelectionModal = () => { if (!quizPaperSelectModal) return; populateQuizPaperOptions(currentActiveSubject); quizPaperSelectModal.classList.remove('hidden'); quizPaperSelectModal.querySelectorAll('.quiz-paper-choice-btn').forEach(btn => { if(btn instanceof HTMLButtonElement) btn.disabled = false; }); if (cancelPaperSelectBtn) cancelPaperSelectBtn.disabled = false; };
      const hidePaperSelectionModal = () => { if (!quizPaperSelectModal) return; quizPaperSelectModal.classList.add('hidden'); };
      const startQuizMode = async (paperSelection) => { if (!currentUserId || !currentActiveSubject || !db) { alert("Cannot start quiz: Missing user, subject, or DB connection."); return; } if (!paperSelection) { alert("Internal error: Paper selection was not provided."); return; } try { const collRef = getSubjectSpecificCollectionRef(currentUserId, 'quizItems', currentActiveSubject); if (!collRef) throw new Error("Could not get quizItems collection ref."); const snapshot = await getDocs(collRef); const allQuestions = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })); let filteredQuestions = []; if (paperSelection === 'All') { filteredQuestions = allQuestions; } else { filteredQuestions = allQuestions.filter(q => (q.paper || 'General') === paperSelection); } if (filteredQuestions.length === 0) { alert(`No questions found for ${currentActiveSubject} matching criteria: ${paperSelection}. Add some questions first!`); return; } quizState = { active: true, currentSubject: currentActiveSubject, currentPaperSelection: paperSelection, initialQuestions: filteredQuestions.map(q => ({ ...q, markedIncorrectInPriorRound: false, masteredInThisSession: false })), currentQuizPool: shuffleArray([...filteredQuestions]), incorrectlyAnswered: [], currentQuestionIndex: 0, round: 1, totalMastered: 0, isAnswerVisible: false, buttonTimeout: null, correctAnswersInSession: 0, isSpinnerModalOpen: false, spinJustFinished: false }; if (addQuizDetails) addQuizDetails.style.display = 'none'; if (quizListContainer) quizListContainer.classList.add('hidden'); if (quizCompletionMessage) quizCompletionMessage.classList.add('hidden'); if (quizModeInterface) quizModeInterface.classList.remove('hidden'); if (stopQuizButton) stopQuizButton.textContent = "Stop Quiz"; displayCurrentQuizQuestion(); } catch (error) { console.error("Error starting quiz:", error); alert("Could not start the quiz due to an error. Check console."); stopQuizMode(); } };
      const stopQuizMode = () => { if (!quizState.active && quizModeInterface?.classList.contains('hidden')) { return; } const wasActive = quizState.active;
       if (spinnerModalOverlay && spinnerModalOverlay.classList.contains('visible')) {
           closeSpinnerModal(false);
       }
       quizState.active = false; quizState.isSpinnerModalOpen = false; quizState.spinJustFinished = false; if (quizModeInterface) quizModeInterface.classList.add('hidden'); if (currentActiveSubject) { if (addQuizDetails) addQuizDetails.style.display = 'block'; if (quizListContainer) quizListContainer.classList.remove('hidden'); } if (quizCorrectAnswerDisplay) quizCorrectAnswerDisplay.style.display = 'none'; if (quizJudgmentButtons) quizJudgmentButtons.style.display = 'flex';
       if (quizState.buttonTimeout) { clearTimeout(quizState.buttonTimeout); quizState.buttonTimeout = null; } const subjectBeforeReset = quizState.currentSubject; quizState = { active: false, currentSubject: subjectBeforeReset, currentPaperSelection: 'All', initialQuestions: [], currentQuizPool: [], incorrectlyAnswered: [], currentQuestionIndex: -1, round: 1, totalMastered: 0, isAnswerVisible: false, buttonTimeout: null, correctAnswersInSession: 0, isSpinnerModalOpen: false, spinJustFinished: false }; if (wasActive) toggleQuizButtons(); };
      const updateQuizProgressDisplay = () => { if (!quizProgress || !quizState.active) return; const remainingInPool = Math.max(0, quizState.currentQuizPool.length - quizState.currentQuestionIndex); const totalInitial = quizState.initialQuestions.length; quizProgress.textContent = `Round ${quizState.round} | ${quizState.currentPaperSelection} | Remain: ${remainingInPool} | Mastered: ${quizState.totalMastered}/${totalInitial} | Streak: ${quizState.correctAnswersInSession}/${CORRECT_ANSWERS_FOR_SPINNER}`; };
      const displayCurrentQuizQuestion = () => { if (!quizState.active || !quizQuestionDisplay || !quizCorrectAnswerDisplay || !quizRevealBtnContainer || !quizJudgmentButtons || !quizAnswerTextDisplay || !quizAnswerFileDisplay) { stopQuizMode(); return; } quizCorrectAnswerDisplay.style.display = 'none'; quizCorrectAnswerDisplay.classList.remove('visible'); quizState.isAnswerVisible = false; quizJudgmentButtons.style.display = 'none';
       quizRevealBtnContainer.style.display = 'block';
       quizCorrectBtn?.classList.remove('quiz-feedback-correct'); quizIncorrectBtn?.classList.remove('quiz-feedback-incorrect'); if (quizState.currentQuestionIndex >= quizState.currentQuizPool.length) { handleQuizRoundEnd(); return; } const questionData = quizState.currentQuizPool[quizState.currentQuestionIndex]; if (!questionData) { stopQuizMode(); alert("An error occurred loading the next question."); return; } quizQuestionDisplay.innerHTML = ''; let questionContentRendered = false; if (questionData.question) { const p = document.createElement('p'); p.className = 'text-text dark:text-text-dark text-lg mb-3 whitespace-pre-wrap'; p.textContent = questionData.question; quizQuestionDisplay.appendChild(p); questionContentRendered = true; } if (questionData.questionFileUrl) { const previewHtml = renderFilePreview(questionData.questionFileUrl, 'Question file', 'quiz'); quizQuestionDisplay.insertAdjacentHTML('beforeend', previewHtml); questionContentRendered = true; } if (!questionContentRendered) { const p = document.createElement('p'); p.className = 'italic text-muted dark:text-muted-dark text-base'; p.textContent = '(Question content missing)'; quizQuestionDisplay.appendChild(p); } let answerContentRendered = false; if (questionData.answer) { quizAnswerTextDisplay.innerHTML = `<strong class="text-sm font-semibold text-primary dark:text-primary-dark mr-2">Answer:</strong><span class="whitespace-pre-wrap">${escapeHtml(questionData.answer)}</span>`; answerContentRendered = true; } else { quizAnswerTextDisplay.innerHTML = ''; } quizAnswerFileDisplay.innerHTML = questionData.answerFileUrl ? renderFilePreview(questionData.answerFileUrl, 'Answer file', 'quiz') : ''; if (questionData.answerFileUrl) answerContentRendered = true; if (!answerContentRendered && quizAnswerTextDisplay) { quizAnswerTextDisplay.innerHTML = `<strong class="text-sm font-semibold text-primary dark:text-primary-dark mr-2">Answer:</strong><span class="italic text-muted dark:text-muted-dark">(Answer content missing)</span>`; } updateQuizProgressDisplay(); if (quizCorrectBtn) quizCorrectBtn.disabled = true;
       if (quizIncorrectBtn) quizIncorrectBtn.disabled = true; safelyCreateIcons(); };
      const revealQuizAnswer = () => { if (!quizState.active || !quizCorrectAnswerDisplay || !quizRevealBtnContainer || !quizJudgmentButtons) { return; } quizCorrectAnswerDisplay.classList.add('visible'); quizCorrectAnswerDisplay.style.display = 'block'; quizRevealBtnContainer.style.display = 'none';
       quizJudgmentButtons.style.display = 'flex';
       quizState.isAnswerVisible = true; if (quizCorrectBtn) quizCorrectBtn.disabled = false;
       if (quizIncorrectBtn) quizIncorrectBtn.disabled = false; safelyCreateIcons(); };
      const handleQuizAnswer = (isCorrect) => {
          if (!quizState.active || !quizState.isAnswerVisible || quizState.buttonTimeout || quizState.isSpinnerModalOpen || !quizCorrectBtn || !quizIncorrectBtn) {
              return;
          }
          const currentQuestion = quizState.currentQuizPool[quizState.currentQuestionIndex];
          if (!currentQuestion) {
              return;
          }
          quizCorrectBtn.disabled = true;
          quizIncorrectBtn.disabled = true;

          if (isCorrect) {
              quizState.correctAnswersInSession++;
              let originalQuestionRef = quizState.initialQuestions.find(q => q.id === currentQuestion.id);
              if (originalQuestionRef && !originalQuestionRef.markedIncorrectInPriorRound && !originalQuestionRef.masteredInThisSession) {
                  quizState.totalMastered++;
                  originalQuestionRef.masteredInThisSession = true;
              }
              quizCorrectBtn?.classList.add('quiz-feedback-correct');

              if (quizState.correctAnswersInSession >= CORRECT_ANSWERS_FOR_SPINNER) {
                  if (quizJudgmentButtons) quizJudgmentButtons.style.display = 'none';
                  setTimeout(showSpinnerModal, 400);
                  return; // Don't proceed to next question immediately
              }
          } else {
              quizState.correctAnswersInSession = 0;
              if (!quizState.incorrectlyAnswered.find(iq => iq.id === currentQuestion.id)) {
                  quizState.incorrectlyAnswered.push(currentQuestion);
              }
              let originalQuestionRef = quizState.initialQuestions.find(q => q.id === currentQuestion.id);
              if (originalQuestionRef) {
                  originalQuestionRef.markedIncorrectInPriorRound = true;
                  if (originalQuestionRef.masteredInThisSession) {
                      originalQuestionRef.masteredInThisSession = false;
                      quizState.totalMastered = quizState.initialQuestions.filter(q => q.masteredInThisSession).length;
                  }
              }
              quizIncorrectBtn?.classList.add('quiz-feedback-incorrect');
          }

          updateQuizProgressDisplay();
          quizState.buttonTimeout = setTimeout(() => {
              quizState.buttonTimeout = null;
              quizState.currentQuestionIndex++;
              displayCurrentQuizQuestion();
          }, 800);
      };
      const handleQuizRoundEnd = () => { const trulyMasteredCount = quizState.initialQuestions.filter(q => q.masteredInThisSession).length; quizState.totalMastered = trulyMasteredCount; updateQuizProgressDisplay(); if (quizState.incorrectlyAnswered.length === 0) { if(quizCompletionMessage) { quizCompletionMessage.textContent = `🎉 Well done! You've mastered all ${quizState.initialQuestions.length} questions for ${quizState.currentSubject} (${quizState.currentPaperSelection})!`; quizCompletionMessage.classList.remove('hidden'); } if (quizQuestionDisplay) quizQuestionDisplay.innerHTML = '<p class="italic text-muted dark:text-muted-dark">Quiz complete!</p>'; if (quizRevealBtnContainer) quizRevealBtnContainer.style.display = 'none'; if (quizJudgmentButtons) quizJudgmentButtons.style.display = 'none'; if (quizCorrectAnswerDisplay) quizCorrectAnswerDisplay.style.display = 'none'; if (stopQuizButton) stopQuizButton.textContent = "Finish Session"; } else { quizState.round++; quizState.currentQuizPool = shuffleArray([...quizState.incorrectlyAnswered]); quizState.incorrectlyAnswered = []; quizState.currentQuestionIndex = 0; alert(`Round ${quizState.round} starting with ${quizState.currentQuizPool.length} remaining question(s).`); displayCurrentQuizQuestion(); } };

      // --- Momentum Spinner Logic ---
      const populateMomentumSpinner = () => {
            if (!momentumSpinner || !momentumSpinnerViewport) return;
            momentumSpinner.innerHTML = '';
            momentumSpinnerState.fullSequence = [];
            const shuffledItems = shuffleArray([...MOMENTUM_ITEMS]);

            for (let r = 0; r < MOMENTUM_REPETITIONS; r++) {
                shuffledItems.forEach(itemValue => {
                    const itemElement = document.createElement('div');
                    itemElement.classList.add('momentum-spinner-item');
                    itemElement.innerHTML = `${itemValue}<span>min</span>`;
                    itemElement.dataset.value = itemValue;
                    momentumSpinner.appendChild(itemElement);
                    momentumSpinnerState.fullSequence.push(itemValue);
                });
            }

            const bufferCount = Math.ceil(momentumSpinnerViewport.offsetWidth / MOMENTUM_ITEM_WIDTH / 2) + 10;
            for (let i = 0; i < bufferCount; i++) {
                const prependValue = shuffledItems[shuffledItems.length - 1 - (i % shuffledItems.length)];
                const prependEl = document.createElement('div');
                prependEl.classList.add('momentum-spinner-item');
                prependEl.innerHTML = `${prependValue}<span>min</span>`;
                momentumSpinner.insertBefore(prependEl, momentumSpinner.firstChild);

                const appendValue = shuffledItems[i % shuffledItems.length];
                const appendEl = document.createElement('div');
                appendEl.classList.add('momentum-spinner-item');
                appendEl.innerHTML = `${appendValue}<span>min</span>`;
                momentumSpinner.appendChild(appendEl);
            }
        };

      const getWeightedRandomMomentumItem = () => {
            const totalWeight = MOMENTUM_WEIGHTS.reduce((sum, item) => sum + item.weight, 0);
            let randomNum = Math.random() * totalWeight;
            for (const item of MOMENTUM_WEIGHTS) {
                if (randomNum < item.weight) return item.value;
                randomNum -= item.weight;
            }
            return MOMENTUM_WEIGHTS[MOMENTUM_WEIGHTS.length - 1].value;
      };

      const triggerValueUpdateAnimation = (element, value) => {
            if (!element) return;
            element.textContent = value;
            element.classList.add('updated');
            setTimeout(() => {
                element.classList.remove('updated');
            }, 300);
        };

       const showSpinnerModal = () => {
            if (!spinnerModalOverlay || momentumSpinnerState.isSpinning || quizState.isSpinnerModalOpen) {
                return;
            }
            quizState.isSpinnerModalOpen = true;
            momentumSpinnerState.isSpinning = false;
            quizState.spinJustFinished = false;

            populateMomentumSpinner();

            if (modalSpinButton) {
                modalSpinButton.disabled = false;
                modalSpinButton.textContent = 'Spin Now';
                modalSpinButton.classList.add('ready-to-spin');
            }
            if (momentumResultDisplay) momentumResultDisplay.classList.remove('show');
            if (momentumResultValueDisplay) momentumResultValueDisplay.textContent = '?';
            if (closeSpinnerModalButton) closeSpinnerModalButton.style.display = 'none';

            if (momentumSpinner && momentumSpinnerViewport) {
                 momentumSpinner.style.transition = 'none';
                 const initialOffset = (momentumSpinnerViewport.offsetWidth / 2) - (MOMENTUM_ITEM_WIDTH * 3.5) ;
                 momentumSpinner.style.transform = `translateX(${initialOffset}px)`;
                 momentumSpinner.offsetHeight;
            }

            spinnerModalOverlay.classList.remove('hidden');
            requestAnimationFrame(() => {
                spinnerModalOverlay.classList.add('visible');
                safelyCreateIcons();
            });
        };

      const performMomentumSpin = () => {
            if (momentumSpinnerState.isSpinning || !momentumSpinner || !momentumSpinnerViewport) {
                return;
            }
            momentumSpinnerState.isSpinning = true;
            if (modalSpinButton) {
                modalSpinButton.disabled = true;
                modalSpinButton.textContent = 'Spinning...';
                modalSpinButton.classList.remove('ready-to-spin');
            }
            if (momentumResultDisplay) momentumResultDisplay.classList.remove('show');

            const winningValue = getWeightedRandomMomentumItem();
            const bufferItemCountApprox = Array.from(momentumSpinner.children).findIndex(el => el.classList.contains('momentum-spinner-item') && parseInt(el.dataset.value) === momentumSpinnerState.fullSequence[0]);
            const minSearchIndex = Math.floor(momentumSpinnerState.fullSequence.length * 0.3);
            const maxSearchIndex = Math.floor(momentumSpinnerState.fullSequence.length * 0.8);
            let possibleIndices = [];
            momentumSpinnerState.fullSequence.forEach((val, idx) => {
                 if (val === winningValue && idx >= minSearchIndex && idx < maxSearchIndex) {
                    possibleIndices.push(idx);
                 }
            });
            let targetSequenceIndex;
            if (possibleIndices.length > 0) { targetSequenceIndex = possibleIndices[Math.floor(Math.random() * possibleIndices.length)]; } else { targetSequenceIndex = momentumSpinnerState.fullSequence.findIndex((val, idx) => val === winningValue && idx >= MOMENTUM_ITEMS.length); if (targetSequenceIndex === -1) { targetSequenceIndex = momentumSpinnerState.fullSequence.findIndex(val => val === winningValue); if (targetSequenceIndex === -1) targetSequenceIndex = 0; } }
            const viewportWidth = momentumSpinnerViewport.offsetWidth;
            const markerPosition = viewportWidth / 2;
            const adjustedTargetIndex = targetSequenceIndex + bufferItemCountApprox;
            const targetCenterPosition = (adjustedTargetIndex * MOMENTUM_ITEM_WIDTH) + (MOMENTUM_ITEM_WIDTH / 2);
            const maxOffset = MOMENTUM_ITEM_WIDTH * 0.40;
            let nearMissOffset = (Math.random() * maxOffset * 2) - maxOffset;
            if (Math.abs(nearMissOffset) < 5) { nearMissOffset = (nearMissOffset >= 0 ? 1 : -1) * (5 + Math.random() * (maxOffset - 5)); }
            const finalPosition = -(targetCenterPosition - markerPosition) + nearMissOffset;

            momentumSpinner.style.transition = `transform ${MOMENTUM_SPIN_DURATION_SECONDS}s ${tailwind.config.theme.extend.transitionTimingFunction['momentum-spin']}`;
            momentumSpinner.style.transform = `translateX(${finalPosition}px)`;

            if (momentumSpinnerState.spinTimeout) { clearTimeout(momentumSpinnerState.spinTimeout); }
            momentumSpinnerState.spinTimeout = setTimeout(async () => {
                momentumSpinnerState.isSpinning = false;
                quizState.spinJustFinished = true;
                if (modalSpinButton) { modalSpinButton.disabled = true; modalSpinButton.textContent = 'Result!'; }
                if (closeSpinnerModalButton) closeSpinnerModalButton.style.display = 'block';
                triggerValueUpdateAnimation(momentumResultValueDisplay, winningValue);
                momentumResultDisplay.innerHTML = `You got <span id="momentum-result-value">${winningValue}</span> minutes! <i data-lucide="award" class="inline-block h-5 w-5 text-yellow-500 ml-1"></i>`;
                safelyCreateIcons();
                if (momentumResultDisplay) momentumResultDisplay.classList.add('show');
                await addWonTime(winningValue * 60);
                 setTimeout(() => { if (spinnerModalOverlay?.classList.contains('visible') && quizState.spinJustFinished) { closeSpinnerModal(true); } }, 2500);
            }, MOMENTUM_SPIN_DURATION_MS + 100);
        };

        const closeSpinnerModal = (proceedWithQuiz = false) => {
            if (!spinnerModalOverlay || !spinnerModalOverlay.classList.contains('visible')) {
                momentumSpinnerState.isSpinning = false;
                quizState.isSpinnerModalOpen = false;
                quizState.spinJustFinished = false;
                if (momentumSpinnerState.spinTimeout) clearTimeout(momentumSpinnerState.spinTimeout);
                return;
            }
            const spinHadJustFinished = quizState.spinJustFinished;
            spinnerModalOverlay.classList.remove('visible');
            setTimeout(() => {
                spinnerModalOverlay?.classList.add('hidden');
                if (momentumSpinner) { momentumSpinner.style.transition = 'none'; }
                 if (momentumResultDisplay) { momentumResultDisplay.classList.remove('show'); momentumResultDisplay.innerHTML = `You got <span id="momentum-result-value">?</span> minutes!`; }
                 if (momentumResultValueDisplay) momentumResultValueDisplay.textContent = '?';
                 if (closeSpinnerModalButton) closeSpinnerModalButton.style.display = 'none';
            }, 300);
             if (momentumSpinnerState.spinTimeout) { clearTimeout(momentumSpinnerState.spinTimeout); momentumSpinnerState.spinTimeout = null; }
            momentumSpinnerState.isSpinning = false;
            quizState.isSpinnerModalOpen = false;
            quizState.spinJustFinished = false;
            if (spinHadJustFinished && proceedWithQuiz && quizState.active) {
                quizState.correctAnswersInSession = 0;
                quizState.currentQuestionIndex++;
                if (quizJudgmentButtons) quizJudgmentButtons.style.display = 'none';
                if (quizRevealBtnContainer) quizRevealBtnContainer.style.display = 'block';
                if (quizCorrectAnswerDisplay) quizCorrectAnswerDisplay.style.display = 'none';
                displayCurrentQuizQuestion();
            } else if (!proceedWithQuiz && quizState.active && quizState.isAnswerVisible) {
                if (quizJudgmentButtons && quizState.currentQuestionIndex < quizState.currentQuizPool.length) {
                    quizJudgmentButtons.style.display = 'flex';
                    if(quizCorrectBtn) quizCorrectBtn.disabled = false;
                    if(quizIncorrectBtn) quizIncorrectBtn.disabled = false;
                }
            }
        };

      // --- Edit Quiz Question Modal Logic ---
      const openEditQuizQuestionModal = (quizId, subject, quizData) => {
          if (!editQuizQuestionModal || !editQuizIdInput || !editQuizSubjectInput || !editQuizQuestionInput || !editQuizAnswerInput || !editQuizPaperSelect || !editQuizErrorMessage || !editQuizQuestionFileInput || !editQuizAnswerFileInput || !currentEditQFileDisplay || !currentEditAFileDisplay) return;

          initialQuizDataForEdit = { // Reset initial data
              questionFileUrl: quizData.questionFileUrl || null,
              answerFileUrl: quizData.answerFileUrl || null,
              questionFileCleared: false,
              answerFileCleared: false
          };

          editQuizIdInput.value = quizId;
          editQuizSubjectInput.value = subject;
          editQuizQuestionInput.value = quizData.question || '';
          editQuizAnswerInput.value = quizData.answer || '';
          populateQuizPaperOptions(subject, editQuizPaperSelect); // Populate and set value
          editQuizPaperSelect.value = quizData.paper || 'General';
          editQuizErrorMessage.textContent = '';

          // Reset file inputs and displays
          editQuizQuestionFileInput.value = '';
          editQuizAnswerFileInput.value = '';
          editQuizQuestionFilenameEl.textContent = '';
          editClearQuizQuestionFileBtn.classList.add('hidden');
          editQuizAnswerFilenameEl.textContent = '';
          editClearQuizAnswerFileBtn.classList.add('hidden');

          // Show current files
          currentEditQFileDisplay.innerHTML = `Current: ${quizData.questionFileUrl ? renderFilePreview(quizData.questionFileUrl, 'Current Question File', 'list') : 'None'}`;
          currentEditAFileDisplay.innerHTML = `Current: ${quizData.answerFileUrl ? renderFilePreview(quizData.answerFileUrl, 'Current Answer File', 'list') : 'None'}`;
          safelyCreateIcons(); // For icons in renderFilePreview

          validateEditQuizForm();
          editQuizQuestionModal.classList.remove('hidden');
      };

      const closeEditQuizQuestionModal = () => {
          if (editQuizQuestionModal) editQuizQuestionModal.classList.add('hidden');
          if (editQuizErrorMessage) editQuizErrorMessage.textContent = '';
          // Reset initial data tracking
          initialQuizDataForEdit = { questionFileUrl: null, answerFileUrl: null, questionFileCleared: false, answerFileCleared: false };
      };

      const validateEditQuizForm = () => validateQuizForm(true); // Use shared validation logic

      const handleSaveQuizQuestionChanges = async () => {
          if (!currentUserId || !db || !storage || !editQuizIdInput || !editQuizSubjectInput || !editQuizQuestionInput || !editQuizAnswerInput || !editQuizPaperSelect || !editQuizErrorMessage || !saveQuizChangesBtn || !editQuizQuestionFileInput || !editQuizAnswerFileInput) {
              if(editQuizErrorMessage) editQuizErrorMessage.textContent = 'Error: Modal elements missing.';
              return;
          }

          validateEditQuizForm();
          if (saveQuizChangesBtn.disabled) {
              if(editQuizErrorMessage) editQuizErrorMessage.textContent = 'Please ensure question and answer (text or file) are provided.';
              return;
          }
          editQuizErrorMessage.textContent = '';

          const quizId = editQuizIdInput.value;
          const subject = editQuizSubjectInput.value;
          const questionText = editQuizQuestionInput.value.trim();
          const answerText = editQuizAnswerInput.value.trim();
          const paper = editQuizPaperSelect.value || 'General';
          const newQuestionFile = editQuizQuestionFileInput.files[0];
          const newAnswerFile = editQuizAnswerFileInput.files[0];

          saveQuizChangesBtn.disabled = true;
          saveQuizChangesBtn.textContent = 'Saving...';

          const updatedQuizData = { question: questionText, answer: answerText, paper: paper, updatedAt: serverTimestamp() };
          let newQuestionFileUrl = null;
          let newAnswerFileUrl = null;
          let errorOccurred = false;
          const filesToDelete = { qFile: null, aFile: null };

          try {
              // Handle Question File
              if (newQuestionFile) {
                  saveQuizChangesBtn.textContent = 'Uploading Q file...';
                  newQuestionFileUrl = await uploadFile(newQuestionFile, subject);
                  updatedQuizData.questionFileUrl = newQuestionFileUrl;
                  if (initialQuizDataForEdit.questionFileUrl) { filesToDelete.qFile = initialQuizDataForEdit.questionFileUrl; } // Mark old file for deletion
              } else if (initialQuizDataForEdit.questionFileCleared) {
                  updatedQuizData.questionFileUrl = deleteField(); // Remove field
                  if (initialQuizDataForEdit.questionFileUrl) { filesToDelete.qFile = initialQuizDataForEdit.questionFileUrl; } // Mark old file for deletion
              } // Else: Keep existing file (no change needed in updatedQuizData)

              // Handle Answer File
              if (newAnswerFile) {
                  saveQuizChangesBtn.textContent = 'Uploading A file...';
                  newAnswerFileUrl = await uploadFile(newAnswerFile, subject);
                  updatedQuizData.answerFileUrl = newAnswerFileUrl;
                  if (initialQuizDataForEdit.answerFileUrl) { filesToDelete.aFile = initialQuizDataForEdit.answerFileUrl; } // Mark old file for deletion
              } else if (initialQuizDataForEdit.answerFileCleared) {
                  updatedQuizData.answerFileUrl = deleteField(); // Remove field
                  if (initialQuizDataForEdit.answerFileUrl) { filesToDelete.aFile = initialQuizDataForEdit.answerFileUrl; } // Mark old file for deletion
              } // Else: Keep existing file

              saveQuizChangesBtn.textContent = 'Updating Data...';
              const docRef = getSubjectSpecificDocRef(currentUserId, 'quizItems', subject, quizId);
              if (!docRef) throw new Error("Could not get document reference for update.");
              await updateDoc(docRef, updatedQuizData);

              // Delete old files AFTER successful database update
              if (filesToDelete.qFile || filesToDelete.aFile) {
                  await handleDeleteQuizItemFiles(subject, null, filesToDelete);
              }

              closeEditQuizQuestionModal();
              if (currentActiveSubject === subject) {
                  displaySavedQuizQuestions(subject);
              }

          } catch (error) {
              errorOccurred = true;
              console.error("Error updating quiz question:", error);
              if(editQuizErrorMessage) editQuizErrorMessage.textContent = `Failed to save changes. ${error.message}.`;
              alert("Failed to update quiz question. Please try again.");

              // Attempt to delete newly uploaded files if DB update failed
              const cleanupPromises = [];
              if (newQuestionFileUrl) { cleanupPromises.push( deleteObject(ref(storage, newQuestionFileUrl)).catch(e => console.warn("Could not clean up failed Q upload:", e)) ); }
              if (newAnswerFileUrl) { cleanupPromises.push( deleteObject(ref(storage, newAnswerFileUrl)).catch(e => console.warn("Could not clean up failed A upload:", e)) ); }
              await Promise.allSettled(cleanupPromises);

          } finally {
              saveQuizChangesBtn.disabled = false;
              saveQuizChangesBtn.textContent = 'Save Changes';
          }
      };



      // --- General Setup and Initialization ---
      const populateSubjectDropdown = (selectElement) => { if (!(selectElement instanceof HTMLSelectElement)) return; const currentValue = selectElement.value; const placeholder = selectElement.options[0]?.value === "" ? selectElement.options[0].cloneNode(true) : null; selectElement.innerHTML = ''; if (placeholder) { selectElement.appendChild(placeholder); } else { const opt = document.createElement('option'); opt.value = ""; opt.textContent = "-- Select Subject --"; selectElement.appendChild(opt); } if (!subjects || subjects.length === 0) return; subjects.forEach(subject => { const option = document.createElement('option'); option.value = subject; option.textContent = subject; selectElement.appendChild(option); }); if (subjects.includes(currentValue)) { selectElement.value = currentValue; } };

      const updateFileInputDisplay = (fileInput, filenameEl, clearBtn, isEdit = false, fileType = '') => { // Added isEdit and fileType
          if (!fileInput || !filenameEl || !clearBtn) return;

          if (fileInput.files && fileInput.files.length > 0) {
              filenameEl.textContent = fileInput.files[0].name;
              clearBtn.classList.remove('hidden');
              // If editing, mark that this file type is *not* cleared if a new one is selected
              if (isEdit) {
                  if (fileType === 'question') initialQuizDataForEdit.questionFileCleared = false;
                  if (fileType === 'answer') initialQuizDataForEdit.answerFileCleared = false;
              }
          } else {
              filenameEl.textContent = '';
              clearBtn.classList.add('hidden');
              // If editing and the input is cleared, mark that the file *should* be cleared
              if (isEdit) {
                  if (fileType === 'question') initialQuizDataForEdit.questionFileCleared = true;
                  if (fileType === 'answer') initialQuizDataForEdit.answerFileCleared = true;
              }
          }
          if(isEdit) validateEditQuizForm(); else validateQuizForm();
      };


      const setupGlobalEventListeners = () => {
          if (eventListenersAttached) {
              return;
          }
          // Login/Logout/Theme/Navigation... (Existing listeners)
          themeToggle?.addEventListener('click', toggleTheme);
          themeToggleMobile?.addEventListener('click', toggleTheme);
          loginButton?.addEventListener('click', handleLogin);
          passwordInput?.addEventListener('keypress', (e) => { if (e.key === 'Enter') handleLogin(); });
          logoutButton?.addEventListener('click', handleLogout);
          logoutButtonMobile?.addEventListener('click', handleLogout);
          changePasswordButton?.addEventListener('click', handleChangePassword);
          mobileMenuButton?.addEventListener('click', openMobileMenu);
          mobileCloseButton?.addEventListener('click', closeMobileMenu);
          mobileOverlay?.addEventListener('click', closeMobileMenu);
          document.querySelectorAll('a.nav-link[data-page], a.mobile-nav-link[data-page]').forEach(link => { link.addEventListener('click', (e) => { e.preventDefault(); if (link instanceof HTMLElement && link.dataset.page) { window.navigateToPage(link.dataset.page); } }); });
          getElement('dashboard')?.addEventListener('click', (e) => { const pomodoroBtn = e.target.closest('#start-pomodoro-dashboard-btn'); const examItem = e.target.closest('#upcoming-exams-list .upcoming-exam-item'); const quickAddResource = e.target.closest('#quick-add-resource'); const quickAddTracker = e.target.closest('#quick-add-tracker'); const quickAddPlanner = e.target.closest('#quick-add-planner'); if (pomodoroBtn) { window.navigateToPage('pomodoro'); } else if (examItem instanceof HTMLElement && examItem.dataset.page && examItem.dataset.subject) { window.navigateToPage(examItem.dataset.page, examItem.dataset.subject); } else if (quickAddResource) { window.navigateToPage('resources', null, 'add-resource-details'); } else if (quickAddTracker) { window.navigateToPage('tracker', null, 'add-tracker-details'); } else if (quickAddPlanner) { window.navigateToPage('planner'); } });

          // Resources
          subjectTabsContainer?.addEventListener('click', (e) => { const tab = e.target.closest('.subject-tab'); if (tab instanceof HTMLElement && tab.dataset.subject) { handleSubjectSelection(tab.dataset.subject, 'resources'); } });
          resourceTypeSelect?.addEventListener('change', () => toggleResourceTypeFields(false));
          resourceTitleInput?.addEventListener('input', validateResourceForm);
          resourceUrlInput?.addEventListener('input', validateResourceForm);
          resourceNoteInput?.addEventListener('input', validateResourceForm);
          saveResourceBtn?.addEventListener('click', handleSaveResource);
          editResourceTypeSelect?.addEventListener('change', () => toggleResourceTypeFields(true));
          editResourceTitleInput?.addEventListener('input', validateEditResourceForm);
          editResourceUrlInput?.addEventListener('input', validateEditResourceForm);
          editResourceNoteInput?.addEventListener('input', validateEditResourceForm);
          saveResourceChangesBtn?.addEventListener('click', handleSaveResourceChanges);
          cancelEditResourceBtn?.addEventListener('click', closeEditResourceModal);

          // Pomodoro
          startPauseButton?.addEventListener('click', () => { if (pomodoroState.timerState === 'running') pauseTimer(); else startTimer(); });
          resetButton?.addEventListener('click', () => resetTimer(false));
          modeButtons.forEach(btn => { btn?.addEventListener('click', () => { if (btn instanceof HTMLElement && btn.dataset.mode) { const mode = btn.dataset.mode; if (mode !== pomodoroState.timerMode) { setTimerMode(mode, true); } } }); });
          workDurationInput?.addEventListener('change', () => handleDurationChange('work'));
          shortBreakDurationInput?.addEventListener('change', () => handleDurationChange('shortBreak'));
          longBreakDurationInput?.addEventListener('change', () => handleDurationChange('longBreak'));
          pomodoroSubjectSelect?.addEventListener('change', () => { if (pomodoroState.timerState === 'stopped' && pomodoroState.timerMode === 'work') { pomodoroState.workSessionSubject = pomodoroSubjectSelect.value; savePomodoroState(); } });
          useWonTimeButton?.addEventListener('click', startBonusTimer);

          // Tracker
          trackerSubjectSelect?.addEventListener('change', (e) => { if (e.target instanceof HTMLSelectElement) handleSubjectSelection(e.target.value, 'tracker'); });
          trackerDescriptionInput?.addEventListener('input', validateTrackerForm);
          trackerStatusSelect?.addEventListener('change', validateTrackerForm);
          saveTrackerItemBtn?.addEventListener('click', handleSaveTrackerItem);
          editTrackerDescriptionInput?.addEventListener('input', validateEditTrackerForm);
          editTrackerStatusSelect?.addEventListener('change', validateEditTrackerForm);
          saveTrackerChangesBtn?.addEventListener('click', handleSaveTrackerItemChanges);
          cancelEditTrackerBtn?.addEventListener('click', closeEditTrackerItemModal);

          // Planner
          plannerDateInput?.addEventListener('input', validatePlannerForm);
          plannerTimeInput?.addEventListener('input', validatePlannerForm);
          plannerSubjectSelect?.addEventListener('change', validatePlannerForm);
          plannerTopicInput?.addEventListener('input', validatePlannerForm);
          savePlannerItemBtn?.addEventListener('click', handleSavePlannerItem);

          // Quiz (Add)
          quizSubjectSelect?.addEventListener('change', (e) => { if (e.target instanceof HTMLSelectElement) handleSubjectSelection(e.target.value, 'quiz'); });
          quizQuestionInput?.addEventListener('input', validateQuizForm);
          quizAnswerInput?.addEventListener('input', validateQuizForm);
          quizQuestionFileInput?.addEventListener('change', () => updateFileInputDisplay(quizQuestionFileInput, quizQuestionFilenameEl, clearQuizQuestionFileBtn, false, 'question'));
          clearQuizQuestionFileBtn?.addEventListener('click', () => { if (quizQuestionFileInput) quizQuestionFileInput.value = ''; updateFileInputDisplay(quizQuestionFileInput, quizQuestionFilenameEl, clearQuizQuestionFileBtn, false, 'question'); });
          quizAnswerFileInput?.addEventListener('change', () => updateFileInputDisplay(quizAnswerFileInput, quizAnswerFilenameEl, clearQuizAnswerFileBtn, false, 'answer'));
          clearQuizAnswerFileBtn?.addEventListener('click', () => { if (quizAnswerFileInput) quizAnswerFileInput.value = ''; updateFileInputDisplay(quizAnswerFileInput, quizAnswerFilenameEl, clearQuizAnswerFileBtn, false, 'answer'); });
          quizPaperSelect?.addEventListener('change', validateQuizForm);
          saveQuizQuestionBtn?.addEventListener('click', handleSaveQuizQuestion);

          // Quiz (Mode)
          startQuizButton?.addEventListener('click', showPaperSelectionModal);
          stopQuizButton?.addEventListener('click', stopQuizMode);
          quizRevealAnswerBtn?.addEventListener('click', revealQuizAnswer);
          quizCorrectBtn?.addEventListener('click', () => handleQuizAnswer(true));
          quizIncorrectBtn?.addEventListener('click', () => handleQuizAnswer(false));
          quizPaperModalOptions?.addEventListener('click', (e) => { const choiceBtn = e.target.closest('.quiz-paper-choice-btn'); if (choiceBtn instanceof HTMLButtonElement && choiceBtn.dataset.paperChoice) { hidePaperSelectionModal(); startQuizMode(choiceBtn.dataset.paperChoice); } });
          cancelPaperSelectBtn?.addEventListener('click', hidePaperSelectionModal);

          // Quiz (Edit Modal)
          editQuizQuestionInput?.addEventListener('input', validateEditQuizForm);
          editQuizAnswerInput?.addEventListener('input', validateEditQuizForm);
          editQuizQuestionFileInput?.addEventListener('change', () => updateFileInputDisplay(editQuizQuestionFileInput, editQuizQuestionFilenameEl, editClearQuizQuestionFileBtn, true, 'question'));
          editClearQuizQuestionFileBtn?.addEventListener('click', () => {
                if (editQuizQuestionFileInput) editQuizQuestionFileInput.value = '';
                updateFileInputDisplay(editQuizQuestionFileInput, editQuizQuestionFilenameEl, editClearQuizQuestionFileBtn, true, 'question');
          });
          editQuizAnswerFileInput?.addEventListener('change', () => updateFileInputDisplay(editQuizAnswerFileInput, editQuizAnswerFilenameEl, editClearQuizAnswerFileBtn, true, 'answer'));
          editClearQuizAnswerFileBtn?.addEventListener('click', () => {
                if (editQuizAnswerFileInput) editQuizAnswerFileInput.value = '';
                updateFileInputDisplay(editQuizAnswerFileInput, editQuizAnswerFilenameEl, editClearQuizAnswerFileBtn, true, 'answer');
          });
          editQuizPaperSelect?.addEventListener('change', validateEditQuizForm);
          saveQuizChangesBtn?.addEventListener('click', handleSaveQuizQuestionChanges);
          cancelEditQuizBtn?.addEventListener('click', closeEditQuizQuestionModal);

          // Goals & Spinner
          saveDailyGoalsBtn?.addEventListener('click', saveDailyGoals);
          modalSpinButton?.addEventListener('click', performMomentumSpin);
          closeSpinnerModalButton?.addEventListener('click', () => closeSpinnerModal(false));

          eventListenersAttached = true;
      };

      const initializeAppHub = () => {
          try {
              applyTheme(localStorage.getItem('theme') || 'light');
          } catch(e){
              applyTheme('light');
          }
          setupGlobalEventListeners();
          if(spinnerModalOverlay) spinnerModalOverlay.classList.add('hidden');
          if(quizPaperSelectModal) quizPaperSelectModal.classList.add('hidden');
          if(editResourceModal) editResourceModal.classList.add('hidden');
          if(editTrackerItemModal) editTrackerItemModal.classList.add('hidden');
          if(editQuizQuestionModal) editQuizQuestionModal.classList.add('hidden');
      };

      initializeAppHub();

    </script>
</body>
</html>
