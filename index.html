<!DOCTYPE html>
<html lang="en" class="light min-h-screen">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Giorgi's GCSE Revision Hub</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest"></script>
    <script>
        // Configure Tailwind CSS
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    },
                    colors: {
                        primary: { light: '#4f46e5', DEFAULT: '#4f46e5', dark: '#6366f1' },
                        secondary: { light: '#059669', DEFAULT: '#059669', dark: '#10b981' },
                        background: { light: '#f8fafc', DEFAULT: '#f8fafc', dark: '#0f172a' },
                        card: { light: '#ffffff', DEFAULT: '#ffffff', dark: '#1e293b' },
                        text: { light: '#1e293b', DEFAULT: '#1e293b', dark: '#e2e8f0' },
                        muted: { light: '#64748b', DEFAULT: '#64748b', dark: '#94a3b8' },
                        status: {
                            review: 'bg-yellow-100 dark:bg-yellow-900/50 text-yellow-700 dark:text-yellow-300 border border-yellow-300 dark:border-yellow-700/50 font-medium',
                            progress: 'bg-blue-100 dark:bg-blue-900/50 text-blue-700 dark:text-blue-300 border border-blue-300 dark:border-blue-700/50 font-medium',
                            mastered: 'bg-green-100 dark:bg-green-900/50 text-green-700 dark:text-green-300 border border-green-300 dark:border-green-700/50 font-medium',
                        }
                    },
                    boxShadow: {
                        'widget': '0 4px 12px -1px rgb(0 0 0 / 0.07), 0 2px 8px -2px rgb(0 0 0 / 0.05)',
                        'widget-dark': '0 4px 12px -1px rgb(0 0 0 / 0.2), 0 2px 8px -2px rgb(0 0 0 / 0.15)',
                        'widget-hover': '0 10px 20px -3px rgb(0 0 0 / 0.1), 0 4px 8px -4px rgb(0 0 0 / 0.08)',
                        'widget-hover-dark': '0 10px 20px -3px rgb(0 0 0 / 0.3), 0 4px 8px -4px rgb(0 0 0 / 0.25)',
                    },
                    borderRadius: { 'xl': '0.75rem', 'lg': '0.5rem' },
                    transitionTimingFunction: { 'smooth': 'cubic-bezier(0.4, 0, 0.2, 1)', 'snap': 'cubic-bezier(0.165, 0.84, 0.44, 1)' }
                }
            }
        }
    </script>
    <style>
        :root {
             --ease-smooth: cubic-bezier(0.4, 0, 0.2, 1);
             --ease-snap: cubic-bezier(0.165, 0.84, 0.44, 1);
             --color-primary-DEFAULT: theme('colors.primary.DEFAULT');
             --color-primary-dark: theme('colors.primary.dark');
        }
        html { scroll-behavior: smooth; }
        /* Base transition */
        button, a, input, textarea, select, div[role="button"], details summary {
            transition: background-color 0.2s ease-out, border-color 0.2s ease-out, color 0.2s ease-out, box-shadow 0.2s ease-out, opacity 0.2s ease-out, transform 0.15s ease-out;
            outline-offset: 2px;
        }
        /* Consistent Focus Ring */
        *:focus-visible { outline: 2px solid var(--color-primary-DEFAULT); outline-offset: 3px; border-radius: 0.25rem; }
        .dark *:focus-visible { outline-color: var(--color-primary-dark); }
        input:focus-visible, select:focus-visible, textarea:focus-visible { border-color: var(--color-primary-DEFAULT) !important; outline-offset: 1px; }
        .dark input:focus-visible, .dark select:focus-visible, .dark textarea:focus-visible { border-color: var(--color-primary-dark) !important; }
        a:focus-visible, button:focus-visible { outline-offset: 2px; }

        /* Button/Link Hover & Active Animation */
        .btn-animated { transform: scale(1); transition: transform 0.1s var(--ease-snap), background-color 0.15s var(--ease-smooth), box-shadow 0.1s var(--ease-smooth), filter 0.15s var(--ease-smooth); }
        .btn-animated:hover:not(:disabled) { filter: brightness(1.08); transform: scale(1.03); box-shadow: theme('boxShadow.md');}
        .btn-animated:active:not(:disabled) { transform: scale(0.96); filter: brightness(0.90); transition-duration: 0.05s; }
        a.nav-link:hover, a.mobile-nav-link:hover { transform: translateY(-1px); filter: brightness(1.1); }

        /* Card hover */
        .dashboard-card { transition: transform 0.25s var(--ease-smooth), box-shadow 0.25s var(--ease-smooth); }
        .dashboard-card:hover { transform: translateY(-6px) scale(1.015); box-shadow: var(--tw-shadow-widget-hover); }
        .dark .dashboard-card:hover { box-shadow: var(--tw-shadow-widget-hover-dark); }
        .upcoming-exam-item { transition: transform 0.2s var(--ease-smooth), box-shadow 0.2s var(--ease-smooth), background-color 0.2s ease-out; }
        .upcoming-exam-item:hover { transform: scale(1.02); box-shadow: var(--tw-shadow-widget-hover); cursor: pointer; background-color: theme('colors.slate.50');}
        .dark .upcoming-exam-item:hover { box-shadow: var(--tw-shadow-widget-hover-dark); background-color: theme('colors.slate.800'); }

        /* Page transition */
        .page { display: none; padding: 1rem; }
        @media (min-width: 768px) { .page { padding: 1.5rem; } }
        @media (min-width: 1024px) { .page { padding: 2rem; } }
        .page.active { display: block; animation: pageFadeIn 0.5s var(--ease-smooth); }
        @keyframes pageFadeIn { from { opacity: 0; transform: translateY(15px) scale(0.99); } to { opacity: 1; transform: translateY(0) scale(1); } }
        /* Lucide Icons */
        i[data-lucide] { width: 1em; height: 1em; display: inline-block; vertical-align: -0.125em; stroke-width: 2; }
        /* Pomodoro Timer Ring */
        .timer-ring { stroke-dasharray: 283; stroke-dashoffset: 283; transition: stroke-dashoffset 1s linear; }
        /* Custom scrollbar */
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background-color: #e2e8f0; border-radius: 9999px; }
        ::-webkit-scrollbar-thumb { background-color: rgba(165, 180, 252, 0.7); border-radius: 9999px; }
        ::-webkit-scrollbar-thumb:hover { background-color: rgba(129, 140, 248, 0.9); }
        .dark ::-webkit-scrollbar-track { background-color: #334155; }
        .dark ::-webkit-scrollbar-thumb { background-color: rgba(99, 102, 241, 0.6); }
        .dark ::-webkit-scrollbar-thumb:hover { background-color: rgba(79, 70, 229, 0.8); }
        /* Mobile Menu Transition */
        #mobile-menu { transform: translateX(-100%); opacity: 0; transition: transform 0.35s var(--ease-smooth), opacity 0.3s ease-out; pointer-events: none; }
        #mobile-menu.open { transform: translateX(0); opacity: 1; pointer-events: auto; }
        #mobile-overlay { transition: opacity 0.35s var(--ease-smooth); opacity: 0; pointer-events: none; }
        #mobile-overlay.visible { opacity: 1; pointer-events: auto; }

        /* Timetable Design Enhancements */
        #timetable-body tr:nth-child(even) { background-color: theme('colors.slate.50 / 70%'); }
        #timetable-body tr:hover { background-color: theme('colors.slate.100'); }
        .dark #timetable-body tr:nth-child(even) { background-color: theme('colors.slate.800 / 50%'); }
        .dark #timetable-body tr:hover { background-color: theme('colors.slate.700 / 60%'); }
        .timetable-new-day td { border-top: 3px solid #cbd5e1 !important; padding-top: 1.25rem !important; }
        .dark .timetable-new-day td { border-top-color: #475569 !important; }
        .timetable-subject-cell { background-color: rgba(var(--subject-rgb), 0.08); position: relative; }
        .dark .timetable-subject-cell { background-color: rgba(var(--subject-rgb), 0.18); }
        #timetable-body td { padding-top: 1rem; padding-bottom: 1rem; vertical-align: middle; } /* Increased padding */
        .timetable-subject-text { font-weight: 600; }

        /* List Item Hovers & Transitions */
        .list-item { transition: background-color 0.15s ease-out, transform 0.2s var(--ease-smooth), box-shadow 0.2s var(--ease-smooth); }
        .list-item:hover { background-color: #f1f5f9; transform: scale(1.01); box-shadow: 0 3px 6px rgba(0,0,0,0.06); }
        .dark .list-item:hover { background-color: #334155; box-shadow: 0 3px 6px rgba(0,0,0,0.2); }
        /* Delete button */
        .list-delete-btn { color: #94a3b8; transition: color 0.15s ease-out, background-color 0.15s ease-out, transform 0.15s var(--ease-smooth); }
        .list-delete-btn:hover { color: #ef4444; background-color: #fee2e2; transform: scale(1.15) rotate(5deg); }
        .dark .list-delete-btn { color: #64748b; }
        .dark .list-delete-btn:hover { color: #f87171; background-color: #450a0a; }
        /* Disabled button styling */
        button:disabled, button[disabled] { opacity: 0.5; cursor: not-allowed; filter: grayscale(50%); transform: none !important; box-shadow: none !important; }
        /* Resource Type Toggle Animation */
        #resource-url-wrapper, #resource-note-wrapper { display: none; }
        #resource-url-wrapper.visible, #resource-note-wrapper.visible { display: block; animation: contentFadeInShort 0.35s var(--ease-smooth); }
        /* List Item Entrance Animation */
        @keyframes listItemFadeIn { from { opacity: 0; transform: translate(0, 10px) scale(0.98); } to { opacity: 1; transform: translate(0, 0) scale(1); } }
        .list-item-appear { animation: listItemFadeIn 0.4s var(--ease-smooth) backwards; }
        /* Content Area Fade for Subject Switching */
        @keyframes contentFadeOut { to { opacity: 0; transform: scale(0.98); } }
        @keyframes contentFadeInShort { from { opacity: 0; transform: scale(0.98); } to { opacity: 1; transform: scale(1); } }
        .content-fade-out { animation: contentFadeOut 0.15s var(--ease-smooth) forwards; }
        .content-fade-in { animation: contentFadeInShort 0.3s var(--ease-smooth) 0.15s backwards; }

         /* **Details/Summary Styling & Animation (Refined)** */
        details > summary { list-style: none; cursor: pointer; transition: background-color 0.2s ease-out; position: relative; padding-right: 2.5rem; }
        details > summary::-webkit-details-marker { display: none; }
        details > summary .summary-chevron { display: block; width: 0.5rem; height: 0.5rem; border-bottom: 2px solid currentColor; border-right: 2px solid currentColor; position: absolute; right: 1rem; top: 50%; transform: translateY(-70%) rotate(45deg); transition: transform 0.3s var(--ease-smooth); pointer-events: none; }
        details[open] > summary .summary-chevron { transform: translateY(-40%) rotate(225deg); }
        details[open] > summary { background-color: #f1f5f9; border-bottom: 1px solid #e2e8f0; border-bottom-left-radius: 0; border-bottom-right-radius: 0; }
        .dark details[open] > summary { background-color: #334155; border-bottom-color: #475569; }
        /* Dropdown Content Animation using Grid */
        details > div {
            display: grid;
            grid-template-rows: 0fr; /* Start collapsed */
            opacity: 0;
            transition: grid-template-rows 0.4s var(--ease-smooth), opacity 0.3s ease-out 0.1s; /* Adjusted timing */
        }
        details[open] > div {
            grid-template-rows: 1fr; /* Expand */
            opacity: 1;
        }
        details > div > div { /* Inner wrapper */
             overflow: hidden;
             padding: 1rem; /* Apply padding here */
             border-top: 1px solid #e2e8f0;
             .dark & { border-top-color: #475569; }
        }

         /* Active Tab Styling */
        .subject-tab[aria-selected="true"] { color: var(--color-primary-DEFAULT); border-color: var(--color-primary-DEFAULT); font-weight: 600; background-color: transparent; }
        .dark .subject-tab[aria-selected="true"] { color: var(--color-primary-dark); border-color: var(--color-primary-dark); background-color: transparent; }

        /* Quiz Button Feedback */
        .quiz-feedback-correct { animation: flashGreen 0.5s ease-out; }
        .quiz-feedback-incorrect { animation: shakeHorizontal 0.4s ease-in-out; }
        @keyframes flashGreen { 0%, 100% { background-color: transparent; } 50% { background-color: rgba(74, 222, 128, 0.3); } }
        @keyframes shakeHorizontal { 0%, 100% { transform: translateX(0); } 25%, 75% { transform: translateX(-6px); } 50% { transform: translateX(6px); } } /* More pronounced shake */

        /* Hide quiz answer area initially */
        #quiz-correct-answer-display { display: none; }
        #quiz-correct-answer-display.visible { display: block; animation: contentFadeInShort 0.3s var(--ease-smooth); }

    </style>
</head>
<body class="flex flex-col min-h-screen bg-background text-text font-sans transition-colors duration-300 dark:bg-background-dark">

    <!-- Login Overlay -->
    <div id="login-overlay" class="fixed inset-0 bg-background dark:bg-background-dark flex items-center justify-center p-4 transition-opacity duration-300 z-[100]">
        <div class="bg-card text-text rounded-xl shadow-widget p-6 md:p-8 dark:bg-card-dark dark:text-text-dark dark:shadow-widget-dark transition-all duration-300 max-w-sm w-full">
            <h2 class="text-2xl font-semibold mb-4 text-center text-primary dark:text-primary-dark">Revision Hub Login</h2>
            <p class="text-muted dark:text-muted-dark text-sm mb-1 text-center">Welcome back, Giorgi!</p>
            <p class="text-xs text-muted dark:text-muted-dark mb-6 text-center">(Use your Firebase credentials)</p>
            <div class="mb-4">
                <label for="email-input" class="block text-sm font-medium text-muted dark:text-muted-dark mb-1">Email</label>
                <input type="email" id="email-input" placeholder="your.email@example.com" class="w-full p-2 border rounded-lg bg-background dark:bg-slate-700 border-slate-300 dark:border-slate-600 focus:ring-primary focus:border-primary transition duration-150 ease-in-out">
            </div>
            <div class="mb-6">
                <label for="password-input" class="block text-sm font-medium text-muted dark:text-muted-dark mb-1">Password</label>
                <input type="password" id="password-input" placeholder="••••••••" class="w-full p-2 border rounded-lg bg-background dark:bg-slate-700 border-slate-300 dark:border-slate-600 focus:ring-primary focus:border-primary transition duration-150 ease-in-out">
            </div>
            <button id="login-button" class="w-full bg-primary hover:bg-primary/90 dark:bg-primary-dark dark:hover:bg-primary-dark/90 text-white font-semibold py-2.5 px-4 rounded-lg btn-animated shadow-sm focus-visible:ring-2 focus-visible:ring-offset-2 focus-visible:ring-primary">Login</button>
            <p id="login-error" class="text-red-500 text-sm mt-3 text-center hidden h-4"></p> <!-- Ensure this has space -->
        </div>
    </div>

    <!-- Main App Wrapper -->
    <div id="app-wrapper" class="hidden flex flex-col min-h-screen">
        <!-- Header -->
        <header class="sticky top-0 z-50 bg-card dark:bg-card-dark shadow-md dark:shadow-slate-700/50 transition-colors duration-300">
            <nav class="container mx-auto px-4 py-3 flex justify-between items-center">
                 <a href="#" data-page="dashboard" class="nav-link text-xl md:text-2xl font-bold text-primary dark:text-primary-dark flex items-center space-x-2 btn-animated rounded-md p-1 -m-1 focus-visible:outline focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-primary"> <i data-lucide="graduation-cap" class="h-6 w-6"></i> <span>Giorgi's Hub</span> </a>
                <div class="hidden md:flex items-center space-x-1 lg:space-x-2">
                    <a href="#" data-page="dashboard" class="nav-link px-3 py-1.5 rounded-md text-muted dark:text-muted-dark hover:text-primary dark:hover:text-primary-dark hover:bg-slate-100 dark:hover:bg-slate-700 font-medium text-sm focus-visible:ring-2 focus-visible:ring-primary">Dashboard</a>
                     <a href="#" data-page="timetable" class="nav-link px-3 py-1.5 rounded-md text-muted dark:text-muted-dark hover:text-primary dark:hover:text-primary-dark hover:bg-slate-100 dark:hover:bg-slate-700 font-medium text-sm focus-visible:ring-2 focus-visible:ring-primary">Timetable</a>
                     <a href="#" data-page="resources" class="nav-link px-3 py-1.5 rounded-md text-muted dark:text-muted-dark hover:text-primary dark:hover:text-primary-dark hover:bg-slate-100 dark:hover:bg-slate-700 font-medium text-sm focus-visible:ring-2 focus-visible:ring-primary">Resources</a>
                     <a href="#" data-page="pomodoro" class="nav-link px-3 py-1.5 rounded-md text-muted dark:text-muted-dark hover:text-primary dark:hover:text-primary-dark hover:bg-slate-100 dark:hover:bg-slate-700 font-medium text-sm focus-visible:ring-2 focus-visible:ring-primary">Pomodoro</a>
                     <a href="#" data-page="tracker" class="nav-link px-3 py-1.5 rounded-md text-muted dark:text-muted-dark hover:text-primary dark:hover:text-primary-dark hover:bg-slate-100 dark:hover:bg-slate-700 font-medium text-sm focus-visible:ring-2 focus-visible:ring-primary">Tracker</a>
                     <a href="#" data-page="planner" class="nav-link px-3 py-1.5 rounded-md text-muted dark:text-muted-dark hover:text-primary dark:hover:text-primary-dark hover:bg-slate-100 dark:hover:bg-slate-700 font-medium text-sm focus-visible:ring-2 focus-visible:ring-primary">Planner</a>
                     <a href="#" data-page="quiz" class="nav-link px-3 py-1.5 rounded-md text-muted dark:text-muted-dark hover:text-primary dark:hover:text-primary-dark hover:bg-slate-100 dark:hover:bg-slate-700 font-medium text-sm focus-visible:ring-2 focus-visible:ring-primary">Quiz</a>
                    <button id="theme-toggle" title="Toggle Theme" class="p-2 rounded-full text-muted dark:text-muted-dark hover:bg-slate-100 dark:hover:bg-slate-700 focus:outline-none focus-visible:ring-2 focus-visible:ring-offset-2 focus-visible:ring-primary dark:focus-visible:ring-offset-slate-800 btn-animated"> <i data-lucide="sun" id="theme-icon-light" class="h-5 w-5"></i> <i data-lucide="moon" id="theme-icon-dark" class="h-5 w-5 hidden"></i> </button>
                    <button id="logout-button" title="Logout" class="p-2 rounded-full text-muted dark:text-muted-dark hover:bg-red-100 dark:hover:bg-red-900/50 hover:text-red-600 dark:hover:text-red-400 focus:outline-none focus-visible:ring-2 focus-visible:ring-offset-2 focus-visible:ring-red-500 dark:focus-visible:ring-offset-slate-800 btn-animated"> <i data-lucide="log-out" class="h-5 w-5"></i> </button>
                </div>
                <div class="md:hidden flex items-center">
                     <button id="theme-toggle-mobile" title="Toggle Theme" class="p-2 mr-2 rounded-full text-muted dark:text-muted-dark hover:bg-slate-100 dark:hover:bg-slate-700 focus:outline-none focus-visible:ring-2 focus-visible:ring-offset-2 focus-visible:ring-primary dark:focus-visible:ring-offset-slate-800 btn-animated"> <i data-lucide="sun" id="theme-icon-light-mobile" class="h-5 w-5"></i> <i data-lucide="moon" id="theme-icon-dark-mobile" class="h-5 w-5 hidden"></i> </button>
                    <button id="mobile-menu-button" title="Open Menu" class="p-2 rounded-md text-muted dark:text-muted-dark hover:text-primary dark:hover:text-primary-dark hover:bg-slate-100 dark:hover:bg-slate-700 focus:outline-none focus-visible:ring-2 focus-visible:ring-inset focus-visible:ring-primary btn-animated"> <span class="sr-only">Open main menu</span> <i data-lucide="menu" class="h-6 w-6"></i> </button>
                </div>
            </nav>
             <div id="mobile-menu" class="md:hidden fixed inset-y-0 left-0 w-64 bg-card dark:bg-card-dark shadow-xl z-60 p-4 border-r border-slate-200 dark:border-slate-700"> <div class="flex justify-between items-center mb-6"> <a href="#" data-page="dashboard" class="nav-link text-lg font-bold text-primary dark:text-primary-dark flex items-center space-x-2 focus-visible:outline focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-primary rounded"> <i data-lucide="graduation-cap" class="h-5 w-5"></i> <span>Giorgi's Hub</span> </a> <button id="mobile-close-button" title="Close Menu" class="p-1 rounded-md text-muted dark:text-muted-dark hover:text-primary dark:hover:text-primary-dark hover:bg-slate-100 dark:hover:bg-slate-700 btn-animated focus-visible:ring-2 focus-visible:ring-primary"> <i data-lucide="x" class="h-5 w-5"></i> </button> </div> <nav class="flex flex-col space-y-1"> <a href="#" data-page="dashboard" class="mobile-nav-link block px-3 py-2 rounded-md text-base font-medium text-muted dark:text-muted-dark hover:bg-slate-100 dark:hover:bg-slate-700 hover:text-primary dark:hover:text-primary-dark focus-visible:ring-2 focus-visible:ring-primary">Dashboard</a> <a href="#" data-page="timetable" class="mobile-nav-link block px-3 py-2 rounded-md text-base font-medium text-muted dark:text-muted-dark hover:bg-slate-100 dark:hover:bg-slate-700 hover:text-primary dark:hover:text-primary-dark focus-visible:ring-2 focus-visible:ring-primary">Timetable</a> <a href="#" data-page="resources" class="mobile-nav-link block px-3 py-2 rounded-md text-base font-medium text-muted dark:text-muted-dark hover:bg-slate-100 dark:hover:bg-slate-700 hover:text-primary dark:hover:text-primary-dark focus-visible:ring-2 focus-visible:ring-primary">Resources</a> <a href="#" data-page="pomodoro" class="mobile-nav-link block px-3 py-2 rounded-md text-base font-medium text-muted dark:text-muted-dark hover:bg-slate-100 dark:hover:bg-slate-700 hover:text-primary dark:hover:text-primary-dark focus-visible:ring-2 focus-visible:ring-primary">Pomodoro</a> <a href="#" data-page="tracker" class="mobile-nav-link block px-3 py-2 rounded-md text-base font-medium text-muted dark:text-muted-dark hover:bg-slate-100 dark:hover:bg-slate-700 hover:text-primary dark:hover:text-primary-dark focus-visible:ring-2 focus-visible:ring-primary">Tracker</a> <a href="#" data-page="planner" class="mobile-nav-link block px-3 py-2 rounded-md text-base font-medium text-muted dark:text-muted-dark hover:bg-slate-100 dark:hover:bg-slate-700 hover:text-primary dark:hover:text-primary-dark focus-visible:ring-2 focus-visible:ring-primary">Planner</a> <a href="#" data-page="quiz" class="mobile-nav-link block px-3 py-2 rounded-md text-base font-medium text-muted dark:text-muted-dark hover:bg-slate-100 dark:hover:bg-slate-700 hover:text-primary dark:hover:text-primary-dark focus-visible:ring-2 focus-visible:ring-primary">Quiz</a> <hr class="my-3 border-slate-200 dark:border-slate-700"> <button id="logout-button-mobile" class="w-full text-left block px-3 py-2 rounded-md text-base font-medium text-red-600 dark:text-red-400 hover:bg-red-100 dark:hover:bg-red-900/50 btn-animated flex items-center space-x-2 focus-visible:ring-2 focus-visible:ring-red-500"> <i data-lucide="log-out" class="h-4 w-4"></i> <span>Logout</span> </button> </nav> </div>
            <div id="mobile-overlay" class="fixed inset-0 bg-black/60 dark:bg-black/80 z-55 hidden md:hidden"></div>
        </header>

        <main class="flex-grow container mx-auto py-6 bg-background dark:bg-background-dark transition-colors duration-300">

            <!-- Dashboard Section -->
            <section id="dashboard" class="page active">
                 <h1 class="text-2xl md:text-3xl font-bold mb-1 text-text dark:text-text-dark">Welcome, Giorgi!</h1>
                 <p class="text-muted dark:text-muted-dark mb-6 text-sm">Candidate Number: 7590</p>
                 <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                    <div class="dashboard-card bg-card text-text rounded-xl shadow-widget p-4 md:p-6 dark:bg-card-dark dark:text-text-dark dark:shadow-widget-dark md:col-span-2 lg:col-span-2">
                        <h2 class="text-xl font-semibold mb-4 flex items-center space-x-2"> <i data-lucide="calendar-clock" class="h-5 w-5 text-primary dark:text-primary-dark"></i> <span>Upcoming Exams</span> </h2>
                        <div id="upcoming-exams-list" class="space-y-3 text-sm min-h-[60px]"></div>
                    </div>
                    <div class="dashboard-card bg-card text-text rounded-xl shadow-widget p-4 md:p-6 dark:bg-card-dark dark:text-text-dark dark:shadow-widget-dark">
                        <h2 class="text-xl font-semibold mb-4 flex items-center space-x-2"> <i data-lucide="timer" class="h-5 w-5 text-secondary dark:text-secondary-dark"></i> <span>Recent Study Sessions</span> </h2>
                        <div id="pomodoro-summary" class="space-y-2 text-sm min-h-[60px]"></div>
                        <button id="start-pomodoro-dashboard-btn" class="mt-4 w-full bg-secondary hover:bg-secondary/90 dark:bg-secondary-dark dark:hover:bg-secondary-dark/90 text-white font-semibold py-2 px-4 rounded-lg flex items-center justify-center space-x-2 btn-animated shadow-sm focus-visible:ring-2 focus-visible:ring-offset-2 focus-visible:ring-secondary"> <i data-lucide="play-circle" class="h-5 w-5"></i> <span>Start Pomodoro</span> </button>
                    </div>
                     <div class="dashboard-card bg-card text-text rounded-xl shadow-widget p-4 md:p-6 dark:bg-card-dark dark:text-text-dark dark:shadow-widget-dark">
                        <h2 class="text-xl font-semibold mb-4 flex items-center space-x-2"> <i data-lucide="bar-chart-3" class="h-5 w-5 text-cyan-500"></i> <span>Study Time Analytics</span> </h2>
                        <div id="pomodoro-analytics" class="space-y-2 text-sm min-h-[60px]"></div>
                    </div>
                    <div class="dashboard-card bg-card text-text rounded-xl shadow-widget p-4 md:p-6 dark:bg-card-dark dark:text-text-dark dark:shadow-widget-dark">
                        <h2 class="text-xl font-semibold mb-4 flex items-center space-x-2"> <i data-lucide="link" class="h-5 w-5 text-blue-500"></i> <span>Quick Links</span> </h2>
                        <div id="quick-links-list" class="space-y-2 text-sm">
                            <a href="#" data-page="resources" data-subject="Computer Science" class="quick-link block text-primary dark:text-primary-dark hover:underline font-medium focus-visible:ring-1 focus-visible:ring-primary rounded -ml-1 pl-1 btn-animated">Computer Science Resources</a>
                            <a href="#" data-page="resources" data-subject="Mathematics" class="quick-link block text-primary dark:text-primary-dark hover:underline font-medium focus-visible:ring-1 focus-visible:ring-primary rounded -ml-1 pl-1 btn-animated">Maths Notes</a>
                            <a href="#" data-page="timetable" class="quick-link block text-primary dark:text-primary-dark hover:underline font-medium focus-visible:ring-1 focus-visible:ring-primary rounded -ml-1 pl-1 btn-animated">Full Timetable</a>
                            <a href="#" data-page="planner" class="quick-link block text-primary dark:text-primary-dark hover:underline font-medium focus-visible:ring-1 focus-visible:ring-primary rounded -ml-1 pl-1 btn-animated">Revision Planner</a>
                        </div>
                    </div>
                     <div class="dashboard-card bg-card text-text rounded-xl shadow-widget p-4 md:p-6 dark:bg-card-dark dark:text-text-dark dark:shadow-widget-dark">
                        <h2 class="text-xl font-semibold mb-4 flex items-center space-x-2"> <i data-lucide="quote" class="h-5 w-5 text-purple-500"></i> <span>Daily Motivation</span> </h2>
                        <blockquote id="motivational-quote" class="text-muted dark:text-muted-dark italic border-l-4 border-purple-300 dark:border-purple-600 pl-4 py-1 min-h-[40px]"> Loading quote... </blockquote>
                    </div>
                    <div class="bg-card text-text rounded-xl shadow-widget p-4 md:p-6 dark:bg-card-dark dark:text-text-dark dark:shadow-widget-dark md:col-span-2 lg:col-span-3">
                        <h2 class="text-xl font-semibold mb-4 flex items-center space-x-2"> <i data-lucide="key-round" class="h-5 w-5 text-gray-500"></i> <span>Account Settings</span> </h2>
                        <div id="change-password-form">
                            <p class="text-sm text-muted dark:text-muted-dark mb-3">Change your login password.</p>
                            <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4 items-end">
                                <div> <label for="current-password" class="block text-xs font-medium text-muted dark:text-muted-dark mb-1">Current Password:</label> <input type="password" id="current-password" class="w-full p-2 border border-slate-300 dark:border-slate-600 rounded-lg text-sm bg-background dark:bg-slate-700 focus:ring-primary focus:border-primary"> </div>
                                <div> <label for="new-password" class="block text-xs font-medium text-muted dark:text-muted-dark mb-1">New Password:</label> <input type="password" id="new-password" class="w-full p-2 border border-slate-300 dark:border-slate-600 rounded-lg text-sm bg-background dark:bg-slate-700 focus:ring-primary focus:border-primary"> </div>
                                <button id="change-password-button" class="bg-slate-500 hover:bg-slate-600 dark:bg-slate-600 dark:hover:bg-slate-500 text-white font-semibold py-2 px-4 rounded-lg h-10 btn-animated shadow-sm self-end w-full sm:w-auto focus-visible:ring-2 focus-visible:ring-offset-2 focus-visible:ring-slate-500">Change Password</button>
                            </div>
                            <p id="change-password-message" class="text-sm mt-2 h-4"></p>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Timetable Section -->
            <section id="timetable" class="page">
                <h1 class="text-2xl md:text-3xl font-bold mb-6 text-text dark:text-text-dark">Exam Timetable</h1>
                <div class="bg-card text-text rounded-xl shadow-widget dark:bg-card-dark dark:text-text-dark dark:shadow-widget-dark transition-all duration-300 overflow-x-auto">
                    <table class="min-w-full divide-y divide-slate-200 dark:divide-slate-700">
                        <thead class="bg-slate-50 dark:bg-slate-700/50">
                            <tr>
                                <th scope="col" class="pl-4 pr-3 py-3.5 text-left text-xs font-semibold text-muted dark:text-muted-dark uppercase tracking-wider">Subject & Paper</th>
                                <th scope="col" class="px-3 py-3.5 text-left text-xs font-semibold text-muted dark:text-muted-dark uppercase tracking-wider">Date & Time</th>
                                <th scope="col" class="px-3 py-3.5 text-left text-xs font-semibold text-muted dark:text-muted-dark uppercase tracking-wider">Duration</th>
                                <th scope="col" class="px-3 py-3.5 text-left text-xs font-semibold text-muted dark:text-muted-dark uppercase tracking-wider">Board/Tier</th>
                                <th scope="col" class="px-3 py-3.5 text-left text-xs font-semibold text-muted dark:text-muted-dark uppercase tracking-wider">Location & Seat</th>
                                <th scope="col" class="pl-3 pr-4 py-3.5 text-left text-xs font-semibold text-muted dark:text-muted-dark uppercase tracking-wider">Countdown</th>
                            </tr>
                        </thead>
                        <tbody id="timetable-body" class="divide-y divide-slate-200 dark:divide-slate-700"></tbody>
                    </table>
                </div>
            </section>

            <!-- Resources Section -->
            <section id="resources" class="page">
                 <h1 class="text-2xl md:text-3xl font-bold mb-6 text-text dark:text-text-dark">Revision Resources</h1>
                <div class="bg-card text-text rounded-xl shadow-widget p-4 md:p-6 dark:bg-card-dark dark:text-text-dark dark:shadow-widget-dark transition-all duration-300">
                    <h2 class="text-xl font-semibold mb-4">Manage Your Resources</h2>
                    <p class="text-muted dark:text-muted-dark mb-5">Select a subject to view, add, or manage links and notes.</p>
                    <div class="mb-5 border-b border-slate-200 dark:border-slate-700">
                        <nav id="subject-tabs" class="flex space-x-4 overflow-x-auto pb-px" aria-label="Tabs"></nav>
                    </div>
                    <details id="add-resource-details" class="mb-6 border border-slate-200 dark:border-slate-700 rounded-lg overflow-hidden bg-slate-50 dark:bg-slate-800/50" style="display: none;">
                        <summary class="p-3 font-medium text-primary dark:text-primary-dark hover:bg-slate-100 dark:hover:bg-slate-700/50 flex items-center justify-between focus-visible:ring-1 focus-visible:ring-primary cursor-pointer"> <span>Add New Resource</span> <span class="summary-chevron"></span> </summary>
                        <div> <div id="add-resource-form" class="p-4 grid grid-cols-1 md:grid-cols-3 gap-4">
                            <div> <label for="resource-type" class="block text-sm font-medium text-muted dark:text-muted-dark mb-1">Type:</label> <select id="resource-type" class="w-full p-2 border border-slate-300 dark:border-slate-600 rounded-lg bg-background dark:bg-slate-700 focus:ring-primary focus:border-primary"> <option value="link">Link</option> <option value="note">Note</option> </select> </div>
                            <div class="md:col-span-2"> <label for="resource-title" class="block text-sm font-medium text-muted dark:text-muted-dark mb-1">Title:</label> <input type="text" id="resource-title" placeholder="e.g., Algebra Video" class="w-full p-2 border border-slate-300 dark:border-slate-600 rounded-lg bg-background dark:bg-slate-700 focus:ring-primary focus:border-primary"> </div>
                            <div id="resource-url-wrapper" class="md:col-span-3"> <label for="resource-url" class="block text-sm font-medium text-muted dark:text-muted-dark mb-1">URL:</label> <input type="url" id="resource-url" placeholder="https://example.com" class="w-full p-2 border border-slate-300 dark:border-slate-600 rounded-lg bg-background dark:bg-slate-700 focus:ring-primary focus:border-primary"> </div>
                            <div id="resource-note-wrapper" class="md:col-span-3"> <label for="resource-note" class="block text-sm font-medium text-muted dark:text-muted-dark mb-1">Note:</label> <textarea id="resource-note" placeholder="Enter notes..." rows="5" class="w-full p-2 border border-slate-300 dark:border-slate-600 rounded-lg bg-background dark:bg-slate-700 focus:ring-primary focus:border-primary"></textarea> </div>
                            <div class="md:col-span-3"> <button id="save-resource-btn" class="mt-2 bg-primary hover:bg-primary/90 dark:bg-primary-dark dark:hover:bg-primary-dark/90 text-white font-semibold py-2 px-5 rounded-lg btn-animated shadow-sm disabled:opacity-50 focus-visible:ring-2 focus-visible:ring-offset-2 focus-visible:ring-primary">Add Resource</button> </div>
                        </div></div>
                    </details>
                    <div id="resource-content" class="mt-4 min-h-[150px]"></div>
                </div>
            </section>

            <!-- Pomodoro Section -->
            <section id="pomodoro" class="page">
                 <h1 class="text-2xl md:text-3xl font-bold mb-6 text-text dark:text-text-dark">Pomodoro Timer</h1>
                <div class="bg-card text-text rounded-xl shadow-widget p-5 md:p-8 dark:bg-card-dark dark:text-text-dark dark:shadow-widget-dark transition-all duration-300 max-w-lg mx-auto flex flex-col items-center">
                    <h2 id="pomodoro-mode-title" class="text-2xl font-semibold mb-5 text-center">Focus Session</h2>
                    <div id="pomodoro-subject-wrapper" class="mb-6 w-full max-w-xs mx-auto" style="display: block;"> <label for="pomodoro-subject" class="block text-sm font-medium text-muted dark:text-muted-dark mb-1 text-center">Subject (for Focus Session)</label> <select id="pomodoro-subject" class="w-full p-2 border border-slate-300 dark:border-slate-600 rounded-lg bg-background dark:bg-slate-700 focus:ring-primary focus:border-primary text-sm"> <option value="">-- Select Subject --</option> </select> </div>
                    <div class="flex justify-center space-x-3 mb-8"> <button id="work-mode-button" class="pomodoro-mode-btn text-sm font-medium py-1.5 px-4 rounded-full border border-slate-300 dark:border-slate-600 text-muted dark:text-muted-dark hover:bg-slate-100 dark:hover:bg-slate-700 btn-animated flex items-center space-x-1.5 active focus-visible:ring-2 focus-visible:ring-primary" data-mode="work"> <i data-lucide="briefcase" class="h-4 w-4"></i> <span>Work</span> </button> <button id="short-break-mode-button" class="pomodoro-mode-btn text-sm font-medium py-1.5 px-4 rounded-full border border-slate-300 dark:border-slate-600 text-muted dark:text-muted-dark hover:bg-slate-100 dark:hover:bg-slate-700 btn-animated flex items-center space-x-1.5 focus-visible:ring-2 focus-visible:ring-primary" data-mode="shortBreak"> <i data-lucide="coffee" class="h-4 w-4"></i> <span>Short Break</span> </button> <button id="long-break-mode-button" class="pomodoro-mode-btn text-sm font-medium py-1.5 px-4 rounded-full border border-slate-300 dark:border-slate-600 text-muted dark:text-muted-dark hover:bg-slate-100 dark:hover:bg-slate-700 btn-animated flex items-center space-x-1.5 focus-visible:ring-2 focus-visible:ring-primary" data-mode="longBreak"> <i data-lucide="bed" class="h-4 w-4"></i> <span>Long Break</span> </button> </div>
                    <div class="relative w-52 h-52 mx-auto mb-8"> <svg class="w-full h-full" viewBox="0 0 100 100"> <circle class="text-slate-200 dark:text-slate-700" stroke-width="8" stroke="currentColor" fill="transparent" r="45" cx="50" cy="50"/> <circle id="timer-progress-ring" class="text-primary dark:text-primary-dark timer-ring" stroke-width="8" stroke-linecap="round" stroke="currentColor" fill="transparent" r="45" cx="50" cy="50" transform="rotate(-90 50 50)" /> </svg> <div id="timer-display" class="absolute inset-0 flex flex-col items-center justify-center text-4xl font-bold text-text dark:text-text-dark tracking-tight">25:00</div> <div id="timer-status" class="absolute bottom-0 left-0 right-0 text-center text-xs font-medium uppercase tracking-wider text-muted dark:text-muted-dark -mb-5">Work</div> </div>
                    <div class="flex justify-center space-x-3"> <button id="start-pause-button" class="bg-primary hover:bg-primary/90 dark:bg-primary-dark dark:hover:bg-primary-dark/90 text-white font-semibold py-2.5 px-6 rounded-lg btn-animated shadow-sm flex items-center space-x-2 focus-visible:ring-2 focus-visible:ring-offset-2 focus-visible:ring-primary"> <i data-lucide="play" class="h-5 w-5"></i> <span>Start</span> </button> <button id="reset-button" class="bg-slate-500 hover:bg-slate-600 dark:bg-slate-600 dark:hover:bg-slate-500 text-white font-semibold py-2.5 px-6 rounded-lg btn-animated shadow-sm flex items-center space-x-2 focus-visible:ring-2 focus-visible:ring-offset-2 focus-visible:ring-slate-500"> <i data-lucide="rotate-ccw" class="h-5 w-5"></i> <span>Reset</span> </button> </div>
                    <details class="mt-8 text-center w-full max-w-xs"> <summary class="cursor-pointer text-sm text-muted dark:text-muted-dark hover:text-primary dark:hover:text-primary-dark font-medium list-none flex items-center justify-center space-x-1 focus-visible:ring-1 focus-visible:ring-primary rounded p-1"> <i data-lucide="settings" class="h-4 w-4"></i> <span>Timer Settings</span> <span class="summary-chevron ml-auto"></span> </summary> <div><div class="p-4 bg-slate-50 dark:bg-slate-700/50 rounded-b-lg border border-t-0 border-slate-200 dark:border-slate-600/50 space-y-3 text-left"> <div> <label for="work-duration" class="block text-xs font-medium text-muted dark:text-muted-dark mb-1">Work Duration (min):</label> <input type="number" id="work-duration" value="25" min="1" max="90" class="w-full p-1.5 border border-slate-300 dark:border-slate-500 rounded-md text-sm bg-white dark:bg-slate-600 focus:ring-primary focus:border-primary"> </div> <div> <label for="short-break-duration" class="block text-xs font-medium text-muted dark:text-muted-dark mb-1">Short Break (min):</label> <input type="number" id="short-break-duration" value="5" min="1" max="30" class="w-full p-1.5 border border-slate-300 dark:border-slate-500 rounded-md text-sm bg-white dark:bg-slate-600 focus:ring-primary focus:border-primary"> </div> <div> <label for="long-break-duration" class="block text-xs font-medium text-muted dark:text-muted-dark mb-1">Long Break (min):</label> <input type="number" id="long-break-duration" value="15" min="5" max="60" class="w-full p-1.5 border border-slate-300 dark:border-slate-500 rounded-md text-sm bg-white dark:bg-slate-600 focus:ring-primary focus:border-primary"> </div> </div></div> </details>
                </div>
            </section>

            <!-- Tracker Section -->
            <section id="tracker" class="page">
                 <h1 class="text-2xl md:text-3xl font-bold mb-6 text-text dark:text-text-dark">Feedback & Improvement Tracker</h1>
                <div class="bg-card text-text rounded-xl shadow-widget p-4 md:p-6 dark:bg-card-dark dark:text-text-dark dark:shadow-widget-dark transition-all duration-300">
                    <h2 class="text-xl font-semibold mb-4">Track Your Progress</h2>
                    <p class="text-muted dark:text-muted-dark mb-5">Log feedback, weak areas, and action points.</p>
                    <div class="mb-6">
                        <label for="tracker-subject-select" class="block text-sm font-medium text-muted dark:text-muted-dark mb-1">Select Subject:</label>
                        <select id="tracker-subject-select" class="w-full md:w-1/2 lg:w-1/3 p-2 border border-slate-300 dark:border-slate-600 rounded-lg bg-background dark:bg-slate-700 focus:ring-primary focus:border-primary"> <option value="">-- Select Subject --</option> </select>
                    </div>
                     <details id="add-tracker-details" class="mb-6 border border-slate-200 dark:border-slate-700 rounded-lg overflow-hidden bg-slate-50 dark:bg-slate-800/50" style="display: none;">
                         <summary class="p-3 font-medium text-primary dark:text-primary-dark hover:bg-slate-100 dark:hover:bg-slate-700/50 flex items-center justify-between focus-visible:ring-1 focus-visible:ring-primary cursor-pointer">
                             <span>Add New Tracker Item</span> <span class="summary-chevron"></span>
                         </summary>
                         <div><div id="add-tracker-item-form" class="p-4 grid grid-cols-1 md:grid-cols-3 gap-4 border-t border-slate-200 dark:border-slate-700">
                            <div class="md:col-span-2"> <label for="tracker-description" class="block text-sm font-medium text-muted dark:text-muted-dark mb-1">Description:</label> <textarea id="tracker-description" placeholder="Describe the feedback..." rows="3" class="w-full p-2 border border-slate-300 dark:border-slate-600 rounded-lg bg-background dark:bg-slate-700 focus:ring-primary focus:border-primary"></textarea> </div>
                            <div> <label for="tracker-status-select" class="block text-sm font-medium text-muted dark:text-muted-dark mb-1">Status:</label> <select id="tracker-status-select" class="w-full p-2 border border-slate-300 dark:border-slate-600 rounded-lg bg-background dark:bg-slate-700 focus:ring-primary focus:border-primary"> <option value="To Review">To Review</option> <option value="In Progress">In Progress</option> <option value="Mastered">Mastered</option> </select> </div>
                            <div class="md:col-span-3"> <button id="save-tracker-item-btn" class="mt-2 bg-primary hover:bg-primary/90 dark:bg-primary-dark dark:hover:bg-primary-dark/90 text-white font-semibold py-2 px-5 rounded-lg btn-animated shadow-sm disabled:opacity-50 focus-visible:ring-2 focus-visible:ring-offset-2 focus-visible:ring-primary">Add Item</button> </div>
                        </div></div>
                    </details>
                    <h3 class="text-lg font-medium mb-3 text-text dark:text-text-dark">Logged Items</h3>
                    <div id="tracker-items-list" class="mt-4 min-h-[150px] space-y-3"></div>
                </div>
            </section>

            <!-- Planner Section -->
            <section id="planner" class="page">
                <h1 class="text-2xl md:text-3xl font-bold mb-6 text-text dark:text-text-dark">Revision Planner</h1>
                <div class="bg-card text-text rounded-xl shadow-widget p-4 md:p-6 dark:bg-card-dark dark:text-text-dark dark:shadow-widget-dark transition-all duration-300">
                    <h2 class="text-xl font-semibold mb-4">Schedule Your Study Time</h2>
                    <p class="text-muted dark:text-muted-dark mb-5">Plan your revision sessions by date, time, subject, and topic.</p>
                    <div id="add-planner-item-form" class="mb-6 pb-6 border-b border-slate-200 dark:border-slate-700">
                        <h3 class="text-lg font-medium mb-4 text-primary dark:text-primary-dark">Add New Session</h3>
                        <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-5 gap-4 items-end">
                            <div class="lg:col-span-1"> <label for="planner-date" class="block text-sm font-medium text-muted dark:text-muted-dark mb-1">Date:</label> <input type="date" id="planner-date" class="w-full p-2 border border-slate-300 dark:border-slate-600 rounded-lg bg-background dark:bg-slate-700 focus:ring-primary focus:border-primary"> </div>
                            <div class="lg:col-span-1"> <label for="planner-time" class="block text-sm font-medium text-muted dark:text-muted-dark mb-1">Time:</label> <input type="time" id="planner-time" class="w-full p-2 border border-slate-300 dark:border-slate-600 rounded-lg bg-background dark:bg-slate-700 focus:ring-primary focus:border-primary"> </div>
                            <div class="lg:col-span-1"> <label for="planner-subject-select" class="block text-sm font-medium text-muted dark:text-muted-dark mb-1">Subject:</label> <select id="planner-subject-select" class="w-full p-2 border border-slate-300 dark:border-slate-600 rounded-lg bg-background dark:bg-slate-700 focus:ring-primary focus:border-primary"> <option value="">-- Select --</option> </select> </div>
                            <div class="sm:col-span-2 lg:col-span-2"> <label for="planner-topic" class="block text-sm font-medium text-muted dark:text-muted-dark mb-1">Topic / Notes:</label> <input type="text" id="planner-topic" placeholder="e.g., Algebra Practice" class="w-full p-2 border border-slate-300 dark:border-slate-600 rounded-lg bg-background dark:bg-slate-700 focus:ring-primary focus:border-primary"> </div>
                            <div class="sm:col-span-full lg:col-span-5 flex justify-start"> <button id="save-planner-item-btn" class="mt-2 bg-primary hover:bg-primary/90 dark:bg-primary-dark dark:hover:bg-primary-dark/90 text-white font-semibold py-2 px-5 rounded-lg btn-animated shadow-sm disabled:opacity-50 focus-visible:ring-2 focus-visible:ring-offset-2 focus-visible:ring-primary">Schedule Session</button> </div>
                        </div>
                     </div>
                    <h2 class="text-xl font-semibold mt-6 mb-4 text-text dark:text-text-dark">Scheduled Sessions</h2>
                    <div id="planner-items-list" class="mt-4 space-y-5 min-h-[100px]"></div>
                </div>
            </section>

             <!-- Quiz Section -->
             <section id="quiz" class="page">
                 <h1 class="text-2xl md:text-3xl font-bold mb-6 text-text dark:text-text-dark">Quiz Yourself</h1>
                <div class="bg-card text-text rounded-xl shadow-widget p-4 md:p-6 dark:bg-card-dark dark:text-text-dark dark:shadow-widget-dark transition-all duration-300">
                    <h2 class="text-xl font-semibold mb-4">Practice Questions</h2>
                    <p class="text-muted dark:text-muted-dark mb-5">Save challenging questions and test yourself until you master them.</p>
                    <div class="mb-6">
                        <label for="quiz-subject-select" class="block text-sm font-medium text-muted dark:text-muted-dark mb-1">Select Subject:</label>
                        <select id="quiz-subject-select" class="w-full md:w-1/2 lg:w-1/3 p-2 border border-slate-300 dark:border-slate-600 rounded-lg bg-background dark:bg-slate-700 focus:ring-primary focus:border-primary"> <option value="">-- Select Subject --</option> </select>
                    </div>

                    <div id="quiz-content-wrapper" class="hidden">
                         <!-- Add Question Dropdown -->
                        <details id="add-quiz-details" class="mb-6 border border-slate-200 dark:border-slate-700 rounded-lg overflow-hidden bg-slate-50 dark:bg-slate-800/50" style="display: none;">
                            <summary class="p-3 font-medium text-primary dark:text-primary-dark hover:bg-slate-100 dark:hover:bg-slate-700/50 flex items-center justify-between focus-visible:ring-1 focus-visible:ring-primary cursor-pointer">
                                <span>Add New Question</span> <span class="summary-chevron"></span>
                            </summary>
                            <div><div id="add-quiz-question-form" class="p-4 space-y-4 border-t border-slate-200 dark:border-slate-700">
                                 <div> <label for="quiz-question-input" class="block text-sm font-medium text-muted dark:text-muted-dark mb-1">Question:</label> <textarea id="quiz-question-input" placeholder="Enter the question text..." rows="3" class="w-full p-2 border border-slate-300 dark:border-slate-600 rounded-lg bg-background dark:bg-slate-700 focus:ring-primary focus:border-primary"></textarea> </div>
                                 <div> <label for="quiz-answer-input" class="block text-sm font-medium text-muted dark:text-muted-dark mb-1">Answer / Mark Scheme:</label> <textarea id="quiz-answer-input" placeholder="Enter the correct answer..." rows="4" class="w-full p-2 border border-slate-300 dark:border-slate-600 rounded-lg bg-background dark:bg-slate-700 focus:ring-primary focus:border-primary"></textarea> </div>
                                 <button id="save-quiz-question-btn" class="mt-2 bg-primary hover:bg-primary/90 dark:bg-primary-dark dark:hover:bg-primary-dark/90 text-white font-semibold py-2 px-5 rounded-lg btn-animated shadow-sm disabled:opacity-50 focus-visible:ring-2 focus-visible:ring-offset-2 focus-visible:ring-primary">Add Question</button>
                            </div></div>
                        </details>

                        <div id="quiz-list-container">
                             <h3 class="text-lg font-medium mb-3 text-text dark:text-text-dark">Saved Questions</h3>
                             <div id="quiz-items-list" class="mt-4 mb-6 max-h-72 overflow-y-auto space-y-3 pr-2 border border-slate-200 dark:border-slate-700 rounded-lg p-3 bg-slate-50 dark:bg-slate-900/30 min-h-[100px]"></div>
                             <button id="start-quiz-button" class="bg-secondary hover:bg-secondary/90 dark:bg-secondary-dark dark:hover:bg-secondary-dark/90 text-white font-semibold py-2.5 px-5 rounded-lg btn-animated shadow-sm disabled:opacity-50 flex items-center space-x-2 focus-visible:ring-2 focus-visible:ring-offset-2 focus-visible:ring-secondary"> <i data-lucide="swords" class="h-5 w-5"></i> <span>Challenge Me!</span> </button> <!-- Changed text -->
                        </div>
                    </div>

                    <!-- ** GAMIFIED Quiz Mode Interface ** -->
                    <div id="quiz-mode-interface" class="hidden mt-6 pt-6 border-t border-slate-200 dark:border-slate-700">
                         <div class="flex justify-between items-center mb-3">
                             <h3 class="text-xl font-semibold text-primary dark:text-primary-dark">Quiz Challenge</h3>
                             <span id="quiz-progress" class="text-sm font-medium text-muted dark:text-muted-dark">Round 1 | Remaining: 0</span>
                         </div>
                         <div id="quiz-question-display" class="p-4 border-2 border-dashed border-slate-300 dark:border-slate-600 rounded-lg mb-4 min-h-[120px] bg-background dark:bg-slate-800/50 text-text dark:text-text-dark flex items-center justify-center text-center text-lg"> <!-- Increased min-height and text size -->
                             <p class="italic text-muted dark:text-muted-dark">Loading question...</p>
                         </div>
                         <!-- Show Answer Button -->
                         <div id="quiz-reveal-button-container" class="mb-3 text-center">
                            <button id="quiz-reveal-answer-btn" class="bg-slate-200 hover:bg-slate-300 dark:bg-slate-600 dark:hover:bg-slate-500 text-text dark:text-text-dark font-medium py-2 px-4 rounded-lg text-sm btn-animated flex items-center space-x-1.5 mx-auto focus-visible:ring-2 focus-visible:ring-offset-1 focus-visible:ring-slate-500">
                                <i data-lucide="eye" class="h-4 w-4"></i> <span>Show Answer</span>
                            </button>
                         </div>
                         <!-- Answer Area (hidden initially) -->
                         <div id="quiz-correct-answer-display" class="p-3 bg-slate-100 dark:bg-slate-700 rounded-md text-sm mb-4" style="display: none;"> <!-- Use display none initially -->
                             <!-- Content set by JS -->
                         </div>
                         <!-- Correct/Incorrect Buttons (hidden initially) -->
                         <div id="quiz-judgment-buttons" class="mt-4 flex justify-center gap-4" style="display: none;">
                             <button id="quiz-incorrect-btn" class="w-full sm:w-auto bg-red-500 hover:bg-red-600 text-white font-semibold py-2.5 px-6 rounded-lg btn-animated shadow-sm flex items-center justify-center space-x-2 focus-visible:ring-2 focus-visible:ring-offset-2 focus-visible:ring-red-500">
                                 <i data-lucide="x" class="h-5 w-5"></i> <span>Got it Wrong</span>
                             </button>
                              <button id="quiz-correct-btn" class="w-full sm:w-auto bg-green-500 hover:bg-green-600 text-white font-semibold py-2.5 px-6 rounded-lg btn-animated shadow-sm flex items-center justify-center space-x-2 focus-visible:ring-2 focus-visible:ring-offset-2 focus-visible:ring-green-500">
                                 <i data-lucide="check" class="h-5 w-5"></i> <span>Got it Right!</span>
                             </button>
                         </div>
                         <!-- Stop Button -->
                         <div class="mt-6 text-center">
                            <button id="stop-quiz-button" class="text-xs text-muted dark:text-muted-dark hover:text-red-600 dark:hover:text-red-400 underline focus-visible:ring-1 focus-visible:ring-red-500 rounded px-1 btn-animated">Stop Quiz</button>
                         </div>
                         <!-- Completion Message Area -->
                         <div id="quiz-completion-message" class="hidden mt-6 p-4 text-center bg-green-100 dark:bg-green-900/50 text-green-700 dark:text-green-200 rounded-lg font-medium"></div>
                    </div>
                </div>
            </section>

        </main>

        <!-- Footer -->
        <footer class="bg-card dark:bg-card-dark mt-auto py-4 shadow-inner dark:shadow-[0_-1px_5px_-1px_rgba(0,0,0,0.1)] transition-colors duration-300 border-t border-slate-200 dark:border-slate-700">
            <div class="container mx-auto px-4 text-center text-xs text-muted dark:text-muted-dark">
                 &copy; <span id="current-year"></span> Giorgi Suramlishvili Revision Hub. Candidate: 7590. Keep pushing!
            </div>
        </footer>
    </div> <!-- End App Wrapper -->

    <script type="module">
      // Import Firebase functions
      import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.0/firebase-app.js";
      import { getAuth, onAuthStateChanged, signInWithEmailAndPassword, signOut, updatePassword, EmailAuthProvider, reauthenticateWithCredential } from "https://www.gstatic.com/firebasejs/11.6.0/firebase-auth.js";
      import { getFirestore, collection, doc, addDoc, getDocs, getDoc, updateDoc, deleteDoc, query, orderBy, limit, serverTimestamp, increment, writeBatch, Timestamp, where } from "https://www.gstatic.com/firebasejs/11.6.0/firebase-firestore.js";

    
// For Firebase JS SDK v7.20.0 and later, measurementId is optional
      const firebaseConfig = {
        apiKey: "AIzaSyAt3uFOLLQXjt2p0LERjvizePMfg9S74Mk",
        authDomain: "studentpage-97bb5.firebaseapp.com",
        databaseURL: "https://studentpage-97bb5-default-rtdb.europe-west1.firebasedatabase.app",
        projectId: "studentpage-97bb5",
        storageBucket: "studentpage-97bb5.firebasestorage.app",
        messagingSenderId: "613071061381",
        appId: "1:613071061381:web:124051538e7e0dfec344ec",
        measurementId: "G-WC262FYLJH"  
      };

      // --- Initialize Firebase ---
      let app, auth, db;
      try {
          app = initializeApp(firebaseConfig);
          auth = getAuth(app);
          db = getFirestore(app);
          console.log("Firebase Initialized");
      } catch (error) {
          console.error("Firebase Init Error:", error);
          // Display error directly on login form if init fails
          const initialLoginError = document.getElementById('login-error');
          const initialLoginButton = document.getElementById('login-button');
          if (initialLoginError) {
              initialLoginError.textContent = "Firebase connection failed. Check config.";
              initialLoginError.classList.remove('hidden');
          }
          if (initialLoginButton) {
              initialLoginButton.disabled = true;
              initialLoginButton.textContent = 'Login Unavailable';
          }
      }

      // --- Global State ---
      let currentUserId = null;
      let isInitialized = false; // Tracks if post-login setup has run
      let eventListenersAttached = false; // *** FLAG ADDED ***
      let countdownInterval = null;
      let pomodoroInterval = null;
      let currentActiveSubject = null;
      let quizState = {
          active: false, currentSubject: null, initialQuestions: [], currentQuizPool: [], incorrectlyAnswered: [],
          currentQuestionIndex: -1, round: 1, totalMastered: 0, isAnswerVisible: false, buttonTimeout: null
      };
      let targetSubjectParam = null;

      // --- DATA (Hardcoded Exam & Quotes) ---
      const examData = [ { subject: "English Literature", paper: "Paper 1", date: "2025-05-12T08:45:00", duration: "1h 45m", board: "AQA", tier: null, location: "Sports Hall 1", seat: "M3" }, { subject: "Computer Science", paper: "Computer Systems Written", date: "2025-05-12T13:45:00", duration: "1h 30m", board: "OCR", tier: null, location: "Sports Hall 1", seat: "C10" }, { subject: "Biology", paper: "Paper 1", date: "2025-05-13T13:45:00", duration: "1h 45m", board: "AQA", tier: "H", location: "Sports Hall 1", seat: "N1" }, { subject: "Geography", paper: "Paper 1", date: "2025-05-14T08:45:00", duration: "1h 30m", board: "AQA", tier: null, location: "Sports Hall 1", seat: "F8" }, { subject: "Mathematics", paper: "Option H: Non-Calculator", date: "2025-05-15T08:45:00", duration: "1h 30m", board: "Edexcel", tier: "H", location: "Sports Hall 1", seat: "M3" }, { subject: "Chemistry", paper: "Paper 1", date: "2025-05-19T08:45:00", duration: "1h 45m", board: "AQA", tier: "H", location: "Sports Hall 1", seat: "N1" }, { subject: "English Literature", paper: "Paper 2", date: "2025-05-20T08:45:00", duration: "2h 15m", board: "AQA", tier: null, location: "Sports Hall 1", seat: "M3" }, { subject: "Computer Science", paper: "Computational Thinking, Algorithms & Programming", date: "2025-05-20T13:45:00", duration: "1h 30m", board: "OCR", tier: null, location: "Sports Hall 1", seat: "C10" }, { subject: "Physics", paper: "Paper 1", date: "2025-05-22T08:45:00", duration: "1h 45m", board: "AQA", tier: "H", location: "Sports Hall 1", seat: "N1" }, { subject: "English Language", paper: "Paper 1", date: "2025-05-23T08:45:00", duration: "1h 45m", board: "AQA", tier: null, location: "Sports Hall 1", seat: "M3" }, { subject: "Mathematics", paper: "Option H: Calculator", date: "2025-06-04T08:45:00", duration: "1h 30m", board: "Edexcel", tier: "H", location: "Sports Hall 1", seat: "M2" }, { subject: "English Language", paper: "Paper 2", date: "2025-06-06T08:45:00", duration: "1h 45m", board: "AQA", tier: null, location: "Sports Hall 1", seat: "M3" }, { subject: "Geography", paper: "Paper 2", date: "2025-06-06T13:45:00", duration: "1h 30m", board: "AQA", tier: null, location: "Sports Hall 1", seat: "F8" }, { subject: "Biology", paper: "Paper 2", date: "2025-06-09T08:45:00", duration: "1h 45m", board: "AQA", tier: "H", location: "Sports Hall 1", seat: "N1" }, { subject: "Spanish", paper: "Listening", date: "2025-06-10T08:45:00", duration: "0h 45m", board: "AQA", tier: "H", location: "4G3 - History E3", seat: null }, { subject: "Spanish", paper: "Reading", date: "2025-06-10T09:50:00", duration: "1h 00m", board: "AQA", tier: "H", location: "4G3 - History E3", seat: null }, { subject: "Mathematics", paper: "Option H: Calculator P3", date: "2025-06-11T08:45:00", duration: "1h 30m", board: "Edexcel", tier: "H", location: "Sports Hall 1", seat: "M3" }, { subject: "Geography", paper: "Paper 3", date: "2025-06-12T08:45:00", duration: "1h 30m", board: "AQA", tier: null, location: "Sports Hall 1", seat: "F8" }, { subject: "Chemistry", paper: "Paper 2", date: "2025-06-13T08:45:00", duration: "1h 45m", board: "AQA", tier: "H", location: "Sports Hall 1", seat: "N1" }, { subject: "Physics", paper: "Paper 2", date: "2025-06-16T08:45:00", duration: "1h 45m", board: "AQA", tier: "H", location: "Sports Hall 1", seat: "N1" }, { subject: "Spanish", paper: "Writing", date: "2025-06-17T08:45:00", duration: "1h 15m", board: "AQA", tier: "H", location: "Sports Hall 1", seat: "J3" } ].sort((a, b) => new Date(a.date) - new Date(b.date));
      const motivationalQuotes = [ "Believe you can and you're halfway there.", "The secret to getting ahead is getting started.", "Don't watch the clock; do what it does. Keep going.", "Success is not final, failure is not fatal: It is the courage to continue that counts.", "The expert in anything was once a beginner.", "Strive for progress, not perfection.", "Your limitation—it's only your imagination.", "Push yourself, because no one else is going to do it for you.", "Great things never come from comfort zones.", "The harder you work for something, the greater you'll feel when you achieve it.", "Focus on the step in front of you, not the whole staircase.", "Small steps every day lead to big results." ];
      const subjects = [...new Set(examData.map(exam => exam.subject))].sort();

      // --- UTILS ---
      const getElement = (id) => document.getElementById(id);
      const safelyCreateIcons = () => { if (typeof lucide !== 'undefined' && lucide.createIcons) { try { lucide.createIcons(); } catch (e) { console.error("Lucide icon creation failed:", e); } } };
      const formatGeneralDate = (d) => { try { const date = new Date(d); return date.toLocaleDateString('en-GB', { weekday: 'short', year: 'numeric', month: 'short', day: 'numeric' }); } catch (e) { return "Invalid Date"; } };
      const formatPlannerDateTime = (iso) => { try { const date = new Date(iso); const dp = date.toLocaleDateString('en-GB', { weekday: 'short', month: 'short', day: 'numeric' }); const tp = date.toLocaleTimeString('en-GB', { hour: '2-digit', minute: '2-digit', hour12: true }); return `${dp}, ${tp}`; } catch (e) { try { return formatGeneralDate(iso.split('T')[0]); } catch { return "Invalid Date"; } } };
      const formatExamDate = (d) => { try { const date = new Date(d); return date.toLocaleDateString('en-GB', { weekday: 'short', month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit', hour12: true }); } catch (e) { return "Invalid Date"; } };
      const formatMinutes = (m) => { if (!m || m < 1) return '0m'; const h = Math.floor(m / 60); const min = m % 60; let r = ''; if (h > 0) r += `${h}h `; if (min > 0 || h === 0) r += `${min}m`; return r.trim(); };
      const formatCountdown = (d) => { try { const now = new Date(); const examDate = new Date(d); const diff = examDate - now; if (diff <= 0) return "<span class='text-green-600 dark:text-green-400 font-medium'>Completed</span>"; const days = Math.floor(diff / 864e5); const hours = Math.floor((diff % 864e5) / 36e5); const minutes = Math.floor((diff % 36e5) / 6e4); let p = []; if (days > 0) p.push(`${days}d`); if (hours > 0) p.push(`${hours}h`); if (days < 1 && minutes > 0) p.push(`${minutes}m`); if (p.length === 0 && diff > 0) return "<span class='text-orange-500 font-medium'>&lt; 1m</span>"; return p.join(' '); } catch (e) { return "<span class='text-red-500'>Error</span>"; } };
      const getSubjectColor = (s) => { const cs = [ 'border-indigo-400 dark:border-indigo-600', 'border-sky-400 dark:border-sky-600', 'border-emerald-400 dark:border-emerald-600', 'border-amber-400 dark:border-amber-600', 'border-violet-400 dark:border-violet-600', 'border-rose-400 dark:border-rose-600', 'border-cyan-400 dark:border-cyan-600', 'border-lime-400 dark:border-lime-600', 'border-fuchsia-400 dark:border-fuchsia-600', 'border-orange-400 dark:border-orange-600', ]; const i = subjects.indexOf(s); return cs[i % cs.length] || 'border-slate-400 dark:border-slate-600'; };
      const getSubjectColorRGB = (s) => { const cm = { 'border-indigo-400': '129, 140, 248', 'border-sky-400': '56, 189, 248', 'border-emerald-400': '52, 211, 153', 'border-amber-400': '251, 191, 36', 'border-violet-400': '167, 139, 250', 'border-rose-400': '251, 113, 133', 'border-cyan-400': '34, 211, 238', 'border-lime-400': '163, 230, 53', 'border-fuchsia-400': '217, 70, 239', 'border-orange-400': '251, 146, 60' }; const bc = getSubjectColor(s).split(' ')[0]; return cm[bc] || '203, 213, 225'; };
      const shuffleArray = (a) => { for (let i = a.length - 1; i > 0; i--) { const j = Math.floor(Math.random() * (i + 1)); [a[i], a[j]] = [a[j], a[i]]; } return a; };
      const escapeHtml = (unsafe) => { return unsafe ? unsafe.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;").replace(/"/g, "&quot;").replace(/'/g, "&#039;") : ''; };
      const applyStaggerAnimation = (elements) => { Array.from(elements).forEach((el, index) => { el.style.animationDelay = `${index * 0.06}s`; el.classList.add('list-item-appear'); }); };

      // --- Firestore Refs ---
      const getUserDataRef = (userId, path) => doc(db, `users/${userId}/${path}`);
      const getUserCollectionRef = (userId, collectionName) => collection(db, `users/${userId}/${collectionName}`);
      const getSubjectSpecificCollectionRef = (userId, mainCollection, subject) => collection(db, `users/${userId}/${mainCollection}/${subject}/items`);
      const getSubjectSpecificDocRef = (userId, mainCollection, subject, docId) => doc(db, `users/${userId}/${mainCollection}/${subject}/items/${docId}`);

      // --- DOM Elements --- (Defined in HTML)
      const loginOverlay = getElement('login-overlay');
      const appWrapper = getElement('app-wrapper');
      const emailInput = getElement('email-input');
      const passwordInput = getElement('password-input');
      const loginButton = getElement('login-button');
      const loginError = getElement('login-error');
      const logoutButton = getElement('logout-button');
      const logoutButtonMobile = getElement('logout-button-mobile');
      const currentPasswordInput = getElement('current-password');
      const newPasswordInput = getElement('new-password');
      const changePasswordButton = getElement('change-password-button');
      const changePasswordMessage = getElement('change-password-message');
      const themeToggle = getElement('theme-toggle');
      const themeToggleMobile = getElement('theme-toggle-mobile');
      const themeIconLight = getElement('theme-icon-light');
      const themeIconDark = getElement('theme-icon-dark');
      const themeIconLightMobile = getElement('theme-icon-light-mobile');
      const themeIconDarkMobile = getElement('theme-icon-dark-mobile');
      const htmlElement = document.documentElement;
      const navLinks = document.querySelectorAll('.nav-link:not(.mobile-nav-link)');
      const pages = document.querySelectorAll('.page');
      const mobileMenuButton = getElement('mobile-menu-button');
      const mobileCloseButton = getElement('mobile-close-button');
      const mobileMenu = getElement('mobile-menu');
      const mobileOverlay = getElement('mobile-overlay');
      const mobileNavLinks = document.querySelectorAll('.mobile-nav-link');
      const currentYearEl = getElement('current-year');
      const subjectTabsContainer = getElement('subject-tabs');
      const resourceContent = getElement('resource-content');
      const addResourceDetails = getElement('add-resource-details');
      const resourceTypeSelect = getElement('resource-type');
      const resourceTitleInput = getElement('resource-title');
      const resourceUrlWrapper = getElement('resource-url-wrapper');
      const resourceUrlInput = getElement('resource-url');
      const resourceNoteWrapper = getElement('resource-note-wrapper');
      const resourceNoteInput = getElement('resource-note');
      const saveResourceBtn = getElement('save-resource-btn');
      const timerDisplay = getElement('timer-display');
      const timerStatus = getElement('timer-status');
      const startPauseButton = getElement('start-pause-button');
      const resetButton = getElement('reset-button');
      const pomodoroSubjectSelect = getElement('pomodoro-subject');
      const pomodoroSubjectWrapper = getElement('pomodoro-subject-wrapper');
      const workDurationInput = getElement('work-duration');
      const shortBreakDurationInput = getElement('short-break-duration');
      const longBreakDurationInput = getElement('long-break-duration');
      const progressRing = getElement('timer-progress-ring');
      const workModeButton = getElement('work-mode-button');
      const shortBreakModeButton = getElement('short-break-mode-button');
      const longBreakModeButton = getElement('long-break-mode-button');
      const pomodoroModeTitle = getElement('pomodoro-mode-title');
      const modeButtons = [workModeButton, shortBreakModeButton, longBreakModeButton];
      const trackerSubjectSelect = getElement('tracker-subject-select');
      const trackerItemsList = getElement('tracker-items-list');
      const addTrackerDetails = getElement('add-tracker-details');
      const trackerDescriptionInput = getElement('tracker-description');
      const trackerStatusSelect = getElement('tracker-status-select');
      const saveTrackerItemBtn = getElement('save-tracker-item-btn');
      const plannerDateInput = getElement('planner-date');
      const plannerTimeInput = getElement('planner-time');
      const plannerSubjectSelect = getElement('planner-subject-select');
      const plannerTopicInput = getElement('planner-topic');
      const savePlannerItemBtn = getElement('save-planner-item-btn');
      const plannerItemsList = getElement('planner-items-list');
      const quizSubjectSelect = getElement('quiz-subject-select');
      const quizContentWrapper = getElement('quiz-content-wrapper');
      const addQuizDetails = getElement('add-quiz-details');
      const quizQuestionInput = getElement('quiz-question-input');
      const quizAnswerInput = getElement('quiz-answer-input');
      const saveQuizQuestionBtn = getElement('save-quiz-question-btn');
      const quizItemsList = getElement('quiz-items-list');
      const quizListContainer = getElement('quiz-list-container');
      const startQuizButton = getElement('start-quiz-button');
      const quizModeInterface = getElement('quiz-mode-interface');
      const quizQuestionDisplay = getElement('quiz-question-display');
      const quizRevealBtnContainer = getElement('quiz-reveal-button-container');
      const quizRevealAnswerBtn = getElement('quiz-reveal-answer-btn');
      const quizCorrectAnswerDisplay = getElement('quiz-correct-answer-display');
      const quizJudgmentButtons = getElement('quiz-judgment-buttons');
      const quizIncorrectBtn = getElement('quiz-incorrect-btn');
      const quizCorrectBtn = getElement('quiz-correct-btn');
      const stopQuizButton = getElement('stop-quiz-button');
      const quizProgress = getElement('quiz-progress');
      const quizCompletionMessage = getElement('quiz-completion-message');

      // --- Helper: Populate Subject Dropdowns ---
      const populateSubjectDropdown = (selectElement) => {
          if (!selectElement) return;
          const placeholder = selectElement.options[0];
          selectElement.innerHTML = '';
          if (placeholder) selectElement.appendChild(placeholder);
          else { const opt = document.createElement('option'); opt.value = ""; opt.textContent = "-- Select --"; selectElement.appendChild(opt); }
          if (!subjects || subjects.length === 0) return;
          subjects.forEach(subject => {
              const option = document.createElement('option');
              option.value = subject;
              option.textContent = subject;
              selectElement.appendChild(option);
          });
      };

      // --- Helper: Create Loading/Empty Messages ---
      const createLoadingMessage = (text, isTableRow = false, colspan = 1) => {
          const p = document.createElement('p');
          p.className = 'text-muted dark:text-muted-dark italic p-4 text-center text-sm';
          p.textContent = text;
          if (isTableRow) {
              const td = document.createElement('td');
              td.colSpan = colspan;
              td.className = 'p-4';
              td.appendChild(p);
              const tr = document.createElement('tr');
              tr.appendChild(td);
              // Return the HTML string for the table row
              return tr.outerHTML;
          }
          // Return the HTML string for the paragraph
          return p.outerHTML;
      };

      // --- AUTHENTICATION & State Management ---
      onAuthStateChanged(auth, (user) => {
          console.log("Auth state changed:", user ? `Logged in as ${user.uid}` : 'Logged out');
          if (user && db) { // Make sure DB is also ready
              currentUserId = user.uid;
              loginOverlay.classList.add('opacity-0', 'pointer-events-none');
              setTimeout(() => loginOverlay.classList.add('hidden'), 400);
              appWrapper.classList.remove('hidden');
              appWrapper.classList.add('flex');
              if (!isInitialized) {
                  // Use DOMContentLoaded only if needed (script is at the end, likely not needed)
                  initializePostLogin(user); // Initialize immediately
                  isInitialized = true;
              }
          } else {
              currentUserId = null;
              isInitialized = false; // Reset initialization flag on logout
              loginOverlay.classList.remove('hidden', 'opacity-0', 'pointer-events-none');
              appWrapper.classList.add('hidden');
              appWrapper.classList.remove('flex');
              clearDynamicContent(); // Clear UI elements
              // Clear intervals
              if (countdownInterval) clearInterval(countdownInterval);
              if (pomodoroInterval) clearInterval(pomodoroInterval);
              countdownInterval = null;
              pomodoroInterval = null;
              // Reset quiz state
              quizState = { active: false, currentSubject: null, initialQuestions: [], currentQuizPool: [], incorrectlyAnswered: [], currentQuestionIndex: -1, round: 1, totalMastered: 0, isAnswerVisible: false, buttonTimeout: null };
              // Clear login form fields
              if (emailInput) emailInput.value = '';
              if (passwordInput) passwordInput.value = '';
              if (loginError) {
                  loginError.textContent = '';
                  loginError.classList.add('hidden');
              }
          }
          safelyCreateIcons(); // Refresh icons after UI changes
      });

      // --- Handle Login Function (Robust Version) ---
      const handleLogin = async () => {
          // Check if essential elements and auth are available
          if (!emailInput || !passwordInput || !loginButton || !loginError || !auth) {
              console.error("Login function cannot run: Missing required elements or Firebase auth.");
              if (loginError) {
                  loginError.textContent = "Internal error. Please refresh.";
                  loginError.classList.remove('hidden'); // Show error
              }
              if (loginButton) {
                  loginButton.disabled = true; // Disable button if setup fails
                  loginButton.textContent = 'Error';
              }
              return;
          }

          const email = emailInput.value.trim();
          const password = passwordInput.value;

          // Reset previous error messages before attempting
          loginError.textContent = '';
          loginError.classList.add('hidden');

          // Basic validation
          if (!email || !password) {
              loginError.textContent = "Please enter both email and password.";
              loginError.classList.remove('hidden');
              return;
          }

          // Disable button during login attempt
          loginButton.disabled = true;
          loginButton.textContent = 'Logging in...';

          try {
              console.log("Attempting Firebase sign in with:", email); // Log the email being used
              await signInWithEmailAndPassword(auth, email, password);
              console.log("Login successful for:", email);
              // Successful login: onAuthStateChanged will handle showing the app.
              // No need to manually hide loginError here, as the overlay will hide.
          } catch (error) {
              console.error("RAW LOGIN ERROR OBJECT:", error); // Log the raw error for debugging
              console.error("Login Error Code:", error.code, "Message:", error.message); // Log specific parts

              // Determine user-friendly error message
              let errorMessage = "Login failed. Please check details and try again."; // Default
              if (error.code === 'auth/invalid-credential' || error.code === 'auth/user-not-found' || error.code === 'auth/wrong-password') {
                  errorMessage = "Invalid email or password.";
              } else if (error.code === 'auth/network-request-failed') {
                  errorMessage = "Network error. Please check your connection.";
              } else if (error.code === 'auth/too-many-requests') {
                  errorMessage = "Too many login attempts. Please try again later.";
              } else if (error.message) {
                   // Use Firebase's message for other errors if available
                   errorMessage = `Login error: ${error.message}`;
              }

              loginError.textContent = errorMessage;
              loginError.classList.remove('hidden'); // *** Ensure the error message is displayed ***

              // Re-enable the login button after failure
              loginButton.disabled = false;
              loginButton.textContent = 'Login';
          }
      };
      // --- End Handle Login Function ---

      const handleLogout = async () => {
          if (!auth) return; // Check if auth is available
          // Stop timers/processes before logging out
          if (pomodoroInterval) clearInterval(pomodoroInterval);
          pomodoroInterval = null;
          if (countdownInterval) clearInterval(countdownInterval);
          countdownInterval = null;
          if (quizState.active) stopQuizMode(); // Stop quiz if running

          try {
              await signOut(auth);
              console.log("Logout successful");
              closeMobileMenu(); // Close menu if open
              // onAuthStateChanged will handle UI clearing and showing login overlay
          } catch (error) {
              console.error("Logout Error:", error);
              alert("Logout failed. Please try again."); // Inform user
          }
      };

      const handleChangePassword = async () => {
           if (!currentPasswordInput || !newPasswordInput || !changePasswordButton || !changePasswordMessage || !auth?.currentUser) {
              if(changePasswordMessage) changePasswordMessage.textContent = 'Cannot change password now.';
              return;
            }
            const currentPassword = currentPasswordInput.value;
            const newPassword = newPasswordInput.value;
            changePasswordMessage.textContent = '';
            changePasswordMessage.className = 'text-sm mt-2 h-4';

            if (!currentPassword || !newPassword) {
                changePasswordMessage.textContent = 'Please enter both current and new passwords.';
                changePasswordMessage.classList.add('text-red-500');
                return;
            }
            if (newPassword.length < 6) {
                changePasswordMessage.textContent = 'New password must be at least 6 characters long.';
                changePasswordMessage.classList.add('text-red-500');
                return;
            }

            changePasswordButton.disabled = true;
            changePasswordButton.textContent = 'Changing...';

            try {
                const user = auth.currentUser;
                if (!user || !user.email) throw new Error("User or email not found."); // Should not happen if logged in

                const credential = EmailAuthProvider.credential(user.email, currentPassword);
                await reauthenticateWithCredential(user, credential); // Re-authenticate first
                await updatePassword(user, newPassword); // Then update

                changePasswordMessage.textContent = 'Password updated successfully!';
                changePasswordMessage.classList.add('text-green-600', 'dark:text-green-400');
                currentPasswordInput.value = ''; // Clear fields on success
                newPasswordInput.value = '';
            } catch (error) {
                console.error("Change Password Error:", error);
                if (error.code === 'auth/wrong-password' || error.code === 'auth/invalid-credential') {
                    changePasswordMessage.textContent = 'Incorrect current password.';
                } else if (error.code === 'auth/weak-password') {
                    changePasswordMessage.textContent = 'New password is too weak.';
                } else if (error.code === 'auth/requires-recent-login') {
                    changePasswordMessage.textContent = 'Security check: Please log out and log back in to change password.';
                } else {
                    changePasswordMessage.textContent = 'Failed to change password. Please try again.';
                }
                changePasswordMessage.classList.add('text-red-500');
            } finally {
                changePasswordButton.disabled = false;
                changePasswordButton.textContent = 'Change Password';
            }
      };

      // --- THEME TOGGLE ---
      const applyTheme = (theme) => {
          htmlElement.classList.remove('light', 'dark');
          htmlElement.classList.add(theme);
          const isDark = theme === 'dark';
          themeIconLight?.classList.toggle('hidden', isDark);
          themeIconDark?.classList.toggle('hidden', !isDark);
          themeIconLightMobile?.classList.toggle('hidden', isDark);
          themeIconDarkMobile?.classList.toggle('hidden', !isDark);
          localStorage.setItem('theme', theme);
          safelyCreateIcons(); // Ensure icons are updated
      };
      const toggleTheme = () => { applyTheme(htmlElement.classList.contains('dark') ? 'light' : 'dark'); };

      // --- NAVIGATION ---
      const setActiveLink = (pageId) => {
          // Desktop nav
          navLinks.forEach(link => {
              const isActive = link.dataset.page === pageId;
              link.classList.toggle('text-primary', isActive);
              link.classList.toggle('dark:text-primary-dark', isActive);
              link.classList.toggle('font-semibold', isActive);
              link.classList.toggle('bg-slate-100', isActive);
              link.classList.toggle('dark:bg-slate-700', isActive);
              link.classList.toggle('text-muted', !isActive);
              link.classList.toggle('dark:text-muted-dark', !isActive);
              link.classList.toggle('font-medium', !isActive);
          });
          // Mobile nav
          mobileNavLinks.forEach(link => {
              const isActive = link.dataset.page === pageId;
              link.classList.toggle('text-primary', isActive);
              link.classList.toggle('dark:text-primary-dark', isActive);
              link.classList.toggle('bg-slate-100', isActive);
              link.classList.toggle('dark:bg-slate-700', isActive);
              link.classList.toggle('font-semibold', isActive);
              link.classList.toggle('text-muted', !isActive);
              link.classList.toggle('dark:text-muted-dark', !isActive);
              link.classList.toggle('font-medium', !isActive);
          });
      };
      const showPage = (pageId) => {
          if (!getElement(pageId)) pageId = 'dashboard'; // Default to dashboard if page doesn't exist
          pages.forEach(page => page.classList.remove('active'));
          const targetPage = getElement(pageId);
          if (targetPage) targetPage.classList.add('active');
          setActiveLink(pageId); // Update nav link styles
          window.scrollTo(0, 0); // Scroll to top
          safelyCreateIcons(); // Re-render icons if needed

          // Handle deferred subject selection if navigating to a relevant page
          if (targetSubjectParam && targetSubjectParam.page === pageId) {
              console.log(`Handling deferred param for ${pageId}: ${targetSubjectParam.subject}`);
              handleSubjectSelection(targetSubjectParam.subject, pageId);
              targetSubjectParam = null; // Clear the param once handled
          }
      };
      const _navigateToPage = (pageId, param = null) => {
          console.log(`Navigate request: ${pageId}, param: ${param ? param : 'none'}`);
          // Store subject param only if navigating to a page that uses it
          targetSubjectParam = (param && ['resources', 'tracker', 'quiz'].includes(pageId)) ? { page: pageId, subject: param } : null;

          // Reset active subject if navigating away from subject-specific pages
          if (!['resources', 'tracker', 'quiz'].includes(pageId)) {
              currentActiveSubject = null;
          }

          showPage(pageId);
          closeMobileMenu(); // Close mobile menu on navigation
      };
      const openMobileMenu = () => {
          mobileMenu?.classList.add('open');
          mobileOverlay?.classList.remove('hidden');
          setTimeout(() => mobileOverlay?.classList.add('visible'), 10); // For transition
      };
      const closeMobileMenu = () => {
          mobileOverlay?.classList.remove('visible');
          mobileMenu?.classList.remove('open');
          setTimeout(() => mobileOverlay?.classList.add('hidden'), 350); // Match transition duration
      };

      // --- Clear Dynamic Content on Logout ---
      const clearDynamicContent = () => {
          console.log("Clearing dynamic content...");
          const upcomingList = getElement('upcoming-exams-list');
          const pomodoroSummary = getElement('pomodoro-summary');
          const pomodoroAnalytics = getElement('pomodoro-analytics');
          const quoteEl = getElement('motivational-quote');
          const timetableBody = getElement('timetable-body'); // Get reference

          // Dashboard
          if (upcomingList) upcomingList.innerHTML = createLoadingMessage('Loading...');
          if (pomodoroSummary) pomodoroSummary.innerHTML = createLoadingMessage('No sessions logged.');
          if (pomodoroAnalytics) pomodoroAnalytics.innerHTML = createLoadingMessage('Loading analytics...');
          if (quoteEl) quoteEl.textContent = 'Loading quote...';

          // Timetable
          if (timetableBody) {
              timetableBody.innerHTML = createLoadingMessage('Loading timetable...', true, 6);
          }

          // Resources
          if (subjectTabsContainer) subjectTabsContainer.innerHTML = '';
          if (resourceContent) resourceContent.innerHTML = createLoadingMessage('Select a subject.');
          if (addResourceDetails) { addResourceDetails.style.display = 'none'; addResourceDetails.removeAttribute('open'); }

          // Tracker
          if (trackerSubjectSelect) trackerSubjectSelect.value = '';
          if (trackerItemsList) trackerItemsList.innerHTML = createLoadingMessage('Select a subject.');
          if (addTrackerDetails) { addTrackerDetails.style.display = 'none'; addTrackerDetails.removeAttribute('open'); }

          // Planner
          if (plannerSubjectSelect) plannerSubjectSelect.value = '';
          if (plannerItemsList) plannerItemsList.innerHTML = createLoadingMessage('No sessions scheduled.');
          if(plannerDateInput) plannerDateInput.value = '';
          if(plannerTimeInput) plannerTimeInput.value = '';
          if(plannerTopicInput) plannerTopicInput.value = '';

          // Quiz
          if (quizSubjectSelect) quizSubjectSelect.value = '';
          if (quizContentWrapper) quizContentWrapper.classList.add('hidden');
          if (quizItemsList) quizItemsList.innerHTML = createLoadingMessage('Select a subject.');
          if (addQuizDetails) { addQuizDetails.style.display = 'none'; addQuizDetails.removeAttribute('open'); }
          if (quizModeInterface) quizModeInterface.classList.add('hidden');

          // Password Change Form
          if (currentPasswordInput) currentPasswordInput.value = '';
          if (newPasswordInput) newPasswordInput.value = '';
          if (changePasswordMessage) changePasswordMessage.textContent = '';

          // Pomodoro Reset
          resetTimer(true); // Reset timer state silently
          currentActiveSubject = null; // Reset active subject state
          console.log("Dynamic content cleared.");
      };


      // --- DASHBOARD ---
      const loadDashboard = async () => {
          if (!currentUserId || !db) return;
          console.log("Loading dashboard data...");
          const upcomingList = getElement('upcoming-exams-list');
          const pomodoroSummaryEl = getElement('pomodoro-summary');
          const pomodoroAnalyticsEl = getElement('pomodoro-analytics');
          const quoteEl = getElement('motivational-quote');

          // Upcoming Exams
          if (upcomingList) {
              upcomingList.innerHTML = ''; // Clear previous
              const now = new Date();
              const futureExams = examData.filter(exam => new Date(exam.date) > now).slice(0, 5); // Get next 5
              if (futureExams.length > 0) {
                  futureExams.forEach((exam, index) => {
                      const div = document.createElement('div');
                      div.className = `upcoming-exam-item p-3 rounded-lg border-l-4 ${getSubjectColor(exam.subject)} bg-background dark:bg-slate-800/50 shadow-sm list-item list-item-appear cursor-pointer hover:shadow-md dark:hover:shadow-widget-hover-dark`;
                      div.style.animationDelay = `${index * 0.07}s`; // Stagger animation
                      div.dataset.page = "resources"; // Link to resources page
                      div.dataset.subject = exam.subject; // Pass subject
                      div.setAttribute('role', 'button');
                      div.setAttribute('tabindex', '0');
                      div.innerHTML = `
                          <div class="flex justify-between items-center mb-1 pointer-events-none">
                              <span class="font-semibold text-text dark:text-text-dark">${escapeHtml(exam.subject)}</span>
                              <span class="text-xs font-medium text-primary dark:text-primary-dark" data-date="${exam.date}">${formatCountdown(exam.date)}</span>
                          </div>
                          <p class="text-xs text-muted dark:text-muted-dark pointer-events-none">${escapeHtml(exam.paper)} (${escapeHtml(exam.duration)})</p>
                          <p class="text-xs text-muted dark:text-muted-dark pointer-events-none">${formatExamDate(exam.date)}</p>`;
                      upcomingList.appendChild(div);
                  });
              } else {
                  upcomingList.innerHTML = createLoadingMessage('No upcoming exams found.');
              }
          }

          // Pomodoro Summary & Analytics
          if (pomodoroSummaryEl && pomodoroAnalyticsEl) {
             pomodoroSummaryEl.innerHTML = createLoadingMessage('Loading sessions...');
             pomodoroAnalyticsEl.innerHTML = createLoadingMessage('Loading analytics...');
              try {
                  // Fetch recent logs (last 5)
                  const logQuery = query(getUserCollectionRef(currentUserId, 'pomodoroLogs'), orderBy("timestamp", "desc"), limit(5));
                  const logSnapshot = await getDocs(logQuery);
                  if (logSnapshot.empty) {
                      pomodoroSummaryEl.innerHTML = createLoadingMessage('No recent study sessions.');
                  } else {
                       pomodoroSummaryEl.innerHTML = ''; // Clear loading
                       logSnapshot.docs.forEach((logDoc, index) => {
                           const data = logDoc.data();
                           const p = document.createElement('p');
                           p.className = 'text-xs text-muted dark:text-muted-dark list-item-appear';
                           p.style.animationDelay = `${index * 0.06}s`;
                           const dateStr = data.timestamp?.toDate ? formatGeneralDate(data.timestamp.toDate()) : 'Recent';
                           p.innerHTML = `<i data-lucide="check-circle" class="h-3 w-3 text-green-500 mr-1"></i> ${escapeHtml(data.subject)} - ${formatMinutes(data.durationMinutes)} <span class="text-gray-400 dark:text-gray-500">(${dateStr})</span>`;
                           pomodoroSummaryEl.appendChild(p);
                       });
                       safelyCreateIcons();
                  }

                  // Fetch analytics
                  const analyticsDoc = await getDoc(getUserDataRef(currentUserId, 'stats/pomodoroAnalytics'));
                  if (analyticsDoc.exists()) {
                      const data = analyticsDoc.data();
                       pomodoroAnalyticsEl.innerHTML = ''; // Clear loading
                      const totalMins = data.totalMinutes || 0;
                      const totalSessions = data.totalSessions || 0;
                      const subjectMins = data.subjectMinutes || {};
                      let analyticsHTML = `<p class="text-sm text-text dark:text-text-dark">Total Time: <span class="font-semibold">${formatMinutes(totalMins)}</span> (${totalSessions} sessions)</p>`;
                      const sortedSubjects = Object.entries(subjectMins).sort(([,a],[,b]) => b-a).slice(0, 3); // Top 3 subjects
                      if(sortedSubjects.length > 0) {
                          analyticsHTML += `<p class="text-xs mt-2 text-muted dark:text-muted-dark">Top Subjects:</p><ul class="list-disc list-inside text-xs ml-1 space-y-0.5 mt-1">`;
                          sortedSubjects.forEach(([subject, mins]) => {
                              analyticsHTML += `<li>${escapeHtml(subject)}: ${formatMinutes(mins)}</li>`;
                          });
                           analyticsHTML += `</ul>`;
                      } else if (totalMins > 0) {
                          analyticsHTML += `<p class="text-xs mt-2 text-muted dark:text-muted-dark">Keep tracking to see subject breakdown!</p>`;
                      }
                      pomodoroAnalyticsEl.innerHTML = analyticsHTML;
                  } else {
                      pomodoroAnalyticsEl.innerHTML = createLoadingMessage('No analytics data yet.');
                  }

              } catch (error) {
                  console.error("Error loading Pomodoro data:", error);
                  pomodoroSummaryEl.innerHTML = createLoadingMessage('Error loading sessions.');
                  pomodoroAnalyticsEl.innerHTML = createLoadingMessage('Error loading analytics.');
              }
          }

          // Motivational Quote
          if (quoteEl) {
              quoteEl.textContent = motivationalQuotes[Math.floor(Math.random() * motivationalQuotes.length)];
          }

          safelyCreateIcons(); // Ensure all icons render
          console.log("Dashboard loaded.");
      };


      // --- TIMETABLE ---
      const loadTimetable = () => {
          const tbody = getElement('timetable-body');
          if (!tbody) { console.error("Timetable tbody missing!"); return; }
          tbody.innerHTML = ''; // Clear previous content
          let lastDateStr = null;

          if (!examData || examData.length === 0) {
              tbody.innerHTML = createLoadingMessage('Timetable data unavailable.', true, 6);
              return;
          }

          examData.forEach((exam, index) => {
              try {
                  const tr = document.createElement('tr');
                  const currentDate = new Date(exam.date);
                  if (isNaN(currentDate.getTime())) return; // Skip invalid dates

                  const currentDateStr = currentDate.toDateString();
                  // Add class for visual separation between days
                  if (lastDateStr && currentDateStr !== lastDateStr) {
                      tr.classList.add('timetable-new-day');
                  }
                  lastDateStr = currentDateStr;

                  const colorClasses = getSubjectColor(exam.subject).split(' ');
                  const rgbColor = getSubjectColorRGB(exam.subject);

                  tr.classList.add('text-sm', 'align-middle');

                  const subjectColorVar = colorClasses.find(c => c.startsWith('border-'))?.replace('border-', 'text-') || 'text-slate-700';
                  const darkSubjectColorVar = colorClasses.find(c => c.startsWith('dark:border-'))?.replace('dark:border-', 'dark:text-') || 'dark:text-slate-300';

                  tr.innerHTML = `
                      <td class="timetable-subject-cell pl-4 pr-3 py-4 font-medium text-text dark:text-text-dark whitespace-nowrap border-l-4 ${colorClasses.join(' ')}" style="--subject-rgb: ${rgbColor};">
                          <span class="timetable-subject-text ${subjectColorVar} ${darkSubjectColorVar}">${escapeHtml(exam.subject)}</span>
                          <br><span class="text-xs text-muted dark:text-muted-dark">${escapeHtml(exam.paper)}</span>
                      </td>
                      <td class="px-3 py-4 text-muted dark:text-muted-dark whitespace-nowrap">${formatExamDate(exam.date)}</td>
                      <td class="px-3 py-4 text-muted dark:text-muted-dark whitespace-nowrap">${escapeHtml(exam.duration)}</td>
                      <td class="px-3 py-4 text-muted dark:text-muted-dark whitespace-nowrap">${escapeHtml(exam.board)}${exam.tier ? ` (${escapeHtml(exam.tier)})` : ''}</td>
                      <td class="px-3 py-4 text-muted dark:text-muted-dark whitespace-nowrap">${escapeHtml(exam.location || 'N/A')}${exam.seat ? ` (Seat: ${escapeHtml(exam.seat)})` : ''}</td>
                      <td class="pl-3 pr-4 py-4 text-muted dark:text-muted-dark whitespace-nowrap countdown-cell" data-date="${exam.date}">${formatCountdown(exam.date)}</td>`;
                  tbody.appendChild(tr);
              } catch (rowError) {
                  console.error(`Error creating timetable row ${index}:`, rowError, exam);
              }
          });
          safelyCreateIcons(); // Render any icons if added later
          updateTimetableCountdowns(); // Initial countdown update
          console.log("Timetable loaded.");
      };

      const updateTimetableCountdowns = () => {
           if (!appWrapper || appWrapper.classList.contains('hidden')) return; // Only update if app is visible
           document.querySelectorAll('.countdown-cell[data-date]').forEach(cell => {
                cell.innerHTML = formatCountdown(cell.dataset.date);
            });
           getElement('upcoming-exams-list')?.querySelectorAll('[data-date]').forEach(span => {
                 span.innerHTML = formatCountdown(span.dataset.date);
             });
      };

      // --- Content Area Animation ---
      const animateContentSwitch = async (containerElement, displayFunction, subject) => {
          if (!containerElement) return;
          containerElement.classList.add('content-fade-out');
          await new Promise(resolve => setTimeout(resolve, 150));
          containerElement.innerHTML = '';
          containerElement.classList.remove('content-fade-out');
          await displayFunction(subject);
          containerElement.classList.add('content-fade-in');
          setTimeout(() => containerElement.classList.remove('content-fade-in'), 300);
      };

      // --- SUBJECT SELECTION HANDLER (for Resources, Tracker, Quiz) ---
      const handleSubjectSelection = (subject, context) => {
          const isValidSubject = subjects.includes(subject);
          currentActiveSubject = isValidSubject ? subject : null;
          console.log(`Handling Subject selection for ${context}: ${currentActiveSubject || 'None'}`);

          const toggleDetailsVisibility = (detailsId) => {
              const detailsElement = getElement(detailsId);
              if (detailsElement) {
                  detailsElement.style.display = isValidSubject ? 'block' : 'none';
                  if (!isValidSubject && detailsElement.hasAttribute('open')) {
                      detailsElement.removeAttribute('open');
                  }
              }
          };

          toggleDetailsVisibility('add-resource-details');
          toggleDetailsVisibility('add-tracker-details');
          toggleDetailsVisibility('add-quiz-details');
          if (quizContentWrapper) quizContentWrapper.classList.toggle('hidden', !isValidSubject);

          if (context === 'resources') {
              setActiveSubjectTab(currentActiveSubject);
              if (isValidSubject) {
                  if(resourceTitleInput) resourceTitleInput.value = '';
                  if(resourceUrlInput) resourceUrlInput.value = '';
                  if(resourceNoteInput) resourceNoteInput.value = '';
                  if(resourceTypeSelect) resourceTypeSelect.value = 'link';
                  toggleResourceTypeFields();
                  validateResourceForm();
                  animateContentSwitch(resourceContent, displayResources, currentActiveSubject);
              } else {
                  if(resourceContent) resourceContent.innerHTML = createLoadingMessage('Select a subject tab above.');
              }
          } else if (context === 'tracker') {
              if (isValidSubject) {
                  if(trackerDescriptionInput) trackerDescriptionInput.value = '';
                  if(trackerStatusSelect) trackerStatusSelect.value = 'To Review';
                  validateTrackerForm();
                  animateContentSwitch(trackerItemsList, displayTrackerItems, currentActiveSubject);
              } else {
                   if(trackerItemsList) trackerItemsList.innerHTML = createLoadingMessage('Select a subject.');
              }
          } else if (context === 'quiz') {
              stopQuizMode();
              if (isValidSubject) {
                  if(quizQuestionInput) quizQuestionInput.value = '';
                  if(quizAnswerInput) quizAnswerInput.value = '';
                  validateQuizForm();
                  animateContentSwitch(quizItemsList, displaySavedQuizQuestions, currentActiveSubject);
              } else {
                   if(quizItemsList) quizItemsList.innerHTML = createLoadingMessage('Select a subject.');
                   toggleQuizButtons();
              }
          }
      };

      // --- RESOURCES ---
      const loadResources = () => {
           if (!subjectTabsContainer) return;
           subjectTabsContainer.innerHTML = '';
            if (!subjects || subjects.length === 0) return;

            subjects.forEach(subject => {
                const button = document.createElement('button');
                button.setAttribute('role', 'tab');
                button.setAttribute('aria-selected', 'false');
                button.dataset.subject = subject;
                button.className = `subject-tab whitespace-nowrap py-2 px-3 text-sm font-medium rounded-t-lg border-b-2 border-transparent text-muted dark:text-muted-dark hover:text-primary dark:hover:text-primary-dark hover:border-slate-300 dark:hover:border-slate-600 focus:outline-none focus-visible:ring-1 focus-visible:ring-primary focus-visible:ring-offset-1 transition-colors duration-150`;
                button.textContent = subject;
                subjectTabsContainer.appendChild(button);
            });

            if (addResourceDetails) addResourceDetails.style.display = 'none';
            if(resourceContent) resourceContent.innerHTML = createLoadingMessage('Select a subject tab above.');
            validateResourceForm();
      };
      const toggleResourceTypeFields = () => {
          if (!resourceTypeSelect || !resourceUrlWrapper || !resourceNoteWrapper) return;
           const isLink = resourceTypeSelect.value === 'link';
           resourceUrlWrapper.classList.toggle('visible', isLink);
           resourceNoteWrapper.classList.toggle('visible', !isLink);
           if (isLink && resourceNoteInput) resourceNoteInput.value = '';
           else if (!isLink && resourceUrlInput) resourceUrlInput.value = '';
           validateResourceForm();
      };
      const validateResourceForm = () => {
           if (!saveResourceBtn || !resourceTitleInput || !resourceTypeSelect || !currentActiveSubject) {
                if(saveResourceBtn) saveResourceBtn.disabled = true;
                return;
            }
            let isValid = resourceTitleInput.value.trim() !== '';

            if (resourceTypeSelect.value === 'link') {
                 isValid = isValid && resourceUrlInput && resourceUrlInput.value.trim() !== '' && resourceUrlInput.value.includes('://');
            } else if (resourceTypeSelect.value === 'note') {
                 isValid = isValid && resourceNoteInput && resourceNoteInput.value.trim() !== '';
            } else {
                 isValid = false;
            }
            saveResourceBtn.disabled = !isValid;
      };
      const setActiveSubjectTab = (subject) => {
           document.querySelectorAll('.subject-tab').forEach(tab => {
                const isSelected = tab.dataset.subject === subject;
                tab.setAttribute('aria-selected', isSelected.toString());
                tab.classList.toggle('border-primary', isSelected);
                tab.classList.toggle('dark:border-primary-dark', isSelected);
                tab.classList.toggle('text-primary', isSelected);
                tab.classList.toggle('dark:text-primary-dark', isSelected);
                tab.classList.toggle('font-semibold', isSelected);
                tab.classList.toggle('border-transparent', !isSelected);
                tab.classList.toggle('text-muted', !isSelected);
                tab.classList.toggle('dark:text-muted-dark', !isSelected);
                tab.classList.toggle('font-medium', !isSelected);
           });
      };
      const displayResources = async (subject) => {
           if (!currentUserId || !resourceContent || !db) return;
           resourceContent.innerHTML = createLoadingMessage(`Loading ${subject} resources...`);
           try {
                const q = query(getSubjectSpecificCollectionRef(currentUserId, 'resources', subject), orderBy("createdAt", "desc"));
                const snapshot = await getDocs(q);
                const items = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                resourceContent.innerHTML = '';

                if (items.length === 0) {
                     resourceContent.innerHTML = createLoadingMessage(`No resources saved for ${subject} yet.`);
                } else {
                     const ul = document.createElement('ul');
                     ul.className = 'space-y-3';
                     items.forEach((item, index) => {
                        const li = document.createElement('li');
                        li.className = `resource-item list-item flex justify-between items-start p-3 rounded-lg border bg-background dark:bg-slate-800/50 hover:bg-slate-50 dark:hover:bg-slate-700/50 transition-all duration-150 space-x-3 ${getSubjectColor(subject).replace('border-l-4', 'border')}`;
                        let contentHtml = '';
                        if (item.type === 'link' && item.url) {
                            contentHtml = `
                                <a href="${escapeHtml(item.url)}" target="_blank" rel="noopener noreferrer" class="flex items-center space-x-2 group focus-visible:outline focus-visible:outline-1 focus-visible:outline-primary rounded -m-1 p-1">
                                    <i data-lucide="link" class="h-4 w-4 text-primary dark:text-primary-dark flex-shrink-0"></i>
                                    <span class="font-medium text-sm text-text dark:text-text-dark group-hover:underline">${escapeHtml(item.title)}</span>
                                    <i data-lucide="external-link" class="h-3 w-3 text-muted dark:text-muted-dark opacity-0 group-hover:opacity-100 transition-opacity"></i>
                                </a>`;
                        } else if (item.type === 'note') {
                             contentHtml = `
                                 <div class="flex items-start space-x-2">
                                     <i data-lucide="notebook-pen" class="h-4 w-4 text-secondary dark:text-secondary-dark flex-shrink-0 mt-0.5"></i>
                                     <div>
                                         <p class="font-medium text-sm text-text dark:text-text-dark">${escapeHtml(item.title)}</p>
                                         <p class="text-xs text-muted dark:text-muted-dark mt-1 whitespace-pre-wrap">${escapeHtml(item.noteContent || '')}</p>
                                     </div>
                                 </div>`;
                         } else {
                             contentHtml = `<p class="font-medium text-sm text-text dark:text-text-dark">${escapeHtml(item.title)}</p>`;
                         }
                         li.innerHTML = `
                            <div class="flex-grow mr-2">${contentHtml}</div>
                            <button title="Delete Resource" class="list-delete-btn flex-shrink-0 p-1 -m-1 rounded-full btn-animated focus-visible:ring-1 focus-visible:ring-red-500" onclick="window.handleDeleteResource('${escapeHtml(subject)}', '${item.id}')">
                                <i data-lucide="trash-2" class="h-4 w-4"></i>
                            </button>`;
                         ul.appendChild(li);
                     });
                     resourceContent.appendChild(ul);
                     applyStaggerAnimation(ul.children);
                     safelyCreateIcons();
                }
           } catch (error) {
                console.error(`Error loading resources for ${subject}:`, error);
                resourceContent.innerHTML = createLoadingMessage(`Error loading resources for ${subject}.`);
           }
      };
      const handleSaveResource = async () => {
           if (!currentUserId || !currentActiveSubject || !saveResourceBtn || !db) return;
           validateResourceForm();
           if (saveResourceBtn.disabled) return;

           const type = resourceTypeSelect.value;
           const title = resourceTitleInput.value.trim();
           const url = resourceUrlInput.value.trim();
           const noteContent = resourceNoteInput.value.trim();

           const newResource = { title, type, createdAt: serverTimestamp() };
           if (type === 'link') newResource.url = url;
           else if (type === 'note') newResource.noteContent = noteContent;

           saveResourceBtn.disabled = true;
           saveResourceBtn.textContent = 'Saving...';

           try {
                await addDoc(getSubjectSpecificCollectionRef(currentUserId, 'resources', currentActiveSubject), newResource);
                resourceTitleInput.value = '';
                resourceUrlInput.value = '';
                resourceNoteInput.value = '';
                resourceTypeSelect.value = 'link';
                toggleResourceTypeFields();
                if (addResourceDetails) addResourceDetails.open = false;
                displayResources(currentActiveSubject);
           } catch (error) {
                console.error("Error saving resource:", error);
                alert("Failed to save resource. Please try again.");
           } finally {
                saveResourceBtn.disabled = false;
                saveResourceBtn.textContent = 'Add Resource';
                validateResourceForm();
           }
      };
       window.handleDeleteResource = async (subject, resourceDocId) => {
            if (!currentUserId || !subject || !resourceDocId || !db) return;
            if (!confirm(`Are you sure you want to delete this resource for ${subject}?`)) return;
            try {
                 await deleteDoc(getSubjectSpecificDocRef(currentUserId, 'resources', subject, resourceDocId));
                 console.log(`Resource ${resourceDocId} deleted for ${subject}.`);
                 if (currentActiveSubject === subject && getElement('resources').classList.contains('active')) {
                      displayResources(subject);
                 }
            } catch (error) {
                 console.error("Error deleting resource:", error);
                 alert("Failed to delete resource.");
            }
       };

       // --- POMODORO TIMER ---
       const ringCircumference = progressRing ? 2 * Math.PI * parseFloat(progressRing.getAttribute('r')) : 283;
       if (progressRing) { progressRing.style.strokeDasharray = `${ringCircumference} ${ringCircumference}`; progressRing.style.strokeDashoffset = ringCircumference; }
       let totalSeconds = 0, currentSeconds = 0, timerState = 'stopped', timerMode = 'work', pomodoroCycle = 0, selectedSubject = '';

       const updateTimerDisplay = () => {
           if (!timerDisplay || !progressRing) return;
           const minutes = Math.max(0, Math.floor(currentSeconds / 60));
           const seconds = Math.max(0, currentSeconds % 60);
           timerDisplay.textContent = `${minutes}:${seconds < 10 ? '0' : ''}${seconds}`;
           const progress = totalSeconds > 0 ? Math.min(1, Math.max(0, (totalSeconds - currentSeconds) / totalSeconds)) : 0;
           const offset = ringCircumference * (1 - progress);
           progressRing.style.strokeDashoffset = Math.max(0, Math.min(ringCircumference, offset));
       };
       const setActiveModeButton = (activeMode) => {
           modeButtons.forEach(btn => {
               if (btn) btn.classList.toggle('active', btn.dataset.mode === activeMode);
           });
           if (pomodoroSubjectWrapper) {
               pomodoroSubjectWrapper.style.display = activeMode === 'work' ? 'block' : 'none';
           }
       };
       const handleDurationChange = (mode) => {
           if (timerState !== 'running' && timerMode === mode) {
               setTimerMode(mode, false);
           }
       };
       const setTimerMode = (mode, fromInteraction = false) => {
           if (!timerStatus || !progressRing || !workDurationInput || !shortBreakDurationInput || !longBreakDurationInput || !pomodoroModeTitle) return;

           if (timerState === 'running' && fromInteraction) {
               console.log("Cannot change mode while timer is running.");
               const buttonToShake = modeButtons.find(btn => btn.dataset.mode === mode);
               buttonToShake?.classList.add('shake-horizontal');
               setTimeout(() => buttonToShake?.classList.remove('shake-horizontal'), 400);
               return;
           }

           timerMode = mode;
           pomodoroCycle = parseInt(localStorage.getItem('pomodoroCycle') || '0');
           let title = '', durationInput, ringColorClass = 'text-primary dark:text-primary-dark';

           switch (mode) {
               case 'work': durationInput = workDurationInput; title = 'Focus Session'; timerStatus.textContent = 'Work'; break;
               case 'shortBreak': durationInput = shortBreakDurationInput; title = 'Short Break'; timerStatus.textContent = 'Short Break'; ringColorClass = 'text-emerald-500 dark:text-emerald-400'; break;
               case 'longBreak': durationInput = longBreakDurationInput; title = 'Long Break'; timerStatus.textContent = 'Long Break'; ringColorClass = 'text-sky-500 dark:text-sky-400'; break;
               default: console.error("Invalid timer mode:", mode); return;
           }

           totalSeconds = parseInt(durationInput.value) * 60;
           totalSeconds = (!isNaN(totalSeconds) && totalSeconds >= 0) ? totalSeconds : (25 * 60);
           currentSeconds = totalSeconds;

           pomodoroModeTitle.textContent = title;
           setActiveModeButton(mode);
           updateTimerDisplay();

           progressRing.classList.remove('text-primary', 'dark:text-primary-dark', 'text-emerald-500', 'dark:text-emerald-400', 'text-sky-500', 'dark:text-sky-400');
           progressRing.classList.add(...ringColorClass.split(' '));

           if (timerState !== 'running' || !fromInteraction) {
               if (pomodoroInterval) clearInterval(pomodoroInterval);
               pomodoroInterval = null;
               timerState = 'stopped';
               if (startPauseButton) {
                   startPauseButton.innerHTML = `<i data-lucide="play" class="h-5 w-5"></i> <span>Start</span>`;
                   startPauseButton.disabled = false;
               }
               safelyCreateIcons();
               modeButtons.forEach(btn => { if (btn) btn.disabled = false; });
           }
       };
       const addPomodoroLogAndAnalytics = async (subject, durationMinutes) => {
           if (!currentUserId || !subject || durationMinutes < 1 || !db) return;
           console.log(`Logging Pomodoro: ${subject}, ${durationMinutes}min`);
           const logCollRef = getUserCollectionRef(currentUserId, 'pomodoroLogs');
           const analyticsRef = getUserDataRef(currentUserId, 'stats/pomodoroAnalytics');
           try {
               const batch = writeBatch(db);
               batch.set(doc(logCollRef), { subject, durationMinutes, timestamp: serverTimestamp() });
               const updateData = { totalSessions: increment(1), totalMinutes: increment(durationMinutes), [`subjectMinutes.${subject}`]: increment(durationMinutes) };
               batch.set(analyticsRef, updateData, { merge: true });
               await batch.commit();
               console.log("Pomodoro log and analytics updated.");
               if (getElement('dashboard').classList.contains('active')) { loadDashboard(); }
           } catch (error) { console.error("Error logging Pomodoro:", error); }
       };
       const startTimer = () => {
           if (timerState === 'running' || !startPauseButton) return;

           if (timerMode === 'work') {
               selectedSubject = pomodoroSubjectSelect.value;
               if (!selectedSubject) { alert('Please select a subject for this Focus Session.'); pomodoroSubjectSelect.focus(); return; }
           } else { selectedSubject = `Break (${timerMode})`; }

           if (currentSeconds <= 0) {
               setTimerMode(timerMode, false);
               if (currentSeconds <= 0) { alert("Timer duration is set to 0. Please adjust settings."); return; }
           }

           timerState = 'running';
           startPauseButton.innerHTML = `<i data-lucide="pause" class="h-5 w-5"></i> <span>Pause</span>`;
           safelyCreateIcons();
           startPauseButton.disabled = false;
           modeButtons.forEach(btn => { if (btn) btn.disabled = true; });

           if (pomodoroInterval) clearInterval(pomodoroInterval);
           pomodoroInterval = setInterval(() => {
               if (currentSeconds <= 0) {
                   clearInterval(pomodoroInterval);
                   pomodoroInterval = null;
                   timerState = 'stopped';
                   modeButtons.forEach(btn => { if(btn) btn.disabled = false; });

                   const finishedMode = timerMode;
                   let nextMode = 'work';
                   let alertMessage = '';

                   if (finishedMode === 'work') {
                       pomodoroCycle++;
                       localStorage.setItem('pomodoroCycle', pomodoroCycle.toString());
                       addPomodoroLogAndAnalytics(selectedSubject, parseInt(workDurationInput.value));
                       nextMode = (pomodoroCycle % 4 === 0) ? 'longBreak' : 'shortBreak';
                       alertMessage = `Focus session complete! Time for a ${nextMode === 'longBreak' ? 'long' : 'short'} break.`;
                   } else {
                       alertMessage = "Break's over! Time to get back to focus.";
                       nextMode = 'work';
                   }
                   alert(alertMessage);
                   setTimerMode(nextMode, false);
               } else {
                   currentSeconds--;
                   updateTimerDisplay();
               }
           }, 1000);
       };
       const pauseTimer = () => {
           if (timerState !== 'running' || !startPauseButton) return;
           if (pomodoroInterval) clearInterval(pomodoroInterval);
           pomodoroInterval = null;
           timerState = 'paused';
           startPauseButton.innerHTML = `<i data-lucide="play" class="h-5 w-5"></i> <span>Resume</span>`;
           safelyCreateIcons();
           modeButtons.forEach(btn => { if (btn) btn.disabled = true; });
       };
       const resetTimer = (silent = false) => {
           if (pomodoroInterval) clearInterval(pomodoroInterval);
           pomodoroInterval = null;
           timerState = 'stopped';
           setTimerMode(timerMode, true);
           if (startPauseButton) {
               startPauseButton.innerHTML = `<i data-lucide="play" class="h-5 w-5"></i> <span>Start</span>`;
               startPauseButton.disabled = false;
           }
           safelyCreateIcons();
           modeButtons.forEach(btn => { if (btn) btn.disabled = false; });
           if (!silent) console.log("Timer reset by user.");
       };

       // --- TRACKER ---
       const loadTracker = () => {
           populateSubjectDropdown(trackerSubjectSelect);
           if(addTrackerDetails) addTrackerDetails.style.display = 'none';
           if(trackerItemsList) trackerItemsList.innerHTML = createLoadingMessage('Select a subject to view items.');
           validateTrackerForm();
       };
       const validateTrackerForm = () => {
           if (saveTrackerItemBtn && trackerDescriptionInput && currentActiveSubject) {
               saveTrackerItemBtn.disabled = trackerDescriptionInput.value.trim() === '';
           } else if (saveTrackerItemBtn) {
                saveTrackerItemBtn.disabled = true;
           }
       };
       const displayTrackerItems = async (subject) => {
           if (!currentUserId || !trackerItemsList || !db) return;
           trackerItemsList.innerHTML = createLoadingMessage(`Loading ${subject} tracker items...`);
           try {
               const q = query(getSubjectSpecificCollectionRef(currentUserId, 'trackerItems', subject), orderBy("createdAt", "desc"));
               const snapshot = await getDocs(q);
               const items = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
               trackerItemsList.innerHTML = '';

               if (items.length === 0) {
                   trackerItemsList.innerHTML = createLoadingMessage(`No items tracked for ${subject} yet.`);
               } else {
                   const getStatusClass = (status) => {
                       const statusKey = status?.toLowerCase().replace(' ','') || 'review';
                       return tailwind.config.theme.extend.colors.status[statusKey] || 'bg-gray-100 dark:bg-slate-700 text-gray-800 dark:text-gray-200 border border-gray-300 dark:border-gray-600 font-medium';
                   };
                   items.forEach((item, index) => {
                       const div = document.createElement('div');
                       div.className = `tracker-item list-item flex justify-between items-start p-3 rounded-lg border bg-background dark:bg-slate-800/50 hover:bg-slate-50 dark:hover:bg-slate-700/50 transition-all duration-150 space-x-3 ${getSubjectColor(subject).replace('border-l-4', 'border')} list-item-appear`;
                       div.style.animationDelay = `${index * 0.05}s`;
                       div.innerHTML = `
                           <div class="flex-grow">
                               <p class="text-sm text-text dark:text-text-dark whitespace-pre-wrap">${escapeHtml(item.description)}</p>
                               <span class="text-xs px-2 py-0.5 rounded-full mt-2 inline-block ${getStatusClass(item.status)}">${escapeHtml(item.status)}</span>
                               ${item.createdAt?.toDate ? `<span class="text-xs text-muted dark:text-muted-dark ml-2">${formatGeneralDate(item.createdAt.toDate())}</span>` : ''}
                           </div>
                           <div class="flex-shrink-0 flex flex-col items-end space-y-1">
                               <button title="Delete Item" class="list-delete-btn p-1 -m-1 rounded-full btn-animated focus-visible:ring-1 focus-visible:ring-red-500" onclick="window.handleDeleteTrackerItem('${escapeHtml(subject)}', '${item.id}')">
                                   <i data-lucide="trash-2" class="h-4 w-4"></i>
                               </button>
                           </div>`;
                       trackerItemsList.appendChild(div);
                   });
                   safelyCreateIcons();
               }
           } catch (error) {
               console.error(`Error loading tracker items for ${subject}:`, error);
               trackerItemsList.innerHTML = createLoadingMessage(`Error loading items for ${subject}.`);
           }
       };
       const handleSaveTrackerItem = async () => {
           if (!currentUserId || !currentActiveSubject || !saveTrackerItemBtn || !db) return;
           validateTrackerForm();
           if (saveTrackerItemBtn.disabled) return;

           const description = trackerDescriptionInput.value.trim();
           const status = trackerStatusSelect.value;
           const newItem = { description, status, createdAt: serverTimestamp() };

           saveTrackerItemBtn.disabled = true;
           saveTrackerItemBtn.textContent = 'Adding...';

           try {
               await addDoc(getSubjectSpecificCollectionRef(currentUserId, 'trackerItems', currentActiveSubject), newItem);
               trackerDescriptionInput.value = '';
               trackerStatusSelect.value = 'To Review';
               if (addTrackerDetails) addTrackerDetails.open = false;
               displayTrackerItems(currentActiveSubject);
           } catch (error) {
               console.error("Error saving tracker item:", error);
               alert("Failed to save tracker item.");
           } finally {
               saveTrackerItemBtn.disabled = false;
               saveTrackerItemBtn.textContent = 'Add Item';
               validateTrackerForm();
           }
       };
       window.handleDeleteTrackerItem = async (subject, itemId) => {
           if (!currentUserId || !subject || !itemId || !db) return;
           if (!confirm(`Are you sure you want to delete this tracker item for ${subject}?`)) return;
           try {
               await deleteDoc(getSubjectSpecificDocRef(currentUserId, 'trackerItems', subject, itemId));
               console.log(`Tracker item ${itemId} deleted for ${subject}.`);
               if (currentActiveSubject === subject && getElement('tracker').classList.contains('active')) {
                   displayTrackerItems(subject);
               }
           } catch (error) {
               console.error("Error deleting tracker item:", error);
               alert("Failed to delete tracker item.");
           }
       };


      // --- PLANNER ---
      const loadPlanner = () => {
          if (!plannerDateInput || !plannerTimeInput || !plannerSubjectSelect || !plannerTopicInput || !savePlannerItemBtn || !plannerItemsList) return;
          populateSubjectDropdown(plannerSubjectSelect);
          displayPlannerItems();

          try {
              const now = new Date();
              const localISODate = new Date(now.getTime() - (now.getTimezoneOffset() * 60000)).toISOString().split('T')[0];
              plannerDateInput.value = localISODate;
              plannerTimeInput.value = now.toTimeString().substring(0, 5);
          } catch (e) { console.warn("Could not set default date/time for planner:", e); }
          validatePlannerForm();
      };
      const validatePlannerForm = () => {
          if (savePlannerItemBtn && plannerDateInput && plannerTimeInput && plannerSubjectSelect && plannerTopicInput) {
              savePlannerItemBtn.disabled = !plannerDateInput.value || !plannerTimeInput.value || !plannerSubjectSelect.value || !plannerTopicInput.value.trim();
          } else if (savePlannerItemBtn) {
              savePlannerItemBtn.disabled = true;
          }
      };
      const handleSavePlannerItem = async () => {
          if (!currentUserId || !db) return;
          validatePlannerForm();
          if (savePlannerItemBtn.disabled) return;

          const date = plannerDateInput.value;
          const time = plannerTimeInput.value;
          const subject = plannerSubjectSelect.value;
          const topic = plannerTopicInput.value.trim();
          let dateTimeString;

          try {
              const combined = new Date(`${date}T${time}:00`);
              if (isNaN(combined.getTime())) throw new Error("Invalid date/time combination");
              dateTimeString = combined.toISOString();
          } catch (e) { console.error("Invalid date/time format:", e); alert("Please enter a valid date and time."); return; }

          const newItem = { dateTime: dateTimeString, subject, topic, createdAt: serverTimestamp() };

          savePlannerItemBtn.disabled = true;
          savePlannerItemBtn.textContent = 'Scheduling...';

          try {
              await addDoc(getUserCollectionRef(currentUserId, 'plannerItems'), newItem);
              await displayPlannerItems();
              plannerSubjectSelect.value = '';
              plannerTopicInput.value = '';
              validatePlannerForm();
          } catch (e) {
              console.error("Error saving planner item:", e);
              alert("Failed to schedule session.");
          } finally {
              savePlannerItemBtn.disabled = false;
              savePlannerItemBtn.textContent = 'Schedule Session';
          }
      };
      const displayPlannerItems = async () => {
          if (!currentUserId || !plannerItemsList || !db) return;
          plannerItemsList.innerHTML = createLoadingMessage('Loading scheduled sessions...');
          try {
              const q = query(getUserCollectionRef(currentUserId, 'plannerItems'), orderBy("dateTime", "asc"));
              const snapshot = await getDocs(q);
              const items = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
              plannerItemsList.innerHTML = '';

              if (items.length === 0) {
                  plannerItemsList.innerHTML = createLoadingMessage('No sessions scheduled yet.');
              } else {
                  const groupedByDate = items.reduce((acc, item) => {
                      try {
                          const d = new Date(item.dateTime);
                          if (isNaN(d.getTime())) throw new Error("Invalid stored date");
                          const dateStr = d.toLocaleDateString('en-GB', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
                          if (!acc[dateStr]) acc[dateStr] = [];
                          acc[dateStr].push(item);
                      } catch (e) { console.warn("Skipping item with invalid date:", item.id, item.dateTime, e); }
                      return acc;
                  }, {});

                  const sortedDates = Object.keys(groupedByDate).sort((a, b) => {
                       try {
                           const parseDate = (str) => {
                               const parts = str.split(', ')[1].split(' ');
                               if (parts.length === 3) {
                                   const day = parseInt(parts[0]);
                                   const year = parseInt(parts[2]);
                                   const monthNames = ["January", "February", "March", "April", "May", "June", "July", "August", "September", "October", "November", "December"];
                                   const monthIndex = monthNames.indexOf(parts[1]);
                                   if (!isNaN(day) && !isNaN(year) && monthIndex !== -1) {
                                       return new Date(year, monthIndex, day);
                                   }
                               }
                               return new Date(NaN);
                           }
                           const dateA = parseDate(a);
                           const dateB = parseDate(b);
                           if (isNaN(dateA.getTime()) || isNaN(dateB.getTime())) return 0;
                           return dateA - dateB;
                       } catch { return 0; }
                  });

                  sortedDates.forEach(dateStr => {
                      const dateHeader = document.createElement('h4');
                      dateHeader.className = 'text-lg font-semibold mt-5 mb-2 text-text dark:text-text-dark border-b pb-1 dark:border-slate-600';
                      dateHeader.textContent = dateStr;
                      plannerItemsList.appendChild(dateHeader);

                      const list = document.createElement('ul');
                      list.className = 'space-y-3';
                      groupedByDate[dateStr].forEach((item, index) => {
                          const li = document.createElement('li');
                          li.className = `planner-item list-item flex justify-between items-center p-3 rounded-lg border-l-4 bg-card dark:bg-card-dark shadow-sm hover:bg-slate-50 dark:hover:bg-slate-700/60 transition-all duration-150 ${getSubjectColor(item.subject)} list-item-appear`;
                          li.style.animationDelay = `${index * 0.05}s`;
                          const formattedDateTime = item.dateTime ? formatPlannerDateTime(item.dateTime) : 'Invalid time';
                          const isPast = item.dateTime ? new Date(item.dateTime) < new Date() : false;
                          li.innerHTML = `
                              <div class="flex-grow mr-3 ${isPast ? 'opacity-60' : ''}">
                                  <p class="font-semibold text-sm text-text dark:text-text-dark">${escapeHtml(item.subject)}</p>
                                  <p class="text-xs text-muted dark:text-muted-dark mt-0.5">${escapeHtml(item.topic)}</p>
                                  <p class="text-xs text-primary dark:text-primary-dark font-medium mt-1.5">${formattedDateTime}</p>
                                  ${isPast ? '<span class="text-xs text-red-500 dark:text-red-400 ml-2">(Past)</span>' : ''}
                              </div>
                              <button title="Delete Session" class="list-delete-btn flex-shrink-0 p-1 -m-1 rounded-full btn-animated focus-visible:ring-1 focus-visible:ring-red-500" onclick="window.handleDeletePlannerItem('${item.id}')">
                                  <i data-lucide="trash-2" class="h-4 w-4"></i>
                              </button>`;
                          list.appendChild(li);
                      });
                      plannerItemsList.appendChild(list);
                  });
                  safelyCreateIcons();
              }
          } catch (error) {
              console.error("Error loading planner items:", error);
              plannerItemsList.innerHTML = createLoadingMessage('Error loading scheduled sessions.');
          }
      };
      window.handleDeletePlannerItem = async (itemId) => {
          if (!currentUserId || !itemId || !db) return;
          if (!confirm('Are you sure you want to delete this scheduled session?')) return;
          try {
              await deleteDoc(doc(db, `users/${currentUserId}/plannerItems/${itemId}`));
              console.log(`Planner item ${itemId} deleted.`);
              displayPlannerItems();
          } catch (error) {
              console.error("Error deleting planner item:", error);
              alert("Failed to delete session.");
          }
      };

      // --- QUIZ (Gamified) ---
      const loadQuizPage = () => {
          populateSubjectDropdown(quizSubjectSelect);
          if(quizContentWrapper) quizContentWrapper.classList.add('hidden');
          if(quizModeInterface) quizModeInterface.classList.add('hidden');
          if (addQuizDetails) addQuizDetails.style.display = 'none';
          validateQuizForm();
          toggleQuizButtons();
      };
      const validateQuizForm = () => {
          if (saveQuizQuestionBtn && quizQuestionInput && quizAnswerInput && currentActiveSubject) {
              saveQuizQuestionBtn.disabled = quizQuestionInput.value.trim() === '' || quizAnswerInput.value.trim() === '';
          } else if (saveQuizQuestionBtn) {
              saveQuizQuestionBtn.disabled = true;
          }
      };
      const toggleQuizButtons = async () => {
          if (!startQuizButton || !currentActiveSubject || !currentUserId || !db) {
              if (startQuizButton) startQuizButton.disabled = true;
              return;
          }
          try {
              const q = query(getSubjectSpecificCollectionRef(currentUserId, 'quizItems', currentActiveSubject), limit(1));
              const snapshot = await getDocs(q);
              startQuizButton.disabled = snapshot.empty;
          } catch (error) {
              console.error("Error checking for quiz questions:", error);
              startQuizButton.disabled = true;
          }
      };
      const displaySavedQuizQuestions = async (subject) => {
          if (!currentUserId || !quizItemsList || !db) return;
           quizItemsList.innerHTML = createLoadingMessage(`Loading ${subject} questions...`);
          try {
              const q = query(getSubjectSpecificCollectionRef(currentUserId, 'quizItems', subject), orderBy("createdAt", "desc"));
              const snapshot = await getDocs(q);
              const items = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
              quizItemsList.innerHTML = '';

              if (items.length === 0) {
                  quizItemsList.innerHTML = createLoadingMessage(`No questions saved for ${subject} yet.`);
              } else {
                  items.forEach((item, index) => {
                      const div = document.createElement('div');
                      div.className = `quiz-item list-item flex justify-between items-start p-3 rounded-lg border bg-white dark:bg-slate-800 shadow-sm space-x-3 hover:bg-slate-50 dark:hover:bg-slate-700/60 transition-all duration-150 ${getSubjectColor(subject).replace('border-l-4', 'border')} list-item-appear`;
                      div.style.animationDelay = `${index * 0.05}s`;
                      div.innerHTML = `
                          <div class="flex-grow text-sm overflow-hidden">
                              <p class="font-medium text-text dark:text-text-dark mb-1 truncate">Q: ${escapeHtml(item.question)}</p>
                              <p class="text-xs text-muted dark:text-muted-dark whitespace-pre-wrap break-words">A: ${escapeHtml(item.answer.substring(0, 100))}${item.answer.length > 100 ? '...' : ''}</p>
                          </div>
                          <button title="Delete Question" class="list-delete-btn flex-shrink-0 p-1 -m-1 rounded-full btn-animated focus-visible:ring-1 focus-visible:ring-red-500" onclick="window.handleDeleteQuizItem('${escapeHtml(subject)}', '${item.id}')">
                              <i data-lucide="trash-2" class="h-4 w-4"></i>
                          </button>`;
                      quizItemsList.appendChild(div);
                  });
                  safelyCreateIcons();
              }
              await toggleQuizButtons();
          } catch (error) {
              console.error(`Error loading quiz items for ${subject}:`, error);
              quizItemsList.innerHTML = createLoadingMessage(`Error loading questions for ${subject}.`);
              toggleQuizButtons();
          }
      };
      const handleSaveQuizQuestion = async () => {
          if (!currentUserId || !currentActiveSubject || !saveQuizQuestionBtn || !db) return;
          validateQuizForm();
          if (saveQuizQuestionBtn.disabled) return;

          const question = quizQuestionInput.value.trim();
          const answer = quizAnswerInput.value.trim();
          const newItem = { question, answer, createdAt: serverTimestamp() };

          saveQuizQuestionBtn.disabled = true;
          saveQuizQuestionBtn.textContent = 'Adding...';

          try {
              await addDoc(getSubjectSpecificCollectionRef(currentUserId, 'quizItems', currentActiveSubject), newItem);
              quizQuestionInput.value = '';
              quizAnswerInput.value = '';
              if (addQuizDetails) addQuizDetails.open = false;
              displaySavedQuizQuestions(currentActiveSubject);
          } catch (error) {
              console.error("Error saving quiz question:", error);
              alert("Failed to save question.");
          } finally {
              saveQuizQuestionBtn.disabled = false;
              saveQuizQuestionBtn.textContent = 'Add Question';
              validateQuizForm();
          }
      };
      window.handleDeleteQuizItem = async (subject, itemId) => {
          if (!currentUserId || !subject || !itemId || !db) return;
          if (!confirm(`Are you sure you want to delete this quiz question for ${subject}?`)) return;
          try {
              await deleteDoc(getSubjectSpecificDocRef(currentUserId, 'quizItems', subject, itemId));
              console.log(`Quiz item ${itemId} deleted for ${subject}.`);
              if (currentActiveSubject === subject && getElement('quiz').classList.contains('active')) {
                  displaySavedQuizQuestions(subject);
              }
          } catch (error) {
              console.error("Error deleting quiz item:", error);
              alert("Failed to delete question.");
          }
      };
      const startQuizMode = async () => {
          if (!currentUserId || !currentActiveSubject || !db) return;
          try {
              const snapshot = await getDocs(getSubjectSpecificCollectionRef(currentUserId, 'quizItems', currentActiveSubject));
              if (snapshot.empty) {
                  alert(`No questions found for ${currentActiveSubject} to start the quiz.`);
                  return;
              }
              const allQuestions = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
              quizState = {
                  active: true, currentSubject: currentActiveSubject, initialQuestions: [...allQuestions],
                  currentQuizPool: shuffleArray([...allQuestions]), incorrectlyAnswered: [],
                  currentQuestionIndex: 0, round: 1, totalMastered: 0, isAnswerVisible: false, buttonTimeout: null
              };
              console.log("Starting Quiz - Initial State:", quizState);

              if (addQuizDetails) addQuizDetails.style.display = 'none';
              if (quizListContainer) quizListContainer.classList.add('hidden');
              if (quizCompletionMessage) quizCompletionMessage.classList.add('hidden');
              if (quizModeInterface) quizModeInterface.classList.remove('hidden');
              if (stopQuizButton) stopQuizButton.textContent = "Stop Quiz";

              displayCurrentQuizQuestion();
          } catch (error) {
              console.error("Error starting quiz:", error);
              alert("Could not start the quiz due to an error.");
          }
      };
      const stopQuizMode = () => {
          if (!quizState.active) return;
          console.log("Stopping quiz mode.");
          quizState.active = false;
          if (quizModeInterface) quizModeInterface.classList.add('hidden');
          if (currentActiveSubject) {
              if (addQuizDetails) addQuizDetails.style.display = 'block';
              if (quizListContainer) quizListContainer.classList.remove('hidden');
          }
          if (quizCorrectAnswerDisplay) quizCorrectAnswerDisplay.style.display = 'none';
          quizState.isAnswerVisible = false;
          if (quizState.buttonTimeout) clearTimeout(quizState.buttonTimeout);
          quizState.buttonTimeout = null;

          toggleQuizButtons();
           quizState = { active: false, currentSubject: null, initialQuestions: [], currentQuizPool: [], incorrectlyAnswered: [], currentQuestionIndex: -1, round: 1, totalMastered: 0, isAnswerVisible: false, buttonTimeout: null };
      };
      const updateQuizProgressDisplay = () => {
          if (!quizProgress || !quizState.active) return;
          const remainingInPool = Math.max(0, quizState.currentQuizPool.length - quizState.currentQuestionIndex);
          const totalInitial = quizState.initialQuestions.length;
          quizProgress.textContent = `Round ${quizState.round} | Remaining: ${remainingInPool} | Mastered: ${quizState.totalMastered}/${totalInitial}`;
      };
      const displayCurrentQuizQuestion = () => {
           if (!quizState.active || !quizQuestionDisplay || !quizCorrectAnswerDisplay || !quizRevealBtnContainer || !quizJudgmentButtons) return;

           quizCorrectAnswerDisplay.style.display = 'none';
           quizState.isAnswerVisible = false;
           quizJudgmentButtons.style.display = 'none';
           quizRevealBtnContainer.style.display = 'block';
           quizCorrectBtn?.classList.remove('quiz-feedback-correct');
           quizIncorrectBtn?.classList.remove('quiz-feedback-incorrect');

           if (quizState.currentQuestionIndex >= quizState.currentQuizPool.length) {
               handleQuizRoundEnd();
               return;
           }

           const questionData = quizState.currentQuizPool[quizState.currentQuestionIndex];
           if (!questionData) {
                console.error("Error: Could not get question data at index", quizState.currentQuestionIndex);
                stopQuizMode();
                alert("An error occurred loading the next question.");
                return;
           }

           quizQuestionDisplay.innerHTML = `<p class="text-text dark:text-text-dark text-lg">${escapeHtml(questionData.question)}</p>`;
           quizCorrectAnswerDisplay.innerHTML = `<strong class="text-sm font-semibold text-primary dark:text-primary-dark mr-2">Answer:</strong><span class="whitespace-pre-wrap">${escapeHtml(questionData.answer)}</span>`;

           updateQuizProgressDisplay();

           if (quizCorrectBtn) quizCorrectBtn.disabled = true;
           if (quizIncorrectBtn) quizIncorrectBtn.disabled = true;

           safelyCreateIcons();
      };
      const revealQuizAnswer = () => {
          if (!quizState.active || !quizCorrectAnswerDisplay || !quizRevealBtnContainer || !quizJudgmentButtons) return;
          quizCorrectAnswerDisplay.style.display = 'block';
          quizRevealBtnContainer.style.display = 'none';
          quizJudgmentButtons.style.display = 'flex';
          quizState.isAnswerVisible = true;

          if (quizCorrectBtn) quizCorrectBtn.disabled = false;
          if (quizIncorrectBtn) quizIncorrectBtn.disabled = false;
      };
      const handleQuizAnswer = (isCorrect) => {
           if (!quizState.active || !quizState.isAnswerVisible || quizState.buttonTimeout) return;

           const currentQuestion = quizState.currentQuizPool[quizState.currentQuestionIndex];
           if (!currentQuestion) return;

           if (quizCorrectBtn) quizCorrectBtn.disabled = true;
           if (quizIncorrectBtn) quizIncorrectBtn.disabled = true;

           if (isCorrect) {
               console.log(`Question ${currentQuestion.id} marked CORRECT`);
               // Check if this question ID was previously marked incorrect in earlier rounds
               const wasIncorrectBefore = quizState.initialQuestions.find(q => q.id === currentQuestion.id && quizState.incorrectlyAnswered.some(iq => iq.id === q.id));
               if (!wasIncorrectBefore) { // Only count as mastered if it wasn't wrong before in this session
                   quizState.totalMastered++;
               }
               quizCorrectBtn?.classList.add('quiz-feedback-correct');
           } else {
               console.log(`Question ${currentQuestion.id} marked INCORRECT`);
                if (!quizState.incorrectlyAnswered.find(iq => iq.id === currentQuestion.id)) {
                   quizState.incorrectlyAnswered.push(currentQuestion);
                }
               quizIncorrectBtn?.classList.add('quiz-feedback-incorrect');
           }

           quizState.buttonTimeout = setTimeout(() => {
               quizState.buttonTimeout = null;
               quizState.currentQuestionIndex++;
               displayCurrentQuizQuestion();
           }, 800);
      };
      const handleQuizRoundEnd = () => {
           console.log(`Round ${quizState.round} ended. Incorrectly answered: ${quizState.incorrectlyAnswered.length}`);
           if (quizState.incorrectlyAnswered.length === 0) {
               console.log("Quiz Complete! All questions mastered.");
               if(quizCompletionMessage) {
                   quizCompletionMessage.textContent = `🎉 Well done! You've mastered all ${quizState.initialQuestions.length} questions for ${quizState.currentSubject}!`;
                   quizCompletionMessage.classList.remove('hidden');
               }
               if (quizQuestionDisplay) quizQuestionDisplay.innerHTML = '<p class="italic text-muted dark:text-muted-dark">Quiz complete!</p>';
               if (quizRevealBtnContainer) quizRevealBtnContainer.style.display = 'none';
               if (quizJudgmentButtons) quizJudgmentButtons.style.display = 'none';
               if (quizCorrectAnswerDisplay) quizCorrectAnswerDisplay.style.display = 'none';
               if (stopQuizButton) stopQuizButton.textContent = "Finish Session";
           } else {
               console.log(`Starting round ${quizState.round + 1} with ${quizState.incorrectlyAnswered.length} questions.`);
               quizState.round++;
               quizState.currentQuizPool = shuffleArray([...quizState.incorrectlyAnswered]);
               quizState.incorrectlyAnswered = [];
               quizState.currentQuestionIndex = 0;
               displayCurrentQuizQuestion();
           }
      };


      // --- *** Setup Global Event Listeners (Revised Structure) *** ---
      const setupGlobalEventListeners = () => {
          // *** ADD THIS CHECK ***
          if (eventListenersAttached) {
              console.log("Event listeners already attached. Skipping setup.");
              return;
          }
          console.log("Attaching global event listeners...");

          // Theme Toggle
          themeToggle?.addEventListener('click', toggleTheme);
          themeToggleMobile?.addEventListener('click', toggleTheme);

          // Authentication
          loginButton?.addEventListener('click', handleLogin);
          passwordInput?.addEventListener('keypress', (e) => { if (e.key === 'Enter') handleLogin(); });
          logoutButton?.addEventListener('click', handleLogout);
          logoutButtonMobile?.addEventListener('click', handleLogout);
          changePasswordButton?.addEventListener('click', handleChangePassword);

          // Mobile Menu
          mobileMenuButton?.addEventListener('click', openMobileMenu);
          mobileCloseButton?.addEventListener('click', closeMobileMenu);
          mobileOverlay?.addEventListener('click', closeMobileMenu);

          // Navigation Links (Desktop & Mobile)
          document.querySelectorAll('a.nav-link[data-page], a.mobile-nav-link[data-page]').forEach(link => {
              link.addEventListener('click', (e) => { e.preventDefault(); window.navigateToPage(e.currentTarget.dataset.page); });
          });

          // Dashboard Interactions (Event Delegation)
          getElement('dashboard')?.addEventListener('click', (e) => {
              const pomodoroBtn = e.target.closest('#start-pomodoro-dashboard-btn');
              const quickLink = e.target.closest('#quick-links-list a.quick-link');
              const examItem = e.target.closest('#upcoming-exams-list .upcoming-exam-item');
              if (pomodoroBtn) window.navigateToPage('pomodoro');
              else if (quickLink) { e.preventDefault(); window.navigateToPage(quickLink.dataset.page, quickLink.dataset.subject || null); }
              else if (examItem) window.navigateToPage(examItem.dataset.page, examItem.dataset.subject);
          });

          // Resources Page Interactions
          subjectTabsContainer?.addEventListener('click', (e) => {
              const tab = e.target.closest('.subject-tab');
              if (tab && tab.dataset.subject) handleSubjectSelection(tab.dataset.subject, 'resources');
          });
          resourceTypeSelect?.addEventListener('change', toggleResourceTypeFields);
          resourceTitleInput?.addEventListener('input', validateResourceForm);
          resourceUrlInput?.addEventListener('input', validateResourceForm);
          resourceNoteInput?.addEventListener('input', validateResourceForm);
          saveResourceBtn?.addEventListener('click', handleSaveResource);

          // Pomodoro Page Interactions
          startPauseButton?.addEventListener('click', () => { if (timerState === 'running') pauseTimer(); else startTimer(); });
          resetButton?.addEventListener('click', () => resetTimer());
          modeButtons.forEach(btn => {
              btn?.addEventListener('click', () => { const mode = btn.dataset.mode; if(mode && mode !== timerMode) setTimerMode(mode, true); });
          });
          workDurationInput?.addEventListener('change', () => handleDurationChange('work'));
          shortBreakDurationInput?.addEventListener('change', () => handleDurationChange('shortBreak'));
          longBreakDurationInput?.addEventListener('change', () => handleDurationChange('longBreak'));

          // Tracker Page Interactions
          trackerSubjectSelect?.addEventListener('change', (e) => handleSubjectSelection(e.target.value, 'tracker'));
          trackerDescriptionInput?.addEventListener('input', validateTrackerForm);
          saveTrackerItemBtn?.addEventListener('click', handleSaveTrackerItem);

          // Planner Page Interactions
          plannerDateInput?.addEventListener('input', validatePlannerForm);
          plannerTimeInput?.addEventListener('input', validatePlannerForm);
          plannerSubjectSelect?.addEventListener('change', validatePlannerForm);
          plannerTopicInput?.addEventListener('input', validatePlannerForm);
          savePlannerItemBtn?.addEventListener('click', handleSavePlannerItem);

          // Quiz Page Interactions
          quizSubjectSelect?.addEventListener('change', (e) => handleSubjectSelection(e.target.value, 'quiz'));
          quizQuestionInput?.addEventListener('input', validateQuizForm);
          quizAnswerInput?.addEventListener('input', validateQuizForm);
          saveQuizQuestionBtn?.addEventListener('click', handleSaveQuizQuestion);
          startQuizButton?.addEventListener('click', startQuizMode);
          stopQuizButton?.addEventListener('click', stopQuizMode);
          quizRevealAnswerBtn?.addEventListener('click', revealQuizAnswer);
          quizCorrectBtn?.addEventListener('click', () => handleQuizAnswer(true));
          quizIncorrectBtn?.addEventListener('click', () => handleQuizAnswer(false));

          // *** SET THE FLAG AFTER ATTACHING ***
          eventListenersAttached = true;
          console.log("Global event listeners attached.");
      }; // End of setupGlobalEventListeners


      // --- INITIALIZATION ---
      const initializeAppHub = () => {
          // Apply saved theme or default to light
          applyTheme(localStorage.getItem('theme') || 'light');

          // *** CALL LISTENER SETUP HERE ***
          // This ensures listeners for login, theme etc. are attached immediately
          setupGlobalEventListeners();

          // Firebase auth state listener (onAuthStateChanged) handles the rest of the startup flow
          console.log("App hub initialized, waiting for auth state...");
      };

      const initializePostLogin = (user) => {
          console.log(`Initializing post-login for user: ${user.uid}`);
          if (!db) {
              console.error("Database not ready during post-login initialization!");
              return;
          }

          if (currentYearEl) currentYearEl.textContent = new Date().getFullYear();
          if (countdownInterval) clearInterval(countdownInterval);
          if (pomodoroInterval) clearInterval(pomodoroInterval);
          countdownInterval = null;
          pomodoroInterval = null;

          try {
              loadTimetable();
              populateSubjectDropdown(getElement('pomodoro-subject'));
              populateSubjectDropdown(getElement('tracker-subject-select'));
              populateSubjectDropdown(getElement('planner-subject-select'));
              populateSubjectDropdown(getElement('quiz-subject-select'));
              setTimerMode('work', false);
              loadResources();
              loadTracker();
              loadPlanner();
              loadQuizPage();
              loadDashboard();

              // *** REMOVED REDUNDANT CALL ***
              // setupGlobalEventListeners(); // Listeners are already attached by initializeAppHub

              showPage('dashboard');
              countdownInterval = setInterval(updateTimetableCountdowns, 30000);
              safelyCreateIcons();
              console.log("Post-login initialization complete.");

          } catch (error) {
              console.error("Error during post-login initialization:", error);
              const dashboardPage = getElement('dashboard');
              if (dashboardPage) {
                   dashboardPage.innerHTML = createLoadingMessage('Error loading application data. Please refresh the page.');
                   showPage('dashboard');
              } else {
                  alert("A critical error occurred while loading the application. Please refresh.");
              }
          }
      };

      // --- Make essential functions globally accessible ---
      window.navigateToPage = _navigateToPage;
      // Delete functions are already assigned to window.

      // Start the application
      initializeAppHub();

    </script>

</body>
</html>
```
