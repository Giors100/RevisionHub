<!DOCTYPE html>
<html lang="en" class="light min-h-screen">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Giorgi's GCSE Revision Hub</title> <!-- Default Title -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest"></script>
    <script>
        // Tailwind Configuration (no changes needed here)
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    },
                    colors: {
                        primary: { light: '#4f46e5', DEFAULT: '#4f46e5', dark: '#6366f1' },
                        secondary: { light: '#059669', DEFAULT: '#059669', dark: '#10b981' },
                        background: { light: '#f8fafc', DEFAULT: '#f8fafc', dark: '#0f172a' },
                        card: { light: '#ffffff', DEFAULT: '#ffffff', dark: '#1e293b' },
                        text: { light: '#1e293b', DEFAULT: '#1e293b', dark: '#e2e8f0' },
                        muted: { light: '#64748b', DEFAULT: '#64748b', dark: '#94a3b8' },
                        status: {
                            review: 'bg-yellow-100 dark:bg-yellow-900/50 text-yellow-700 dark:text-yellow-300 border border-yellow-300 dark:border-yellow-700/50 font-medium',
                            progress: 'bg-blue-100 dark:bg-blue-900/50 text-blue-700 dark:text-blue-300 border border-blue-300 dark:border-blue-700/50 font-medium',
                            mastered: 'bg-green-100 dark:bg-green-900/50 text-green-700 dark:text-green-300 border border-green-300 dark:border-green-700/50 font-medium',
                        }
                    },
                    boxShadow: {
                        'widget': '0 4px 12px -1px rgb(0 0 0 / 0.07), 0 2px 8px -2px rgb(0 0 0 / 0.05)',
                        'widget-dark': '0 4px 12px -1px rgb(0 0 0 / 0.2), 0 2px 8px -2px rgb(0 0 0 / 0.15)',
                        'widget-hover': '0 10px 20px -3px rgb(0 0 0 / 0.1), 0 4px 8px -4px rgb(0 0 0 / 0.08)',
                        'widget-hover-dark': '0 10px 20px -3px rgb(0 0 0 / 0.3), 0 4px 8px -4px rgb(0 0 0 / 0.25)',
                    },
                    borderRadius: { 'xl': '0.75rem', 'lg': '0.5rem' },
                    transitionTimingFunction: { 'smooth': 'cubic-bezier(0.4, 0, 0.2, 1)', 'snap': 'cubic-bezier(0.165, 0.84, 0.44, 1)' }
                }
            }
        }
    </script>
    <style>
        /* Styles */
        :root {
             --ease-smooth: cubic-bezier(0.4, 0, 0.2, 1);
             --ease-snap: cubic-bezier(0.165, 0.84, 0.44, 1);
             --color-primary-DEFAULT: theme('colors.primary.DEFAULT');
             --color-primary-dark: theme('colors.primary.dark');
        }
        html { scroll-behavior: smooth; }
        button, a, input, textarea, select, div[role="button"], details summary {
            transition: background-color 0.2s ease-out, border-color 0.2s ease-out, color 0.2s ease-out, box-shadow 0.2s ease-out, opacity 0.2s ease-out, transform 0.15s ease-out;
            outline-offset: 2px;
        }
        *:focus-visible { outline: 2px solid var(--color-primary-DEFAULT); outline-offset: 3px; border-radius: 0.25rem; }
        .dark *:focus-visible { outline-color: var(--color-primary-dark); }
        input:focus-visible, select:focus-visible, textarea:focus-visible { border-color: var(--color-primary-DEFAULT) !important; outline-offset: 1px; }
        .dark input:focus-visible, .dark select:focus-visible, .dark textarea:focus-visible { border-color: var(--color-primary-dark) !important; }
        a:focus-visible, button:focus-visible { outline-offset: 2px; }
        .btn-animated { transform: scale(1); transition: transform 0.1s var(--ease-snap), background-color 0.15s var(--ease-smooth), box-shadow 0.1s var(--ease-smooth), filter 0.15s var(--ease-smooth); }
        .btn-animated:hover:not(:disabled) { filter: brightness(1.08); transform: scale(1.03); box-shadow: theme('boxShadow.md');}
        .btn-animated:active:not(:disabled) { transform: scale(0.96); filter: brightness(0.90); transition-duration: 0.05s; }
        a.nav-link:hover, a.mobile-nav-link:hover { transform: translateY(-1px); filter: brightness(1.1); }
        .dashboard-card { transition: transform 0.25s var(--ease-smooth), box-shadow 0.25s var(--ease-smooth); }
        .dashboard-card:hover { transform: translateY(-6px) scale(1.015); box-shadow: theme('boxShadow.widget-hover'); }
        .dark .dashboard-card:hover { box-shadow: theme('boxShadow.widget-hover-dark'); }
        .upcoming-exam-item { transition: transform 0.2s var(--ease-smooth), box-shadow 0.2s var(--ease-smooth), background-color 0.2s ease-out; }
        .upcoming-exam-item:hover { transform: scale(1.02); box-shadow: theme('boxShadow.widget-hover'); cursor: pointer; background-color: theme('colors.slate.50');}
        .dark .upcoming-exam-item:hover { box-shadow: theme('boxShadow.widget-hover-dark'); background-color: theme('colors.slate.800'); }
        .page { display: none; padding: 1rem; }
        @media (min-width: 768px) { .page { padding: 1.5rem; } }
        @media (min-width: 1024px) { .page { padding: 2rem; } }
        .page.active { display: block; animation: pageFadeIn 0.5s var(--ease-smooth); }
        @keyframes pageFadeIn { from { opacity: 0; transform: translateY(15px) scale(0.99); } to { opacity: 1; transform: translateY(0) scale(1); } }
        i[data-lucide] { width: 1em; height: 1em; display: inline-block; vertical-align: -0.125em; stroke-width: 2; }
        .timer-ring { stroke-dasharray: 283; stroke-dashoffset: 283; transition: stroke-dashoffset 1s linear; }
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background-color: #e2e8f0; border-radius: 9999px; }
        ::-webkit-scrollbar-thumb { background-color: rgba(165, 180, 252, 0.7); border-radius: 9999px; }
        ::-webkit-scrollbar-thumb:hover { background-color: rgba(129, 140, 248, 0.9); }
        .dark ::-webkit-scrollbar-track { background-color: #334155; }
        .dark ::-webkit-scrollbar-thumb { background-color: rgba(99, 102, 241, 0.6); }
        .dark ::-webkit-scrollbar-thumb:hover { background-color: rgba(79, 70, 229, 0.8); }
        #mobile-menu { transform: translateX(-100%); opacity: 0; transition: transform 0.35s var(--ease-smooth), opacity 0.3s ease-out; pointer-events: none; }
        #mobile-menu.open { transform: translateX(0); opacity: 1; pointer-events: auto; }
        #mobile-overlay { transition: opacity 0.35s var(--ease-smooth); opacity: 0; pointer-events: none; }
        #mobile-overlay.visible { opacity: 1; pointer-events: auto; }
        #timetable-body tr:nth-child(even) { background-color: theme('colors.slate.50 / 70%'); }
        #timetable-body tr:hover { background-color: theme('colors.slate.100'); }
        .dark #timetable-body tr:nth-child(even) { background-color: theme('colors.slate.800 / 50%'); }
        .dark #timetable-body tr:hover { background-color: theme('colors.slate.700 / 60%'); }
        .timetable-new-day td { border-top: 3px solid #cbd5e1 !important; padding-top: 1.25rem !important; }
        .dark .timetable-new-day td { border-top-color: #475569 !important; }
        .timetable-subject-cell { background-color: rgba(var(--subject-rgb), 0.08); position: relative; }
        .dark .timetable-subject-cell { background-color: rgba(var(--subject-rgb), 0.18); }
        #timetable-body td { padding-top: 1rem; padding-bottom: 1rem; vertical-align: middle; }
        .timetable-subject-text { font-weight: 600; }
        .list-item { transition: background-color 0.15s ease-out, transform 0.2s var(--ease-smooth), box-shadow 0.2s var(--ease-smooth); }
        .list-item:hover { background-color: #f1f5f9; transform: scale(1.01); box-shadow: 0 3px 6px rgba(0,0,0,0.06); }
        .dark .list-item:hover { background-color: #334155; box-shadow: 0 3px 6px rgba(0,0,0,0.2); }
        .list-delete-btn { color: #94a3b8; transition: color 0.15s ease-out, background-color 0.15s ease-out, transform 0.15s var(--ease-smooth); }
        .list-delete-btn:hover { color: #ef4444; background-color: #fee2e2; transform: scale(1.15) rotate(5deg); }
        .dark .list-delete-btn { color: #64748b; }
        .dark .list-delete-btn:hover { color: #f87171; background-color: #450a0a; }
        button:disabled, button[disabled] { opacity: 0.5; cursor: not-allowed; filter: grayscale(50%); transform: none !important; box-shadow: none !important; }
        #resource-url-wrapper, #resource-note-wrapper { display: none; }
        #resource-url-wrapper.visible, #resource-note-wrapper.visible { display: block; animation: contentFadeInShort 0.35s var(--ease-smooth); }
        @keyframes listItemFadeIn { from { opacity: 0; transform: translate(0, 10px) scale(0.98); } to { opacity: 1; transform: translate(0, 0) scale(1); } }
        .list-item-appear { animation: listItemFadeIn 0.4s var(--ease-smooth) backwards; }
        @keyframes contentFadeOut { to { opacity: 0; transform: scale(0.98); } }
        @keyframes contentFadeInShort { from { opacity: 0; transform: scale(0.98); } to { opacity: 1; transform: scale(1); } }
        .content-fade-out { animation: contentFadeOut 0.15s var(--ease-smooth) forwards; }
        .content-fade-in { animation: contentFadeInShort 0.3s var(--ease-smooth) 0.15s backwards; }
         details > summary { list-style: none; cursor: pointer; transition: background-color 0.2s ease-out; position: relative; padding-right: 2.5rem; }
        details > summary::-webkit-details-marker { display: none; }
        details > summary .summary-chevron { display: block; width: 0.5rem; height: 0.5rem; border-bottom: 2px solid currentColor; border-right: 2px solid currentColor; position: absolute; right: 1rem; top: 50%; transform: translateY(-70%) rotate(45deg); transition: transform 0.3s var(--ease-smooth); pointer-events: none; }
        details[open] > summary .summary-chevron { transform: translateY(-40%) rotate(225deg); }
        details[open] > summary { background-color: #f1f5f9; border-bottom: 1px solid #e2e8f0; border-bottom-left-radius: 0; border-bottom-right-radius: 0; }
        .dark details[open] > summary { background-color: #334155; border-bottom-color: #475569; }
        details > div {
            display: grid;
            grid-template-rows: 0fr;
            opacity: 0;
            transition: grid-template-rows 0.4s var(--ease-smooth), opacity 0.3s ease-out 0.1s;
        }
        details[open] > div {
            grid-template-rows: 1fr;
            opacity: 1;
        }
        details > div > div {
             overflow: hidden;
             padding: 1rem;
             border-top: 1px solid #e2e8f0;
        }
        .dark details > div > div { /* Applied dark style separately */
             border-top-color: #475569;
        }
         .subject-tab[aria-selected="true"] { color: var(--color-primary-DEFAULT); border-color: var(--color-primary-DEFAULT); font-weight: 600; background-color: transparent; }
        .dark .subject-tab[aria-selected="true"] { color: var(--color-primary-dark); border-color: var(--color-primary-dark); background-color: transparent; }
        /* Quiz Feedback Animations */
        .quiz-feedback-correct { animation: flashGreen 0.5s ease-out; }
        .quiz-feedback-incorrect { animation: shakeHorizontal 0.4s ease-in-out; }
        .pomodoro-mode-btn.shake-horizontal { animation: shakeHorizontal 0.4s ease-in-out; } /* Reuse shake for mode buttons */
        @keyframes flashGreen { 0%, 100% { background-color: transparent; } 50% { background-color: rgba(74, 222, 128, 0.3); } }
        @keyframes shakeHorizontal { 0%, 100% { transform: translateX(0); } 25%, 75% { transform: translateX(-6px); } 50% { transform: translateX(6px); } }
        #quiz-correct-answer-display { display: none; }
        #quiz-correct-answer-display.visible { display: block; animation: contentFadeInShort 0.3s var(--ease-smooth); }
        /* Style for small previews in the LIST view */
        .quiz-file-preview {
            max-width: 80px;
            max-height: 60px;
            margin-top: 4px;
            border-radius: 4px;
            border: 1px solid #e2e8f0;
            object-fit: cover;
            vertical-align: middle; /* Align better with text */
        }
        .dark .quiz-file-preview { border-color: #475569; }
        /* NEW STYLE: For large previews in the active QUIZ MODE */
        .quiz-mode-image-display {
            display: block; /* Make it a block element */
            max-width: 90%; /* Allow it to take most of the width */
            max-height: 400px; /* Limit vertical height */
            height: auto; /* Maintain aspect ratio */
            margin: 1rem auto; /* Center the image */
            border-radius: 0.5rem; /* Slightly larger radius */
            border: 1px solid #e2e8f0;
            object-fit: contain; /* Show the whole image */
        }
        .dark .quiz-mode-image-display { border-color: #475569; }

        .analytics-item { border-left: 3px solid; padding-left: 0.75rem; }
        .pomodoro-mode-btn.active {
            background-color: theme('colors.primary.DEFAULT');
            color: white;
            border-color: theme('colors.primary.DEFAULT');
        }
        .dark .pomodoro-mode-btn.active {
             background-color: theme('colors.primary.dark');
             border-color: theme('colors.primary.dark');
             color: theme('colors.text.dark'); /* Ensure contrast in dark mode */
        }
        /* Style disabled mode buttons distinctly */
        .pomodoro-mode-btn:disabled {
             opacity: 0.6;
             cursor: not-allowed;
             background-color: theme('colors.slate.200');
             border-color: theme('colors.slate.300');
             color: theme('colors.slate.500');
             transform: none !important; /* Override btn-animated transforms */
             filter: none !important; /* Override btn-animated filters */
             box-shadow: none !important;
        }
       .dark .pomodoro-mode-btn:disabled {
            background-color: theme('colors.slate.600');
            border-color: theme('colors.slate.500');
            color: theme('colors.slate.400');
       }
       /* NEW: Pomodoro Subject Times List Styling */
       #pomodoro-subject-times .subject-time-item { border-left: 3px solid; padding-left: 0.75rem; }

    </style>
</head>
<body class="flex flex-col min-h-screen bg-background text-text font-sans transition-colors duration-300 dark:bg-background-dark">
    <!-- Login Overlay -->
    <div id="login-overlay" class="fixed inset-0 bg-background dark:bg-background-dark flex items-center justify-center p-4 transition-opacity duration-300 z-[100]">
        <div class="bg-card text-text rounded-xl shadow-widget p-6 md:p-8 dark:bg-card-dark dark:text-text-dark dark:shadow-widget-dark transition-all duration-300 max-w-sm w-full">
            <h2 class="text-2xl font-semibold mb-4 text-center text-primary dark:text-primary-dark">Revision Hub Login</h2>
            <p class="text-muted dark:text-muted-dark text-sm mb-1 text-center">Welcome back, Giorgi!</p>
            <p class="text-xs text-muted dark:text-muted-dark mb-6 text-center">(Use your Firebase credentials)</p>
            <div class="mb-4">
                <label for="email-input" class="block text-sm font-medium text-muted dark:text-muted-dark mb-1">Email</label>
                <input type="email" id="email-input" placeholder="your.email@example.com" class="w-full p-2 border rounded-lg bg-background dark:bg-slate-700 border-slate-300 dark:border-slate-600 focus:ring-primary focus:border-primary transition duration-150 ease-in-out">
            </div>
            <div class="mb-6">
                <label for="password-input" class="block text-sm font-medium text-muted dark:text-muted-dark mb-1">Password</label>
                <input type="password" id="password-input" placeholder="••••••••" class="w-full p-2 border rounded-lg bg-background dark:bg-slate-700 border-slate-300 dark:border-slate-600 focus:ring-primary focus:border-primary transition duration-150 ease-in-out">
            </div>
            <button id="login-button" class="w-full bg-primary hover:bg-primary/90 dark:bg-primary-dark dark:hover:bg-primary-dark/90 text-white font-semibold py-2.5 px-4 rounded-lg btn-animated shadow-sm focus-visible:ring-2 focus-visible:ring-offset-2 focus-visible:ring-primary">Login</button>
            <p id="login-error" class="text-red-500 text-sm mt-3 text-center hidden h-4"></p>
        </div>
    </div>

    <!-- Main App Wrapper (hidden initially) -->
    <div id="app-wrapper" class="hidden flex flex-col min-h-screen">
        <!-- Header -->
        <header class="sticky top-0 z-50 bg-card dark:bg-card-dark shadow-md dark:shadow-slate-700/50 transition-colors duration-300">
            <nav class="container mx-auto px-4 py-3 flex justify-between items-center">
                 <a href="#" data-page="dashboard" class="nav-link text-xl md:text-2xl font-bold text-primary dark:text-primary-dark flex items-center space-x-2 btn-animated rounded-md p-1 -m-1 focus-visible:outline focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-primary"> <i data-lucide="graduation-cap" class="h-6 w-6"></i> <span>Giorgi's Hub</span> </a>
                <!-- Desktop Nav -->
                <div class="hidden md:flex items-center space-x-1 lg:space-x-2">
                    <a href="#" data-page="dashboard" class="nav-link px-3 py-1.5 rounded-md text-muted dark:text-muted-dark hover:text-primary dark:hover:text-primary-dark hover:bg-slate-100 dark:hover:bg-slate-700 font-medium text-sm focus-visible:ring-2 focus-visible:ring-primary">Dashboard</a>
                     <a href="#" data-page="timetable" class="nav-link px-3 py-1.5 rounded-md text-muted dark:text-muted-dark hover:text-primary dark:hover:text-primary-dark hover:bg-slate-100 dark:hover:bg-slate-700 font-medium text-sm focus-visible:ring-2 focus-visible:ring-primary">Timetable</a>
                     <a href="#" data-page="resources" class="nav-link px-3 py-1.5 rounded-md text-muted dark:text-muted-dark hover:text-primary dark:hover:text-primary-dark hover:bg-slate-100 dark:hover:bg-slate-700 font-medium text-sm focus-visible:ring-2 focus-visible:ring-primary">Resources</a>
                     <a href="#" data-page="pomodoro" class="nav-link px-3 py-1.5 rounded-md text-muted dark:text-muted-dark hover:text-primary dark:hover:text-primary-dark hover:bg-slate-100 dark:hover:bg-slate-700 font-medium text-sm focus-visible:ring-2 focus-visible:ring-primary">Pomodoro</a>
                     <a href="#" data-page="tracker" class="nav-link px-3 py-1.5 rounded-md text-muted dark:text-muted-dark hover:text-primary dark:hover:text-primary-dark hover:bg-slate-100 dark:hover:bg-slate-700 font-medium text-sm focus-visible:ring-2 focus-visible:ring-primary">Tracker</a>
                     <a href="#" data-page="planner" class="nav-link px-3 py-1.5 rounded-md text-muted dark:text-muted-dark hover:text-primary dark:hover:text-primary-dark hover:bg-slate-100 dark:hover:bg-slate-700 font-medium text-sm focus-visible:ring-2 focus-visible:ring-primary">Planner</a>
                     <a href="#" data-page="quiz" class="nav-link px-3 py-1.5 rounded-md text-muted dark:text-muted-dark hover:text-primary dark:hover:text-primary-dark hover:bg-slate-100 dark:hover:bg-slate-700 font-medium text-sm focus-visible:ring-2 focus-visible:ring-primary">Quiz</a>
                    <button id="theme-toggle" title="Toggle Theme" class="p-2 rounded-full text-muted dark:text-muted-dark hover:bg-slate-100 dark:hover:bg-slate-700 focus:outline-none focus-visible:ring-2 focus-visible:ring-offset-2 focus-visible:ring-primary dark:focus-visible:ring-offset-slate-800 btn-animated"> <i data-lucide="sun" id="theme-icon-light" class="h-5 w-5"></i> <i data-lucide="moon" id="theme-icon-dark" class="h-5 w-5 hidden"></i> </button>
                    <button id="logout-button" title="Logout" class="p-2 rounded-full text-muted dark:text-muted-dark hover:bg-red-100 dark:hover:bg-red-900/50 hover:text-red-600 dark:hover:text-red-400 focus:outline-none focus-visible:ring-2 focus-visible:ring-offset-2 focus-visible:ring-red-500 dark:focus-visible:ring-offset-slate-800 btn-animated"> <i data-lucide="log-out" class="h-5 w-5"></i> </button>
                </div>
                <!-- Mobile Nav Toggle -->
                <div class="md:hidden flex items-center">
                     <button id="theme-toggle-mobile" title="Toggle Theme" class="p-2 mr-2 rounded-full text-muted dark:text-muted-dark hover:bg-slate-100 dark:hover:bg-slate-700 focus:outline-none focus-visible:ring-2 focus-visible:ring-offset-2 focus-visible:ring-primary dark:focus-visible:ring-offset-slate-800 btn-animated"> <i data-lucide="sun" id="theme-icon-light-mobile" class="h-5 w-5"></i> <i data-lucide="moon" id="theme-icon-dark-mobile" class="h-5 w-5 hidden"></i> </button>
                    <button id="mobile-menu-button" title="Open Menu" class="p-2 rounded-md text-muted dark:text-muted-dark hover:text-primary dark:hover:text-primary-dark hover:bg-slate-100 dark:hover:bg-slate-700 focus:outline-none focus-visible:ring-2 focus-visible:ring-inset focus-visible:ring-primary btn-animated"> <span class="sr-only">Open main menu</span> <i data-lucide="menu" class="h-6 w-6"></i> </button>
                </div>
            </nav>
            <!-- Mobile Menu Overlay -->
            <div id="mobile-overlay" class="fixed inset-0 bg-black/60 dark:bg-black/80 z-[55] hidden md:hidden"></div>
             <!-- Mobile Menu Panel -->
             <div id="mobile-menu" class="md:hidden fixed inset-y-0 left-0 w-64 bg-card dark:bg-card-dark shadow-xl z-[60] p-4 border-r border-slate-200 dark:border-slate-700"> <div class="flex justify-between items-center mb-6"> <a href="#" data-page="dashboard" class="nav-link text-lg font-bold text-primary dark:text-primary-dark flex items-center space-x-2 focus-visible:outline focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-primary rounded"> <i data-lucide="graduation-cap" class="h-5 w-5"></i> <span>Giorgi's Hub</span> </a> <button id="mobile-close-button" title="Close Menu" class="p-1 rounded-md text-muted dark:text-muted-dark hover:text-primary dark:hover:text-primary-dark hover:bg-slate-100 dark:hover:bg-slate-700 btn-animated focus-visible:ring-2 focus-visible:ring-primary"> <i data-lucide="x" class="h-5 w-5"></i> </button> </div> <nav class="flex flex-col space-y-1"> <a href="#" data-page="dashboard" class="mobile-nav-link block px-3 py-2 rounded-md text-base font-medium text-muted dark:text-muted-dark hover:bg-slate-100 dark:hover:bg-slate-700 hover:text-primary dark:hover:text-primary-dark focus-visible:ring-2 focus-visible:ring-primary">Dashboard</a> <a href="#" data-page="timetable" class="mobile-nav-link block px-3 py-2 rounded-md text-base font-medium text-muted dark:text-muted-dark hover:bg-slate-100 dark:hover:bg-slate-700 hover:text-primary dark:hover:text-primary-dark focus-visible:ring-2 focus-visible:ring-primary">Timetable</a> <a href="#" data-page="resources" class="mobile-nav-link block px-3 py-2 rounded-md text-base font-medium text-muted dark:text-muted-dark hover:bg-slate-100 dark:hover:bg-slate-700 hover:text-primary dark:hover:text-primary-dark focus-visible:ring-2 focus-visible:ring-primary">Resources</a> <a href="#" data-page="pomodoro" class="mobile-nav-link block px-3 py-2 rounded-md text-base font-medium text-muted dark:text-muted-dark hover:bg-slate-100 dark:hover:bg-slate-700 hover:text-primary dark:hover:text-primary-dark focus-visible:ring-2 focus-visible:ring-primary">Pomodoro</a> <a href="#" data-page="tracker" class="mobile-nav-link block px-3 py-2 rounded-md text-base font-medium text-muted dark:text-muted-dark hover:bg-slate-100 dark:hover:bg-slate-700 hover:text-primary dark:hover:text-primary-dark focus-visible:ring-2 focus-visible:ring-primary">Tracker</a> <a href="#" data-page="planner" class="mobile-nav-link block px-3 py-2 rounded-md text-base font-medium text-muted dark:text-muted-dark hover:bg-slate-100 dark:hover:bg-slate-700 hover:text-primary dark:hover:text-primary-dark focus-visible:ring-2 focus-visible:ring-primary">Planner</a> <a href="#" data-page="quiz" class="mobile-nav-link block px-3 py-2 rounded-md text-base font-medium text-muted dark:text-muted-dark hover:bg-slate-100 dark:hover:bg-slate-700 hover:text-primary dark:hover:text-primary-dark focus-visible:ring-2 focus-visible:ring-primary">Quiz</a> <hr class="my-3 border-slate-200 dark:border-slate-700"> <button id="logout-button-mobile" class="w-full text-left block px-3 py-2 rounded-md text-base font-medium text-red-600 dark:text-red-400 hover:bg-red-100 dark:hover:bg-red-900/50 btn-animated flex items-center space-x-2 focus-visible:ring-2 focus-visible:ring-red-500"> <i data-lucide="log-out" class="h-4 w-4"></i> <span>Logout</span> </button> </nav> </div>
        </header>

        <!-- Main Content Area -->
        <main class="flex-grow container mx-auto py-6 bg-background dark:bg-background-dark transition-colors duration-300">
            <!-- Dashboard Page -->
            <section id="dashboard" class="page active">
                 <h1 class="text-2xl md:text-3xl font-bold mb-1 text-text dark:text-text-dark">Welcome, Giorgi!</h1>
                 <p class="text-muted dark:text-muted-dark mb-6 text-sm">Candidate Number: 7590</p>
                 <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                    <!-- Upcoming Exams -->
                    <div class="dashboard-card bg-card text-text rounded-xl shadow-widget p-4 md:p-6 dark:bg-card-dark dark:text-text-dark dark:shadow-widget-dark md:col-span-2 lg:col-span-2">
                        <h2 class="text-xl font-semibold mb-4 flex items-center space-x-2"> <i data-lucide="calendar-clock" class="h-5 w-5 text-primary dark:text-primary-dark"></i> <span>Upcoming Exams</span> </h2>
                        <div id="upcoming-exams-list" class="space-y-3 text-sm min-h-[60px]"></div>
                    </div>
                     <!-- Study Analytics -->
                     <div class="dashboard-card bg-card text-text rounded-xl shadow-widget p-4 md:p-6 dark:bg-card-dark dark:text-text-dark dark:shadow-widget-dark">
                        <h2 class="text-xl font-semibold mb-4 flex items-center space-x-2"> <i data-lucide="bar-chart-3" class="h-5 w-5 text-cyan-500"></i> <span>Study Time Analytics</span> </h2>
                        <div id="pomodoro-analytics" class="space-y-3 text-sm min-h-[60px]"></div>
                    </div>
                    <!-- Recent Sessions & Pomodoro Start -->
                    <div class="dashboard-card bg-card text-text rounded-xl shadow-widget p-4 md:p-6 dark:bg-card-dark dark:text-text-dark dark:shadow-widget-dark">
                        <h2 class="text-xl font-semibold mb-4 flex items-center space-x-2"> <i data-lucide="timer" class="h-5 w-5 text-secondary dark:text-secondary-dark"></i> <span>Recent Study Sessions</span> </h2>
                        <div id="pomodoro-summary" class="space-y-2 text-sm min-h-[60px]"></div>
                        <button id="start-pomodoro-dashboard-btn" class="mt-4 w-full bg-secondary hover:bg-secondary/90 dark:bg-secondary-dark dark:hover:bg-secondary-dark/90 text-white font-semibold py-2 px-4 rounded-lg flex items-center justify-center space-x-2 btn-animated shadow-sm focus-visible:ring-2 focus-visible:ring-offset-2 focus-visible:ring-secondary"> <i data-lucide="play-circle" class="h-5 w-5"></i> <span>Start Pomodoro</span> </button>
                    </div>
                    <!-- Quick Links -->
                    <div class="dashboard-card bg-card text-text rounded-xl shadow-widget p-4 md:p-6 dark:bg-card-dark dark:text-text-dark dark:shadow-widget-dark">
                        <h2 class="text-xl font-semibold mb-4 flex items-center space-x-2"> <i data-lucide="link" class="h-5 w-5 text-blue-500"></i> <span>Quick Links</span> </h2>
                        <div id="quick-links-list" class="space-y-2 text-sm">
                            <a href="#" data-page="resources" data-subject="Computer Science" class="quick-link block text-primary dark:text-primary-dark hover:underline font-medium focus-visible:ring-1 focus-visible:ring-primary rounded -ml-1 pl-1 btn-animated">Computer Science Resources</a>
                            <a href="#" data-page="resources" data-subject="Mathematics" class="quick-link block text-primary dark:text-primary-dark hover:underline font-medium focus-visible:ring-1 focus-visible:ring-primary rounded -ml-1 pl-1 btn-animated">Maths Notes</a>
                            <a href="#" data-page="timetable" class="quick-link block text-primary dark:text-primary-dark hover:underline font-medium focus-visible:ring-1 focus-visible:ring-primary rounded -ml-1 pl-1 btn-animated">Full Timetable</a>
                            <a href="#" data-page="planner" class="quick-link block text-primary dark:text-primary-dark hover:underline font-medium focus-visible:ring-1 focus-visible:ring-primary rounded -ml-1 pl-1 btn-animated">Revision Planner</a>
                        </div>
                    </div>
                     <!-- Motivation -->
                     <div class="dashboard-card bg-card text-text rounded-xl shadow-widget p-4 md:p-6 dark:bg-card-dark dark:text-text-dark dark:shadow-widget-dark">
                        <h2 class="text-xl font-semibold mb-4 flex items-center space-x-2"> <i data-lucide="quote" class="h-5 w-5 text-purple-500"></i> <span>Daily Motivation</span> </h2>
                        <blockquote id="motivational-quote" class="text-muted dark:text-muted-dark italic border-l-4 border-purple-300 dark:border-purple-600 pl-4 py-1 min-h-[40px]"> Loading quote... </blockquote>
                    </div>
                    <!-- Account Settings / Change Password -->
                    <div class="bg-card text-text rounded-xl shadow-widget p-4 md:p-6 dark:bg-card-dark dark:text-text-dark dark:shadow-widget-dark md:col-span-2 lg:col-span-3">
                        <h2 class="text-xl font-semibold mb-4 flex items-center space-x-2"> <i data-lucide="key-round" class="h-5 w-5 text-gray-500"></i> <span>Account Settings</span> </h2>
                        <div id="change-password-form">
                            <p class="text-sm text-muted dark:text-muted-dark mb-3">Change your login password.</p>
                            <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4 items-end">
                                <div> <label for="current-password" class="block text-xs font-medium text-muted dark:text-muted-dark mb-1">Current Password:</label> <input type="password" id="current-password" class="w-full p-2 border border-slate-300 dark:border-slate-600 rounded-lg text-sm bg-background dark:bg-slate-700 focus:ring-primary focus:border-primary"> </div>
                                <div> <label for="new-password" class="block text-xs font-medium text-muted dark:text-muted-dark mb-1">New Password:</label> <input type="password" id="new-password" class="w-full p-2 border border-slate-300 dark:border-slate-600 rounded-lg text-sm bg-background dark:bg-slate-700 focus:ring-primary focus:border-primary"> </div>
                                <button id="change-password-button" class="bg-slate-500 hover:bg-slate-600 dark:bg-slate-600 dark:hover:bg-slate-500 text-white font-semibold py-2 px-4 rounded-lg h-10 btn-animated shadow-sm self-end w-full sm:w-auto focus-visible:ring-2 focus-visible:ring-offset-2 focus-visible:ring-slate-500">Change Password</button>
                            </div>
                            <p id="change-password-message" class="text-sm mt-2 h-4"></p>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Timetable Page -->
            <section id="timetable" class="page">
                <h1 class="text-2xl md:text-3xl font-bold mb-6 text-text dark:text-text-dark">Exam Timetable</h1>
                <div class="bg-card text-text rounded-xl shadow-widget dark:bg-card-dark dark:text-text-dark dark:shadow-widget-dark transition-all duration-300 overflow-x-auto">
                    <table class="min-w-full divide-y divide-slate-200 dark:divide-slate-700">
                        <thead class="bg-slate-50 dark:bg-slate-700/50">
                            <tr>
                                <th scope="col" class="pl-4 pr-3 py-3.5 text-left text-xs font-semibold text-muted dark:text-muted-dark uppercase tracking-wider">Subject & Paper</th>
                                <th scope="col" class="px-3 py-3.5 text-left text-xs font-semibold text-muted dark:text-muted-dark uppercase tracking-wider">Date & Time</th>
                                <th scope="col" class="px-3 py-3.5 text-left text-xs font-semibold text-muted dark:text-muted-dark uppercase tracking-wider">Duration</th>
                                <th scope="col" class="px-3 py-3.5 text-left text-xs font-semibold text-muted dark:text-muted-dark uppercase tracking-wider">Board/Tier</th>
                                <th scope="col" class="px-3 py-3.5 text-left text-xs font-semibold text-muted dark:text-muted-dark uppercase tracking-wider">Location & Seat</th>
                                <th scope="col" class="pl-3 pr-4 py-3.5 text-left text-xs font-semibold text-muted dark:text-muted-dark uppercase tracking-wider">Countdown</th>
                            </tr>
                        </thead>
                        <tbody id="timetable-body" class="divide-y divide-slate-200 dark:divide-slate-700"></tbody>
                    </table>
                </div>
            </section>

            <!-- Resources Page -->
            <section id="resources" class="page">
                 <h1 class="text-2xl md:text-3xl font-bold mb-6 text-text dark:text-text-dark">Revision Resources</h1>
                <div class="bg-card text-text rounded-xl shadow-widget p-4 md:p-6 dark:bg-card-dark dark:text-text-dark dark:shadow-widget-dark transition-all duration-300">
                    <h2 class="text-xl font-semibold mb-4">Manage Your Resources</h2>
                    <p class="text-muted dark:text-muted-dark mb-5">Select a subject to view, add, or manage links and notes.</p>
                    <!-- Subject Tabs -->
                    <div class="mb-5 border-b border-slate-200 dark:border-slate-700">
                        <nav id="subject-tabs" class="flex space-x-4 overflow-x-auto pb-px" aria-label="Tabs"></nav>
                    </div>
                    <!-- Add Resource Form (hidden until subject selected) -->
                    <details id="add-resource-details" class="mb-6 border border-slate-200 dark:border-slate-700 rounded-lg overflow-hidden bg-slate-50 dark:bg-slate-800/50" style="display: none;">
                        <summary class="p-3 font-medium text-primary dark:text-primary-dark hover:bg-slate-100 dark:hover:bg-slate-700/50 flex items-center justify-between focus-visible:ring-1 focus-visible:ring-primary cursor-pointer"> <span>Add New Resource</span> <span class="summary-chevron"></span> </summary>
                        <div> <div id="add-resource-form" class="p-4 grid grid-cols-1 md:grid-cols-3 gap-4">
                            <div> <label for="resource-type" class="block text-sm font-medium text-muted dark:text-muted-dark mb-1">Type:</label> <select id="resource-type" class="w-full p-2 border border-slate-300 dark:border-slate-600 rounded-lg bg-background dark:bg-slate-700 focus:ring-primary focus:border-primary"> <option value="link">Link</option> <option value="note">Note</option> </select> </div>
                            <div class="md:col-span-2"> <label for="resource-title" class="block text-sm font-medium text-muted dark:text-muted-dark mb-1">Title:</label> <input type="text" id="resource-title" placeholder="e.g., Algebra Video" class="w-full p-2 border border-slate-300 dark:border-slate-600 rounded-lg bg-background dark:bg-slate-700 focus:ring-primary focus:border-primary"> </div>
                            <div id="resource-url-wrapper" class="md:col-span-3"> <label for="resource-url" class="block text-sm font-medium text-muted dark:text-muted-dark mb-1">URL:</label> <input type="url" id="resource-url" placeholder="https://example.com" class="w-full p-2 border border-slate-300 dark:border-slate-600 rounded-lg bg-background dark:bg-slate-700 focus:ring-primary focus:border-primary"> </div>
                            <div id="resource-note-wrapper" class="md:col-span-3"> <label for="resource-note" class="block text-sm font-medium text-muted dark:text-muted-dark mb-1">Note:</label> <textarea id="resource-note" placeholder="Enter notes..." rows="5" class="w-full p-2 border border-slate-300 dark:border-slate-600 rounded-lg bg-background dark:bg-slate-700 focus:ring-primary focus:border-primary"></textarea> </div>
                            <div class="md:col-span-3"> <button id="save-resource-btn" class="mt-2 bg-primary hover:bg-primary/90 dark:bg-primary-dark dark:hover:bg-primary-dark/90 text-white font-semibold py-2 px-5 rounded-lg btn-animated shadow-sm disabled:opacity-50 focus-visible:ring-2 focus-visible:ring-offset-2 focus-visible:ring-primary">Add Resource</button> </div>
                        </div></div>
                    </details>
                    <!-- Resource List -->
                    <div id="resource-content" class="mt-4 min-h-[150px]"></div>
                </div>
            </section>

            <!-- Pomodoro Page -->
            <section id="pomodoro" class="page">
                 <h1 class="text-2xl md:text-3xl font-bold mb-6 text-text dark:text-text-dark">Pomodoro Timer</h1>
                <div class="bg-card text-text rounded-xl shadow-widget p-5 md:p-8 dark:bg-card-dark dark:text-text-dark dark:shadow-widget-dark transition-all duration-300 max-w-lg mx-auto flex flex-col items-center">
                    <h2 id="pomodoro-mode-title" class="text-2xl font-semibold mb-5 text-center">Focus Session</h2>
                    <!-- Subject Selection for Work Mode -->
                    <div id="pomodoro-subject-wrapper" class="mb-6 w-full max-w-xs mx-auto" style="display: block;"> <label for="pomodoro-subject" class="block text-sm font-medium text-muted dark:text-muted-dark mb-1 text-center">Subject (for Focus Session)</label> <select id="pomodoro-subject" class="w-full p-2 border border-slate-300 dark:border-slate-600 rounded-lg bg-background dark:bg-slate-700 focus:ring-primary focus:border-primary text-sm"> <option value="">-- Select Subject --</option> </select> </div>
                    <!-- Mode Buttons -->
                    <div class="flex justify-center space-x-3 mb-8"> <button id="work-mode-button" class="pomodoro-mode-btn text-sm font-medium py-1.5 px-4 rounded-full border border-slate-300 dark:border-slate-600 text-muted dark:text-muted-dark hover:bg-slate-100 dark:hover:bg-slate-700 btn-animated flex items-center space-x-1.5 active focus-visible:ring-2 focus-visible:ring-primary" data-mode="work"> <i data-lucide="briefcase" class="h-4 w-4"></i> <span>Work</span> </button> <button id="short-break-mode-button" class="pomodoro-mode-btn text-sm font-medium py-1.5 px-4 rounded-full border border-slate-300 dark:border-slate-600 text-muted dark:text-muted-dark hover:bg-slate-100 dark:hover:bg-slate-700 btn-animated flex items-center space-x-1.5 focus-visible:ring-2 focus-visible:ring-primary" data-mode="shortBreak"> <i data-lucide="coffee" class="h-4 w-4"></i> <span>Short Break</span> </button> <button id="long-break-mode-button" class="pomodoro-mode-btn text-sm font-medium py-1.5 px-4 rounded-full border border-slate-300 dark:border-slate-600 text-muted dark:text-muted-dark hover:bg-slate-100 dark:hover:bg-slate-700 btn-animated flex items-center space-x-1.5 focus-visible:ring-2 focus-visible:ring-primary" data-mode="longBreak"> <i data-lucide="bed" class="h-4 w-4"></i> <span>Long Break</span> </button> </div>
                    <!-- Timer Display -->
                    <div class="relative w-52 h-52 mx-auto mb-8"> <svg class="w-full h-full" viewBox="0 0 100 100"> <circle class="text-slate-200 dark:text-slate-700" stroke-width="8" stroke="currentColor" fill="transparent" r="45" cx="50" cy="50"/> <circle id="timer-progress-ring" class="text-primary dark:text-primary-dark timer-ring" stroke-width="8" stroke-linecap="round" stroke="currentColor" fill="transparent" r="45" cx="50" cy="50" transform="rotate(-90 50 50)" /> </svg> <div id="timer-display" class="absolute inset-0 flex flex-col items-center justify-center text-4xl font-bold text-text dark:text-text-dark tracking-tight">25:00</div> <div id="timer-status" class="absolute bottom-0 left-0 right-0 text-center text-xs font-medium uppercase tracking-wider text-muted dark:text-muted-dark -mb-5">Work</div> </div>
                    <!-- Timer Controls -->
                    <div class="flex justify-center space-x-3"> <button id="start-pause-button" class="bg-primary hover:bg-primary/90 dark:bg-primary-dark dark:hover:bg-primary-dark/90 text-white font-semibold py-2.5 px-6 rounded-lg btn-animated shadow-sm flex items-center space-x-2 focus-visible:ring-2 focus-visible:ring-offset-2 focus-visible:ring-primary"> <i data-lucide="play" class="h-5 w-5"></i> <span>Start</span> </button> <button id="reset-button" class="bg-slate-500 hover:bg-slate-600 dark:bg-slate-600 dark:hover:bg-slate-500 text-white font-semibold py-2.5 px-6 rounded-lg btn-animated shadow-sm flex items-center space-x-2 focus-visible:ring-2 focus-visible:ring-offset-2 focus-visible:ring-slate-500"> <i data-lucide="rotate-ccw" class="h-5 w-5"></i> <span>Reset</span> </button> </div>
                    <!-- Timer Settings -->
                    <details class="mt-8 text-center w-full max-w-xs"> <summary class="cursor-pointer text-sm text-muted dark:text-muted-dark hover:text-primary dark:hover:text-primary-dark font-medium list-none flex items-center justify-center space-x-1 focus-visible:ring-1 focus-visible:ring-primary rounded p-1"> <i data-lucide="settings" class="h-4 w-4"></i> <span>Timer Settings</span> <span class="summary-chevron ml-auto"></span> </summary> <div><div class="p-4 bg-slate-50 dark:bg-slate-700/50 rounded-b-lg border border-t-0 border-slate-200 dark:border-slate-600/50 space-y-3 text-left"> <div> <label for="work-duration" class="block text-xs font-medium text-muted dark:text-muted-dark mb-1">Work Duration (min):</label> <input type="number" id="work-duration" value="25" min="1" max="90" class="w-full p-1.5 border border-slate-300 dark:border-slate-500 rounded-md text-sm bg-white dark:bg-slate-600 focus:ring-primary focus:border-primary"> </div> <div> <label for="short-break-duration" class="block text-xs font-medium text-muted dark:text-muted-dark mb-1">Short Break (min):</label> <input type="number" id="short-break-duration" value="5" min="1" max="30" class="w-full p-1.5 border border-slate-300 dark:border-slate-500 rounded-md text-sm bg-white dark:bg-slate-600 focus:ring-primary focus:border-primary"> </div> <div> <label for="long-break-duration" class="block text-xs font-medium text-muted dark:text-muted-dark mb-1">Long Break (min):</label> <input type="number" id="long-break-duration" value="15" min="5" max="60" class="w-full p-1.5 border border-slate-300 dark:border-slate-500 rounded-md text-sm bg-white dark:bg-slate-600 focus:ring-primary focus:border-primary"> </div> </div></div> </details>

                    <!-- NEW: Subject Time Display Area -->
                    <div id="pomodoro-subject-times" class="mt-8 w-full max-w-xs border-t border-slate-200 dark:border-slate-700 pt-6 text-sm">
                         <h3 class="text-base font-semibold mb-3 text-center text-muted dark:text-muted-dark">Total Time per Subject</h3>
                         <div class="min-h-[50px] space-y-2">
                             <!-- Content will be loaded here by JS -->
                         </div>
                    </div>
                </div>
            </section>

            <!-- Tracker Page -->
            <section id="tracker" class="page">
                 <h1 class="text-2xl md:text-3xl font-bold mb-6 text-text dark:text-text-dark">Feedback & Improvement Tracker</h1>
                <div class="bg-card text-text rounded-xl shadow-widget p-4 md:p-6 dark:bg-card-dark dark:text-text-dark dark:shadow-widget-dark transition-all duration-300">
                    <h2 class="text-xl font-semibold mb-4">Track Your Progress</h2>
                    <p class="text-muted dark:text-muted-dark mb-5">Log feedback, weak areas, and action points.</p>
                    <!-- Subject Selection -->
                    <div class="mb-6">
                        <label for="tracker-subject-select" class="block text-sm font-medium text-muted dark:text-muted-dark mb-1">Select Subject:</label>
                        <select id="tracker-subject-select" class="w-full md:w-1/2 lg:w-1/3 p-2 border border-slate-300 dark:border-slate-600 rounded-lg bg-background dark:bg-slate-700 focus:ring-primary focus:border-primary"> <option value="">-- Select Subject --</option> </select>
                    </div>
                     <!-- Add Tracker Item Form (hidden until subject selected) -->
                     <details id="add-tracker-details" class="mb-6 border border-slate-200 dark:border-slate-700 rounded-lg overflow-hidden bg-slate-50 dark:bg-slate-800/50" style="display: none;">
                         <summary class="p-3 font-medium text-primary dark:text-primary-dark hover:bg-slate-100 dark:hover:bg-slate-700/50 flex items-center justify-between focus-visible:ring-1 focus-visible:ring-primary cursor-pointer">
                             <span>Add New Tracker Item</span> <span class="summary-chevron"></span>
                         </summary>
                         <div><div id="add-tracker-item-form" class="p-4 grid grid-cols-1 md:grid-cols-3 gap-4 border-t border-slate-200 dark:border-slate-700">
                            <div class="md:col-span-2"> <label for="tracker-description" class="block text-sm font-medium text-muted dark:text-muted-dark mb-1">Description:</label> <textarea id="tracker-description" placeholder="Describe the feedback..." rows="3" class="w-full p-2 border border-slate-300 dark:border-slate-600 rounded-lg bg-background dark:bg-slate-700 focus:ring-primary focus:border-primary"></textarea> </div>
                            <div> <label for="tracker-status-select" class="block text-sm font-medium text-muted dark:text-muted-dark mb-1">Status:</label> <select id="tracker-status-select" class="w-full p-2 border border-slate-300 dark:border-slate-600 rounded-lg bg-background dark:bg-slate-700 focus:ring-primary focus:border-primary"> <option value="To Review">To Review</option> <option value="In Progress">In Progress</option> <option value="Mastered">Mastered</option> </select> </div>
                            <div class="md:col-span-3"> <button id="save-tracker-item-btn" class="mt-2 bg-primary hover:bg-primary/90 dark:bg-primary-dark dark:hover:bg-primary-dark/90 text-white font-semibold py-2 px-5 rounded-lg btn-animated shadow-sm disabled:opacity-50 focus-visible:ring-2 focus-visible:ring-offset-2 focus-visible:ring-primary">Add Item</button> </div>
                        </div></div>
                    </details>
                    <!-- Tracker Item List -->
                    <h3 class="text-lg font-medium mb-3 text-text dark:text-text-dark">Logged Items</h3>
                    <div id="tracker-items-list" class="mt-4 min-h-[150px] space-y-3"></div>
                </div>
            </section>

            <!-- Planner Page -->
            <section id="planner" class="page">
                <h1 class="text-2xl md:text-3xl font-bold mb-6 text-text dark:text-text-dark">Revision Planner</h1>
                <div class="bg-card text-text rounded-xl shadow-widget p-4 md:p-6 dark:bg-card-dark dark:text-text-dark dark:shadow-widget-dark transition-all duration-300">
                    <h2 class="text-xl font-semibold mb-4">Schedule Your Study Time</h2>
                    <p class="text-muted dark:text-muted-dark mb-5">Plan your revision sessions by date, time, subject, and topic.</p>
                    <!-- Add Planner Item Form -->
                    <div id="add-planner-item-form" class="mb-6 pb-6 border-b border-slate-200 dark:border-slate-700">
                        <h3 class="text-lg font-medium mb-4 text-primary dark:text-primary-dark">Add New Session</h3>
                        <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-5 gap-4 items-end">
                            <div class="lg:col-span-1"> <label for="planner-date" class="block text-sm font-medium text-muted dark:text-muted-dark mb-1">Date:</label> <input type="date" id="planner-date" class="w-full p-2 border border-slate-300 dark:border-slate-600 rounded-lg bg-background dark:bg-slate-700 focus:ring-primary focus:border-primary"> </div>
                            <div class="lg:col-span-1"> <label for="planner-time" class="block text-sm font-medium text-muted dark:text-muted-dark mb-1">Time:</label> <input type="time" id="planner-time" class="w-full p-2 border border-slate-300 dark:border-slate-600 rounded-lg bg-background dark:bg-slate-700 focus:ring-primary focus:border-primary"> </div>
                            <div class="lg:col-span-1"> <label for="planner-subject-select" class="block text-sm font-medium text-muted dark:text-muted-dark mb-1">Subject:</label> <select id="planner-subject-select" class="w-full p-2 border border-slate-300 dark:border-slate-600 rounded-lg bg-background dark:bg-slate-700 focus:ring-primary focus:border-primary"> <option value="">-- Select --</option> </select> </div>
                            <div class="sm:col-span-2 lg:col-span-2"> <label for="planner-topic" class="block text-sm font-medium text-muted dark:text-muted-dark mb-1">Topic / Notes:</label> <input type="text" id="planner-topic" placeholder="e.g., Algebra Practice" class="w-full p-2 border border-slate-300 dark:border-slate-600 rounded-lg bg-background dark:bg-slate-700 focus:ring-primary focus:border-primary"> </div>
                            <div class="sm:col-span-full lg:col-span-5 flex justify-start"> <button id="save-planner-item-btn" class="mt-2 bg-primary hover:bg-primary/90 dark:bg-primary-dark dark:hover:bg-primary-dark/90 text-white font-semibold py-2 px-5 rounded-lg btn-animated shadow-sm disabled:opacity-50 focus-visible:ring-2 focus-visible:ring-offset-2 focus-visible:ring-primary">Schedule Session</button> </div>
                        </div>
                     </div>
                     <!-- Scheduled Sessions List -->
                    <h2 class="text-xl font-semibold mt-6 mb-4 text-text dark:text-text-dark">Scheduled Sessions</h2>
                    <div id="planner-items-list" class="mt-4 space-y-5 min-h-[100px]"></div>
                </div>
            </section>

             <!-- Quiz Page -->
             <section id="quiz" class="page">
                 <h1 class="text-2xl md:text-3xl font-bold mb-6 text-text dark:text-text-dark">Quiz Yourself</h1>
                <div class="bg-card text-text rounded-xl shadow-widget p-4 md:p-6 dark:bg-card-dark dark:text-text-dark dark:shadow-widget-dark transition-all duration-300">
                    <h2 class="text-xl font-semibold mb-4">Practice Questions</h2>
                    <p class="text-muted dark:text-muted-dark mb-5">Save challenging questions and test yourself until you master them.</p>
                    <!-- Subject Selection -->
                    <div class="mb-6">
                        <label for="quiz-subject-select" class="block text-sm font-medium text-muted dark:text-muted-dark mb-1">Select Subject:</label>
                        <select id="quiz-subject-select" class="w-full md:w-1/2 lg:w-1/3 p-2 border border-slate-300 dark:border-slate-600 rounded-lg bg-background dark:bg-slate-700 focus:ring-primary focus:border-primary"> <option value="">-- Select Subject --</option> </select>
                    </div>
                    <!-- Quiz Content Area (Add form, list, start button) -->
                    <div id="quiz-content-wrapper" class="hidden">
                        <!-- Add Question Form (hidden until subject selected) -->
                        <details id="add-quiz-details" class="mb-6 border border-slate-200 dark:border-slate-700 rounded-lg overflow-hidden bg-slate-50 dark:bg-slate-800/50" style="display: none;">
                            <summary class="p-3 font-medium text-primary dark:text-primary-dark hover:bg-slate-100 dark:hover:bg-slate-700/50 flex items-center justify-between focus-visible:ring-1 focus-visible:ring-primary cursor-pointer">
                                <span>Add New Question</span> <span class="summary-chevron"></span>
                            </summary>
                            <div><div id="add-quiz-question-form" class="p-4 space-y-4 border-t border-slate-200 dark:border-slate-700">
                                 <div> <label for="quiz-question-input" class="block text-sm font-medium text-muted dark:text-muted-dark mb-1">Question:</label> <textarea id="quiz-question-input" placeholder="Enter the question text..." rows="3" class="w-full p-2 border border-slate-300 dark:border-slate-600 rounded-lg bg-background dark:bg-slate-700 focus:ring-primary focus:border-primary"></textarea> </div>
                                 <div> <label for="quiz-question-file" class="block text-xs font-medium text-muted dark:text-muted-dark mb-1">Question Image/File (Optional):</label> <input type="file" id="quiz-question-file" accept="image/*,application/pdf,.doc,.docx,.txt" class="block w-full text-sm text-slate-500 file:mr-4 file:py-1.5 file:px-3 file:rounded-full file:border-0 file:text-xs file:font-semibold file:bg-primary-100 file:text-primary-700 hover:file:bg-primary-200 dark:file:bg-primary-900/40 dark:file:text-primary-300 dark:hover:file:bg-primary-900/60 cursor-pointer focus-visible:outline-none focus-visible:ring-1 focus-visible:ring-primary rounded-lg"> </div>
                                 <div> <label for="quiz-answer-input" class="block text-sm font-medium text-muted dark:text-muted-dark mb-1">Answer / Mark Scheme:</label> <textarea id="quiz-answer-input" placeholder="Enter the correct answer..." rows="4" class="w-full p-2 border border-slate-300 dark:border-slate-600 rounded-lg bg-background dark:bg-slate-700 focus:ring-primary focus:border-primary"></textarea> </div>
                                 <div> <label for="quiz-answer-file" class="block text-xs font-medium text-muted dark:text-muted-dark mb-1">Answer Image/File (Optional):</label> <input type="file" id="quiz-answer-file" accept="image/*,application/pdf,.doc,.docx,.txt" class="block w-full text-sm text-slate-500 file:mr-4 file:py-1.5 file:px-3 file:rounded-full file:border-0 file:text-xs file:font-semibold file:bg-primary-100 file:text-primary-700 hover:file:bg-primary-200 dark:file:bg-primary-900/40 dark:file:text-primary-300 dark:hover:file:bg-primary-900/60 cursor-pointer focus-visible:outline-none focus-visible:ring-1 focus-visible:ring-primary rounded-lg"> </div>
                                 <button id="save-quiz-question-btn" class="mt-2 bg-primary hover:bg-primary/90 dark:bg-primary-dark dark:hover:bg-primary-dark/90 text-white font-semibold py-2 px-5 rounded-lg btn-animated shadow-sm disabled:opacity-50 focus-visible:ring-2 focus-visible:ring-offset-2 focus-visible:ring-primary">Add Question</button>
                            </div></div>
                        </details>
                        <!-- Saved Questions List & Start Button -->
                        <div id="quiz-list-container">
                             <h3 class="text-lg font-medium mb-3 text-text dark:text-text-dark">Saved Questions</h3>
                             <div id="quiz-items-list" class="mt-4 mb-6 max-h-72 overflow-y-auto space-y-3 pr-2 border border-slate-200 dark:border-slate-700 rounded-lg p-3 bg-slate-50 dark:bg-slate-900/30 min-h-[100px]"></div>
                             <button id="start-quiz-button" class="bg-secondary hover:bg-secondary/90 dark:bg-secondary-dark dark:hover:bg-secondary-dark/90 text-white font-semibold py-2.5 px-5 rounded-lg btn-animated shadow-sm disabled:opacity-50 flex items-center space-x-2 focus-visible:ring-2 focus-visible:ring-offset-2 focus-visible:ring-secondary"> <i data-lucide="swords" class="h-5 w-5"></i> <span>Challenge Me!</span> </button>
                        </div>
                    </div>
                    <!-- Quiz Mode Interface (hidden until started) -->
                    <div id="quiz-mode-interface" class="hidden mt-6 pt-6 border-t border-slate-200 dark:border-slate-700">
                         <div class="flex justify-between items-center mb-3">
                             <h3 class="text-xl font-semibold text-primary dark:text-primary-dark">Quiz Challenge</h3>
                             <span id="quiz-progress" class="text-sm font-medium text-muted dark:text-muted-dark">Round 1 | Remaining: 0</span>
                         </div>
                         <!-- Question Display Area -->
                         <div id="quiz-question-display" class="p-4 border-2 border-dashed border-slate-300 dark:border-slate-600 rounded-lg mb-4 min-h-[120px] bg-background dark:bg-slate-800/50 text-text dark:text-text-dark flex flex-col items-center justify-center text-center text-lg space-y-2">
                             <p class="italic text-muted dark:text-muted-dark">Loading question...</p>
                             <!-- Image/File will be appended here by JS -->
                         </div>
                         <!-- Location for Question File Display (Now Part of quiz-question-display logic) -->
                         <div id="quiz-question-file-display" class="text-center"></div>

                         <!-- Reveal Answer Button -->
                         <div id="quiz-reveal-button-container" class="mb-3 text-center">
                            <button id="quiz-reveal-answer-btn" class="bg-slate-200 hover:bg-slate-300 dark:bg-slate-600 dark:hover:bg-slate-500 text-text dark:text-text-dark font-medium py-2 px-4 rounded-lg text-sm btn-animated flex items-center space-x-1.5 mx-auto focus-visible:ring-2 focus-visible:ring-offset-1 focus-visible:ring-slate-500">
                                <i data-lucide="eye" class="h-4 w-4"></i> <span>Show Answer</span>
                            </button>
                         </div>
                         <!-- Correct Answer Display Area (hidden until revealed) -->
                         <div id="quiz-correct-answer-display" class="p-3 bg-slate-100 dark:bg-slate-700 rounded-md text-sm mb-4 space-y-2" style="display: none;">
                            <div id="quiz-answer-text-display"></div>
                            <div id="quiz-answer-file-display" class="text-center"></div> <!-- Center potential image/link -->
                         </div>
                         <!-- Judgment Buttons (hidden until revealed) -->
                         <div id="quiz-judgment-buttons" class="mt-4 flex justify-center gap-4" style="display: none;">
                             <button id="quiz-incorrect-btn" class="w-full sm:w-auto bg-red-500 hover:bg-red-600 text-white font-semibold py-2.5 px-6 rounded-lg btn-animated shadow-sm flex items-center justify-center space-x-2 focus-visible:ring-2 focus-visible:ring-offset-2 focus-visible:ring-red-500">
                                 <i data-lucide="x" class="h-5 w-5"></i> <span>Got it Wrong</span>
                             </button>
                              <button id="quiz-correct-btn" class="w-full sm:w-auto bg-green-500 hover:bg-green-600 text-white font-semibold py-2.5 px-6 rounded-lg btn-animated shadow-sm flex items-center justify-center space-x-2 focus-visible:ring-2 focus-visible:ring-offset-2 focus-visible:ring-green-500">
                                 <i data-lucide="check" class="h-5 w-5"></i> <span>Got it Right!</span>
                             </button>
                         </div>
                         <!-- Stop Quiz Button -->
                         <div class="mt-6 text-center">
                            <button id="stop-quiz-button" class="text-xs text-muted dark:text-muted-dark hover:text-red-600 dark:hover:text-red-400 underline focus-visible:ring-1 focus-visible:ring-red-500 rounded px-1 btn-animated">Stop Quiz</button>
                         </div>
                         <!-- Completion Message -->
                         <div id="quiz-completion-message" class="hidden mt-6 p-4 text-center bg-green-100 dark:bg-green-900/50 text-green-700 dark:text-green-200 rounded-lg font-medium"></div>
                    </div>
                </div>
            </section>
        </main>

        <!-- Footer -->
        <footer class="bg-card dark:bg-card-dark mt-auto py-4 shadow-inner dark:shadow-[0_-1px_5px_-1px_rgba(0,0,0,0.1)] transition-colors duration-300 border-t border-slate-200 dark:border-slate-700">
            <div class="container mx-auto px-4 text-center text-xs text-muted dark:text-muted-dark">
                 &copy; <span id="current-year"></span> Giorgi Suramlishvili Revision Hub. Candidate: 7590. Keep pushing!
            </div>
        </footer>
    </div>

    <!-- Firebase and App Logic -->
    <script type="module">
      // Firebase SDK Imports
      import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.0/firebase-app.js";
      import { getAuth, onAuthStateChanged, signInWithEmailAndPassword, signOut, updatePassword, EmailAuthProvider, reauthenticateWithCredential } from "https://www.gstatic.com/firebasejs/11.6.0/firebase-auth.js";
      import { getFirestore, collection, doc, addDoc, getDocs, getDoc, updateDoc, deleteDoc, query, orderBy, limit, serverTimestamp, increment, writeBatch, Timestamp, where } from "https://www.gstatic.com/firebasejs/11.6.0/firebase-firestore.js";
      import { getStorage, ref, uploadBytes, getDownloadURL, deleteObject } from "https://www.gstatic.com/firebasejs/11.6.0/firebase-storage.js";

      // --- Firebase Configuration ---
      const firebaseConfig = {
        apiKey: "AIzaSyAt3uFOLLQXjt2p0LERjvizePMfg9S74Mk", // Replace with your actual API key
        authDomain: "studentpage-97bb5.firebaseapp.com",
        projectId: "studentpage-97bb5",
        storageBucket: "studentpage-97bb5.firebasestorage.app",
        messagingSenderId: "613071061381",
        appId: "1:613071061381:web:124051538e7e0dfec344ec",
        measurementId: "G-WC262FYLJH"
      };

      // --- Global Variables ---
      let app, auth, db, storage;
      let currentUserId = null;
      let isInitialized = false;
      let eventListenersAttached = false;
      let countdownInterval = null;
      let pomodoroInterval = null;
      let currentActiveSubject = null;
      let quizState = { active: false, currentSubject: null, initialQuestions: [], currentQuizPool: [], incorrectlyAnswered: [], currentQuestionIndex: -1, round: 1, totalMastered: 0, isAnswerVisible: false, buttonTimeout: null };
      let targetSubjectParam = null;
      const DEFAULT_TITLE = "Giorgi's GCSE Revision Hub";

      // --- Static Data ---
      const examData = [ { subject: "English Literature", paper: "Paper 1", date: "2025-05-12T08:45:00", duration: "1h 45m", board: "AQA", tier: null, location: "Sports Hall 1", seat: "M3" }, { subject: "Computer Science", paper: "Computer Systems Written", date: "2025-05-12T13:45:00", duration: "1h 30m", board: "OCR", tier: null, location: "Sports Hall 1", seat: "C10" }, { subject: "Biology", paper: "Paper 1", date: "2025-05-13T13:45:00", duration: "1h 45m", board: "AQA", tier: "H", location: "Sports Hall 1", seat: "N1" }, { subject: "Geography", paper: "Paper 1", date: "2025-05-14T08:45:00", duration: "1h 30m", board: "AQA", tier: null, location: "Sports Hall 1", seat: "F8" }, { subject: "Mathematics", paper: "Option H: Non-Calculator", date: "2025-05-15T08:45:00", duration: "1h 30m", board: "Edexcel", tier: "H", location: "Sports Hall 1", seat: "M3" }, { subject: "Chemistry", paper: "Paper 1", date: "2025-05-19T08:45:00", duration: "1h 45m", board: "AQA", tier: "H", location: "Sports Hall 1", seat: "N1" }, { subject: "English Literature", paper: "Paper 2", date: "2025-05-20T08:45:00", duration: "2h 15m", board: "AQA", tier: null, location: "Sports Hall 1", seat: "M3" }, { subject: "Computer Science", paper: "Computational Thinking, Algorithms & Programming", date: "2025-05-20T13:45:00", duration: "1h 30m", board: "OCR", tier: null, location: "Sports Hall 1", seat: "C10" }, { subject: "Physics", paper: "Paper 1", date: "2025-05-22T08:45:00", duration: "1h 45m", board: "AQA", tier: "H", location: "Sports Hall 1", seat: "N1" }, { subject: "English Language", paper: "Paper 1", date: "2025-05-23T08:45:00", duration: "1h 45m", board: "AQA", tier: null, location: "Sports Hall 1", seat: "M3" }, { subject: "Mathematics", paper: "Option H: Calculator", date: "2025-06-04T08:45:00", duration: "1h 30m", board: "Edexcel", tier: "H", location: "Sports Hall 1", seat: "M2" }, { subject: "English Language", paper: "Paper 2", date: "2025-06-06T08:45:00", duration: "1h 45m", board: "AQA", tier: null, location: "Sports Hall 1", seat: "M3" }, { subject: "Geography", paper: "Paper 2", date: "2025-06-06T13:45:00", duration: "1h 30m", board: "AQA", tier: null, location: "Sports Hall 1", seat: "F8" }, { subject: "Biology", paper: "Paper 2", date: "2025-06-09T08:45:00", duration: "1h 45m", board: "AQA", tier: "H", location: "Sports Hall 1", seat: "N1" }, { subject: "Spanish", paper: "Listening", date: "2025-06-10T08:45:00", duration: "0h 45m", board: "AQA", tier: "H", location: "4G3 - History E3", seat: null }, { subject: "Spanish", paper: "Reading", date: "2025-06-10T09:50:00", duration: "1h 00m", board: "AQA", tier: "H", location: "4G3 - History E3", seat: null }, { subject: "Mathematics", paper: "Option H: Calculator P3", date: "2025-06-11T08:45:00", duration: "1h 30m", board: "Edexcel", tier: "H", location: "Sports Hall 1", seat: "M3" }, { subject: "Geography", paper: "Paper 3", date: "2025-06-12T08:45:00", duration: "1h 30m", board: "AQA", tier: null, location: "Sports Hall 1", seat: "F8" }, { subject: "Chemistry", paper: "Paper 2", date: "2025-06-13T08:45:00", duration: "1h 45m", board: "AQA", tier: "H", location: "Sports Hall 1", seat: "N1" }, { subject: "Physics", paper: "Paper 2", date: "2025-06-16T08:45:00", duration: "1h 45m", board: "AQA", tier: "H", location: "Sports Hall 1", seat: "N1" }, { subject: "Spanish", paper: "Writing", date: "2025-06-17T08:45:00", duration: "1h 15m", board: "AQA", tier: "H", location: "Sports Hall 1", seat: "J3" } ].sort((a, b) => new Date(a.date) - new Date(b.date));
      const motivationalQuotes = [ "Believe you can and you're halfway there.", "The secret to getting ahead is getting started.", "Don't watch the clock; do what it does. Keep going.", "Success is not final, failure is not fatal: It is the courage to continue that counts.", "The expert in anything was once a beginner.", "Strive for progress, not perfection.", "Your limitation—it's only your imagination.", "Push yourself, because no one else is going to do it for you.", "Great things never come from comfort zones.", "The harder you work for something, the greater you'll feel when you achieve it.", "Focus on the step in front of you, not the whole staircase.", "Small steps every day lead to big results." ];
      const subjects = [...new Set(examData.map(exam => exam.subject))].sort();

      // --- DOM Element References ---
      const getElement = (id) => document.getElementById(id);
      const loginOverlay = getElement('login-overlay');
      const appWrapper = getElement('app-wrapper');
      const emailInput = getElement('email-input');
      const passwordInput = getElement('password-input');
      const loginButton = getElement('login-button');
      const loginError = getElement('login-error');
      const logoutButton = getElement('logout-button');
      const logoutButtonMobile = getElement('logout-button-mobile');
      const currentPasswordInput = getElement('current-password');
      const newPasswordInput = getElement('new-password');
      const changePasswordButton = getElement('change-password-button');
      const changePasswordMessage = getElement('change-password-message');
      const themeToggle = getElement('theme-toggle');
      const themeToggleMobile = getElement('theme-toggle-mobile');
      const themeIconLight = getElement('theme-icon-light');
      const themeIconDark = getElement('theme-icon-dark');
      const themeIconLightMobile = getElement('theme-icon-light-mobile');
      const themeIconDarkMobile = getElement('theme-icon-dark-mobile');
      const htmlElement = document.documentElement;
      const navLinks = document.querySelectorAll('.nav-link:not(.mobile-nav-link)');
      const pages = document.querySelectorAll('.page');
      const mobileMenuButton = getElement('mobile-menu-button');
      const mobileCloseButton = getElement('mobile-close-button');
      const mobileMenu = getElement('mobile-menu');
      const mobileOverlay = getElement('mobile-overlay');
      const mobileNavLinks = document.querySelectorAll('.mobile-nav-link');
      const currentYearEl = getElement('current-year');
      // Resource Page Elements
      const subjectTabsContainer = getElement('subject-tabs');
      const resourceContent = getElement('resource-content');
      const addResourceDetails = getElement('add-resource-details');
      const resourceTypeSelect = getElement('resource-type');
      const resourceTitleInput = getElement('resource-title');
      const resourceUrlWrapper = getElement('resource-url-wrapper');
      const resourceUrlInput = getElement('resource-url');
      const resourceNoteWrapper = getElement('resource-note-wrapper');
      const resourceNoteInput = getElement('resource-note');
      const saveResourceBtn = getElement('save-resource-btn');
      // Pomodoro Page Elements
      const timerDisplay = getElement('timer-display');
      const timerStatus = getElement('timer-status');
      const startPauseButton = getElement('start-pause-button');
      const resetButton = getElement('reset-button');
      const pomodoroSubjectSelect = getElement('pomodoro-subject');
      const pomodoroSubjectWrapper = getElement('pomodoro-subject-wrapper');
      const workDurationInput = getElement('work-duration');
      const shortBreakDurationInput = getElement('short-break-duration');
      const longBreakDurationInput = getElement('long-break-duration');
      const progressRing = getElement('timer-progress-ring');
      const workModeButton = getElement('work-mode-button');
      const shortBreakModeButton = getElement('short-break-mode-button');
      const longBreakModeButton = getElement('long-break-mode-button');
      const pomodoroModeTitle = getElement('pomodoro-mode-title');
      const pomodoroSubjectTimesContainer = getElement('pomodoro-subject-times'); // NEW
      const modeButtons = [workModeButton, shortBreakModeButton, longBreakModeButton];
      // Tracker Page Elements
      const trackerSubjectSelect = getElement('tracker-subject-select');
      const trackerItemsList = getElement('tracker-items-list');
      const addTrackerDetails = getElement('add-tracker-details');
      const trackerDescriptionInput = getElement('tracker-description');
      const trackerStatusSelect = getElement('tracker-status-select');
      const saveTrackerItemBtn = getElement('save-tracker-item-btn');
      // Planner Page Elements
      const plannerDateInput = getElement('planner-date');
      const plannerTimeInput = getElement('planner-time');
      const plannerSubjectSelect = getElement('planner-subject-select');
      const plannerTopicInput = getElement('planner-topic');
      const savePlannerItemBtn = getElement('save-planner-item-btn');
      const plannerItemsList = getElement('planner-items-list');
      // Quiz Page Elements
      const quizSubjectSelect = getElement('quiz-subject-select');
      const quizContentWrapper = getElement('quiz-content-wrapper');
      const addQuizDetails = getElement('add-quiz-details');
      const quizQuestionInput = getElement('quiz-question-input');
      const quizAnswerInput = getElement('quiz-answer-input');
      const quizQuestionFileInput = getElement('quiz-question-file');
      const quizAnswerFileInput = getElement('quiz-answer-file');
      const saveQuizQuestionBtn = getElement('save-quiz-question-btn');
      const quizItemsList = getElement('quiz-items-list');
      const quizListContainer = getElement('quiz-list-container');
      const startQuizButton = getElement('start-quiz-button');
      const quizModeInterface = getElement('quiz-mode-interface');
      const quizQuestionDisplay = getElement('quiz-question-display');
      const quizQuestionFileDisplay = getElement('quiz-question-file-display');
      const quizRevealBtnContainer = getElement('quiz-reveal-button-container');
      const quizRevealAnswerBtn = getElement('quiz-reveal-answer-btn');
      const quizCorrectAnswerDisplay = getElement('quiz-correct-answer-display');
      const quizAnswerTextDisplay = getElement('quiz-answer-text-display');
      const quizAnswerFileDisplay = getElement('quiz-answer-file-display');
      const quizJudgmentButtons = getElement('quiz-judgment-buttons');
      const quizIncorrectBtn = getElement('quiz-incorrect-btn');
      const quizCorrectBtn = getElement('quiz-correct-btn');
      const stopQuizButton = getElement('stop-quiz-button');
      const quizProgress = getElement('quiz-progress');
      const quizCompletionMessage = getElement('quiz-completion-message');

      // --- Pomodoro State Variables ---
      let pomodoroState = { totalSeconds: 0, currentSeconds: 0, timerState: 'stopped', timerMode: 'work', pomodoroCycle: 0, workSessionSubject: '', timerEndTime: null };
      const POMODORO_STORAGE_KEY = 'pomodoroState';

      // --- Utility Functions ---
      const safelyCreateIcons = () => {
          if (typeof lucide !== 'undefined' && lucide.createIcons) {
              try {
                  lucide.createIcons();
              } catch (e) {
                  console.error("Lucide icon creation failed:", e);
              }
          } else {
             // console.warn("Lucide library not available for icon creation.");
          }
      };

      const formatGeneralDate = (d) => {
          try {
              const date = (d instanceof Date) ? d : (d?.toDate ? d.toDate() : new Date(d));
              if (isNaN(date.getTime())) return "Invalid Date";
              return date.toLocaleDateString('en-GB', { weekday: 'short', year: 'numeric', month: 'short', day: 'numeric' });
          } catch (e) {
               console.warn("Error formatting general date:", d, e);
               return "Invalid Date";
           }
      };

      const formatPlannerDateTime = (iso) => {
          try {
              const date = new Date(iso);
               if (isNaN(date.getTime())) return "Invalid Date";
              const dp = date.toLocaleDateString('en-GB', { weekday: 'short', month: 'short', day: 'numeric' });
              const tp = date.toLocaleTimeString('en-GB', { hour: '2-digit', minute: '2-digit', hour12: true });
              return `${dp}, ${tp}`;
          } catch (e) {
              console.warn("Error formatting planner date/time:", iso, e);
              try { return formatGeneralDate(iso.split('T')[0]); } // Fallback to date only
              catch { return "Invalid Date"; }
          }
      };

      const formatExamDate = (d) => {
          try {
              const date = new Date(d);
               if (isNaN(date.getTime())) return "Invalid Date";
              return date.toLocaleDateString('en-GB', { weekday: 'short', month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit', hour12: true });
          } catch (e) {
               console.warn("Error formatting exam date:", d, e);
               return "Invalid Date";
           }
      };

      const formatMinutes = (m) => {
          if (typeof m !== 'number' || isNaN(m) || m < 1) return '0m';
          const h = Math.floor(m / 60);
          const min = m % 60;
          let r = '';
          if (h > 0) r += `${h}h `;
          if (min > 0 || h === 0) r += `${min}m`;
          return r.trim();
      };

      const formatCountdown = (d) => {
          try {
              const now = new Date();
              const examDate = new Date(d);
               if (isNaN(examDate.getTime())) return "<span class='text-red-500'>Error</span>";
              const diff = examDate - now;
              if (diff <= 0) return "<span class='text-green-600 dark:text-green-400 font-medium'>Completed</span>";
              const days = Math.floor(diff / 864e5);
              const hours = Math.floor((diff % 864e5) / 36e5);
              const minutes = Math.floor((diff % 36e5) / 6e4);
              let p = [];
              if (days > 0) p.push(`${days}d`);
              if (hours > 0) p.push(`${hours}h`);
              if (days < 1 && minutes > 0) p.push(`${minutes}m`);
              if (p.length === 0 && diff > 0) return "<span class='text-orange-500 font-medium'>&lt; 1m</span>";
              return p.join(' ');
          } catch (e) {
                console.warn("Error formatting countdown:", d, e);
                return "<span class='text-red-500'>Error</span>";
            }
      };

      const getSubjectColor = (s) => {
          const cs = [ 'border-indigo-400 dark:border-indigo-600', 'border-sky-400 dark:border-sky-600', 'border-emerald-400 dark:border-emerald-600', 'border-amber-400 dark:border-amber-600', 'border-violet-400 dark:border-violet-600', 'border-rose-400 dark:border-rose-600', 'border-cyan-400 dark:border-cyan-600', 'border-lime-400 dark:border-lime-600', 'border-fuchsia-400 dark:border-fuchsia-600', 'border-orange-400 dark:border-orange-600', ];
          const i = subjects.indexOf(s);
          return cs[i % cs.length] || 'border-slate-400 dark:border-slate-600';
      };

      const getSubjectColorRGB = (s) => {
          const cm = { 'border-indigo-400': '129, 140, 248', 'border-sky-400': '56, 189, 248', 'border-emerald-400': '52, 211, 153', 'border-amber-400': '251, 191, 36', 'border-violet-400': '167, 139, 250', 'border-rose-400': '251, 113, 133', 'border-cyan-400': '34, 211, 238', 'border-lime-400': '163, 230, 53', 'border-fuchsia-400': '217, 70, 239', 'border-orange-400': '251, 146, 60' };
          const bc = getSubjectColor(s).split(' ')[0];
          return cm[bc] || '203, 213, 225'; // Default slate
      };

      const shuffleArray = (a) => {
          if (!Array.isArray(a)) return [];
          for (let i = a.length - 1; i > 0; i--) {
              const j = Math.floor(Math.random() * (i + 1));
              [a[i], a[j]] = [a[j], a[i]];
          }
          return a;
      };

      const escapeHtml = (unsafe) => {
          return unsafe ? unsafe.toString().replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;").replace(/"/g, "&quot;").replace(/'/g, "&#039;") : '';
      };

      const applyStaggerAnimation = (elements) => {
          if (!elements) return;
          Array.from(elements).forEach((el, index) => {
              if (el instanceof HTMLElement) {
                  el.style.animationDelay = `${index * 0.06}s`;
                  el.classList.add('list-item-appear');
              }
          });
      };


      // --- Firebase Initialization ---
      try {
          app = initializeApp(firebaseConfig);
          auth = getAuth(app);
          db = getFirestore(app);
          storage = getStorage(app);
          console.log("Firebase Initialized Successfully.");
      } catch (error) {
          console.error("Firebase Initialization Error:", error);
          if (loginError) {
              loginError.textContent = "Firebase connection failed. Check config or network.";
              loginError.classList.remove('hidden');
          }
          if (loginButton) {
              loginButton.disabled = true;
              loginButton.textContent = 'Login Unavailable';
          }
      }

      // --- Firebase Helper Functions ---
        const getUserDataRef = (userId, path) => {
          if (!userId || !db) { console.error("Cannot get user data ref: Missing userId or db"); return null; }
          return doc(db, `users/${userId}/${path}`);
      }
      const getUserCollectionRef = (userId, collectionName) => {
           if (!userId || !db) { console.error("Cannot get user collection ref: Missing userId or db"); return null; }
           return collection(db, `users/${userId}/${collectionName}`);
      }
      const getSubjectSpecificCollectionRef = (userId, mainCollection, subject) => {
          if (!userId || !db || !subject) { console.error("Cannot get subject collection ref: Missing userId, db, or subject"); return null; }
          return collection(db, `users/${userId}/${mainCollection}/${subject}/items`);
      }
      const getSubjectSpecificDocRef = (userId, mainCollection, subject, docId) => {
          if (!userId || !db || !subject || !docId) { console.error("Cannot get subject doc ref: Missing userId, db, subject, or docId"); return null; }
          return doc(db, `users/${userId}/${mainCollection}/${subject}/items/${docId}`);
      }

      // --- Authentication ---
        onAuthStateChanged(auth, (user) => {
          if (user && db && storage) {
              currentUserId = user.uid;
              console.log("User authenticated:", currentUserId);
              if (loginOverlay) loginOverlay.classList.add('opacity-0', 'pointer-events-none');
              setTimeout(() => loginOverlay?.classList.add('hidden'), 400); // Allow fade out
              if (appWrapper) {
                appWrapper.classList.remove('hidden');
                appWrapper.classList.add('flex');
              }
              if (!isInitialized) {
                  initializePostLogin(user);
                  isInitialized = true;
              }
          } else {
              console.log("User logged out or auth not ready.");
              currentUserId = null;
              isInitialized = false;
              if (loginOverlay) loginOverlay.classList.remove('hidden', 'opacity-0', 'pointer-events-none');
               if (appWrapper) {
                  appWrapper.classList.add('hidden');
                  appWrapper.classList.remove('flex');
               }
              clearDynamicContentAndIntervals(); // Clear content and stop timers on logout
              if (emailInput) emailInput.value = '';
              if (passwordInput) passwordInput.value = '';
              if (loginError) {
                  loginError.textContent = '';
                  loginError.classList.add('hidden');
              }
              document.title = DEFAULT_TITLE;
          }
          safelyCreateIcons();
      });

      const handleLogin = async () => {
          if (!emailInput || !passwordInput || !loginButton || !loginError || !auth) {
              console.error("Login function cannot run: Missing required elements or Firebase auth.");
              if (loginError) {
                  loginError.textContent = "Internal error. Please refresh.";
                  loginError.classList.remove('hidden');
              }
              if (loginButton) loginButton.disabled = true;
              return;
          }
          const email = emailInput.value.trim();
          const password = passwordInput.value;
          loginError.textContent = '';
          loginError.classList.add('hidden');
          if (!email || !password) {
              loginError.textContent = "Please enter both email and password.";
              loginError.classList.remove('hidden');
              return;
          }
          loginButton.disabled = true;
          loginButton.textContent = 'Logging in...';
          try {
              await signInWithEmailAndPassword(auth, email, password);
          } catch (error) {
              console.error("Login Error:", error);
              let errorMessage = "Login failed. Please check details and try again.";
              if (error.code === 'auth/invalid-credential' || error.code === 'auth/user-not-found' || error.code === 'auth/wrong-password') {
                  errorMessage = "Invalid email or password.";
              } else if (error.code === 'auth/network-request-failed') {
                  errorMessage = "Network error. Please check your connection.";
              } else if (error.code === 'auth/too-many-requests') {
                  errorMessage = "Too many login attempts. Please try again later.";
              } else if (error.message) {
                   errorMessage = `Login error: ${error.message}`;
              }
              loginError.textContent = errorMessage;
              loginError.classList.remove('hidden');
              loginButton.disabled = false;
              loginButton.textContent = 'Login';
          }
      };

      const handleLogout = async () => {
          if (!auth) return;
          console.log("Attempting logout...");
          stopPomodoroTimer(true);
          if (quizState.active) stopQuizMode();
          try {
              await signOut(auth);
              closeMobileMenu();
              console.log("Logout successful.");
          } catch (error) {
              console.error("Logout Error:", error);
              alert("Logout failed. Please try again.");
          }
      };

      const handleChangePassword = async () => {
           if (!currentPasswordInput || !newPasswordInput || !changePasswordButton || !changePasswordMessage || !auth?.currentUser) {
              if(changePasswordMessage) changePasswordMessage.textContent = 'Cannot change password now.';
              return;
            }
            const currentPassword = currentPasswordInput.value;
            const newPassword = newPasswordInput.value;
            changePasswordMessage.textContent = '';
            changePasswordMessage.className = 'text-sm mt-2 h-4'; // Reset classes
            if (!currentPassword || !newPassword) {
                changePasswordMessage.textContent = 'Please enter both current and new passwords.';
                changePasswordMessage.classList.add('text-red-500');
                return;
            }
            if (newPassword.length < 6) {
                changePasswordMessage.textContent = 'New password must be at least 6 characters long.';
                changePasswordMessage.classList.add('text-red-500');
                return;
            }
            changePasswordButton.disabled = true;
            changePasswordButton.textContent = 'Changing...';
            try {
                const user = auth.currentUser;
                if (!user || !user.email) throw new Error("User or email not found.");
                const credential = EmailAuthProvider.credential(user.email, currentPassword);
                console.log("Reauthenticating for password change...");
                await reauthenticateWithCredential(user, credential);
                console.log("Reauthentication successful. Updating password...");
                await updatePassword(user, newPassword);
                console.log("Password update successful.");
                changePasswordMessage.textContent = 'Password updated successfully!';
                changePasswordMessage.classList.add('text-green-600', 'dark:text-green-400');
                currentPasswordInput.value = '';
                newPasswordInput.value = '';
            } catch (error) {
                console.error("Change Password Error:", error);
                if (error.code === 'auth/wrong-password' || error.code === 'auth/invalid-credential') {
                    changePasswordMessage.textContent = 'Incorrect current password.';
                } else if (error.code === 'auth/weak-password') {
                    changePasswordMessage.textContent = 'New password is too weak.';
                } else if (error.code === 'auth/requires-recent-login') {
                    changePasswordMessage.textContent = 'Security check: Please log out and log back in to change password.';
                } else {
                    changePasswordMessage.textContent = 'Failed to change password. Please try again.';
                }
                changePasswordMessage.classList.add('text-red-500');
            } finally {
                changePasswordButton.disabled = false;
                changePasswordButton.textContent = 'Change Password';
            }
      };


      // --- UI and Navigation ---
        const applyTheme = (theme) => {
          if (!htmlElement) return;
          htmlElement.classList.remove('light', 'dark');
          htmlElement.classList.add(theme);
          const isDark = theme === 'dark';
          themeIconLight?.classList.toggle('hidden', isDark);
          themeIconDark?.classList.toggle('hidden', !isDark);
          themeIconLightMobile?.classList.toggle('hidden', isDark);
          themeIconDarkMobile?.classList.toggle('hidden', !isDark);
          try {
            localStorage.setItem('theme', theme);
          } catch (e) { console.warn("Could not save theme preference to localStorage:", e); }
          safelyCreateIcons();
      };

      const toggleTheme = () => { applyTheme(htmlElement.classList.contains('dark') ? 'light' : 'dark'); };

      const setActiveLink = (pageId) => {
          navLinks.forEach(link => {
              if (link instanceof HTMLElement) {
                  const isActive = link.dataset.page === pageId;
                  link.classList.toggle('text-primary', isActive);
                  link.classList.toggle('dark:text-primary-dark', isActive);
                  link.classList.toggle('font-semibold', isActive);
                  link.classList.toggle('bg-slate-100', isActive);
                  link.classList.toggle('dark:bg-slate-700', isActive);
                  link.classList.toggle('text-muted', !isActive);
                  link.classList.toggle('dark:text-muted-dark', !isActive);
                  link.classList.toggle('font-medium', !isActive);
              }
          });
          mobileNavLinks.forEach(link => {
             if (link instanceof HTMLElement) {
                 const isActive = link.dataset.page === pageId;
                 link.classList.toggle('text-primary', isActive);
                 link.classList.toggle('dark:text-primary-dark', isActive);
                 link.classList.toggle('bg-slate-100', isActive);
                 link.classList.toggle('dark:bg-slate-700', isActive);
                 link.classList.toggle('font-semibold', isActive);
                 link.classList.toggle('text-muted', !isActive);
                 link.classList.toggle('dark:text-muted-dark', !isActive);
                 link.classList.toggle('font-medium', !isActive);
             }
          });
      };

      const showPage = (pageId) => {
          if (!getElement(pageId)) pageId = 'dashboard'; // Default to dashboard if ID is invalid
          pages.forEach(page => page.classList.remove('active'));
          const targetPage = getElement(pageId);
          if (targetPage) targetPage.classList.add('active');
          else console.error(`Target page with ID "${pageId}" not found.`);

          setActiveLink(pageId);
          window.scrollTo(0, 0);
          safelyCreateIcons();

          // Handle subject targeting
          if (targetSubjectParam && targetSubjectParam.page === pageId) {
              handleSubjectSelection(targetSubjectParam.subject, pageId);
              targetSubjectParam = null; // Consume the parameter
          }

          // Page-specific load actions
          if (pageId === 'dashboard' && currentUserId) loadDashboard();
          if (pageId === 'pomodoro' && currentUserId) displayPomodoroSubjectTimes(); // NEW: Load subject times when Pomodoro page shown

          // Stop quiz if navigating away
           if (pageId !== 'quiz' && quizState.active) {
              stopQuizMode();
          }
      };

      const _navigateToPage = (pageId, param = null) => {
          console.log(`Navigating to page: ${pageId}` + (param ? ` with param: ${param}` : ''));
          // Store subject parameter ONLY if targeting a relevant page
          targetSubjectParam = (param && ['resources', 'tracker', 'quiz'].includes(pageId)) ? { page: pageId, subject: param } : null;
           // Reset currentActiveSubject if navigating away from subject-based pages
           if (!['resources', 'tracker', 'quiz'].includes(pageId)) {
              currentActiveSubject = null;
          }
          showPage(pageId);
          closeMobileMenu();
      };
      window.navigateToPage = _navigateToPage; // Expose for global use

      const openMobileMenu = () => {
          mobileMenu?.classList.add('open');
          mobileOverlay?.classList.remove('hidden');
          setTimeout(() => mobileOverlay?.classList.add('visible'), 10);
      };

      const closeMobileMenu = () => {
          mobileOverlay?.classList.remove('visible');
          mobileMenu?.classList.remove('open');
          setTimeout(() => mobileOverlay?.classList.add('hidden'), 350);
      };

      const createLoadingMessage = (text, isTableRow = false, colspan = 1) => {
          const p = document.createElement('p');
          p.className = 'text-muted dark:text-muted-dark italic p-4 text-center text-sm';
          p.textContent = text;
          if (isTableRow) {
              const td = document.createElement('td');
              td.colSpan = colspan;
              td.className = 'p-4';
              td.appendChild(p);
              const tr = document.createElement('tr');
              tr.appendChild(td);
              return tr.outerHTML;
          }
          return p.outerHTML;
      };

       const clearDynamicContentAndIntervals = () => {
          console.log("Clearing dynamic content and intervals...");
          if (countdownInterval) clearInterval(countdownInterval);
          if (pomodoroInterval) clearInterval(pomodoroInterval);
          countdownInterval = null;
          pomodoroInterval = null;
          document.title = DEFAULT_TITLE;

          const upcomingList = getElement('upcoming-exams-list');
          const pomodoroSummary = getElement('pomodoro-summary');
          const pomodoroAnalytics = getElement('pomodoro-analytics');
          const quoteEl = getElement('motivational-quote');
          const timetableBody = getElement('timetable-body');
          const pomodoroSubjectTimes = getElement('pomodoro-subject-times'); // NEW

          if (upcomingList) upcomingList.innerHTML = createLoadingMessage('Loading...');
          if (pomodoroSummary) pomodoroSummary.innerHTML = createLoadingMessage('No sessions logged.');
          if (pomodoroAnalytics) pomodoroAnalytics.innerHTML = createLoadingMessage('Loading analytics...');
          if (pomodoroSubjectTimes) pomodoroSubjectTimes.querySelector('div').innerHTML = ''; // Clear inner div NEW
          if (quoteEl) quoteEl.textContent = 'Loading quote...';
          if (timetableBody) timetableBody.innerHTML = createLoadingMessage('Loading timetable...', true, 6);

          if (subjectTabsContainer) subjectTabsContainer.innerHTML = '';
          if (resourceContent) resourceContent.innerHTML = createLoadingMessage('Select a subject.');
          if (addResourceDetails) { addResourceDetails.style.display = 'none'; addResourceDetails.removeAttribute('open'); }

          if (trackerSubjectSelect) trackerSubjectSelect.value = '';
          if (trackerItemsList) trackerItemsList.innerHTML = createLoadingMessage('Select a subject.');
          if (addTrackerDetails) { addTrackerDetails.style.display = 'none'; addTrackerDetails.removeAttribute('open'); }

          if (plannerSubjectSelect) plannerSubjectSelect.value = '';
          if (plannerItemsList) plannerItemsList.innerHTML = createLoadingMessage('No sessions scheduled.');
          if (plannerDateInput) plannerDateInput.value = '';
          if (plannerTimeInput) plannerTimeInput.value = '';
          if (plannerTopicInput) plannerTopicInput.value = '';

          if (quizSubjectSelect) quizSubjectSelect.value = '';
          if (quizContentWrapper) quizContentWrapper.classList.add('hidden');
          if (quizItemsList) quizItemsList.innerHTML = createLoadingMessage('Select a subject.');
          if (addQuizDetails) { addQuizDetails.style.display = 'none'; addQuizDetails.removeAttribute('open'); }
          if (quizModeInterface) quizModeInterface.classList.add('hidden');

          if (currentPasswordInput) currentPasswordInput.value = '';
          if (newPasswordInput) newPasswordInput.value = '';
          if (changePasswordMessage) changePasswordMessage.textContent = '';
          if (resourceTitleInput) resourceTitleInput.value = '';
          if (resourceUrlInput) resourceUrlInput.value = '';
          if (resourceNoteInput) resourceNoteInput.value = '';
          if (resourceTypeSelect) resourceTypeSelect.value = 'link';
          if (trackerDescriptionInput) trackerDescriptionInput.value = '';
          if (trackerStatusSelect) trackerStatusSelect.value = 'To Review';

          resetPomodoroTimer(true);
          quizState = { active: false, currentSubject: null, initialQuestions: [], currentQuizPool: [], incorrectlyAnswered: [], currentQuestionIndex: -1, round: 1, totalMastered: 0, isAnswerVisible: false, buttonTimeout: null };
          currentActiveSubject = null;
          targetSubjectParam = null;

          console.log("Dynamic content and intervals cleared.");
      };

      // --- Dashboard Loading ---
        const loadDashboard = async () => {
          if (!currentUserId || !db || !getElement('dashboard')?.classList.contains('active')) return;
          console.log("Loading dashboard data...");

          const upcomingList = getElement('upcoming-exams-list');
          const pomodoroSummaryEl = getElement('pomodoro-summary');
          const pomodoroAnalyticsEl = getElement('pomodoro-analytics');
          const quoteEl = getElement('motivational-quote');

          // Upcoming Exams
          if (upcomingList) {
              upcomingList.innerHTML = createLoadingMessage('Loading exams...');
              try {
                  const now = new Date();
                  const futureExams = examData.filter(exam => new Date(exam.date) > now).slice(0, 5);
                   upcomingList.innerHTML = '';
                  if (futureExams.length > 0) {
                      futureExams.forEach((exam, index) => {
                          const div = document.createElement('div');
                          div.className = `upcoming-exam-item p-3 rounded-lg border-l-4 ${getSubjectColor(exam.subject)} bg-background dark:bg-slate-800/50 shadow-sm list-item list-item-appear cursor-pointer hover:shadow-md dark:hover:shadow-widget-hover-dark`;
                          div.style.animationDelay = `${index * 0.07}s`;
                          div.dataset.page = "resources";
                          div.dataset.subject = exam.subject;
                          div.setAttribute('role', 'button');
                          div.setAttribute('tabindex', '0');
                          div.innerHTML = `
                              <div class="flex justify-between items-center mb-1 pointer-events-none">
                                  <span class="font-semibold text-text dark:text-text-dark">${escapeHtml(exam.subject)}</span>
                                  <span class="text-xs font-medium text-primary dark:text-primary-dark" data-date="${exam.date}">${formatCountdown(exam.date)}</span>
                              </div>
                              <p class="text-xs text-muted dark:text-muted-dark pointer-events-none">${escapeHtml(exam.paper)} (${escapeHtml(exam.duration)})</p>
                              <p class="text-xs text-muted dark:text-muted-dark pointer-events-none">${formatExamDate(exam.date)}</p>`;
                          upcomingList.appendChild(div);
                      });
                  } else {
                      upcomingList.innerHTML = createLoadingMessage('No upcoming exams found.');
                  }
              } catch (e) { console.error("Error rendering upcoming exams:", e); upcomingList.innerHTML = createLoadingMessage('Error loading exams.'); }
          }

          // Pomodoro Recent Sessions
          if (pomodoroSummaryEl) {
             pomodoroSummaryEl.innerHTML = createLoadingMessage('Loading sessions...');
              try {
                  const logColl = getUserCollectionRef(currentUserId, 'pomodoroLogs');
                  if (!logColl) throw new Error("Could not get pomodoroLogs collection ref.");
                  const logQuery = query(logColl, orderBy("timestamp", "desc"), limit(5));
                  const logSnapshot = await getDocs(logQuery);
                  pomodoroSummaryEl.innerHTML = '';
                  if (logSnapshot.empty) {
                      pomodoroSummaryEl.innerHTML = createLoadingMessage('No recent study sessions.');
                  } else {
                       logSnapshot.docs.forEach((logDoc, index) => {
                           const data = logDoc.data();
                           const p = document.createElement('p');
                           p.className = 'text-xs text-muted dark:text-muted-dark list-item-appear';
                           p.style.animationDelay = `${index * 0.06}s`;
                           const dateStr = data.timestamp ? formatGeneralDate(data.timestamp) : 'Recent';
                           p.innerHTML = `<i data-lucide="check-circle" class="h-3 w-3 text-green-500 mr-1"></i> ${escapeHtml(data.subject || 'Unknown Subject')} - ${formatMinutes(data.durationMinutes || 0)} <span class="text-gray-400 dark:text-gray-500">(${dateStr})</span>`;
                           pomodoroSummaryEl.appendChild(p);
                       });
                  }
              } catch (error) {
                  console.error("Error loading Pomodoro recent sessions:", error);
                  pomodoroSummaryEl.innerHTML = createLoadingMessage('Error loading sessions.');
              }
          }

          // Pomodoro Analytics (Dashboard)
          if (pomodoroAnalyticsEl) {
              pomodoroAnalyticsEl.innerHTML = createLoadingMessage('Loading analytics...');
               try {
                    const analyticsRef = getUserDataRef(currentUserId, 'stats/pomodoroAnalytics');
                    if (!analyticsRef) throw new Error("Could not get pomodoroAnalytics doc ref.");
                    const analyticsDoc = await getDoc(analyticsRef);
                    pomodoroAnalyticsEl.innerHTML = '';
                    if (analyticsDoc.exists()) {
                        const data = analyticsDoc.data();
                        const totalMins = data.totalMinutes || 0;
                        const totalSessions = data.totalSessions || 0;
                        const subjectMins = (data.subjectMinutes && typeof data.subjectMinutes === 'object') ? data.subjectMinutes : {};
                        let analyticsHTML = `<div class="space-y-3">`;
                        analyticsHTML += `<div class="flex justify-between items-baseline">
                                            <span class="text-sm text-muted dark:text-muted-dark">Total Study Time:</span>
                                            <span class="text-lg font-semibold text-text dark:text-text-dark">${formatMinutes(totalMins)}</span>
                                         </div>`;
                        analyticsHTML += `<div class="flex justify-between items-baseline">
                                            <span class="text-sm text-muted dark:text-muted-dark">Total Sessions:</span>
                                            <span class="text-lg font-semibold text-text dark:text-text-dark">${totalSessions}</span>
                                         </div>`;

                        const sortedSubjects = Object.entries(subjectMins).sort(([,a],[,b]) => b-a);

                        if(sortedSubjects.length > 0) {
                            analyticsHTML += `<hr class="border-slate-200 dark:border-slate-700 my-3">`;
                            analyticsHTML += `<h4 class="text-sm font-medium text-muted dark:text-muted-dark mb-2">Time per Subject:</h4><div class="space-y-2">`;
                            sortedSubjects.forEach(([subjectKey, mins]) => {
                                // NOTE: subjectKey might be SANITIZED ('_'). Displaying as is.
                                // Using original subject names (from `subjects` array) if possible for color,
                                // but might require mapping sanitized keys back if they differ significantly.
                                const originalSubject = subjects.find(s => s.replace(/[.*$#[\]/]/g, '_') === subjectKey) || subjectKey;
                                const colorBorderClass = getSubjectColor(originalSubject).split(' ')[0];
                                analyticsHTML += `<div class="analytics-item flex justify-between items-center text-sm ${colorBorderClass}">
                                                    <span class="text-text dark:text-text-dark">${escapeHtml(subjectKey)}</span>
                                                    <span class="font-medium text-muted dark:text-muted-dark">${formatMinutes(mins)}</span>
                                                  </div>`;
                            });
                            analyticsHTML += `</div>`;
                        } else if (totalMins > 0) {
                            analyticsHTML += `<p class="text-xs mt-2 text-muted dark:text-muted-dark italic">Keep tracking to see subject breakdown!</p>`;
                        }
                        analyticsHTML += `</div>`;
                        pomodoroAnalyticsEl.innerHTML = analyticsHTML;
                    } else {
                        pomodoroAnalyticsEl.innerHTML = createLoadingMessage('No study analytics yet. Complete a Pomodoro session!');
                    }
               } catch(error) {
                    console.error("Error loading Pomodoro analytics:", error);
                    pomodoroAnalyticsEl.innerHTML = createLoadingMessage('Error loading analytics.');
               }
          }

          // Motivational Quote
          if (quoteEl) {
              quoteEl.textContent = motivationalQuotes[Math.floor(Math.random() * motivationalQuotes.length)];
          }

          safelyCreateIcons();
          console.log("Dashboard data loaded.");
      };

      // --- Timetable ---
        const loadTimetable = () => {
          const tbody = getElement('timetable-body');
          if (!tbody) { console.error("Timetable tbody missing!"); return; }
          tbody.innerHTML = '';
          let lastDateStr = null;
          if (!examData || examData.length === 0) {
              tbody.innerHTML = createLoadingMessage('Timetable data unavailable.', true, 6);
              return;
          }
          examData.forEach((exam, index) => {
              try {
                  const tr = document.createElement('tr');
                  const currentDate = new Date(exam.date);
                  if (isNaN(currentDate.getTime())) {
                      console.warn("Skipping exam with invalid date:", exam);
                      return;
                  }
                  const currentDateStr = currentDate.toDateString();
                  if (lastDateStr && currentDateStr !== lastDateStr) {
                      tr.classList.add('timetable-new-day');
                  }
                  lastDateStr = currentDateStr;
                  const colorClasses = getSubjectColor(exam.subject).split(' ');
                  const rgbColor = getSubjectColorRGB(exam.subject);
                  tr.classList.add('text-sm', 'align-middle');
                  const subjectColorVar = colorClasses.find(c => c.startsWith('border-'))?.replace('border-', 'text-') || 'text-slate-700';
                  const darkSubjectColorVar = colorClasses.find(c => c.startsWith('dark:border-'))?.replace('dark:border-', 'dark:text-') || 'dark:text-slate-300';

                  tr.innerHTML = `
                      <td class="timetable-subject-cell pl-4 pr-3 py-4 font-medium text-text dark:text-text-dark whitespace-nowrap border-l-4 ${colorClasses.join(' ')}" style="--subject-rgb: ${rgbColor};">
                          <span class="timetable-subject-text ${subjectColorVar} ${darkSubjectColorVar}">${escapeHtml(exam.subject)}</span>
                          <br><span class="text-xs text-muted dark:text-muted-dark">${escapeHtml(exam.paper)}</span>
                      </td>
                      <td class="px-3 py-4 text-muted dark:text-muted-dark whitespace-nowrap">${formatExamDate(exam.date)}</td>
                      <td class="px-3 py-4 text-muted dark:text-muted-dark whitespace-nowrap">${escapeHtml(exam.duration)}</td>
                      <td class="px-3 py-4 text-muted dark:text-muted-dark whitespace-nowrap">${escapeHtml(exam.board)}${exam.tier ? ` (${escapeHtml(exam.tier)})` : ''}</td>
                      <td class="px-3 py-4 text-muted dark:text-muted-dark whitespace-nowrap">${escapeHtml(exam.location || 'N/A')}${exam.seat ? ` (Seat: ${escapeHtml(exam.seat)})` : ''}</td>
                      <td class="pl-3 pr-4 py-4 text-muted dark:text-muted-dark whitespace-nowrap countdown-cell" data-date="${exam.date}">${formatCountdown(exam.date)}</td>`;
                  tbody.appendChild(tr);
              } catch (rowError) {
                  console.error(`Error creating timetable row ${index}:`, rowError, exam);
              }
          });
          safelyCreateIcons();
          updateTimetableCountdowns();
          console.log("Timetable loaded.");
      };

      const updateTimetableCountdowns = () => {
           if (!appWrapper || appWrapper.classList.contains('hidden') || !currentUserId) return;
           document.querySelectorAll('.countdown-cell[data-date]').forEach(cell => {
                if (cell instanceof HTMLElement && cell.dataset.date) {
                    cell.innerHTML = formatCountdown(cell.dataset.date);
                }
            });
           getElement('upcoming-exams-list')?.querySelectorAll('[data-date]').forEach(span => {
                 if (span instanceof HTMLElement && span.dataset.date) {
                     span.innerHTML = formatCountdown(span.dataset.date);
                 }
             });
      };


      // --- Content Switching Animation ---
        const animateContentSwitch = async (containerElement, displayFunction, subject) => {
          if (!containerElement) return;
          containerElement.classList.add('content-fade-out');
          await new Promise(resolve => setTimeout(resolve, 150));

          containerElement.innerHTML = '';
          containerElement.classList.remove('content-fade-out');
          await displayFunction(subject); // Assuming displayFunction might be async

          containerElement.classList.add('content-fade-in');
          setTimeout(() => containerElement.classList.remove('content-fade-in'), 300);
      };


      // --- Subject Selection Logic ---
        const handleSubjectSelection = (subject, context) => {
          const isValidSubject = subjects.includes(subject);
          console.log(`Subject selected: ${subject} (Valid: ${isValidSubject}) in context: ${context}`);
          currentActiveSubject = isValidSubject ? subject : null;

          const toggleDetailsVisibility = (detailsId) => {
              const detailsElement = getElement(detailsId);
              if (detailsElement) {
                  detailsElement.style.display = isValidSubject ? 'block' : 'none';
                  if (!isValidSubject && detailsElement.hasAttribute('open')) {
                      detailsElement.removeAttribute('open');
                  }
              }
          };

          if (context === 'resources') {
              setActiveSubjectTab(currentActiveSubject);
              toggleDetailsVisibility('add-resource-details');
              if (isValidSubject) {
                  if(resourceTitleInput) resourceTitleInput.value = '';
                  if(resourceUrlInput) resourceUrlInput.value = '';
                  if(resourceNoteInput) resourceNoteInput.value = '';
                  if(resourceTypeSelect) resourceTypeSelect.value = 'link';
                  toggleResourceTypeFields();
                  validateResourceForm();
                  animateContentSwitch(resourceContent, displayResources, currentActiveSubject);
              } else {
                  if(resourceContent) resourceContent.innerHTML = createLoadingMessage('Select a subject tab above.');
              }
          } else if (context === 'tracker') {
              toggleDetailsVisibility('add-tracker-details');
              if (isValidSubject) {
                   if(trackerDescriptionInput) trackerDescriptionInput.value = '';
                   if(trackerStatusSelect) trackerStatusSelect.value = 'To Review';
                   validateTrackerForm();
                   animateContentSwitch(trackerItemsList, displayTrackerItems, currentActiveSubject);
              } else {
                   if(trackerItemsList) trackerItemsList.innerHTML = createLoadingMessage('Select a subject.');
              }
          } else if (context === 'quiz') {
              stopQuizMode();
              toggleDetailsVisibility('add-quiz-details');
               if (quizContentWrapper) quizContentWrapper.classList.toggle('hidden', !isValidSubject);
              if (isValidSubject) {
                  if(quizQuestionInput) quizQuestionInput.value = '';
                  if(quizAnswerInput) quizAnswerInput.value = '';
                  if(quizQuestionFileInput) quizQuestionFileInput.value = '';
                  if(quizAnswerFileInput) quizAnswerFileInput.value = '';
                  validateQuizForm();
                  animateContentSwitch(quizItemsList, displaySavedQuizQuestions, currentActiveSubject);
              } else {
                   if(quizItemsList) quizItemsList.innerHTML = createLoadingMessage('Select a subject.');
                   toggleQuizButtons();
              }
          }
      };


      // --- Resources ---
       const loadResources = () => {
           if (!subjectTabsContainer) { console.error("Resource subject tabs container not found."); return; }
           subjectTabsContainer.innerHTML = '';
            if (!subjects || subjects.length === 0) {
                subjectTabsContainer.innerHTML = '<p class="text-sm text-muted p-2">No subjects defined.</p>';
                return;
            }
            subjects.forEach(subject => {
                const button = document.createElement('button');
                button.setAttribute('role', 'tab');
                button.setAttribute('aria-selected', 'false');
                button.dataset.subject = subject;
                button.className = `subject-tab whitespace-nowrap py-2 px-3 text-sm font-medium rounded-t-lg border-b-2 border-transparent text-muted dark:text-muted-dark hover:text-primary dark:hover:text-primary-dark hover:border-slate-300 dark:hover:border-slate-600 focus:outline-none focus-visible:ring-1 focus-visible:ring-primary focus-visible:ring-offset-1 transition-colors duration-150`;
                button.textContent = subject;
                subjectTabsContainer.appendChild(button);
            });

            if (addResourceDetails) addResourceDetails.style.display = 'none';
            if(resourceContent) resourceContent.innerHTML = createLoadingMessage('Select a subject tab above.');
            validateResourceForm();
            console.log("Resources tab initialized.");
      };

      const toggleResourceTypeFields = () => {
          if (!resourceTypeSelect || !resourceUrlWrapper || !resourceNoteWrapper) return;
           const isLink = resourceTypeSelect.value === 'link';
           resourceUrlWrapper.classList.toggle('visible', isLink);
           resourceNoteWrapper.classList.toggle('visible', !isLink);
           if (isLink && resourceNoteInput) resourceNoteInput.value = '';
           else if (!isLink && resourceUrlInput) resourceUrlInput.value = '';
           validateResourceForm();
      };

      const validateResourceForm = () => {
           if (!saveResourceBtn || !resourceTitleInput || !resourceTypeSelect) {
                if(saveResourceBtn) saveResourceBtn.disabled = true;
                return;
            }
            let isValid = !!currentActiveSubject && resourceTitleInput.value.trim() !== '';
            if (isValid) {
                 if (resourceTypeSelect.value === 'link') {
                     isValid = resourceUrlInput && resourceUrlInput.value.trim() !== '' && resourceUrlInput.checkValidity();
                 } else if (resourceTypeSelect.value === 'note') {
                     isValid = resourceNoteInput && resourceNoteInput.value.trim() !== '';
                 } else {
                     isValid = false;
                 }
            }
            saveResourceBtn.disabled = !isValid;
      };

      const setActiveSubjectTab = (subject) => {
           document.querySelectorAll('#subject-tabs .subject-tab').forEach(tab => {
               if (tab instanceof HTMLElement) {
                    const isSelected = tab.dataset.subject === subject;
                    tab.setAttribute('aria-selected', isSelected.toString());
                    tab.classList.toggle('border-primary', isSelected);
                    tab.classList.toggle('dark:border-primary-dark', isSelected);
                    tab.classList.toggle('text-primary', isSelected);
                    tab.classList.toggle('dark:text-primary-dark', isSelected);
                    tab.classList.toggle('font-semibold', isSelected);
                    tab.classList.toggle('border-transparent', !isSelected);
                    tab.classList.toggle('text-muted', !isSelected);
                    tab.classList.toggle('dark:text-muted-dark', !isSelected);
                    tab.classList.toggle('font-medium', !isSelected);
               }
           });
      };

      const displayResources = async (subject) => {
           if (!currentUserId || !resourceContent || !db) {
                if(resourceContent) resourceContent.innerHTML = createLoadingMessage('Cannot load resources: Not logged in or DB unavailable.');
                return;
            }
           resourceContent.innerHTML = createLoadingMessage(`Loading ${subject} resources...`);
           try {
                const collRef = getSubjectSpecificCollectionRef(currentUserId, 'resources', subject);
                if (!collRef) throw new Error("Could not get resources collection ref.");

                const q = query(collRef, orderBy("createdAt", "desc"));
                const snapshot = await getDocs(q);
                const items = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));

                resourceContent.innerHTML = '';
                if (items.length === 0) {
                     resourceContent.innerHTML = createLoadingMessage(`No resources saved for ${subject} yet.`);
                } else {
                     const ul = document.createElement('ul');
                     ul.className = 'space-y-3';
                     items.forEach((item, index) => {
                        const li = document.createElement('li');
                        const itemSubject = item.subject || subject;
                        li.className = `resource-item list-item flex justify-between items-start p-3 rounded-lg border bg-background dark:bg-slate-800/50 hover:bg-slate-50 dark:hover:bg-slate-700/50 transition-all duration-150 space-x-3 ${getSubjectColor(itemSubject).replace('border-l-4', 'border')}`;

                        let contentHtml = '';
                        if (item.type === 'link' && item.url) {
                            contentHtml = `
                                <a href="${escapeHtml(item.url)}" target="_blank" rel="noopener noreferrer" class="flex items-center space-x-2 group focus-visible:outline focus-visible:outline-1 focus-visible:outline-primary rounded -m-1 p-1">
                                    <i data-lucide="link" class="h-4 w-4 text-primary dark:text-primary-dark flex-shrink-0"></i>
                                    <span class="font-medium text-sm text-text dark:text-text-dark group-hover:underline">${escapeHtml(item.title)}</span>
                                    <i data-lucide="external-link" class="h-3 w-3 text-muted dark:text-muted-dark opacity-0 group-hover:opacity-100 transition-opacity"></i>
                                </a>`;
                        } else if (item.type === 'note') {
                             contentHtml = `
                                 <div class="flex items-start space-x-2">
                                     <i data-lucide="notebook-pen" class="h-4 w-4 text-secondary dark:text-secondary-dark flex-shrink-0 mt-0.5"></i>
                                     <div>
                                         <p class="font-medium text-sm text-text dark:text-text-dark">${escapeHtml(item.title)}</p>
                                         <p class="text-xs text-muted dark:text-muted-dark mt-1 whitespace-pre-wrap">${escapeHtml(item.noteContent || '')}</p>
                                     </div>
                                 </div>`;
                         } else {
                             contentHtml = `<p class="font-medium text-sm text-text dark:text-text-dark">${escapeHtml(item.title)}</p>`;
                         }
                         li.innerHTML = `
                            <div class="flex-grow mr-2 overflow-hidden">${contentHtml}</div>
                            <button title="Delete Resource" class="list-delete-btn flex-shrink-0 p-1 -m-1 rounded-full btn-animated focus-visible:ring-1 focus-visible:ring-red-500" onclick="window.handleGenericDeleteItem('resources', '${escapeHtml(subject)}', '${item.id}', 'resource', window.displayResources)">
                                <i data-lucide="trash-2" class="h-4 w-4"></i>
                            </button>`;
                         ul.appendChild(li);
                     });
                     resourceContent.appendChild(ul);
                     applyStaggerAnimation(ul.children);
                     safelyCreateIcons();
                }
           } catch (error) {
                console.error(`Error loading resources for ${subject}:`, error);
                resourceContent.innerHTML = createLoadingMessage(`Error loading resources for ${subject}. Check console.`);
           }
      };
       window.displayResources = displayResources; // Expose for onclick

      const handleSaveResource = async () => {
           if (!currentUserId || !currentActiveSubject || !saveResourceBtn || !db) {
               alert("Cannot save resource: Missing user, subject, or database connection.");
               return;
            }
           validateResourceForm();
           if (saveResourceBtn.disabled) return;

           const type = resourceTypeSelect.value;
           const title = resourceTitleInput.value.trim();
           const url = resourceUrlInput.value.trim();
           const noteContent = resourceNoteInput.value.trim();

           const newResource = { title, type, createdAt: serverTimestamp(), subject: currentActiveSubject };
           if (type === 'link') newResource.url = url;
           else if (type === 'note') newResource.noteContent = noteContent;

           saveResourceBtn.disabled = true;
           saveResourceBtn.textContent = 'Saving...';
           try {
                const collRef = getSubjectSpecificCollectionRef(currentUserId, 'resources', currentActiveSubject);
                if (!collRef) throw new Error("Could not get resources collection ref.");
                await addDoc(collRef, newResource);
                console.log("Resource saved successfully.");
                if (resourceTitleInput) resourceTitleInput.value = '';
                if (resourceUrlInput) resourceUrlInput.value = '';
                if (resourceNoteInput) resourceNoteInput.value = '';
                if (resourceTypeSelect) resourceTypeSelect.value = 'link';
                toggleResourceTypeFields();
                if (addResourceDetails) addResourceDetails.open = false;
                displayResources(currentActiveSubject); // Refresh list
           } catch (error) {
                console.error("Error saving resource:", error);
                alert("Failed to save resource. Please try again.");
           } finally {
                saveResourceBtn.disabled = false;
                saveResourceBtn.textContent = 'Add Resource';
                validateResourceForm();
           }
      };


      // --- Pomodoro Timer Logic ---
      const ringCircumference = progressRing ? 2 * Math.PI * parseFloat(progressRing.getAttribute('r') || '45') : 283;
      if (progressRing) {
          progressRing.style.strokeDasharray = `${ringCircumference} ${ringCircumference}`;
          progressRing.style.strokeDashoffset = ringCircumference;
      }

      const loadPomodoroState = () => {
          try {
              const savedState = localStorage.getItem(POMODORO_STORAGE_KEY);
              if (savedState) {
                   const parsedState = JSON.parse(savedState);
                   if (parsedState && typeof parsedState.currentSeconds === 'number' && typeof parsedState.totalSeconds === 'number') {
                       pomodoroState = { ...pomodoroState, ...parsedState };
                       console.log("Pomodoro state loaded from localStorage:", pomodoroState);

                       // Restore duration input values (might differ from totalSeconds if changed while stopped)
                       if (workDurationInput) workDurationInput.value = parsedState.workDuration || 25;
                       if (shortBreakDurationInput) shortBreakDurationInput.value = parsedState.shortBreakDuration || 5;
                       if (longBreakDurationInput) longBreakDurationInput.value = parsedState.longBreakDuration || 15;

                       // Restore subject if in work mode
                       if (pomodoroSubjectSelect && pomodoroState.timerMode === 'work') pomodoroSubjectSelect.value = pomodoroState.workSessionSubject || "";

                       // Restore timer based on saved state and end time
                       if (pomodoroState.timerState === 'running' && pomodoroState.timerEndTime) {
                           const now = Date.now();
                           const remainingSeconds = Math.max(0, Math.round((pomodoroState.timerEndTime - now) / 1000));
                           pomodoroState.currentSeconds = remainingSeconds;

                           if (remainingSeconds > 0) {
                               console.log(`Resuming running timer with ${remainingSeconds}s left.`);
                               startPomodoroTimerInterval(); // Restart interval
                               updatePomodoroUIState('running');
                           } else {
                               console.log("Timer finished while tab was inactive.");
                               handlePomodoroCompletion(true); // Trigger completion logic (silent)
                               savePomodoroState(); // Save the new state after completion
                           }
                       } else if (pomodoroState.timerState === 'paused') {
                            console.log("Restoring paused timer state.");
                            setTimerMode(pomodoroState.timerMode, false); // Ensure UI (ring color, title) matches mode
                            updatePomodoroUIState('paused');
                            updateTimerDisplay(); // Display the paused time
                       } else { // 'stopped'
                           console.log("Restoring stopped timer state.");
                           setTimerMode(pomodoroState.timerMode || 'work', false); // Set mode and reset timer display/UI
                           updatePomodoroUIState('stopped');
                       }
                       return true; // State loaded successfully
                   } else {
                       console.warn("Invalid Pomodoro state found in localStorage.");
                       localStorage.removeItem(POMODORO_STORAGE_KEY);
                   }
              }
          } catch (e) {
              console.error("Error loading Pomodoro state from localStorage:", e);
              localStorage.removeItem(POMODORO_STORAGE_KEY);
          }
           // If load failed or no state found, initialize default
          return false;
      };

      const savePomodoroState = () => {
          try {
              // Include current duration settings in saved state
              const stateToSave = {
                  ...pomodoroState,
                  workDuration: parseInt(workDurationInput?.value || '25'),
                  shortBreakDuration: parseInt(shortBreakDurationInput?.value || '5'),
                  longBreakDuration: parseInt(longBreakDurationInput?.value || '15'),
              };
              localStorage.setItem(POMODORO_STORAGE_KEY, JSON.stringify(stateToSave));
          } catch (e) {
              console.error("Error saving Pomodoro state to localStorage:", e);
          }
      };

       const stopPomodoroTimer = (clearStorage = false) => {
           if (pomodoroInterval) {
               clearInterval(pomodoroInterval);
               pomodoroInterval = null;
               console.log("Pomodoro interval cleared.");
           }
           pomodoroState.timerState = 'stopped';
           pomodoroState.timerEndTime = null;
           updatePomodoroUIState('stopped');
           // Reset title only if it's currently showing a timer
           if (document.title !== DEFAULT_TITLE) {
               document.title = DEFAULT_TITLE;
           }

           if (clearStorage) {
               try {
                   localStorage.removeItem(POMODORO_STORAGE_KEY);
                   console.log("Pomodoro localStorage cleared.");
               } catch (e) { console.error("Error clearing Pomodoro state from localStorage:", e);}
           } else {
               savePomodoroState(); // Save the stopped state
           }
       };

        const updatePomodoroUIState = (newState) => {
            if (!startPauseButton || !pomodoroSubjectSelect) return;

            const isRunning = newState === 'running';
            const isPaused = newState === 'paused';

            if (isRunning) {
                startPauseButton.innerHTML = `<i data-lucide="pause" class="h-5 w-5"></i> <span>Pause</span>`;
            } else if (isPaused) {
                startPauseButton.innerHTML = `<i data-lucide="play" class="h-5 w-5"></i> <span>Resume</span>`;
            } else { // stopped
                startPauseButton.innerHTML = `<i data-lucide="play" class="h-5 w-5"></i> <span>Start</span>`;
            }

            const disableControls = isRunning || isPaused;
            modeButtons.forEach(btn => { if (btn) btn.disabled = disableControls; });
            // Also disable duration inputs when running/paused
            if(workDurationInput) workDurationInput.disabled = disableControls;
            if(shortBreakDurationInput) shortBreakDurationInput.disabled = disableControls;
            if(longBreakDurationInput) longBreakDurationInput.disabled = disableControls;

            pomodoroSubjectSelect.disabled = disableControls || pomodoroState.timerMode !== 'work';
            if(startPauseButton) startPauseButton.disabled = false; // Start/Pause/Resume is always enabled unless mid-action

            safelyCreateIcons();
        };


       const updateTimerDisplay = () => {
           if (!timerDisplay || !progressRing) return;

           const minutes = Math.max(0, Math.floor(pomodoroState.currentSeconds / 60));
           const seconds = Math.max(0, pomodoroState.currentSeconds % 60);
           const timeString = `${minutes}:${seconds < 10 ? '0' : ''}${seconds}`;
           timerDisplay.textContent = timeString;

           const progress = pomodoroState.totalSeconds > 0 ? Math.min(1, Math.max(0, (pomodoroState.totalSeconds - pomodoroState.currentSeconds) / pomodoroState.totalSeconds)) : 0;
           const offset = ringCircumference * (1 - progress);
           progressRing.style.strokeDashoffset = Math.max(0, Math.min(ringCircumference, offset));

           // Update Tab Title
           if (pomodoroState.timerState === 'running') {
                let modeLabel = "Focus";
                if (pomodoroState.timerMode === 'shortBreak') modeLabel = "Short Break";
                else if (pomodoroState.timerMode === 'longBreak') modeLabel = "Long Break";
                document.title = `${timeString} - ${modeLabel} | ${DEFAULT_TITLE}`;
           } else {
               // Reset title if it's currently showing a timer value
               if (document.title !== DEFAULT_TITLE) {
                   document.title = DEFAULT_TITLE;
               }
           }
       };


       const setActiveModeButton = (activeMode) => {
           modeButtons.forEach(btn => {
               if (btn) btn.classList.toggle('active', btn.dataset.mode === activeMode);
           });
           if (pomodoroSubjectWrapper) {
               pomodoroSubjectWrapper.style.display = activeMode === 'work' ? 'block' : 'none';
           }
            if(pomodoroSubjectSelect) {
                pomodoroSubjectSelect.disabled = activeMode !== 'work' || pomodoroState.timerState !== 'stopped';
            }
       };


       const handleDurationChange = (mode) => {
           // Only reset the timer if the duration for the *current* inactive mode is changed
           if (pomodoroState.timerState !== 'running' && pomodoroState.timerMode === mode) {
               console.log(`Duration changed for current mode: ${mode}. Resetting timer.`);
               setTimerMode(mode, false); // This will read the new value and update totalSeconds
           } else {
               // If changing duration for a *different* mode, just save the new value for later
               savePomodoroState();
           }
       };

        const setTimerMode = (mode, fromInteraction = false) => {
           if (!timerStatus || !progressRing || !workDurationInput || !shortBreakDurationInput || !longBreakDurationInput || !pomodoroModeTitle) {
               console.error("Cannot set timer mode: Missing essential UI elements.");
               return;
           }

            // Prevent switching mode if timer is running *and* it was a direct button click
           if (pomodoroState.timerState === 'running' && fromInteraction) {
               const buttonToShake = modeButtons.find(btn => btn?.dataset.mode === mode);
               buttonToShake?.classList.add('shake-horizontal');
               setTimeout(() => buttonToShake?.classList.remove('shake-horizontal'), 400);
               console.log("Cannot switch mode while timer is running.");
               return;
           }

           stopPomodoroTimer(false); // Stop current interval/state but keep localStorage

           pomodoroState.timerMode = mode;
           pomodoroState.pomodoroCycle = parseInt(localStorage.getItem('pomodoroCycle') || '0');


           let title = '', durationInput, ringColorClass = 'text-primary dark:text-primary-dark';
           switch (mode) {
               case 'work':
                    durationInput = workDurationInput;
                    title = 'Focus Session';
                    if(timerStatus) timerStatus.textContent = 'Work';
                    if (pomodoroSubjectSelect && pomodoroState.workSessionSubject) {
                        pomodoroSubjectSelect.value = pomodoroState.workSessionSubject;
                    }
                    break;
               case 'shortBreak':
                    durationInput = shortBreakDurationInput;
                    title = 'Short Break';
                     if(timerStatus) timerStatus.textContent = 'Short Break';
                    ringColorClass = 'text-emerald-500 dark:text-emerald-400';
                    break;
               case 'longBreak':
                    durationInput = longBreakDurationInput;
                    title = 'Long Break';
                     if(timerStatus) timerStatus.textContent = 'Long Break';
                    ringColorClass = 'text-sky-500 dark:text-sky-400';
                    break;
               default:
                    console.error("Invalid timer mode requested:", mode);
                    durationInput = workDurationInput;
                    pomodoroState.timerMode = 'work';
                    title = 'Focus Session';
                     if(timerStatus) timerStatus.textContent = 'Work';
           }

           let newDuration = parseInt(durationInput?.value || (mode === 'work' ? '25' : (mode === 'shortBreak' ? '5' : '15')));
           pomodoroState.totalSeconds = (!isNaN(newDuration) && newDuration > 0) ? newDuration * 60 : (25 * 60); // Fallback duration
           pomodoroState.currentSeconds = pomodoroState.totalSeconds;
           pomodoroState.timerState = 'stopped'; // Explicitly set to stopped
           pomodoroState.timerEndTime = null;

           if(pomodoroModeTitle) pomodoroModeTitle.textContent = title;
           setActiveModeButton(mode);
           updateTimerDisplay(); // Update clock and ring to full

           if (progressRing) {
               progressRing.classList.remove('text-primary', 'dark:text-primary-dark', 'text-emerald-500', 'dark:text-emerald-400', 'text-sky-500', 'dark:text-sky-400');
               progressRing.classList.add(...ringColorClass.split(' '));
           }

           updatePomodoroUIState('stopped'); // Ensure buttons/inputs are enabled
           savePomodoroState(); // Save the newly set mode and duration
           console.log(`Timer mode set to: ${mode}, Duration: ${pomodoroState.totalSeconds}s`);
       };


      const addPomodoroLogAndAnalytics = async (subject, durationMinutes) => {
            if (!currentUserId || !subject || !db) {
                console.error("Cannot log Pomodoro: Missing userId, subject, or DB connection.");
                return;
            }
             if (durationMinutes < 1) {
                console.warn("Pomodoro duration is less than 1 minute, not logging.");
                return;
            }

            // Use original subject name for logging, sanitize only for Firestore field key
            const sanitizedSubjectKey = subject.replace(/[.*$#[\]/]/g, '_');

            if (!sanitizedSubjectKey) {
                console.error("Cannot log Pomodoro: Subject name resulted in empty key after sanitization:", subject);
                 try {
                     const logColl = getUserCollectionRef(currentUserId, 'pomodoroLogs');
                      if (logColl) {
                         await addDoc(logColl, {
                             subject: subject, // Log original name
                             durationMinutes,
                             timestamp: serverTimestamp()
                         });
                         console.log("Logged Pomodoro session (without analytics due to key issue).");
                         if (getElement('dashboard')?.classList.contains('active')) loadDashboard();
                     }
                 } catch (logError) { console.error("Error logging Pomodoro session (even without analytics):", logError);}
                 return;
            }

            console.log(`Logging Pomodoro: Subject='${subject}', SanitizedKey='${sanitizedSubjectKey}', Duration=${durationMinutes}m`);

            const logCollRef = getUserCollectionRef(currentUserId, 'pomodoroLogs');
            const analyticsRef = getUserDataRef(currentUserId, 'stats/pomodoroAnalytics');

            if (!logCollRef || !analyticsRef) {
                 console.error("Could not get Firestore references for Pomodoro logging.");
                 return;
            }

            try {
                const batch = writeBatch(db);

                // Log entry with original subject name
                batch.set(doc(logCollRef), {
                    subject: subject,
                    durationMinutes,
                    timestamp: serverTimestamp()
                });

                // Update analytics using sanitized key
                const updateData = {
                    totalSessions: increment(1),
                    totalMinutes: increment(durationMinutes),
                    [`subjectMinutes.${sanitizedSubjectKey}`]: increment(durationMinutes)
                };
                batch.set(analyticsRef, updateData, { merge: true });

                await batch.commit();
                console.log("Pomodoro log and analytics updated successfully via batch.");

                // Refresh dashboard if visible
                if (getElement('dashboard')?.classList.contains('active')) {
                    loadDashboard();
                }
                // Refresh Pomodoro page subject times if visible (NEW)
                if (getElement('pomodoro')?.classList.contains('active')) {
                     displayPomodoroSubjectTimes();
                }
            } catch (error) {
                console.error("Error logging Pomodoro using batch write:", error);
                 console.error("Attempted data:", { subject, sanitizedSubjectKey, durationMinutes });
            }
      };

      // NEW: Function to display subject times on Pomodoro page
      const displayPomodoroSubjectTimes = async () => {
          const container = pomodoroSubjectTimesContainer?.querySelector('div');
          if (!currentUserId || !db || !container) {
                if (container) container.innerHTML = createLoadingMessage('Cannot load times: Missing user/DB.');
                return;
            }
          container.innerHTML = createLoadingMessage('Loading subject times...');
          try {
              const analyticsRef = getUserDataRef(currentUserId, 'stats/pomodoroAnalytics');
              if (!analyticsRef) throw new Error("Could not get pomodoroAnalytics doc ref.");
              const analyticsDoc = await getDoc(analyticsRef);
              container.innerHTML = ''; // Clear loading message

              if (analyticsDoc.exists()) {
                   const data = analyticsDoc.data();
                   const subjectMins = (data.subjectMinutes && typeof data.subjectMinutes === 'object') ? data.subjectMinutes : {};
                   const sortedSubjects = Object.entries(subjectMins).sort(([,a],[,b]) => b-a);

                   if (sortedSubjects.length > 0) {
                        sortedSubjects.forEach(([subjectKey, mins]) => {
                           // Attempt to find original subject name for color, fallback to key
                           const originalSubject = subjects.find(s => s.replace(/[.*$#[\]/]/g, '_') === subjectKey) || subjectKey;
                           const colorBorderClass = getSubjectColor(originalSubject).split(' ')[0];
                           const div = document.createElement('div');
                           div.className = `subject-time-item flex justify-between items-center text-sm ${colorBorderClass}`;
                           div.innerHTML = `
                                <span class="text-text dark:text-text-dark">${escapeHtml(subjectKey)}</span>
                                <span class="font-medium text-muted dark:text-muted-dark">${formatMinutes(mins)}</span>
                            `;
                           container.appendChild(div);
                        });
                   } else {
                        container.innerHTML = createLoadingMessage('No time tracked yet.');
                   }
              } else {
                   container.innerHTML = createLoadingMessage('No time tracked yet.');
              }
              safelyCreateIcons(); // If any icons were used (though unlikely here)
          } catch(error) {
               console.error("Error loading Pomodoro subject times:", error);
               container.innerHTML = createLoadingMessage('Error loading times.');
          }
      };


      const startPomodoroTimerInterval = () => {
           if (pomodoroInterval) clearInterval(pomodoroInterval); // Clear any existing interval

           pomodoroState.timerState = 'running';
           // Set end time ONLY if it's not already set (e.g., resuming from pause)
           if (!pomodoroState.timerEndTime || pomodoroState.timerState === 'stopped') { // Check if stopped too
               pomodoroState.timerEndTime = Date.now() + pomodoroState.currentSeconds * 1000;
           }
           savePomodoroState(); // Save the running state and potentially new end time
           updatePomodoroUIState('running'); // Update buttons etc.
           updateTimerDisplay(); // Initial display update

           pomodoroInterval = setInterval(() => {
                // Calculate remaining time based on the fixed end time
                const now = Date.now();
                const remainingMillis = pomodoroState.timerEndTime - now;
                pomodoroState.currentSeconds = Math.max(0, Math.round(remainingMillis / 1000));

                updateTimerDisplay(); // Update clock, ring, and title

                if (pomodoroState.currentSeconds <= 0) {
                    handlePomodoroCompletion(false); // Trigger completion logic
                }
           }, 1000); // Tick every second
            console.log("Pomodoro interval started/resumed.");
      };

       const handlePomodoroCompletion = (fromLoad = false) => {
            if (pomodoroInterval) clearInterval(pomodoroInterval);
            pomodoroInterval = null;
            const finishedMode = pomodoroState.timerMode;
            const workDuration = parseInt(workDurationInput?.value || '25'); // Get duration *at time of completion*
            let nextMode = 'work';
            let alertMessage = '';

            console.log(`Pomodoro finished mode: ${finishedMode}`);

            // Log and update cycle only if a work session finished
            if (finishedMode === 'work') {
                pomodoroState.pomodoroCycle++;
                try { localStorage.setItem('pomodoroCycle', pomodoroState.pomodoroCycle.toString()); }
                catch (e) { console.warn("Could not save pomodoro cycle to localStorage", e);}

                // Log only if a subject was selected and duration was positive
                if (pomodoroState.workSessionSubject && workDuration > 0) {
                     addPomodoroLogAndAnalytics(pomodoroState.workSessionSubject, workDuration); // Log occurs here
                } else {
                    console.warn("Work session finished but no subject selected or duration zero, not logging.");
                }

                // Determine next mode
                nextMode = (pomodoroState.pomodoroCycle % 4 === 0) ? 'longBreak' : 'shortBreak';
                alertMessage = `Focus session complete! Time for a ${nextMode === 'longBreak' ? 'long' : 'short'} break.`;

            } else { // Break finished
                 alertMessage = "Break's over! Time to get back to focus.";
                 nextMode = 'work';
            }

            // Show alert only if triggered naturally, not from background load completion
            if (alertMessage && !fromLoad) {
                 // Optional: Add sound effect here
                 alert(alertMessage);
            }

             // Reset state for the next mode
            pomodoroState.workSessionSubject = ''; // Clear subject for breaks/next work session
            setTimerMode(nextMode, false); // Set up the next timer (reads duration, updates UI)
            // Note: savePomodoroState() is called within setTimerMode()

            // NEW: Ensure subject times are refreshed on the Pomodoro page if it's active
            if (!fromLoad && getElement('pomodoro')?.classList.contains('active')) {
                 displayPomodoroSubjectTimes();
             }
        };


        const startTimer = () => {
            if (pomodoroState.timerState === 'running') return; // Already running

            // If resuming from pause, just restart the interval
            if (pomodoroState.timerState === 'paused') {
                console.log("Resuming timer...");
                startPomodoroTimerInterval();
                return;
            }

            // --- Starting a fresh timer (state is 'stopped') ---
            if (pomodoroState.timerMode === 'work') {
                const selectedSubject = pomodoroSubjectSelect?.value;
                if (!selectedSubject) {
                    alert('Please select a subject for this Focus Session.');
                    pomodoroSubjectSelect?.focus();
                    return;
                }
                pomodoroState.workSessionSubject = selectedSubject;
            } else {
                pomodoroState.workSessionSubject = ''; // Ensure subject is clear for breaks
            }

            // Ensure timer isn't starting at 0
            if (pomodoroState.currentSeconds <= 0) {
                console.log("Timer at 0, resetting duration before start.");
                setTimerMode(pomodoroState.timerMode, false); // Reset to full duration of current mode
                if (pomodoroState.currentSeconds <= 0) { // Check again after reset
                   alert("Timer duration is invalid (0 or less). Please adjust settings.");
                   return;
                }
            }

            console.log("Starting timer...");
            startPomodoroTimerInterval(); // This sets state to 'running' and saves
        };

        const pauseTimer = () => {
            if (pomodoroState.timerState !== 'running') return; // Can only pause if running

            console.log("Pausing timer...");
            if (pomodoroInterval) clearInterval(pomodoroInterval);
            pomodoroInterval = null;
            pomodoroState.timerState = 'paused';
            // Keep pomodoroState.currentSeconds as it is
            pomodoroState.timerEndTime = null; // Clear end time as it's no longer running towards it

            updatePomodoroUIState('paused');
            savePomodoroState(); // Save the paused state
            document.title = DEFAULT_TITLE; // Reset tab title
        };

        const resetTimer = (silent = false) => {
             console.log("Resetting timer...");
             stopPomodoroTimer(false); // Stop any interval, set state to 'stopped', save
             // Reset the timer to the full duration of the *current* mode
             setTimerMode(pomodoroState.timerMode, false);
             if (!silent) {
                 console.log("Timer reset to full duration for mode:", pomodoroState.timerMode);
             }
        };
        // Expose reset function if needed by other parts, e.g., on logout
        window.resetPomodoroTimer = resetTimer;


      // --- Tracker ---
      const loadTracker = () => {
          populateSubjectDropdown(trackerSubjectSelect);
          if(addTrackerDetails) addTrackerDetails.style.display = 'none';
          if(trackerItemsList) trackerItemsList.innerHTML = createLoadingMessage('Select a subject to view items.');
          validateTrackerForm();
          console.log("Tracker page initialized.");
      };

      const validateTrackerForm = () => {
          if (saveTrackerItemBtn && trackerDescriptionInput) {
              saveTrackerItemBtn.disabled = !currentActiveSubject || trackerDescriptionInput.value.trim() === '';
          } else if (saveTrackerItemBtn) {
               saveTrackerItemBtn.disabled = true;
          }
      };

      const displayTrackerItems = async (subject) => {
          if (!currentUserId || !trackerItemsList || !db) {
              if(trackerItemsList) trackerItemsList.innerHTML = createLoadingMessage('Cannot load items: Not logged in or DB unavailable.');
              return;
           }
          trackerItemsList.innerHTML = createLoadingMessage(`Loading ${subject} tracker items...`);
          try {
              const collRef = getSubjectSpecificCollectionRef(currentUserId, 'trackerItems', subject);
               if (!collRef) throw new Error("Could not get trackerItems collection ref.");

              const q = query(collRef, orderBy("createdAt", "desc"));
              const snapshot = await getDocs(q);
              const items = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
              trackerItemsList.innerHTML = '';
              if (items.length === 0) {
                  trackerItemsList.innerHTML = createLoadingMessage(`No items tracked for ${subject} yet.`);
              } else {
                  const getStatusClass = (status) => {
                      const statusKey = status?.toLowerCase().replace(/\s+/g,'') || 'review';
                      const statusClasses = tailwind?.config?.theme?.extend?.colors?.status;
                      return statusClasses?.[statusKey] || 'bg-gray-100 dark:bg-slate-700 text-gray-800 dark:text-gray-200 border border-gray-300 dark:border-gray-600 font-medium';
                  };
                  items.forEach((item, index) => {
                      const div = document.createElement('div');
                      const itemSubject = item.subject || subject;
                      div.className = `tracker-item list-item flex justify-between items-start p-3 rounded-lg border bg-background dark:bg-slate-800/50 hover:bg-slate-50 dark:hover:bg-slate-700/50 transition-all duration-150 space-x-3 ${getSubjectColor(itemSubject).replace('border-l-4', 'border')} list-item-appear`;
                      div.style.animationDelay = `${index * 0.05}s`;
                      div.innerHTML = `
                          <div class="flex-grow">
                              <p class="text-sm text-text dark:text-text-dark whitespace-pre-wrap">${escapeHtml(item.description)}</p>
                              <span class="text-xs px-2 py-0.5 rounded-full mt-2 inline-block ${getStatusClass(item.status)}">${escapeHtml(item.status || 'To Review')}</span>
                              ${item.createdAt ? `<span class="text-xs text-muted dark:text-muted-dark ml-2">${formatGeneralDate(item.createdAt)}</span>` : ''}
                          </div>
                          <div class="flex-shrink-0 flex flex-col items-end space-y-1">
                              <button title="Delete Item" class="list-delete-btn p-1 -m-1 rounded-full btn-animated focus-visible:ring-1 focus-visible:ring-red-500" onclick="window.handleGenericDeleteItem('trackerItems', '${escapeHtml(subject)}', '${item.id}', 'tracker item', window.displayTrackerItems)">
                                  <i data-lucide="trash-2" class="h-4 w-4"></i>
                              </button>
                          </div>`;
                      trackerItemsList.appendChild(div);
                  });
                  safelyCreateIcons();
              }
          } catch (error) {
              console.error(`Error loading tracker items for ${subject}:`, error);
              trackerItemsList.innerHTML = createLoadingMessage(`Error loading items for ${subject}. Check console.`);
          }
      };
      window.displayTrackerItems = displayTrackerItems; // Expose for onclick

      const handleSaveTrackerItem = async () => {
          if (!currentUserId || !currentActiveSubject || !saveTrackerItemBtn || !db || !trackerDescriptionInput || !trackerStatusSelect) {
              alert("Cannot save item: Missing user, subject, or form elements.");
              return;
            }
          validateTrackerForm();
          if (saveTrackerItemBtn.disabled) return;

          const description = trackerDescriptionInput.value.trim();
          const status = trackerStatusSelect.value;
          const newItem = { description, status, createdAt: serverTimestamp(), subject: currentActiveSubject };

          saveTrackerItemBtn.disabled = true;
          saveTrackerItemBtn.textContent = 'Adding...';
          try {
              const collRef = getSubjectSpecificCollectionRef(currentUserId, 'trackerItems', currentActiveSubject);
              if (!collRef) throw new Error("Could not get trackerItems collection ref.");
              await addDoc(collRef, newItem);
              console.log("Tracker item saved.");
              trackerDescriptionInput.value = '';
              trackerStatusSelect.value = 'To Review';
              if (addTrackerDetails) addTrackerDetails.open = false;
              displayTrackerItems(currentActiveSubject); // Refresh list
          } catch (error) {
              console.error("Error saving tracker item:", error);
              alert("Failed to save tracker item.");
          } finally {
              saveTrackerItemBtn.disabled = false;
              saveTrackerItemBtn.textContent = 'Add Item';
              validateTrackerForm();
          }
      };

      // --- Planner ---
        const loadPlanner = () => {
          if (!plannerDateInput || !plannerTimeInput || !plannerSubjectSelect || !plannerTopicInput || !savePlannerItemBtn || !plannerItemsList) {
             console.error("Planner page elements missing.");
             return;
            }
          populateSubjectDropdown(plannerSubjectSelect);
          displayPlannerItems(); // Load existing items

          // Set default date/time
          try {
              const now = new Date();
              const localISODate = new Date(now.getTime() - (now.getTimezoneOffset() * 60000)).toISOString().split('T')[0];
              const localISOTime = now.toTimeString().substring(0, 5);
              plannerDateInput.value = localISODate;
              plannerTimeInput.value = localISOTime;
          } catch (e) { console.warn("Could not set default date/time for planner:", e); }

          validatePlannerForm();
          console.log("Planner page initialized.");
      };

      const validatePlannerForm = () => {
          if (savePlannerItemBtn && plannerDateInput && plannerTimeInput && plannerSubjectSelect && plannerTopicInput) {
              const isValid = plannerDateInput.value &&
                              plannerTimeInput.value &&
                              plannerSubjectSelect.value &&
                              plannerTopicInput.value.trim();
              savePlannerItemBtn.disabled = !isValid;
          } else if (savePlannerItemBtn) {
              savePlannerItemBtn.disabled = true;
          }
      };

      const handleSavePlannerItem = async () => {
          if (!currentUserId || !db || !savePlannerItemBtn || !plannerDateInput || !plannerTimeInput || !plannerSubjectSelect || !plannerTopicInput ) {
              alert("Cannot schedule: Missing user, DB connection, or form elements.");
              return;
            }
          validatePlannerForm();
          if (savePlannerItemBtn.disabled) return;

          const date = plannerDateInput.value;
          const time = plannerTimeInput.value;
          const subject = plannerSubjectSelect.value;
          const topic = plannerTopicInput.value.trim();
          let dateTimeString;

          // Combine date and time into an ISO string for reliable sorting/storage
          try {
              // Check for minimal validity before creating Date object
              if (!/^\d{4}-\d{2}-\d{2}$/.test(date) || !/^\d{2}:\d{2}$/.test(time)) {
                  throw new Error("Invalid date or time format entered.");
              }
              const combined = new Date(`${date}T${time}:00`);
              if (isNaN(combined.getTime())) throw new Error("Invalid date/time combination");
               dateTimeString = combined.toISOString(); // Store as UTC ISO string

          } catch (e) {
              console.error("Invalid date/time format:", e);
              alert("Please enter a valid date and time.");
              return;
          }

          const newItem = { dateTime: dateTimeString, subject, topic, createdAt: serverTimestamp() };

          savePlannerItemBtn.disabled = true;
          savePlannerItemBtn.textContent = 'Scheduling...';
          try {
              const collRef = getUserCollectionRef(currentUserId, 'plannerItems');
               if (!collRef) throw new Error("Could not get plannerItems collection ref.");
              await addDoc(collRef, newItem);
              console.log("Planner item saved.");
              await displayPlannerItems(); // Refresh list
              // Clear only subject/topic after successful save
              if(plannerSubjectSelect) plannerSubjectSelect.value = '';
              if(plannerTopicInput) plannerTopicInput.value = '';
              validatePlannerForm(); // Re-validate (will likely disable button)
          } catch (e) {
              console.error("Error saving planner item:", e);
              alert("Failed to schedule session.");
          } finally {
              savePlannerItemBtn.disabled = false;
              savePlannerItemBtn.textContent = 'Schedule Session';
          }
      };

      const displayPlannerItems = async () => {
          if (!currentUserId || !plannerItemsList || !db) {
              if (plannerItemsList) plannerItemsList.innerHTML = createLoadingMessage('Cannot load sessions: Not logged in or DB unavailable.');
              return;
          }
          plannerItemsList.innerHTML = createLoadingMessage('Loading scheduled sessions...');
          try {
              const collRef = getUserCollectionRef(currentUserId, 'plannerItems');
              if (!collRef) throw new Error("Could not get plannerItems collection ref.");

              // Fetch items ordered by the stored dateTime (ISO string)
              const q = query(collRef, orderBy("dateTime", "asc"));
              const snapshot = await getDocs(q);
              const items = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));

              plannerItemsList.innerHTML = '';
              if (items.length === 0) {
                  plannerItemsList.innerHTML = createLoadingMessage('No sessions scheduled yet.');
              } else {
                   // Group by Local Date String for display purposes
                  const groupedByDate = items.reduce((acc, item) => {
                      try {
                          if (!item.dateTime) throw new Error("Missing dateTime field");
                           // Parse the ISO string back to a Date object
                           const d = new Date(item.dateTime);
                          if (isNaN(d.getTime())) throw new Error("Invalid stored date string");
                           // Format for display using local timezone
                           const dateStr = d.toLocaleDateString('en-GB', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
                          if (!acc[dateStr]) acc[dateStr] = [];
                          acc[dateStr].push(item);
                      } catch (e) { console.warn("Skipping planner item with invalid date:", item.id, item.dateTime, e); }
                      return acc;
                  }, {});

                    // Sort the Display Dates (These are strings like "Monday, 1 January 2024")
                    // We need to parse them back to dates for correct sorting
                   const sortedDates = Object.keys(groupedByDate).sort((a, b) => {
                       try {
                           // Helper to parse "Weekday, D Month YYYY" back to a comparable Date
                           const parseDisplayDate = (str) => {
                                const parts = str.split(', ')[1]?.split(' '); // "D Month YYYY"
                                if (!parts || parts.length !== 3) return new Date(NaN);
                                const day = parseInt(parts[0]);
                                const year = parseInt(parts[2]);
                                const monthNames = ["January", "February", "March", "April", "May", "June", "July", "August", "September", "October", "November", "December"];
                                const monthIndex = monthNames.findIndex(m => m.toLowerCase() === parts[1].toLowerCase());
                                if (isNaN(day) || isNaN(year) || monthIndex === -1) return new Date(NaN);
                                // Use UTC to avoid timezone shifts during comparison
                                return new Date(Date.UTC(year, monthIndex, day));
                           }
                           const dateA = parseDisplayDate(a);
                           const dateB = parseDisplayDate(b);
                           if (isNaN(dateA.getTime()) || isNaN(dateB.getTime())) return 0; // Keep original order if parse fails
                           return dateA - dateB;
                       } catch { return 0; } // Fallback if parsing fails
                   });

                  sortedDates.forEach(dateStr => {
                      const dateHeader = document.createElement('h4');
                      dateHeader.className = 'text-lg font-semibold mt-5 mb-2 text-text dark:text-text-dark border-b pb-1 dark:border-slate-600';
                      dateHeader.textContent = dateStr;
                      plannerItemsList.appendChild(dateHeader);

                      const list = document.createElement('ul');
                      list.className = 'space-y-3';
                       // Sort items within the same day by their exact time (using original dateTime ISO string)
                      const sortedItems = groupedByDate[dateStr].sort((a,b) => new Date(a.dateTime) - new Date(b.dateTime));

                      sortedItems.forEach((item, index) => {
                          const li = document.createElement('li');
                           const itemSubject = item.subject || 'Unspecified';
                          li.className = `planner-item list-item flex justify-between items-center p-3 rounded-lg border-l-4 bg-card dark:bg-card-dark shadow-sm hover:bg-slate-50 dark:hover:bg-slate-700/60 transition-all duration-150 ${getSubjectColor(itemSubject)} list-item-appear`;
                          li.style.animationDelay = `${index * 0.05}s`;
                          const formattedDateTime = item.dateTime ? formatPlannerDateTime(item.dateTime) : 'Invalid time';
                          const isPast = item.dateTime ? new Date(item.dateTime) < new Date() : false;

                          li.innerHTML = `
                              <div class="flex-grow mr-3 ${isPast ? 'opacity-60' : ''}">
                                  <p class="font-semibold text-sm text-text dark:text-text-dark">${escapeHtml(item.subject)}</p>
                                  <p class="text-xs text-muted dark:text-muted-dark mt-0.5">${escapeHtml(item.topic)}</p>
                                  <p class="text-xs text-primary dark:text-primary-dark font-medium mt-1.5">${formattedDateTime}</p>
                                  ${isPast ? '<span class="text-xs text-red-500 dark:text-red-400 ml-2">(Past)</span>' : ''}
                              </div>
                              <button title="Delete Session" class="list-delete-btn flex-shrink-0 p-1 -m-1 rounded-full btn-animated focus-visible:ring-1 focus-visible:ring-red-500" onclick="window.handleGenericDeleteItem('plannerItems', null, '${item.id}', 'scheduled session', window.displayPlannerItems)">
                                  <i data-lucide="trash-2" class="h-4 w-4"></i>
                              </button>`;
                          list.appendChild(li);
                      });
                      plannerItemsList.appendChild(list);
                  });
                  safelyCreateIcons();
              }
          } catch (error) {
              console.error("Error loading planner items:", error);
              plannerItemsList.innerHTML = createLoadingMessage('Error loading scheduled sessions. Check console.');
          }
      };
      window.displayPlannerItems = displayPlannerItems; // Expose for onclick


      // --- Generic Delete Function ---
      window.handleGenericDeleteItem = async (collectionName, subject, itemId, itemTypeName, displayFunction) => {
           if (!currentUserId || !itemId || !db) {
               alert(`Cannot delete ${itemTypeName}: Missing user ID or DB connection.`);
               return;
            }
           if (!confirm(`Are you sure you want to delete this ${itemTypeName}?`)) return;

           console.log(`Attempting to delete ${itemTypeName}: Collection=${collectionName}, Subject=${subject || 'N/A'}, ID=${itemId}`);

           try {
               let itemRef;
               if (subject && ['resources', 'trackerItems', 'quizItems'].includes(collectionName)) {
                   itemRef = getSubjectSpecificDocRef(currentUserId, collectionName, subject, itemId);
               } else if (!subject && ['plannerItems'].includes(collectionName)) {
                   // Planner items are directly under user/plannerItems/{itemId}
                   itemRef = doc(db, `users/${currentUserId}/${collectionName}/${itemId}`);
               } else {
                   throw new Error(`Invalid collection/subject combination for deletion: ${collectionName}, ${subject}`);
               }

               if (!itemRef) throw new Error("Could not construct document reference for deletion.");

               // Special handling for quiz items with files
               if (collectionName === 'quizItems') {
                   await handleDeleteQuizItemFiles(subject, itemId); // Attempt file deletion first
               }

               await deleteDoc(itemRef); // Delete the Firestore document
               console.log(`${itemTypeName} deleted successfully from Firestore.`);

                // Refresh the relevant list display
               if (typeof displayFunction === 'function') {
                   // If subject-specific, only refresh if the current subject matches
                   if (subject && currentActiveSubject === subject) {
                        displayFunction(subject);
                   // If not subject-specific (like planner), always refresh
                   } else if (!subject) {
                       displayFunction();
                   }
               }
                // Update quiz start button state if a quiz item was deleted for the current subject
                if (collectionName === 'quizItems' && currentActiveSubject === subject) {
                    await toggleQuizButtons();
                }

           } catch (error) {
               console.error(`Error deleting ${itemTypeName}:`, error);
               alert(`Failed to delete ${itemTypeName}. Check console for details.`);
           }
       };

       const handleDeleteQuizItemFiles = async (subject, itemId) => {
           if (!currentUserId || !subject || !itemId || !db || !storage) {
               console.warn("Cannot delete quiz files: Missing required context.");
               return;
           }
           const itemRef = getSubjectSpecificDocRef(currentUserId, 'quizItems', subject, itemId);
           if (!itemRef) return;

           try {
                // Get the document data to find file URLs *before* deleting the doc
                const docSnap = await getDoc(itemRef);
                if (docSnap.exists()) {
                    const data = docSnap.data();

                    const tryDeleteFile = async (fileUrl, fileType) => {
                        if (!fileUrl) return; // No URL, nothing to delete
                        try {
                             // Only attempt delete if it's a Firebase Storage URL
                            if (fileUrl.includes('firebasestorage.googleapis.com')) {
                                const fileRef = ref(storage, fileUrl); // Get ref from URL
                                await deleteObject(fileRef);
                                console.log(`Deleted quiz ${fileType} file: ${fileUrl}`);
                            } else {
                                console.log(`Skipping deletion for non-storage URL: ${fileUrl}`);
                            }
                        } catch (e) {
                            // It's okay if the file is already gone
                            if (e.code === 'storage/object-not-found') {
                                console.log(`Quiz ${fileType} file already deleted or not found: ${fileUrl}`);
                            } else {
                                // Log other errors as warnings
                                console.warn(`Failed to delete quiz ${fileType} file ${fileUrl}:`, e);
                            }
                        }
                    };

                    // Attempt to delete both question and answer files if their URLs exist
                    await tryDeleteFile(data.questionFileUrl, 'question');
                    await tryDeleteFile(data.answerFileUrl, 'answer');

                } else {
                     console.log(`Quiz item ${itemId} not found in Firestore, cannot get file URLs for deletion.`);
                }
           } catch(error) {
                console.error(`Error retrieving quiz item ${itemId} to delete files:`, error);
           }
       };


      // --- Quiz ---
        const loadQuizPage = () => {
          populateSubjectDropdown(quizSubjectSelect);
          if(quizContentWrapper) quizContentWrapper.classList.add('hidden');
          if(quizModeInterface) quizModeInterface.classList.add('hidden');
          if (addQuizDetails) addQuizDetails.style.display = 'none';
          validateQuizForm();
          toggleQuizButtons();
          console.log("Quiz page initialized.");
      };

      const validateQuizForm = () => {
          if (!saveQuizQuestionBtn || !quizQuestionInput || !quizAnswerInput || !quizQuestionFileInput || !quizAnswerFileInput) {
              if (saveQuizQuestionBtn) saveQuizQuestionBtn.disabled = true;
              return;
          }
          // Question is valid if either text or file is present
          const hasQuestion = quizQuestionInput.value.trim() !== '' || quizQuestionFileInput.files.length > 0;
          // Answer is valid if either text or file is present
          const hasAnswer = quizAnswerInput.value.trim() !== '' || quizAnswerFileInput.files.length > 0;

          saveQuizQuestionBtn.disabled = !(currentActiveSubject && hasQuestion && hasAnswer);
      };

      const toggleQuizButtons = async () => {
          // Disable start button initially
          if (startQuizButton) startQuizButton.disabled = true;

          // Enable only if subject selected, logged in, and questions exist for that subject
          if (!currentActiveSubject || !currentUserId || !db || !startQuizButton) {
              return;
          }

          try {
              const collRef = getSubjectSpecificCollectionRef(currentUserId, 'quizItems', currentActiveSubject);
               if (!collRef) throw new Error("Could not get quizItems collection ref.");

              // Check if *any* documents exist in the collection quickly
              const q = query(collRef, limit(1));
              const snapshot = await getDocs(q);
              startQuizButton.disabled = snapshot.empty; // Enable if not empty
              console.log(`Quiz start button for ${currentActiveSubject} ${snapshot.empty ? 'disabled' : 'enabled'}.`);
          } catch (error) {
              console.error("Error checking for quiz questions:", error);
              startQuizButton.disabled = true; // Keep disabled on error
          }
      };

       const renderFilePreview = (url, altText = "Uploaded file", context = 'list') => {
           if (!url) return '';
           const imageExtensions = /\.(jpg|jpeg|png|gif|webp|svg)(\?|$)/i;
           let displayHtml = '';

           if (imageExtensions.test(url)) {
                // Choose class based on context
                const imgClass = context === 'quiz' ? 'quiz-mode-image-display' : 'quiz-file-preview';
                displayHtml = `<img src="${escapeHtml(url)}" alt="${escapeHtml(altText)}" class="${imgClass} inline-block border border-slate-300 dark:border-slate-600 rounded" loading="lazy">`;
           } else { // Non-image file (PDF, DOCX, etc.)
               let filename = 'Attached File';
                try {
                     // Try to extract a readable filename from the URL
                    const decodedUrl = decodeURIComponent(url);
                    // Find the part after the last '/' and before the '?'
                    const pathPart = decodedUrl.substring(decodedUrl.lastIndexOf('/') + 1).split('?')[0];
                    // Remove potential timestamp added during upload (e.g., _1678886400000)
                    filename = pathPart.replace(/(_\d{13,})(?=\.[^.]+$)/, '');
                } catch (e) { console.warn("Could not parse filename from URL:", url, e); }

                // Always render as a link, regardless of context for non-images
                displayHtml = `<a href="${escapeHtml(url)}" target="_blank" rel="noopener noreferrer" class="inline-flex items-center space-x-1 text-xs text-primary dark:text-primary-dark hover:underline bg-slate-100 dark:bg-slate-700 px-2 py-1 rounded">
                            <i data-lucide="paperclip" class="h-3 w-3"></i>
                            <span>${escapeHtml(filename)}</span>
                         </a>`;
           }
            // Use a temporary div to render icons correctly
            const container = document.createElement('div');
            container.innerHTML = displayHtml;
            safelyCreateIcons(); // Ensure icons like 'paperclip' are rendered
            return container.innerHTML;
       };

      const displaySavedQuizQuestions = async (subject) => {
          if (!currentUserId || !quizItemsList || !db) {
               if(quizItemsList) quizItemsList.innerHTML = createLoadingMessage('Cannot load questions: Not logged in or DB unavailable.');
               return;
            }
           quizItemsList.innerHTML = createLoadingMessage(`Loading ${subject} questions...`);
          try {
              const collRef = getSubjectSpecificCollectionRef(currentUserId, 'quizItems', subject);
              if (!collRef) throw new Error("Could not get quizItems collection ref.");

              const q = query(collRef, orderBy("createdAt", "desc"));
              const snapshot = await getDocs(q);
              const items = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
              quizItemsList.innerHTML = '';
              if (items.length === 0) {
                  quizItemsList.innerHTML = createLoadingMessage(`No questions saved for ${subject} yet.`);
              } else {
                  items.forEach((item, index) => {
                      const div = document.createElement('div');
                      const itemSubject = item.subject || subject;
                      div.className = `quiz-item list-item flex justify-between items-start p-3 rounded-lg border bg-white dark:bg-slate-800 shadow-sm space-x-3 hover:bg-slate-50 dark:hover:bg-slate-700/60 transition-all duration-150 ${getSubjectColor(itemSubject).replace('border-l-4', 'border')} list-item-appear`;
                      div.style.animationDelay = `${index * 0.05}s`;

                      // Question Part - Context 'list'
                      let questionHtml = item.question ? `<p class="font-medium text-text dark:text-text-dark mb-1 truncate" title="${escapeHtml(item.question)}">Q: ${escapeHtml(item.question)}</p>` : '';
                      if (item.questionFileUrl) {
                          questionHtml += `<div class="mt-1">${renderFilePreview(item.questionFileUrl, 'Question file', 'list')}</div>`; // Context: list
                      }
                      if (!questionHtml) {
                          questionHtml = `<p class="font-medium text-text dark:text-text-dark mb-1 italic text-muted dark:text-muted-dark">(No question text/file)</p>`;
                      }

                      // Answer Part - Context 'list'
                      let answerHtml = item.answer ? `<p class="text-xs text-muted dark:text-muted-dark whitespace-pre-wrap break-words mt-1" title="${escapeHtml(item.answer)}">A: ${escapeHtml(item.answer.substring(0, 100))}${item.answer.length > 100 ? '...' : ''}</p>` : '';
                       if (item.answerFileUrl) {
                           answerHtml += `<div class="mt-1">${renderFilePreview(item.answerFileUrl, 'Answer file', 'list')}</div>`; // Context: list
                       }
                       if (!answerHtml) {
                          answerHtml = `<p class="text-xs text-muted dark:text-muted-dark mt-1 italic">(No answer text/file)</p>`;
                       }

                      div.innerHTML = `
                          <div class="flex-grow text-sm overflow-hidden">
                              ${questionHtml}
                              ${answerHtml}
                          </div>
                          <button title="Delete Question" class="list-delete-btn flex-shrink-0 p-1 -m-1 rounded-full btn-animated focus-visible:ring-1 focus-visible:ring-red-500" onclick="window.handleGenericDeleteItem('quizItems', '${escapeHtml(subject)}', '${item.id}', 'quiz question', window.displaySavedQuizQuestions)">
                              <i data-lucide="trash-2" class="h-4 w-4"></i>
                          </button>`;
// Continuing from the displaySavedQuizQuestions function...
                      quizItemsList.appendChild(div);
                  });
                  safelyCreateIcons(); // Render any icons within the list items
              }
              // Update the start button state after successfully loading questions
              await toggleQuizButtons();
          } catch (error) {
              console.error(`Error loading quiz items for ${subject}:`, error);
              if(quizItemsList) quizItemsList.innerHTML = createLoadingMessage(`Error loading questions for ${subject}. Check console.`);
              await toggleQuizButtons(); // Ensure button is disabled on error
          }
      };
      window.displaySavedQuizQuestions = displaySavedQuizQuestions; // Make accessible for onclick/refresh


      // Uploads a single file to Firebase Storage
      const uploadFile = async (file, subject) => {
          console.log(`Attempting to upload file: ${file.name} for subject: ${subject}`);
          if (!file || !currentUserId || !subject || !storage) {
              console.error("Upload pre-check failed:", { file: !!file, currentUserId, subject, storage: !!storage });
              throw new Error("Cannot upload file: Missing required information or storage service.");
          }

          const timestamp = Date.now();
          // Sanitize filename and add timestamp to prevent collisions
          const nameParts = file.name.split('.');
          const extension = nameParts.length > 1 ? `.${nameParts.pop()}` : '';
          const baseName = nameParts.join('.');
          // Replace potentially problematic characters for storage path
          const cleanBaseName = baseName.replace(/[^a-zA-Z0-9_.\-]/g, '_');
          const safeFileName = `${cleanBaseName}_${timestamp}${extension}`;

          const storagePath = `quizFiles/${currentUserId}/${subject}/${safeFileName}`;
          console.log("Calculated Storage Path:", storagePath);
          const storageRef = ref(storage, storagePath);

          try {
              console.log(`Uploading to: ${storagePath}`);
              const snapshot = await uploadBytes(storageRef, file);
              console.log("Upload successful, getting download URL for:", snapshot.ref.fullPath);
              const downloadURL = await getDownloadURL(snapshot.ref);
              console.log("Upload successful. Download URL:", downloadURL);
              return downloadURL;
          } catch (error) {
              console.error("Firebase Storage Upload Error:", error);
              console.error("Error Code:", error.code);
              console.error("Error Message:", error.message);
              console.error(`Failed to upload file: ${file.name} to path: ${storagePath}`);
              // Provide a more user-friendly error message if possible
              let userMessage = `Upload Failed: ${error.message}`;
              if (error.code === 'storage/unauthorized') {
                   userMessage = 'Upload Failed: You do not have permission to upload files.';
              } else if (error.code === 'storage/canceled') {
                  userMessage = 'Upload Failed: The upload was cancelled.';
              } else if (error.code === 'storage/unknown') {
                  userMessage = 'Upload Failed: An unknown error occurred. Check network connection.';
              }
              throw new Error(`${userMessage} (Code: ${error.code})`);
          }
      };

    // Saves a new quiz question (including file uploads)
    const handleSaveQuizQuestion = async () => {
        console.log("--- handleSaveQuizQuestion triggered ---");
        if (!currentUserId || !currentActiveSubject || !saveQuizQuestionBtn || !db || !storage || !quizQuestionInput || !quizAnswerInput || !quizQuestionFileInput || !quizAnswerFileInput ) {
            alert("Cannot save question: Missing required context or elements.");
            return;
        }

        validateQuizForm();
        if (saveQuizQuestionBtn.disabled) {
            console.log("Save button is disabled, aborting save.");
            return;
        }

        const questionText = quizQuestionInput.value.trim();
        const answerText = quizAnswerInput.value.trim();
        const questionFile = quizQuestionFileInput.files[0];
        const answerFile = quizAnswerFileInput.files[0];

        console.log("Question File Selected:", questionFile ? questionFile.name : "None");
        console.log("Answer File Selected:", answerFile ? answerFile.name : "None");

        saveQuizQuestionBtn.disabled = true;
        saveQuizQuestionBtn.textContent = 'Saving...';

        let questionFileUrl = null;
        let answerFileUrl = null;
        let errorOccurred = false;

        try {
            // Upload Question File if present
            if (questionFile) {
                console.log("Attempting to upload question file...");
                saveQuizQuestionBtn.textContent = 'Uploading Q file...';
                questionFileUrl = await uploadFile(questionFile, currentActiveSubject);
                console.log("Question file upload SUCCESSFUL:", questionFileUrl);
            } else {
                console.log("No question file to upload.");
            }

            // Upload Answer File if present
            if (answerFile) {
                console.log("Attempting to upload answer file...");
                saveQuizQuestionBtn.textContent = 'Uploading A file...';
                answerFileUrl = await uploadFile(answerFile, currentActiveSubject);
                console.log("Answer file upload SUCCESSFUL:", answerFileUrl);
            } else {
                console.log("No answer file to upload.");
            }

            // Save data (text and URLs) to Firestore
            console.log("Uploads complete (or skipped). Proceeding to Firestore save.");
            saveQuizQuestionBtn.textContent = 'Saving Data...';
            const newItem = {
                question: questionText,
                answer: answerText,
                createdAt: serverTimestamp(),
                subject: currentActiveSubject // Store the subject with the item
            };
            if (questionFileUrl) newItem.questionFileUrl = questionFileUrl;
            if (answerFileUrl) newItem.answerFileUrl = answerFileUrl;

            console.log("Data to save in Firestore:", newItem);
            const collRef = getSubjectSpecificCollectionRef(currentUserId, 'quizItems', currentActiveSubject);
             if (!collRef) throw new Error("Could not get quizItems collection ref for saving.");
            const docRef = await addDoc(collRef, newItem);
            console.log("Firestore document saved successfully with ID:", docRef.id);

            // Clear form ONLY on complete success
            if (quizQuestionInput) quizQuestionInput.value = '';
            if (quizAnswerInput) quizAnswerInput.value = '';
            if (quizQuestionFileInput) quizQuestionFileInput.value = '';
            if (quizAnswerFileInput) quizAnswerFileInput.value = '';
            if (addQuizDetails) addQuizDetails.open = false; // Close the details section
            displaySavedQuizQuestions(currentActiveSubject); // Refresh the list

        } catch (error) {
            errorOccurred = true;
            console.error("Error during handleSaveQuizQuestion:", error);
            alert(`Failed to save question. ${error.message}. Check console.`);

            // Attempt to Clean Up Uploaded Files if Firestore Save Failed
            console.log("Attempting cleanup of potentially uploaded files due to error...");
             const cleanupPromises = [];
            // If question file was uploaded but DB save failed, try delete it
            if (questionFileUrl) {
                 cleanupPromises.push(
                     deleteObject(ref(storage, questionFileUrl))
                     .then(() => console.log("Cleaned up orphaned question file:", questionFileUrl))
                     .catch(e => console.warn("Could not clean up orphaned question file:", e))
                 );
            }
            // If answer file was uploaded but DB save failed, try delete it
            if (answerFileUrl) {
                 cleanupPromises.push(
                     deleteObject(ref(storage, answerFileUrl))
                     .then(() => console.log("Cleaned up orphaned answer file:", answerFileUrl))
                     .catch(e => console.warn("Could not clean up orphaned answer file:", e))
                 );
            }
            await Promise.allSettled(cleanupPromises); // Wait for cleanup attempts
            console.log("Cleanup attempt finished.");

        } finally {
             // Reset button state
             saveQuizQuestionBtn.textContent = 'Add Question';
             saveQuizQuestionBtn.disabled = false; // Re-enable button regardless of outcome
             validateQuizForm(); // Re-validate form state
        }
    }; // End of handleSaveQuizQuestion


      // --- Quiz Mode Logic ---

      const startQuizMode = async () => {
          if (!currentUserId || !currentActiveSubject || !db) {
              alert("Cannot start quiz: Missing user, subject, or DB connection.");
              return;
          }
          console.log(`Starting quiz for subject: ${currentActiveSubject}`);
          try {
               const collRef = getSubjectSpecificCollectionRef(currentUserId, 'quizItems', currentActiveSubject);
               if (!collRef) throw new Error("Could not get quizItems collection ref.");

              const snapshot = await getDocs(collRef);
              if (snapshot.empty) {
                  alert(`No questions found for ${currentActiveSubject} to start the quiz.`);
                  return;
              }
              const allQuestions = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));

              // Reset quiz state fully before starting
              quizState = {
                  active: true,
                  currentSubject: currentActiveSubject,
                  initialQuestions: [...allQuestions], // Store original list
                  currentQuizPool: shuffleArray([...allQuestions]), // Shuffle for first round
                  incorrectlyAnswered: [], // Reset incorrect list
                  currentQuestionIndex: 0,
                  round: 1,
                  totalMastered: 0,
                  isAnswerVisible: false,
                  buttonTimeout: null
              };
              console.log("Quiz state initialized:", quizState);

              // Update UI for quiz mode
              if (addQuizDetails) addQuizDetails.style.display = 'none'; // Hide add form
              if (quizListContainer) quizListContainer.classList.add('hidden'); // Hide question list
              if (quizCompletionMessage) quizCompletionMessage.classList.add('hidden'); // Hide completion message
              if (quizModeInterface) quizModeInterface.classList.remove('hidden'); // Show quiz interface
              if (stopQuizButton) stopQuizButton.textContent = "Stop Quiz"; // Set stop button text

              displayCurrentQuizQuestion(); // Display the first question
          } catch (error) {
              console.error("Error starting quiz:", error);
              alert("Could not start the quiz due to an error. Check console.");
              stopQuizMode(); // Ensure clean state if start fails
          }
      };

      const stopQuizMode = () => {
          // Only proceed if quiz is active or interface is mistakenly visible
          if (!quizState.active && quizModeInterface?.classList.contains('hidden')) {
               return; // Already stopped and hidden
          }
          if (!quizState.active) { // If interface somehow visible but state inactive, just hide it
               if (quizModeInterface) quizModeInterface.classList.add('hidden');
               return;
          }

          console.log("Stopping quiz mode.");
          quizState.active = false; // Mark as inactive

          // Update UI back to list/add view
          if (quizModeInterface) quizModeInterface.classList.add('hidden');
          if (currentActiveSubject) { // Only show add/list if a subject is still selected
              if (addQuizDetails) addQuizDetails.style.display = 'block';
              if (quizListContainer) quizListContainer.classList.remove('hidden');
          }
          if (quizCorrectAnswerDisplay) quizCorrectAnswerDisplay.style.display = 'none'; // Hide answer area

          // Clear any pending timeouts
          if (quizState.buttonTimeout) {
              clearTimeout(quizState.buttonTimeout);
              quizState.buttonTimeout = null;
          }

          toggleQuizButtons(); // Re-evaluate start button state

           // Reset quiz state completely
           quizState = {
                active: false, currentSubject: quizState.currentSubject, // Keep track of the subject
                initialQuestions: [], currentQuizPool: [], incorrectlyAnswered: [],
                currentQuestionIndex: -1, round: 1, totalMastered: 0, isAnswerVisible: false, buttonTimeout: null
            };
            console.log("Quiz state reset.");
      };

      const updateQuizProgressDisplay = () => {
          if (!quizProgress || !quizState.active) return;
          const remainingInPool = Math.max(0, quizState.currentQuizPool.length - quizState.currentQuestionIndex);
          const totalInitial = quizState.initialQuestions.length;
          // Display progress
          quizProgress.textContent = `Round ${quizState.round} | Remaining: ${remainingInPool} | Mastered: ${quizState.totalMastered}/${totalInitial}`;
      };

      const displayCurrentQuizQuestion = () => {
           if (!quizState.active || !quizQuestionDisplay || !quizCorrectAnswerDisplay || !quizRevealBtnContainer || !quizJudgmentButtons || !quizAnswerTextDisplay || !quizAnswerFileDisplay) {
               console.error("Cannot display quiz question: Quiz not active or missing required UI elements.");
               stopQuizMode(); // Stop quiz if essential elements are missing
               return;
           }

            // Reset UI elements for the new question
           quizCorrectAnswerDisplay.style.display = 'none';
           quizCorrectAnswerDisplay.classList.remove('visible'); // Remove animation class
           quizState.isAnswerVisible = false; // Answer is hidden initially
           quizJudgmentButtons.style.display = 'none'; // Hide judgment buttons
           quizRevealBtnContainer.style.display = 'block'; // Show reveal button
           // Remove feedback classes from buttons
           quizCorrectBtn?.classList.remove('quiz-feedback-correct');
           quizIncorrectBtn?.classList.remove('quiz-feedback-incorrect');

           // Check if current round is finished
           if (quizState.currentQuestionIndex >= quizState.currentQuizPool.length) {
               handleQuizRoundEnd(); // Proceed to end-of-round logic
               return;
           }

           // Get the current question data
           const questionData = quizState.currentQuizPool[quizState.currentQuestionIndex];
           if (!questionData) {
                console.error("Error: Could not get question data at index", quizState.currentQuestionIndex);
                stopQuizMode();
                alert("An error occurred loading the next question.");
                return;
           }
           console.log(`Displaying question ID: ${questionData.id}, Index: ${quizState.currentQuestionIndex}, Round: ${quizState.round}`);

           // --- Display Question Content ---
           quizQuestionDisplay.innerHTML = ''; // Clear previous question content
           let questionContentRendered = false;
           // Add question text if available
           if (questionData.question) {
               const p = document.createElement('p');
               p.className = 'text-text dark:text-text-dark text-lg mb-3 whitespace-pre-wrap'; // Use pre-wrap for newlines
               p.textContent = questionData.question;
               quizQuestionDisplay.appendChild(p);
               questionContentRendered = true;
           }
            // Add question file PREVIEW using 'quiz' context for larger display
           if (questionData.questionFileUrl) {
               const previewHtml = renderFilePreview(questionData.questionFileUrl, 'Question file', 'quiz'); // Context: quiz
               quizQuestionDisplay.insertAdjacentHTML('beforeend', previewHtml);
               questionContentRendered = true;
           }
           // Show placeholder if no text or file
           if (!questionContentRendered) {
               const p = document.createElement('p');
               p.className = 'italic text-muted dark:text-muted-dark text-base';
               p.textContent = '(Question content missing)';
               quizQuestionDisplay.appendChild(p);
           }


           // --- Prepare Answer Display (kept hidden initially) ---
           let answerContentRendered = false;
            // Prepare answer text
           if (questionData.answer) {
                quizAnswerTextDisplay.innerHTML = `<strong class="text-sm font-semibold text-primary dark:text-primary-dark mr-2">Answer:</strong><span class="whitespace-pre-wrap">${escapeHtml(questionData.answer)}</span>`;
                answerContentRendered = true;
           } else {
                quizAnswerTextDisplay.innerHTML = ''; // Clear previous answer text
           }
            // Prepare answer file preview using 'quiz' context
            quizAnswerFileDisplay.innerHTML = questionData.answerFileUrl
                ? renderFilePreview(questionData.answerFileUrl, 'Answer file', 'quiz') // Context: quiz
                : '';
            if (questionData.answerFileUrl) answerContentRendered = true;
            // Show placeholder if no answer text or file
            if (!answerContentRendered && quizAnswerTextDisplay) {
                 quizAnswerTextDisplay.innerHTML = `<strong class="text-sm font-semibold text-primary dark:text-primary-dark mr-2">Answer:</strong><span class="italic text-muted dark:text-muted-dark">(Answer content missing)</span>`;
            }

           updateQuizProgressDisplay(); // Update the progress counter

           // Ensure judgment buttons are enabled only *after* reveal
           if (quizCorrectBtn) quizCorrectBtn.disabled = true;
           if (quizIncorrectBtn) quizIncorrectBtn.disabled = true;

           safelyCreateIcons(); // Render any icons in the previews
      };

      const revealQuizAnswer = () => {
          if (!quizState.active || !quizCorrectAnswerDisplay || !quizRevealBtnContainer || !quizJudgmentButtons) {
             console.warn("Cannot reveal answer: Quiz not active or UI elements missing.");
             return;
          }
          console.log("Revealing answer.");
          quizCorrectAnswerDisplay.classList.add('visible'); // Add class for potential animation
          quizCorrectAnswerDisplay.style.display = 'block'; // Ensure it's visible
          quizRevealBtnContainer.style.display = 'none'; // Hide the reveal button
          quizJudgmentButtons.style.display = 'flex'; // Show judgment buttons
          quizState.isAnswerVisible = true; // Mark answer as visible

          // Enable judgment buttons now that answer is visible
          if (quizCorrectBtn) quizCorrectBtn.disabled = false;
          if (quizIncorrectBtn) quizIncorrectBtn.disabled = false;

           safelyCreateIcons(); // Render icons if any were added dynamically
      };

      const handleQuizAnswer = (isCorrect) => {
           // Prevent action if quiz inactive, answer not visible, or already processing an answer
           if (!quizState.active || !quizState.isAnswerVisible || quizState.buttonTimeout || !quizCorrectBtn || !quizIncorrectBtn) {
                console.warn("Cannot handle quiz answer: State invalid or buttons blocked.");
                return;
            }

           const currentQuestion = quizState.currentQuizPool[quizState.currentQuestionIndex];
           if (!currentQuestion) {
               console.error("Cannot handle answer: currentQuestion is missing.");
               return;
            }

           console.log(`Handling answer for Q ID: ${currentQuestion.id}, Correct: ${isCorrect}`);

           // Disable buttons immediately to prevent double clicks
           quizCorrectBtn.disabled = true;
           quizIncorrectBtn.disabled = true;

           if (isCorrect) {
               // Find the original question ref to check if it was previously marked incorrect
               let originalQuestionRef = quizState.initialQuestions.find(q => q.id === currentQuestion.id);
               // Only increment mastered count if this question *wasn't* marked wrong in a previous round of this session
               if (!originalQuestionRef?.markedIncorrectInPriorRound) {
                  quizState.totalMastered++;
                  if(originalQuestionRef) originalQuestionRef.masteredInThisSession = true; // Mark as mastered in this session
               }
               quizCorrectBtn?.classList.add('quiz-feedback-correct'); // Visual feedback

           } else { // Incorrect
                // Add to incorrectlyAnswered list for the *next* round if not already there
                if (!quizState.incorrectlyAnswered.find(iq => iq.id === currentQuestion.id)) {
                   quizState.incorrectlyAnswered.push(currentQuestion);
                     // Mark the original question ref so we know not to count it as mastered later
                     let originalQuestionRef = quizState.initialQuestions.find(q => q.id === currentQuestion.id);
                     if (originalQuestionRef) originalQuestionRef.markedIncorrectInPriorRound = true;
                }
               quizIncorrectBtn?.classList.add('quiz-feedback-incorrect'); // Visual feedback
           }

            updateQuizProgressDisplay(); // Update counts

           // Set timeout to automatically move to the next question after feedback
           quizState.buttonTimeout = setTimeout(() => {
               quizState.buttonTimeout = null; // Clear the timeout flag
               quizState.currentQuestionIndex++; // Move to next index
               displayCurrentQuizQuestion(); // Display the next question (or handle round end)
           }, 800); // Delay for feedback visibility
      };

      const handleQuizRoundEnd = () => {
           console.log(`Quiz round ${quizState.round} ended.`);
           if (quizState.incorrectlyAnswered.length === 0) {
               // --- Quiz Complete ---
               console.log("Quiz completed! All questions mastered.");
               if(quizCompletionMessage) {
                   quizCompletionMessage.textContent = `🎉 Well done! You've mastered all ${quizState.initialQuestions.length} questions for ${quizState.currentSubject}!`;
                   quizCompletionMessage.classList.remove('hidden'); // Show completion message
               }
               // Clear display areas
               if (quizQuestionDisplay) quizQuestionDisplay.innerHTML = '<p class="italic text-muted dark:text-muted-dark">Quiz complete!</p>';
               if (quizRevealBtnContainer) quizRevealBtnContainer.style.display = 'none';
               if (quizJudgmentButtons) quizJudgmentButtons.style.display = 'none';
               if (quizCorrectAnswerDisplay) quizCorrectAnswerDisplay.style.display = 'none';
               // Change stop button text to indicate completion
               if (stopQuizButton) stopQuizButton.textContent = "Finish Session";

           } else {
               // --- Start Next Round ---
               quizState.round++;
               console.log(`Starting round ${quizState.round} with ${quizState.incorrectlyAnswered.length} incorrect questions.`);
               // Set the pool for the next round to only the incorrectly answered ones, shuffled
               quizState.currentQuizPool = shuffleArray([...quizState.incorrectlyAnswered]);
               quizState.incorrectlyAnswered = []; // Clear the list for the new round
               quizState.currentQuestionIndex = 0; // Reset index for the new pool

               alert(`Round ${quizState.round} starting with ${quizState.currentQuizPool.length} remaining question(s).`);

               displayCurrentQuizQuestion(); // Display the first question of the new round
           }
      };


      // --- General Setup and Initialization ---

      const populateSubjectDropdown = (selectElement) => {
          if (!selectElement) return;
          const currentValue = selectElement.value; // Store current selection if any
          // Preserve the placeholder option if it exists
          const placeholder = selectElement.options[0]?.value === "" ? selectElement.options[0].cloneNode(true) : null;
          selectElement.innerHTML = ''; // Clear existing options

          if (placeholder) {
              selectElement.appendChild(placeholder); // Add placeholder back
          } else { // Create a default placeholder if none existed
              const opt = document.createElement('option');
              opt.value = "";
              opt.textContent = "-- Select Subject --"; // Consistent placeholder text
              selectElement.appendChild(opt);
          }

          if (!subjects || subjects.length === 0) return; // No subjects to add
          subjects.forEach(subject => {
              const option = document.createElement('option');
              option.value = subject;
              option.textContent = subject;
              selectElement.appendChild(option);
          });
           // Restore previous selection if it's still a valid subject
           if (subjects.includes(currentValue)) {
               selectElement.value = currentValue;
           }
      };


      const setupGlobalEventListeners = () => {
          if (eventListenersAttached) {
              console.log("Global event listeners already attached.");
              return;
          }
          console.log("Attaching global event listeners...");

          // Theme Toggles
          themeToggle?.addEventListener('click', toggleTheme);
          themeToggleMobile?.addEventListener('click', toggleTheme);

          // Authentication
          loginButton?.addEventListener('click', handleLogin);
          passwordInput?.addEventListener('keypress', (e) => { if (e.key === 'Enter') handleLogin(); });
          logoutButton?.addEventListener('click', handleLogout);
          logoutButtonMobile?.addEventListener('click', handleLogout);
          changePasswordButton?.addEventListener('click', handleChangePassword);

          // Mobile Navigation
          mobileMenuButton?.addEventListener('click', openMobileMenu);
          mobileCloseButton?.addEventListener('click', closeMobileMenu);
          mobileOverlay?.addEventListener('click', closeMobileMenu); // Close on overlay click

          // Page Navigation (Desktop & Mobile Links)
          document.querySelectorAll('a.nav-link[data-page], a.mobile-nav-link[data-page]').forEach(link => {
              link.addEventListener('click', (e) => {
                   e.preventDefault();
                   if (link instanceof HTMLElement && link.dataset.page) {
                      window.navigateToPage(link.dataset.page); // Use exposed navigation function
                   }
                });
          });

          // Dashboard Click Handling (Event Delegation)
          getElement('dashboard')?.addEventListener('click', (e) => {
              const pomodoroBtn = e.target.closest('#start-pomodoro-dashboard-btn');
              const quickLink = e.target.closest('#quick-links-list a.quick-link');
              const examItem = e.target.closest('#upcoming-exams-list .upcoming-exam-item');

              if (pomodoroBtn) { window.navigateToPage('pomodoro'); }
              else if (quickLink && quickLink instanceof HTMLElement && quickLink.dataset.page) {
                   e.preventDefault();
                   // Pass subject as parameter if available
                   window.navigateToPage(quickLink.dataset.page, quickLink.dataset.subject || null);
              } else if (examItem && examItem instanceof HTMLElement && examItem.dataset.page) {
                   // Pass subject as parameter
                   window.navigateToPage(examItem.dataset.page, examItem.dataset.subject);
              }
          });

          // Resources Page
          subjectTabsContainer?.addEventListener('click', (e) => {
              const tab = e.target.closest('.subject-tab');
              if (tab instanceof HTMLElement && tab.dataset.subject) {
                   handleSubjectSelection(tab.dataset.subject, 'resources');
                }
          });
          resourceTypeSelect?.addEventListener('change', toggleResourceTypeFields);
          resourceTitleInput?.addEventListener('input', validateResourceForm);
          resourceUrlInput?.addEventListener('input', validateResourceForm);
          resourceNoteInput?.addEventListener('input', validateResourceForm);
          saveResourceBtn?.addEventListener('click', handleSaveResource);

          // Pomodoro Page
          startPauseButton?.addEventListener('click', () => {
               if (pomodoroState.timerState === 'running') pauseTimer();
               else startTimer(); // Handles both start and resume
           });
          resetButton?.addEventListener('click', () => resetTimer(false));
          modeButtons.forEach(btn => {
              btn?.addEventListener('click', () => {
                   if (btn instanceof HTMLElement && btn.dataset.mode) {
                      const mode = btn.dataset.mode;
                      // Only switch if mode is different and timer not running
                      if (mode !== pomodoroState.timerMode) {
                          setTimerMode(mode, true); // Pass true for user interaction
                        }
                    }
                });
          });
          // Update timer immediately if duration changes for the current mode when stopped/paused
          workDurationInput?.addEventListener('change', () => handleDurationChange('work'));
          shortBreakDurationInput?.addEventListener('change', () => handleDurationChange('shortBreak'));
          longBreakDurationInput?.addEventListener('change', () => handleDurationChange('longBreak'));
          // Save selected subject for work sessions immediately
          pomodoroSubjectSelect?.addEventListener('change', () => {
             if (pomodoroState.timerState === 'stopped' && pomodoroState.timerMode === 'work') {
                 pomodoroState.workSessionSubject = pomodoroSubjectSelect.value;
                 savePomodoroState(); // Save the selected subject
             }
          });

          // Tracker Page
          trackerSubjectSelect?.addEventListener('change', (e) => {
              if (e.target instanceof HTMLSelectElement) handleSubjectSelection(e.target.value, 'tracker');
            });
          trackerDescriptionInput?.addEventListener('input', validateTrackerForm);
          trackerStatusSelect?.addEventListener('change', validateTrackerForm); // Validate on status change too
          saveTrackerItemBtn?.addEventListener('click', handleSaveTrackerItem);

          // Planner Page
          plannerDateInput?.addEventListener('input', validatePlannerForm);
          plannerTimeInput?.addEventListener('input', validatePlannerForm);
          plannerSubjectSelect?.addEventListener('change', validatePlannerForm);
          plannerTopicInput?.addEventListener('input', validatePlannerForm);
          savePlannerItemBtn?.addEventListener('click', handleSavePlannerItem);

          // Quiz Page
          quizSubjectSelect?.addEventListener('change', (e) => {
               if (e.target instanceof HTMLSelectElement) handleSubjectSelection(e.target.value, 'quiz');
           });
          // Validate quiz form on any input/change
          quizQuestionInput?.addEventListener('input', validateQuizForm);
          quizAnswerInput?.addEventListener('input', validateQuizForm);
          quizQuestionFileInput?.addEventListener('change', validateQuizForm);
          quizAnswerFileInput?.addEventListener('change', validateQuizForm);
          saveQuizQuestionBtn?.addEventListener('click', handleSaveQuizQuestion);
          // Quiz Mode Controls
          startQuizButton?.addEventListener('click', startQuizMode);
          stopQuizButton?.addEventListener('click', stopQuizMode);
          quizRevealAnswerBtn?.addEventListener('click', revealQuizAnswer);
          quizCorrectBtn?.addEventListener('click', () => handleQuizAnswer(true));
          quizIncorrectBtn?.addEventListener('click', () => handleQuizAnswer(false));

          eventListenersAttached = true;
          console.log("Global event listeners attached.");
      };


      // Initial setup function run once on script load
      const initializeAppHub = () => {
          console.log("Initializing App Hub...");
          // Apply theme early
          try {
            applyTheme(localStorage.getItem('theme') || 'light');
          } catch(e){ console.warn("Could not apply theme from localStorage", e);}
          // Setup listeners that don't depend on Firebase auth state
          setupGlobalEventListeners();
          console.log("App Hub main initialization complete. Waiting for auth state...");
      };

      // Setup function run *after* successful Firebase login
      const initializePostLogin = (user) => {
           console.log("Running post-login initialization for user:", user.uid);
          if (!db || !storage) {
              console.error("Database or Storage not ready during post-login initialization!");
              // Display a user-friendly error, potentially offer refresh
              alert("Failed to connect to services after login. Please refresh the page.");
              handleLogout(); // Log out the user to prevent inconsistent state
              return;
          }

          // Set footer year
          if (currentYearEl) currentYearEl.textContent = new Date().getFullYear();

          // Clear any previous countdown interval
          if (countdownInterval) clearInterval(countdownInterval);

          try {
              // Load static/semi-static data first
              loadTimetable();

              // Populate subject dropdowns used across pages
              populateSubjectDropdown(getElement('pomodoro-subject'));
              populateSubjectDropdown(getElement('tracker-subject-select'));
              populateSubjectDropdown(getElement('planner-subject-select'));
              populateSubjectDropdown(getElement('quiz-subject-select'));

              // Initialize Pomodoro - load saved state or set default
              if (!loadPomodoroState()) {
                   // If no valid state loaded, set default work mode
                  setTimerMode('work', false);
              }

              // Load dynamic content for each page (data fetching)
              loadResources(); // Sets up tabs, prepares for subject selection
              loadTracker();   // Sets up dropdown, prepares for subject selection
              loadPlanner();   // Sets up form, loads existing items
              loadQuizPage();  // Sets up dropdown, prepares for subject selection

              // Load dashboard data (fetches analytics, recent sessions etc.)
              loadDashboard();

              // Show the dashboard by default after login
              showPage('dashboard');

              // Start the countdown update interval
              countdownInterval = setInterval(updateTimetableCountdowns, 30000); // Update every 30 seconds
              updateTimetableCountdowns(); // Initial update

              // Ensure all icons are rendered after dynamic content loads
              safelyCreateIcons();

              console.log("Post-login initialization complete.");

          } catch (error) {
              console.error("Error during post-login initialization:", error);
              const dashboardPage = getElement('dashboard');
              // Display a clear error message on the dashboard
              if (dashboardPage) {
                   dashboardPage.innerHTML = `
                    <div class="p-4 bg-red-100 dark:bg-red-900/50 border border-red-300 dark:border-red-700 rounded-lg text-red-700 dark:text-red-200 text-center">
                        <h2 class="font-semibold text-lg mb-2">Error Loading Application Data</h2>
                        <p class="text-sm mb-3">Something went wrong during setup. Please try refreshing the page.</p>
                        <p class="text-xs">If the problem persists, check the browser console (F12) for technical details.</p>
                        <p class="text-xs mt-1">Error details: ${escapeHtml(error.message)}</p>
                    </div>`;
                   setActiveLink('dashboard'); // Ensure dashboard link is active despite error
              } else {
                  // Fallback alert if dashboard element isn't found
                  alert("A critical error occurred while loading the application. Please refresh the page. Check the console for more details.");
              }
              // Clean up timers on error
              if (countdownInterval) clearInterval(countdownInterval);
              stopPomodoroTimer(true); // Stop pomodoro and clear its state
              // Optionally logout user on critical failure: handleLogout();
          }
      };


      // --- Start the application ---
      initializeAppHub();

    </script>
</body>
</html>
